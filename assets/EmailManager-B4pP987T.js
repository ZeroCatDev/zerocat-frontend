import{b as O,p as Z,x as ee,a8 as ae,f as le,h as t,l as te,D as se,E as oe,H as re,J as ne,X as h,r as n,e as ue,T as w,o as c,N as s,as as M,M as u,j as y,K as i,Y as P,a as L,F as ie,Q as de,W as T,S as b,R as S,ak as ve,an as j}from"./index-BVHv7Kt3.js";import{_ as fe}from"./verifyEmail-D7aNMOcZ.js";import{V as I}from"./VChip-mBmXDnix.js";import{V as R}from"./VDialog-CHpQTOKs.js";import{V as me}from"./VForm-BWGcY56c.js";import{V as J}from"./VTextField-9kh1NZa8.js";import{V as ce}from"./VAlert-B6fgM-_0.js";import{V as K}from"./VSpacer-CAx3LUaN.js";const pe=Z({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...ne(),...re(),...oe(),...se()},"VTable"),ye=O()({name:"VTable",props:pe(),setup(r,v){let{slots:o,emit:k}=v;const{themeClasses:V}=ee(r),{densityClasses:g}=ae(r);return le(()=>t(r.tag,{class:["v-table",{"v-table--fixed-height":!!r.height,"v-table--fixed-header":r.fixedHeader,"v-table--fixed-footer":r.fixedFooter,"v-table--has-top":!!o.top,"v-table--has-bottom":!!o.bottom,"v-table--hover":r.hover},V.value,g.value,r.class],style:r.style},{default:()=>{var d,f,m;return[(d=o.top)==null?void 0:d.call(o),o.default?t("div",{class:"v-table__wrapper",style:{height:te(r.height)}},[t("table",null,[o.default()])]):(f=o.wrapper)==null?void 0:f.call(o),(m=o.bottom)==null?void 0:m.call(o)]}})),{}}}),Ve=async()=>(await h.get("/account/emails")).data,ge=async(r,v)=>(await h.post("/account/add-email",{email:r,verificationCode:v})).data,we=async(r,v)=>(await h.post("/account/remove-email",{email:r,verificationCode:v})).data,be=async(r,v)=>(await h.post("/account/verify-email",{email:r,token:v})).data,Fe={__name:"EmailManager",setup(r,{expose:v}){const o=n([]),k=n(!1),V=n(!1),g=n(!1),d=n(!1),f=n(""),m=n(""),x=n(null),p=n(""),C=n("info"),F=n(!1),U=n(""),$=n(""),_=n(null),B=n(null),E={required:l=>!!l||"此字段为必填项",email:l=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||"请输入有效的邮箱地址",length:l=>(l==null?void 0:l.length)===6||"验证码必须是6位数字"},D=async()=>{try{const l=await Ve();l.status==="success"&&(o.value=l.data)}catch(l){console.error("获取邮箱列表失败:",l)}},N=(l,e,a)=>{U.value=l,$.value=e,_.value=a,F.value=!0},Q=l=>{_.value&&(_.value(l),_.value=null)},A=async()=>{if(!f.value){p.value="请输入新邮箱地址",C.value="error";return}const l=o.value.find(e=>e.is_primary);if(!l){p.value="未找到主邮箱",C.value="error";return}N(l.contact_value,"验证主邮箱",e=>{m.value=e,q()})},q=async()=>{if(!(!f.value||!m.value)){d.value=!0;try{const l=await ge(f.value,m.value);l.status==="success"?(await D(),z()):(p.value=l.message,C.value="error")}catch{p.value="添加邮箱失败",C.value="error"}finally{d.value=!1}}},W=l=>{x.value=l,V.value=!0},X=()=>{const l=o.value.find(e=>e.is_primary);l&&x.value&&N(l.contact_value,"验证主邮箱",async e=>{d.value=!0;try{(await we(x.value.contact_value,e)).status==="success"&&(await D(),H())}catch(a){console.error("删除失败:",a)}finally{d.value=!1}})},z=()=>{k.value=!1,g.value=!1,f.value="",m.value="",p.value="",B.value&&B.value.reset()},H=()=>{V.value=!1,x.value=null},Y=l=>{N(l,"验证邮箱",async e=>{d.value=!0;try{(await be(l,e)).status==="success"&&await D()}catch(a){console.error("验证失败:",a)}finally{d.value=!1}})};return ue(async()=>{await D()}),v({fetchEmails:D}),(l,e)=>(c(),w(S,{class:"mb-4"},{default:s(()=>[t(M,{class:"d-flex align-center justify-space-between"},{default:s(()=>[e[8]||(e[8]=u("span",null,"邮箱管理",-1)),t(y,{color:"primary",onClick:e[0]||(e[0]=a=>k.value=!0),disabled:o.value.length>=5},{default:s(()=>e[7]||(e[7]=[i(" 添加邮箱 ")])),_:1},8,["disabled"])]),_:1}),t(P,null,{default:s(()=>[t(ye,null,{default:s(()=>[e[12]||(e[12]=u("thead",null,[u("tr",null,[u("th",null,"邮箱地址"),u("th",null,"状态"),u("th",null,"添加时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(c(!0),L(ie,null,de(o.value,a=>(c(),L("tr",{key:a.contact_id},[u("td",null,[i(b(a.contact_value)+" ",1),a.is_primary?(c(),w(I,{key:0,color:"primary",size:"small",class:"ml-2"},{default:s(()=>e[9]||(e[9]=[i("主邮箱")])),_:1})):T("",!0)]),u("td",null,[t(I,{color:a.verified?"success":"warning",size:"small"},{default:s(()=>[i(b(a.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),u("td",null,b(new Date(a.created_at).toLocaleString()),1),u("td",null,[a.verified?T("",!0):(c(),w(y,{key:0,variant:"text",color:"primary",size:"small",onClick:G=>Y(a.contact_value)},{default:s(()=>e[10]||(e[10]=[i(" 验证 ")])),_:2},1032,["onClick"])),a.is_primary?T("",!0):(c(),w(y,{key:1,variant:"text",color:"error",size:"small",onClick:G=>W(a)},{default:s(()=>e[11]||(e[11]=[i(" 删除 ")])),_:2},1032,["onClick"]))])]))),128))])]),_:1})]),_:1}),t(R,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=a=>k.value=a),"max-width":"500px"},{default:s(()=>[t(S,null,{default:s(()=>[t(M,null,{default:s(()=>e[13]||(e[13]=[i("添加新邮箱")])),_:1}),t(P,null,{default:s(()=>[t(me,{onSubmit:ve(A,["prevent"]),ref_key:"addForm",ref:B},{default:s(()=>[t(J,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=a=>f.value=a),label:"新邮箱地址",rules:[E.required,E.email],variant:"outlined"},null,8,["modelValue","rules"]),g.value?(c(),w(J,{key:0,modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=a=>m.value=a),label:"主邮箱验证码",rules:[E.required,E.length],maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):T("",!0),p.value?(c(),w(ce,{key:1,type:C.value,variant:"tonal",class:"mt-3"},{default:s(()=>[i(b(p.value),1)]),_:1},8,["type"])):T("",!0)]),_:1},512)]),_:1}),t(j,null,{default:s(()=>[t(K),t(y,{color:"grey",variant:"text",onClick:z},{default:s(()=>e[14]||(e[14]=[i("取消")])),_:1}),t(y,{color:"primary",loading:d.value,onClick:e[3]||(e[3]=a=>g.value?q():A())},{default:s(()=>[i(b(g.value?"添加":"发送验证码"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(R,{modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=a=>V.value=a),"max-width":"500px"},{default:s(()=>[t(S,null,{default:s(()=>[t(M,null,{default:s(()=>e[15]||(e[15]=[i("删除邮箱")])),_:1}),t(P,null,{default:s(()=>{var a;return[u("p",null,"确认要删除邮箱 "+b((a=x.value)==null?void 0:a.contact_value)+" 吗？",1)]}),_:1}),t(j,null,{default:s(()=>[t(K),t(y,{color:"grey",variant:"text",onClick:H},{default:s(()=>e[16]||(e[16]=[i("取消")])),_:1}),t(y,{color:"error",loading:d.value,onClick:X},{default:s(()=>e[17]||(e[17]=[i(" 删除 ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(fe,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=a=>F.value=a),email:U.value,title:$.value,onVerified:Q},null,8,["modelValue","email","title"])]),_:1}))}};export{ye as V,Fe as _,pe as m};
