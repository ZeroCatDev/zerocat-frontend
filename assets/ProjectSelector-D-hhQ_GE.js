import{_ as fe,r as p,x as J,w as ye,M as R,b as ge,ag as V,c,o,e as l,N as t,a9 as _e,f as u,a0 as b,U as n,$ as K,aB as w,Y as g,F as k,X as C,T as h,L as i,P as y,Z as z,af as U,i as T,W as pe,R as F,S,aG as he,aC as j,j as be,aa as Ve,D as ee,n as Q,c7 as te,c6 as ae,a_ as N,b0 as E,bM as xe,c8 as we,aI as ke,aF as Ce,a6 as le}from"./index-sIbGf8Dn.js";const ze={class:"flex-grow-1"},Se={key:0,class:"text-grey-600"},Ne={key:1,class:"d-flex align-center"},Pe={class:"text-subtitle-2"},Ae={class:"text-caption text-grey-600"},$e={key:2,class:"flex-grow-1"},Ie={class:"text-subtitle-2 mb-1"},De={class:"d-flex flex-wrap gap-1"},Ue={class:"text-h6"},Be={class:"pa-4"},Me={key:1,class:"text-center py-8"},Te={key:2,class:"text-center py-8 text-grey-600"},Fe={class:"d-flex align-center gap-2"},Ee={class:"d-flex align-center justify-space-between text-caption text-grey-600"},Oe={class:"d-flex align-center gap-3"},Le={class:"d-flex align-center"},Ge={class:"d-flex align-center"},Je={key:0,class:"mt-2"},Re={key:4,class:"d-flex justify-center mt-6"},Qe={key:0,class:"pa-4"},We={class:"d-flex align-center justify-space-between mb-3"},Xe={class:"d-flex flex-wrap gap-2 mb-4"},Ye={key:1,class:"pa-4"},Ze={class:"d-flex align-center justify-space-between mb-3"},qe={class:"position-absolute",style:{top:"8px",right:"8px"}},He={class:"d-flex align-center gap-2"},Ke={class:"d-flex align-center justify-space-between text-caption text-grey-600"},je={class:"d-flex align-center gap-3"},et={class:"d-flex align-center"},tt={class:"d-flex align-center"},at={key:0,class:"mt-2"},lt={__name:"ProjectSelector",props:{modelValue:{type:[Number,Array],default:()=>null},multiple:{type:Boolean,default:!1},limit:{type:Number,default:20},author:{type:[String,Number,Array],default:null}},emits:["update:modelValue"],setup(_,{emit:se}){const d=_,W=se,x=p(!1),B=p(!1),P=p([]),v=p(new Map),M=p(""),O=p("time_down"),L=p(""),A=p(1),G=p(0),ie=[{title:"最新发布",value:"time_down"},{title:"最早发布",value:"time_up"},{title:"最多观看",value:"view_down"},{title:"最少观看",value:"view_up"},{title:"最多点赞",value:"star_down"},{title:"最少点赞",value:"star_up"},{title:"ID降序",value:"id_down"},{title:"ID升序",value:"id_up"}],ne=[{title:"所有",value:""},{title:"公开",value:"public"},{title:"私有",value:"private"}],m=J(()=>Array.from(v.value.values())),$=J(()=>d.multiple||!d.modelValue?null:v.value.get(d.modelValue)||null),ue=J(()=>d.multiple?m.value.length>0:!!d.modelValue&&!!$.value),X=s=>v.value.has(s),oe=async()=>{if(!d.author)return null;if(d.author==="me")return V.user.value.id;if(Array.isArray(d.author))return d.author.map(a=>Number(a)).filter(a=>!isNaN(a));const s=Number(d.author);return isNaN(s)?null:s},I=async(s=!0)=>{s&&(A.value=1),B.value=!0;try{const a={curr:A.value,limit:d.limit,search_orderby:O.value,search_state:L.value};M.value&&(a.search_title=M.value);const e=await oe();e!==null&&(a.search_userid=e);const r=(await le.get("/searchapi",{params:a})).data;P.value=r.projects,G.value=r.totalCount}catch(a){console.error("Failed to load projects:",a)}finally{B.value=!1}},re=()=>{I()},de=s=>{A.value=s,I(!1)},ce=s=>{d.multiple?v.value.has(s.id)?v.value.delete(s.id):v.value.set(s.id,s):(v.value.clear(),v.value.set(s.id,s),W("update:modelValue",s.id),x.value=!1)},Y=s=>{v.value.delete(s)},Z=()=>{try{const s=Array.from(v.value.keys());console.log(s),W("update:modelValue",s),x.value=!1}catch(s){console.error("Error in confirmSelection:",s)}},ve=()=>{x.value=!0,P.value.length===0&&I()},q=s=>new Date(s).toLocaleDateString("zh-CN"),me=async s=>{var a;if(!(!s||s.length===0))try{const e=await le.post("/project/batch",{projectIds:s}),f=(a=e.data)==null?void 0:a.data;if(!f||!Array.isArray(f)){console.warn("Invalid project data received:",e.data);return}await R(),f.forEach(r=>{r&&r.id&&v.value.has(r.id)&&v.value.set(r.id,r)})}catch(e){console.error("Failed to load project details:",e)}},H=async()=>{if(!v.value||(v.value.clear(),!d.modelValue))return;const s=[],a=e=>({id:e,title:`项目 ${e}`,loading:!0,author:{display_name:"加载中...",username:"",avatar:"",id:0},description:"加载中...",view_count:0,star_count:0,time:new Date().toISOString(),tags:"",state:"public"});try{d.multiple&&Array.isArray(d.modelValue)?d.modelValue.forEach(e=>{e&&typeof e=="number"&&(v.value.set(e,a(e)),s.push(e))}):!d.multiple&&typeof d.modelValue=="number"&&(v.value.set(d.modelValue,a(d.modelValue)),s.push(d.modelValue)),s.length>0&&await me(s)}catch(e){console.error("Error in initializeSelection:",e)}};return ye(()=>d.modelValue,async(s,a)=>{JSON.stringify(s)!==JSON.stringify(a)&&(await R(),await H())},{immediate:!0,deep:!0}),ge(async()=>{await R(),await H(),V.value=V}),(s,a)=>(o(),c("div",null,[l(z,{class:"cursor-pointer",onClick:ve,elevation:"1",rounded:"lg"},{default:t(()=>[l(_e,{class:"d-flex align-center justify-space-between"},{default:t(()=>[u("div",ze,[ue.value?!_.multiple&&$.value?(o(),c("div",Ne,[l(K,{class:"me-2",image:w(V).getUserAvatar($.value.author.avatar)},null,8,["image"]),u("div",null,[u("div",Pe,n($.value.title),1),u("div",Ae," by "+n($.value.author.display_name),1)])])):_.multiple?(o(),c("div",$e,[u("div",Ie," 已选择 "+n(m.value.length)+" 个"+n(_.author==="me"?"我的":"")+"项目 ",1),u("div",De,[(o(!0),c(k,null,C(m.value.slice(0,3),e=>(o(),g(h,{key:e.id,size:"small",variant:"outlined",color:"primary"},{default:t(()=>[i(n(e.title),1)]),_:2},1024))),128)),m.value.length>3?(o(),g(h,{key:0,size:"small",variant:"outlined",color:"grey"},{default:t(()=>[i(" +"+n(m.value.length-3),1)]),_:1})):b("",!0)])])):b("",!0):(o(),c("div",Se,n(_.multiple?"选择项目...":"选择一个项目..."),1))]),l(y,null,{default:t(()=>[...a[6]||(a[6]=[i("mdi-chevron-down",-1)])]),_:1})]),_:1})]),_:1}),l(Ce,{modelValue:x.value,"onUpdate:modelValue":a[5]||(a[5]=e=>x.value=e),"max-width":s.$vuetify.display.mobile?void 0:"1200px",fullscreen:s.$vuetify.display.mobile,scrollable:"",transition:"dialog-transition"},{default:t(()=>[l(z,{border:"",hover:""},{default:t(()=>[l(U,{class:"d-flex align-center justify-space-between pa-4"},{default:t(()=>[u("span",Ue,n(_.multiple?"选择项目":"选择一个项目"),1),l(T,{icon:"",variant:"text",onClick:a[0]||(a[0]=e=>x.value=!1)},{default:t(()=>[l(y,null,{default:t(()=>[...a[7]||(a[7]=[i("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),l(pe,{fluid:"",class:"pa-0"},{default:t(()=>[l(F,{"no-gutters":""},{default:t(()=>[l(S,{cols:_.multiple&&m.value.length>0?s.$vuetify.display.mobile?12:8:12,order:s.$vuetify.display.mobile?2:1},{default:t(()=>[u("div",Be,[l(he,{modelValue:M.value,"onUpdate:modelValue":a[1]||(a[1]=e=>M.value=e),label:"搜索项目","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onInput:re},null,8,["modelValue"]),l(F,{class:"mb-4"},{default:t(()=>[l(S,{cols:"12",sm:"6"},{default:t(()=>[l(j,{modelValue:O.value,"onUpdate:modelValue":[a[2]||(a[2]=e=>O.value=e),I],items:ie,label:"排序",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),l(S,{cols:"12",sm:"6"},{default:t(()=>[l(j,{modelValue:L.value,"onUpdate:modelValue":[a[3]||(a[3]=e=>L.value=e),I],items:ne,label:"状态",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1}),B.value?(o(),g(be,{key:0,indeterminate:"",color:"primary",class:"mb-4"})):b("",!0),B.value&&P.value.length===0?(o(),c("div",Me,[l(Ve,{indeterminate:"",size:"48"}),a[8]||(a[8]=u("div",{class:"mt-4 text-h6"},"加载中...",-1))])):P.value.length===0?(o(),c("div",Te,[l(y,{size:"64",class:"mb-4"},{default:t(()=>[...a[9]||(a[9]=[i("mdi-folder-open-outline",-1)])]),_:1}),a[10]||(a[10]=u("div",{class:"text-h6"},"未找到项目",-1))])):(o(),g(F,{key:3},{default:t(()=>[(o(!0),c(k,null,C(P.value,e=>(o(),g(S,{key:e.id,cols:"6",sm:"6",md:"4",lg:"3"},{default:t(()=>[l(z,{class:ee(["project-card",{selected:X(e.id)}]),rounded:"lg",elevation:"2",onClick:f=>ce(e)},{default:t(()=>{var f;return[l(z,{rounded:"lg",style:{"aspect-ratio":"4/3"}},{default:t(()=>[l(Q,{src:w(ae)(e.thumbnail),class:"align-end",cover:"",gradient:"to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)",height:"100%","lazy-src":te},{default:t(()=>[l(N,null,{default:t(()=>[l(U,{class:"text-white"},{default:t(()=>[i(n(e.title),1)]),_:2},1024),l(E,{class:"text-white"},{default:t(()=>[i(n(e.description),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["src"])]),_:2},1024),l(N,{"append-avatar":(f=e.author)!=null&&f.avatar?w(V).getUserAvatar(e.author.avatar):""},{append:t(()=>[u("div",Fe,[l(h,{color:e.state==="public"?"success":"warning",size:"small",variant:"outlined"},{default:t(()=>[i(n(e.state==="public"?"公开":"私有"),1)]),_:2},1032,["color"]),X(e.id)?(o(),g(y,{key:0,color:"primary",size:"24"},{default:t(()=>[...a[11]||(a[11]=[i(" mdi-check-circle ",-1)])]),_:1})):b("",!0)])]),default:t(()=>[l(U,null,{default:t(()=>{var r,D;return[i(n(((r=e.author)==null?void 0:r.display_name)||((D=e.author)==null?void 0:D.username)||"未知用户"),1)]}),_:2},1024),l(E,null,{default:t(()=>{var r;return[i("@"+n(((r=e.author)==null?void 0:r.username)||""),1)]}),_:2},1024)]),_:2},1032,["append-avatar"]),l(N,{class:"pt-0"},{default:t(()=>[u("div",Ee,[u("div",Oe,[u("div",Le,[l(y,{size:"16",class:"me-1"},{default:t(()=>[...a[12]||(a[12]=[i("mdi-eye",-1)])]),_:1}),i(" "+n(e.view_count),1)]),u("div",Ge,[l(y,{size:"16",class:"me-1"},{default:t(()=>[...a[13]||(a[13]=[i("mdi-star",-1)])]),_:1}),i(" "+n(e.star_count),1)])]),u("div",null,n(q(e.time)),1)]),e.tags?(o(),c("div",Je,[(o(!0),c(k,null,C(e.tags.split(","),r=>(o(),g(h,{key:r,size:"x-small",variant:"outlined",class:"me-1"},{default:t(()=>[i(n(r.trim()),1)]),_:2},1024))),128))])):b("",!0)]),_:2},1024)]}),_:2},1032,["class","onClick"])]),_:2},1024))),128))]),_:1})),G.value>0?(o(),c("div",Re,[l(xe,{modelValue:A.value,"onUpdate:modelValue":[a[4]||(a[4]=e=>A.value=e),de],length:Math.ceil(G.value/_.limit),"total-visible":7},null,8,["modelValue","length"])])):b("",!0)])]),_:1},8,["cols","order"]),_.multiple&&m.value.length>0?(o(),g(S,{key:0,cols:s.$vuetify.display.mobile?12:4,class:ee({"border-s":!s.$vuetify.display.mobile,"border-b":s.$vuetify.display.mobile}),order:s.$vuetify.display.mobile?1:2},{default:t(()=>[s.$vuetify.display.mobile?(o(),c("div",Qe,[u("div",We,[a[14]||(a[14]=u("div",{class:"text-h6"},"已选择",-1)),l(h,{border:"",size:"small"},{default:t(()=>[i(n(m.value.length),1)]),_:1})]),u("div",Xe,[l(we,{column:""},{default:t(()=>[(o(!0),c(k,null,C(m.value,e=>(o(),g(h,{key:e.id,closable:"",border:"",variant:"text","onClick:close":f=>Y(e.id)},{default:t(()=>[l(K,{start:"",size:"24",class:"me-2"},{default:t(()=>[l(Q,{src:w(V).getUserAvatar(e.author.avatar),cover:""},{placeholder:t(()=>[l(y,{size:"12"},{default:t(()=>[...a[15]||(a[15]=[i("mdi-image",-1)])]),_:1})]),_:1},8,["src"])]),_:2},1024),i(" "+n(e.title),1)]),_:2},1032,["onClick:close"]))),128))]),_:1})]),l(T,{color:"primary",variant:"elevated",block:"",size:"large",onClick:Z},{default:t(()=>[l(y,{start:""},{default:t(()=>[...a[16]||(a[16]=[i("mdi-check",-1)])]),_:1}),i(" 确认选择 ("+n(m.value.length)+") ",1)]),_:1})])):(o(),c("div",Ye,[u("div",Ze,[a[17]||(a[17]=u("div",{class:"text-h6"},"已选择",-1)),l(h,{color:"primary",size:"small"},{default:t(()=>[i(n(m.value.length),1)]),_:1})]),u("div",null,[l(F,null,{default:t(()=>[(o(!0),c(k,null,C(m.value,e=>(o(),g(S,{key:e.id,cols:"12",sm:"6"},{default:t(()=>[l(z,{rounded:"lg",elevation:"2",border:"",hover:""},{default:t(()=>{var f;return[l(z,{rounded:"lg",style:{"aspect-ratio":"4/3"}},{default:t(()=>[l(Q,{src:w(ae)(e.thumbnail),class:"align-end",cover:"",gradient:"to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)",height:"100%","lazy-src":te},{default:t(()=>[l(N,null,{default:t(()=>[l(U,{class:"text-white"},{default:t(()=>[i(n(e.title),1)]),_:2},1024),l(E,{class:"text-white"},{default:t(()=>[i(n(e.description),1)]),_:2},1024)]),_:2},1024),u("div",qe,[l(T,{icon:"",size:"small",variant:"elevated",color:"error",onClick:ke(r=>Y(e.id),["stop"])},{default:t(()=>[l(y,{size:"16"},{default:t(()=>[...a[18]||(a[18]=[i("mdi-close",-1)])]),_:1})]),_:1},8,["onClick"])])]),_:2},1032,["src"])]),_:2},1024),l(N,{"append-avatar":(f=e.author)!=null&&f.avatar?w(V).getUserAvatar(e.author.avatar):""},{append:t(()=>[u("div",He,[l(h,{color:e.state==="public"?"success":"warning",size:"small",variant:"outlined"},{default:t(()=>[i(n(e.state==="public"?"公开":"私有"),1)]),_:2},1032,["color"])])]),default:t(()=>[l(U,null,{default:t(()=>{var r,D;return[i(n(((r=e.author)==null?void 0:r.display_name)||((D=e.author)==null?void 0:D.username)||"未知用户"),1)]}),_:2},1024),l(E,null,{default:t(()=>{var r;return[i("@"+n(((r=e.author)==null?void 0:r.username)||""),1)]}),_:2},1024)]),_:2},1032,["append-avatar"]),l(N,{class:"pt-0"},{default:t(()=>[u("div",Ke,[u("div",je,[u("div",et,[l(y,{size:"16",class:"me-1"},{default:t(()=>[...a[19]||(a[19]=[i("mdi-eye",-1)])]),_:1}),i(" "+n(e.view_count),1)]),u("div",tt,[l(y,{size:"16",class:"me-1"},{default:t(()=>[...a[20]||(a[20]=[i("mdi-star",-1)])]),_:1}),i(" "+n(e.star_count),1)])]),u("div",null,n(q(e.time)),1)]),e.tags?(o(),c("div",at,[(o(!0),c(k,null,C(e.tags.split(","),r=>(o(),g(h,{key:r,size:"x-small",variant:"outlined",class:"me-1"},{default:t(()=>[i(n(r.trim()),1)]),_:2},1024))),128))])):b("",!0)]),_:2},1024)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),l(T,{color:"primary",variant:"elevated",block:"",class:"mt-3",size:"large",onClick:Z},{default:t(()=>[l(y,{start:""},{default:t(()=>[...a[21]||(a[21]=[i("mdi-check",-1)])]),_:1}),i(" 确认选择 ("+n(m.value.length)+") ",1)]),_:1})]))]),_:1},8,["cols","class","order"])):b("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","max-width","fullscreen"])]))}},it=fe(lt,[["__scopeId","data-v-de56f006"]]);export{it as _};
