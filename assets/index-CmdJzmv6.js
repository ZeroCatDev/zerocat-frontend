import{_ as P}from"./ProjectSelector-DIHPXN6z.js";import{_ as v}from"./ProjectCard-CRb-NpNo.js";import{_ as S,a1 as V,ab as y,aa as z,Y as p,o as n,N as t,e as s,W as j,a9 as x,L as r,O as u,a3 as C,aF as B,f as d,c as f,i as _,aE as M,aA as T,Q as g,R as h,F as k,U as b,aU as I,X as m,aW as L,S as N,Z as A,n as R,$ as W,aT as Z,T as H,M as O}from"./index--x0Kpdb3.js";import{V as D}from"./VSpacer-CRogZUDA.js";import{V as Q}from"./VSkeletonLoader-BoPZxw3A.js";import"https://static.geetest.com/v4/gt4.js";const X={name:"ExtensionCreateDialog",components:{ProjectCard:v,ProjectSelector:P},props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","created"],data(){return{formValid:!1,loading:!1,s3BucketUrl:"",myProjects:[],selectedProject:null,scratchCompatible:!1,showProjectSelector:!1}},computed:{dialog:{get(){return this.modelValue},set(l){this.$emit("update:modelValue",l)}}},watch:{modelValue(l){l&&this.resetForm()}},async created(){this.s3BucketUrl=await z("s3.staticurl"),await this.fetchMyProjects()},methods:{async fetchMyProjects(){try{const l=await V.get("/searchapi",{params:{search_userid:y.user.value.id,search_state:"public",limit:100}});l.data&&l.data.projects&&(this.myProjects=l.data.projects)}catch(l){console.error("Failed to fetch my projects:",l)}},selectProject(l){this.selectedProject=l,this.showProjectSelector=!1},async createExtension(){if(this.selectedProject){this.loading=!0;try{const l={projectid:this.selectedProject.id,scratchCompatible:this.scratchCompatible},e=await V.post("/extensions/manager/create",l);e.data.status==="success"?(this.$emit("created"),this.closeDialog(),this.showMessage("扩展创建成功","success")):this.showMessage(e.data.message||"创建失败","error")}catch(l){console.error("Failed to create extension:",l),this.showMessage("创建扩展失败","error")}finally{this.loading=!1}}},resetForm(){this.selectedProject=null,this.scratchCompatible=!1,this.projectSearch=""},closeDialog(){this.dialog=!1},showMessage(l,e){console.log(l)}}},Y={class:"d-flex align-center mb-3"},q={key:0,class:"selected-project"},G={key:1,class:"text-center py-4 text-grey"};function J(l,e,F,U,a,c){const w=v,o=P;return n(),p(T,{modelValue:c.dialog,"onUpdate:modelValue":e[3]||(e[3]=i=>c.dialog=i),"max-width":"600",persistent:""},{default:t(()=>[s(j,null,{default:t(()=>[s(x,{class:"d-flex align-center"},{default:t(()=>[s(u,{class:"mr-2"},{default:t(()=>e[4]||(e[4]=[r("mdi-plus",-1)])),_:1,__:[4]}),e[5]||(e[5]=r(" 创建扩展 ",-1))]),_:1,__:[5]}),s(C,null,{default:t(()=>[s(B,{ref:"form",modelValue:a.formValid,"onUpdate:modelValue":e[1]||(e[1]=i=>a.formValid=i)},{default:t(()=>[s(j,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(x,{class:"text-subtitle-1"},{default:t(()=>e[6]||(e[6]=[r("选择项目",-1)])),_:1,__:[6]}),s(C,null,{default:t(()=>[d("div",Y,[s(_,{class:"ml-2",variant:"tonal",onClick:e[0]||(e[0]=i=>a.showProjectSelector=!0)},{default:t(()=>e[7]||(e[7]=[r(" 选择 ",-1)])),_:1,__:[7]})]),a.selectedProject?(n(),f("div",q,[s(w,{project:a.selectedProject,"show-author":!0,author:a.selectedProject.author},null,8,["project","author"])])):(n(),f("div",G,[s(u,{size:"48"},{default:t(()=>e[8]||(e[8]=[r("mdi-folder-outline",-1)])),_:1,__:[8]}),e[9]||(e[9]=d("p",{class:"mt-2"},"请选择要创建扩展的项目",-1)),e[10]||(e[10]=d("p",{class:"text-caption text-grey"},"扩展将使用项目的默认分支和最新提交",-1))]))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(M,null,{default:t(()=>[s(D),s(_,{onClick:c.closeDialog},{default:t(()=>e[11]||(e[11]=[r("取消",-1)])),_:1,__:[11]},8,["onClick"]),s(_,{color:"primary",loading:a.loading,disabled:!a.selectedProject,onClick:c.createExtension},{default:t(()=>e[12]||(e[12]=[r(" 创建扩展 ",-1)])),_:1,__:[12]},8,["loading","disabled","onClick"])]),_:1})]),_:1}),s(o,{modelValue:a.showProjectSelector,"onUpdate:modelValue":e[2]||(e[2]=i=>a.showProjectSelector=i),projects:a.myProjects,onSelect:c.selectProject},null,8,["modelValue","projects","onSelect"])]),_:1},8,["modelValue"])}const E=S(X,[["render",J],["__scopeId","data-v-5d631e21"]]),K={name:"ExtensionsManagement",components:{ExtensionCreateDialog:E},setup(){O({title:"扩展管理 - ZeroCat"})},data(){return{loading:!1,extensions:[],myProjects:[],s3BucketUrl:"",showCreateDialog:!1,showEditDialog:!1,editFormValid:!1,editLoading:!1,editTarget:null,editForm:{branch:"",commit:"",image:"",samples:null,docs:""},showDeleteDialog:!1,deleteLoading:!1,deleteTarget:null,snackbar:{show:!1,message:"",color:"success"}}},async created(){if(y.isLogin.value===!1){this.$router.push("/app/account/login");return}this.s3BucketUrl=await z("s3.staticurl"),await Promise.all([this.fetchExtensions(),this.fetchMyProjects()])},methods:{async fetchExtensions(){this.loading=!0;try{const l=await V.get("/extensions/manager/my");l.data.status==="success"&&(this.extensions=l.data.data)}catch(l){console.error("Failed to fetch extensions:",l),this.showMessage("扩展管理失败","error")}finally{this.loading=!1}},async fetchMyProjects(){try{console.log(y.user);const l=await V.get("/searchapi",{params:{search_userid:y.user.value.id,search_state:"public",limit:100}});l.data&&l.data.projects&&(this.myProjects=l.data.projects)}catch(l){console.error("Failed to fetch my projects:",l)}},getStatusColor(l){return{developing:"primary",pending:"warning",verified:"success",rejected:"error"}[l]||"grey"},getStatusText(l){return{developing:"开发中",pending:"待审核",verified:"已审核",rejected:"已拒绝"}[l]||"未知"},showMessage(l,e="success"){this.snackbar={show:!0,message:l,color:e}}}},$={class:"d-flex align-center mb-2"},ee={class:"text-caption"},te={class:"d-flex align-center mb-2"},se={class:"text-caption"},le={key:0,class:"d-flex align-center mb-2"},ae={class:"text-caption"},oe={class:"d-flex align-center mb-2"},re={class:"text-caption"};function ie(l,e,F,U,a,c){const w=E;return n(),p(H,null,{default:t(()=>[s(g,null,{default:t(()=>[s(h,{cols:"12"},{default:t(()=>[s(j,{variant:"flat"},{default:t(()=>[s(x,{class:"d-flex align-center"},{default:t(()=>[s(u,{class:"mr-2",color:"primary"},{default:t(()=>e[3]||(e[3]=[r("mdi-puzzle",-1)])),_:1,__:[3]}),e[5]||(e[5]=r(" 扩展管理 ",-1)),s(D),s(_,{color:"success","prepend-icon":"mdi-plus",onClick:e[0]||(e[0]=o=>a.showCreateDialog=!0)},{default:t(()=>e[4]||(e[4]=[r(" 创建扩展 ",-1)])),_:1,__:[4]})]),_:1,__:[5]}),s(C,null,{default:t(()=>[a.loading?(n(),p(g,{key:0},{default:t(()=>[(n(),f(k,null,b(6,o=>s(h,{key:o,cols:"12",md:"6",lg:"4"},{default:t(()=>[s(Q,{type:"card"})]),_:2},1024)),64))]),_:1})):a.extensions.length===0?(n(),p(g,{key:1},{default:t(()=>[s(h,{cols:"12",class:"text-center py-8"},{default:t(()=>[s(u,{size:"64",color:"grey-lighten-1"},{default:t(()=>e[6]||(e[6]=[r("mdi-puzzle-outline",-1)])),_:1,__:[6]}),e[7]||(e[7]=d("p",{class:"text-h6 mt-4 text-grey-darken-1"},"扩展管理",-1)),e[8]||(e[8]=d("p",{class:"text-body-2 text-grey"},"扩展管理",-1))]),_:1,__:[7,8]})]),_:1})):(n(),p(g,{key:2},{default:t(()=>[(n(!0),f(k,null,b(a.extensions,o=>(n(),p(h,{key:o.id,cols:"12",md:"6",lg:"4"},{default:t(()=>[s(j,{class:"extension-card",variant:"tonal",border:"",hover:""},{default:t(()=>[s(I,null,{prepend:t(()=>[s(A,{size:"48"},{default:t(()=>[o.image?(n(),p(R,{key:0,src:a.s3BucketUrl+"/material/asset/"+o.image+".png"},null,8,["src"])):(n(),p(u,{key:1,size:"24"},{default:t(()=>e[9]||(e[9]=[r("mdi-puzzle",-1)])),_:1,__:[9]}))]),_:2},1024)]),append:t(()=>[s(N,{color:c.getStatusColor(o.status),size:"small",variant:"flat"},{default:t(()=>[r(m(c.getStatusText(o.status)),1)]),_:2},1032,["color"])]),default:t(()=>[s(x,null,{default:t(()=>{var i;return[r(m(((i=o.project)==null?void 0:i.title)||"扩展"),1)]}),_:2},1024),s(L,null,{default:t(()=>{var i;return[r(m(((i=o.project)==null?void 0:i.description)||"扩展"),1)]}),_:2},1024)]),_:2},1024),s(C,null,{default:t(()=>{var i;return[d("div",$,[s(u,{class:"mr-1",size:"small"},{default:t(()=>e[10]||(e[10]=[r("mdi-source-branch",-1)])),_:1,__:[10]}),d("span",ee,m(o.branch||"main"),1)]),d("div",te,[s(u,{class:"mr-1",size:"small"},{default:t(()=>e[11]||(e[11]=[r("mdi-source-commit",-1)])),_:1,__:[11]}),d("span",se,m(((i=o.commit)==null?void 0:i.substring(0,8))||"latest"),1)]),o.sample_project?(n(),f("div",le,[s(u,{class:"mr-1",size:"small"},{default:t(()=>e[12]||(e[12]=[r("mdi-file-document",-1)])),_:1,__:[12]}),d("span",ae,"示例项目: "+m(o.sample_project.title),1)])):W("",!0),d("div",oe,[s(u,{class:"mr-1",size:"small"},{default:t(()=>e[13]||(e[13]=[r("mdi-puzzle",-1)])),_:1,__:[13]}),d("span",re,m(o.scratchCompatible?"兼容原版Scratch":"不兼容原版Scratch"),1)])]}),_:2},1024),s(M,null,{default:t(()=>[s(_,{variant:"text",size:"small",to:`/app/extensions/my/${o.id}`},{default:t(()=>e[14]||(e[14]=[r(" 查看详情 ",-1)])),_:2,__:[14]},1032,["to"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1}),s(w,{modelValue:a.showCreateDialog,"onUpdate:modelValue":e[1]||(e[1]=o=>a.showCreateDialog=o),onCreated:c.fetchExtensions},null,8,["modelValue","onCreated"]),s(Z,{modelValue:a.snackbar.show,"onUpdate:modelValue":e[2]||(e[2]=o=>a.snackbar.show=o),color:a.snackbar.color},{default:t(()=>[r(m(a.snackbar.message),1)]),_:1},8,["modelValue","color"])]),_:1})}const fe=S(K,[["render",ie],["__scopeId","data-v-6dce7427"]]);export{fe as default};
