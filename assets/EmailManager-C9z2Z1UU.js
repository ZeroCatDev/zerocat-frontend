import{r as s,w as K,a5 as h,X as _,o as c,M as l,e as a,Y as F,ae as U,L as r,T as w,a8 as $,f as d,$ as D,aG as A,aa as Y,aJ as L,N as z,i as V,aF as I,aZ as ee,b as le,c as W,F as ae,W as te,S as X,aK as ue,aI as se,bh as oe,bi as ne,bj as re,bk as ie}from"./index-BDhe8qj9.js";import{V as de}from"./VTable-CE8AJCsV.js";const ve={__name:"verifyEmail",props:{modelValue:Boolean,email:{type:String,required:!0},title:{type:String,default:"验证邮箱"}},emits:["update:modelValue","verified"],setup(S,{expose:B,emit:q}){const k=S,x=q,m=s(k.modelValue),p=s(""),o=s(""),f=s("info"),C=s(!1),y={required:n=>!!n||"此字段为必填项",length:n=>(n==null?void 0:n.length)===6||"验证码必须是6位数字"};K(()=>m.value,n=>{x("update:modelValue",n),n&&g()}),K(()=>k.modelValue,n=>{m.value=n});const g=async()=>{var n,i;o.value="",C.value=!0;try{const v=await h.post("/account/send-verification-code",{email:k.email});v.data.status==="success"?(o.value="验证码已发送",f.value="success"):(o.value=v.data.message,f.value="error")}catch(v){o.value=((i=(n=v.response)==null?void 0:n.data)==null?void 0:i.message)||"发送验证码失败",f.value="error"}finally{C.value=!1}},E=()=>{if(!p.value||p.value.length!==6){o.value="请输入6位验证码",f.value="error";return}x("verified",p.value),b()},b=()=>{m.value=!1,p.value="",o.value=""};return B({sendCode:g}),(n,i)=>(c(),_(I,{modelValue:m.value,"onUpdate:modelValue":i[1]||(i[1]=v=>m.value=v),"max-width":"400px"},{default:l(()=>[a(F,null,{default:l(()=>[a(U,null,{default:l(()=>[r(w(S.title),1)]),_:1}),a($,null,{default:l(()=>[d("p",null,"验证码将发送到邮箱 "+w(S.email),1),a(A,{modelValue:p.value,"onUpdate:modelValue":i[0]||(i[0]=v=>p.value=v),rules:[y.required,y.length],class:"mt-4",label:"验证码",maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"]),o.value?(c(),_(Y,{key:0,type:f.value,class:"mt-3",variant:"tonal"},{default:l(()=>[r(w(o.value),1)]),_:1},8,["type"])):D("",!0)]),_:1}),a(L,null,{default:l(()=>[a(z),a(V,{color:"grey",variant:"text",onClick:b},{default:l(()=>i[2]||(i[2]=[r("取消",-1)])),_:1,__:[2]}),a(V,{loading:C.value,color:"primary",onClick:E},{default:l(()=>i[3]||(i[3]=[r(" 确认 ",-1)])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},ce={__name:"EmailManager",setup(S,{expose:B}){const q=ee(),k=s([]),x=s(!1),m=s(!1),p=s(!1),o=s(!1),f=s(""),C=s(""),y=s(null),g=s(""),E=s("info"),b=s(!1),n=s(""),i=s(""),v=s(null),N=s(null),M={required:t=>!!t||"此字段为必填项",email:t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||"请输入有效的邮箱地址",length:t=>(t==null?void 0:t.length)===6||"验证码必须是6位数字"},T=async()=>{try{const t=await oe();t.status==="success"&&(k.value=t.data)}catch(t){console.error("获取邮箱列表失败:",t)}},Z=(t,e,u)=>{n.value=t,i.value=e,v.value=u,b.value=!0},H=t=>{v.value&&(v.value(t),v.value=null)},j=async()=>{if(f.value){o.value=!0;try{const t=await q.requireSudo({title:"添加邮箱",subtitle:"您正在尝试添加新的邮箱地址。此操作需要验证您的身份。",persistent:!0}),e=await ne(f.value,null,t);e.status==="success"?(await T(),G()):(g.value=e.message,E.value="error")}catch(t){t.type!=="cancel"&&(g.value="添加邮箱失败",E.value="error")}finally{o.value=!1}}},O=t=>{y.value=t,m.value=!0},P=async()=>{if(y.value){o.value=!0;try{const t=await q.requireSudo({title:"删除邮箱",subtitle:`您正在尝试删除邮箱 ${y.value.contact_value}。此操作需要验证您的身份。`,persistent:!0});(await re(y.value.contact_value,t)).status==="success"&&(await T(),J())}catch(t){t.type!=="cancel"&&console.error("删除失败:",t)}finally{o.value=!1}}},G=()=>{x.value=!1,p.value=!1,f.value="",C.value="",g.value="",N.value&&N.value.reset()},J=()=>{m.value=!1,y.value=null},Q=t=>{Z(t,"验证邮箱",async e=>{o.value=!0;try{(await ie(t,e)).status==="success"&&await T()}catch(u){console.error("验证失败:",u)}finally{o.value=!1}})};return le(async()=>{await T()}),B({fetchEmails:T}),(t,e)=>(c(),_(F,{class:"mb-4"},{default:l(()=>[a(U,{class:"d-flex align-center justify-space-between"},{default:l(()=>[e[7]||(e[7]=d("span",null,"邮箱管理",-1)),a(V,{disabled:k.value.length>=5,color:"primary",onClick:e[0]||(e[0]=u=>x.value=!0)},{default:l(()=>e[6]||(e[6]=[r(" 添加邮箱 ",-1)])),_:1,__:[6]},8,["disabled"])]),_:1,__:[7]}),a($,null,{default:l(()=>[a(de,null,{default:l(()=>[e[11]||(e[11]=d("thead",null,[d("tr",null,[d("th",null,"邮箱地址"),d("th",null,"状态"),d("th",null,"添加时间"),d("th",null,"操作")])],-1)),d("tbody",null,[(c(!0),W(ae,null,te(k.value,u=>(c(),W("tr",{key:u.contact_id},[d("td",null,[r(w(u.contact_value)+" ",1),u.is_primary?(c(),_(X,{key:0,class:"ml-2",color:"primary",size:"small"},{default:l(()=>e[8]||(e[8]=[r("主邮箱",-1)])),_:1,__:[8]})):D("",!0)]),d("td",null,[a(X,{color:u.verified?"success":"warning",size:"small"},{default:l(()=>[r(w(u.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),d("td",null,w(new Date(u.created_at).toLocaleString()),1),d("td",null,[u.verified?D("",!0):(c(),_(V,{key:0,color:"primary",size:"small",variant:"text",onClick:R=>Q(u.contact_value)},{default:l(()=>e[9]||(e[9]=[r(" 验证 ",-1)])),_:2,__:[9]},1032,["onClick"])),u.is_primary?D("",!0):(c(),_(V,{key:1,color:"error",size:"small",variant:"text",onClick:R=>O(u)},{default:l(()=>e[10]||(e[10]=[r(" 删除 ",-1)])),_:2,__:[10]},1032,["onClick"]))])]))),128))])]),_:1,__:[11]})]),_:1}),a(I,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=u=>x.value=u),"max-width":"500px"},{default:l(()=>[a(F,null,{default:l(()=>[a(U,null,{default:l(()=>e[12]||(e[12]=[r("添加新邮箱",-1)])),_:1,__:[12]}),a($,null,{default:l(()=>[a(ue,{ref_key:"addForm",ref:N,onSubmit:se(j,["prevent"])},{default:l(()=>[a(A,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=u=>f.value=u),rules:[M.required,M.email],label:"新邮箱地址",variant:"outlined"},null,8,["modelValue","rules"]),p.value?(c(),_(A,{key:0,modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=u=>C.value=u),rules:[M.required,M.length],label:"主邮箱验证码",maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):D("",!0),g.value?(c(),_(Y,{key:1,type:E.value,class:"mt-3",variant:"tonal"},{default:l(()=>[r(w(g.value),1)]),_:1},8,["type"])):D("",!0)]),_:1},512)]),_:1}),a(L,null,{default:l(()=>[a(z),a(V,{color:"grey",variant:"text",onClick:G},{default:l(()=>e[13]||(e[13]=[r("取消",-1)])),_:1,__:[13]}),a(V,{loading:o.value,color:"primary",onClick:j},{default:l(()=>e[14]||(e[14]=[r(" 添加 ",-1)])),_:1,__:[14]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(I,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=u=>m.value=u),"max-width":"500px"},{default:l(()=>[a(F,null,{default:l(()=>[a(U,null,{default:l(()=>e[15]||(e[15]=[r("删除邮箱",-1)])),_:1,__:[15]}),a($,null,{default:l(()=>{var u;return[d("p",null,"确认要删除邮箱 "+w((u=y.value)==null?void 0:u.contact_value)+" 吗？",1)]}),_:1}),a(L,null,{default:l(()=>[a(z),a(V,{color:"grey",variant:"text",onClick:J},{default:l(()=>e[16]||(e[16]=[r("取消",-1)])),_:1,__:[16]}),a(V,{loading:o.value,color:"error",onClick:P},{default:l(()=>e[17]||(e[17]=[r(" 删除 ",-1)])),_:1,__:[17]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ve,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=u=>b.value=u),email:n.value,title:i.value,onVerified:H},null,8,["modelValue","email","title"])]),_:1}))}};export{ce as _};
