import{_ as q,bK as A,bg as O,af as Z,ag as K,c as u,o as n,e as c,f as t,M as i,F as g,W as S,X as y,$ as k,T as o,S as f,L as m,Y as j,a8 as x,O as b,Z as W,i as X}from"./index-BosUQXtR.js";import{a as Y,V as G}from"./VTimeline-1EBh-hDI.js";const H={name:"Timeline",props:{timeline:{type:Object,required:!0,default:()=>({events:[],pagination:{current:1,size:20,total:0}})},isLoadingMore:{type:Boolean,default:!1},username:{type:String,required:!0}},data(){return{localuser:Z,events:[],loading:!1,error:null,page:1,hasMore:!0,s3BucketUrl:"",projectInfoMap:new Map,eventTypes:{project_create:{text:"创建了新项目",label:"新建",color:"success",isProject:!0},project_publish:{text:"更新了项目",label:"更新",color:"info",isProject:!0},project_fork:{text:"复刻了项目",label:"复刻",color:"warning",isProject:!0},project_delete:{text:"删除了项目",label:"删除",color:"error",isProject:!0},project_star:{text:"给项目点了星标",label:"星标",color:"primary",isProject:!0},user_profile_update:{text:"更新了个人资料",label:"更新",color:"info"},user_register:{text:"加入了 ZeroCat",label:"注册",color:"primary"},project_commit:{text:"提交了项目更新",label:"提交",color:"info",isProject:!0},project_rename:{text:"重命名了项目",label:"重命名",color:"warning",isProject:!0},project_info_update:{text:"更新了项目信息",label:"更新信息",color:"info",isProject:!0}},fieldDisplayNames:{display_name:"昵称",bio:"个性签名",sex:"性别",birthday:"生日",avatar:"头像",background:"背景图片",email:"邮箱",phone:"手机号",website:"个人网站",social_links:"社交链接",preferences:"偏好设置",visibility:"可见性设置",language:"语言设置"}}},async mounted(){this.s3BucketUrl=O("s3.staticurl"),this.timeline.events.length>0&&await this.fetchProjectInfoForEvents(this.timeline.events)},watch:{"timeline.events":{immediate:!0,async handler(s){s.length>0&&await this.fetchProjectInfoForEvents(s)}}},computed:{hasMoreEvents(){return this.timeline.events.length<this.timeline.pagination.total}},methods:{async fetchProjectInfoForEvents(s){const a=s.filter(p=>{var v;return((v=p.target)==null?void 0:v.type)==="project"}).map(p=>p.target.id);a.length>0&&await this.fetchProjectInfo(a)},async fetchProjectInfo(s){try{(await A(s)).forEach(p=>{this.projectInfoMap.set(p.id,p)})}catch(a){console.error("Error fetching project info:",a)}},getProjectLink(s){if(!s)return"";const a=this.projectInfoMap.get(s);return a?`/${a.author.username}/${a.name||a.id}`:`/project/${s}`},loadMore(){this.$emit("load-more")},getUpdatedFields(s){return s!=null&&s.length?s.map(a=>this.fieldDisplayNames[a]||a).join("、"):""},getTargetContent(s,a){if(!s)return"";switch(s.type){case"project":return s.title||`项目 #${s.id}`;case"user":return s.display_name||`用户 #${s.id}`;case"projectlist":return`项目列表 #${s.id}`;default:return`${s.type} #${s.id}`}},getFieldDisplayName(s){return{title:"标题",description:"描述",type:"类型",state:"状态",visibility:"可见性",tags:"标签",category:"分类"}[s]||s}}},J={class:"timeline-item-content"},Q={class:"event-header"},R={class:"text-h6"},$={class:"project-info"},ee={class:"font-weight-medium"},te={class:"mt-2 text-caption text-medium-emphasis"},se={class:"d-flex align-center mb-2"},ae={class:"font-weight-medium"},oe={class:"rename-details text-body-2"},ie={class:"d-flex align-center"},re={class:"d-flex align-center mt-1"},le={class:"project-meta text-caption text-medium-emphasis mt-2"},ce={class:"d-flex align-center mb-2"},ne={class:"font-weight-medium"},de={class:"commit-message text-body-2"},me={class:"commit-hash text-caption text-medium-emphasis mt-1"},_e={class:"d-flex align-center mb-2"},pe={class:"font-weight-medium"},ue={class:"info-updates text-body-2"},fe={class:"d-flex align-center"},he={class:"d-flex flex-column mt-1 field-changes"},ye={class:"old-value"},ge={class:"ml-2"},je={class:"new-value"},xe={class:"ml-2 text-info"},be={class:"project-meta text-caption text-medium-emphasis mt-2"},ve={key:3,class:"event-content pa-2"},ke={key:0,class:"text-body-2"},Pe={key:1,class:"text-body-2"},we={key:2,class:"text-body-2 text-medium-emphasis"},Te={class:"d-flex justify-center mt-4 mb-4"},Ve={key:1,class:"text-medium-emphasis"};function Ie(s,a,p,v,h,_){const P=K("router-link");return n(),u(g,null,[c(G,{align:"start",class:"mt-4",side:"end"},{default:i(()=>[(n(!0),u(g,null,S(p.timeline.events,e=>(n(),y(Y,{key:e.id,"dot-color":"primary",size:"small"},{opposite:i(()=>[m(o(new Date(e.created_at).toLocaleString()),1)]),icon:i(()=>[c(W,{image:h.localuser.getUserAvatar(e.actor.avatar)},null,8,["image"])]),default:i(()=>{var w,T,V,I,L,M,C,z,N,F,B,D;return[t("div",J,[t("div",Q,[t("h3",R,o(e.actor.display_name)+" "+o(((w=h.eventTypes[e.type])==null?void 0:w.text)||"进行了操作"),1),c(f,{color:((T=h.eventTypes[e.type])==null?void 0:T.color)||"primary",class:"ml-2",size:"x-small"},{default:i(()=>{var r;return[m(o(((r=h.eventTypes[e.type])==null?void 0:r.label)||e.type),1)]}),_:2},1032,["color"])]),(V=h.eventTypes[e.type])!=null&&V.isProject?(n(),y(P,{key:0,to:_.getProjectLink((I=e.target)==null?void 0:I.id),class:"text-decoration-none"},{default:i(()=>{var r;return[m(o((r=e.event_data)==null?void 0:r.project_title),1)]}),_:2},1032,["to"])):k("",!0),a[4]||(a[4]=t("div",{class:"mb-2"},null,-1)),(L=h.eventTypes[e.type])!=null&&L.isProject&&!["project_rename","project_commit"].includes(e.type)?(n(),y(j,{key:1,to:_.getProjectLink((M=e.target)==null?void 0:M.id),class:"mb-3 project-event"},{default:i(()=>[c(x,null,{default:i(()=>{var r,l;return[t("div",$,[c(b,{class:"mr-2",color:"primary",icon:"mdi-source-repository"}),t("span",ee,o(((r=e.event_data)==null?void 0:r.project_name)||"未命名项目"),1),t("div",te,o((l=e.event_data)==null?void 0:l.project_description),1)])]}),_:2},1024)]),_:2},1032,["to"])):["project_rename","project_commit","project_info_update"].includes(e.type)?(n(),u(g,{key:2},[e.type==="project_rename"?(n(),y(j,{key:0,to:_.getProjectLink((C=e.target)==null?void 0:C.id),class:"rename-card mb-3"},{default:i(()=>[c(x,null,{default:i(()=>{var r;return[t("div",se,[c(b,{class:"mr-2",color:"warning",icon:"mdi-rename-box"}),t("span",ae,o((r=e.event_data)==null?void 0:r.project_title),1)]),t("div",oe,[t("div",ie,[a[0]||(a[0]=t("span",{class:"text-medium-emphasis"},"从",-1)),c(f,{class:"mx-2",color:"surface-variant",size:"small"},{default:i(()=>{var l;return[m(o((l=e.event_data)==null?void 0:l.old_name),1)]}),_:2},1024)]),t("div",re,[a[1]||(a[1]=t("span",{class:"text-medium-emphasis"},"到",-1)),c(f,{class:"mx-2",color:"warning",size:"small"},{default:i(()=>{var l;return[m(o((l=e.event_data)==null?void 0:l.new_name),1)]}),_:2},1024)])]),t("div",le,[c(f,{class:"mr-1",size:"x-small"},{default:i(()=>{var l;return[m(o((l=e.event_data)==null?void 0:l.project_type),1)]}),_:2},1024),c(f,{size:"x-small"},{default:i(()=>{var l;return[m(o((l=e.event_data)==null?void 0:l.project_state),1)]}),_:2},1024)])]}),_:2},1024)]),_:2},1032,["to"])):e.type==="project_commit"?(n(),y(j,{key:1,to:_.getProjectLink((z=e.target)==null?void 0:z.id),class:"commit-card mb-3"},{default:i(()=>[c(x,null,{default:i(()=>{var r,l,d;return[t("div",ce,[c(b,{class:"mr-2",color:"info",icon:"mdi-source-commit"}),t("span",ne,"分支: "+o((r=e.event_data)==null?void 0:r.branch),1)]),t("div",de,o((l=e.event_data)==null?void 0:l.commit_message),1),t("div",me," 提交ID: "+o((d=e.event_data)==null?void 0:d.commit_id.substring(0,7)),1)]}),_:2},1024)]),_:2},1032,["to"])):e.type==="project_info_update"?(n(),y(j,{key:2,to:_.getProjectLink((N=e.target)==null?void 0:N.id),class:"info-update-card mb-3"},{default:i(()=>[c(x,null,{default:i(()=>{var r,l;return[t("div",_e,[c(b,{class:"mr-2",color:"info",icon:"mdi-file-document-edit"}),t("span",pe,o((r=e.event_data)==null?void 0:r.project_title),1)]),t("div",ue,[(n(!0),u(g,null,S((l=e.event_data)==null?void 0:l.updated_fields,d=>{var E,U;return n(),u("div",{key:d,class:"update-item mb-2"},[t("div",fe,[c(f,{class:"mr-2",color:"info",size:"x-small"},{default:i(()=>[m(o(_.getFieldDisplayName(d)),1)]),_:2},1024)]),t("div",he,[t("div",ye,[a[2]||(a[2]=t("span",{class:"text-medium-emphasis"},"从：",-1)),t("span",ge,o((E=e.event_data)==null?void 0:E.old_values[d]),1)]),t("div",je,[a[3]||(a[3]=t("span",{class:"text-medium-emphasis"},"到：",-1)),t("span",xe,o((U=e.event_data)==null?void 0:U.new_values[d]),1)])])])}),128))]),t("div",be,[c(f,{class:"mr-1",size:"x-small"},{default:i(()=>{var d;return[m(o((d=e.event_data)==null?void 0:d.project_type),1)]}),_:2},1024),c(f,{size:"x-small"},{default:i(()=>{var d;return[m(o((d=e.event_data)==null?void 0:d.project_state),1)]}),_:2},1024)])]}),_:2},1024)]),_:2},1032,["to"])):k("",!0)],64)):(n(),u("div",ve,[e.type==="user_profile_update"?(n(),u("div",ke," 更新了："+o(_.getUpdatedFields((F=e.event_data)==null?void 0:F.updated_fields)),1)):((B=e.target)==null?void 0:B.type)==="project"?(n(),u("div",Pe,[t("span",null,o(((D=h.eventTypes[e.type])==null?void 0:D.text)||"操作了"),1),c(P,{to:_.getProjectLink(e.target.id),class:"text-decoration-none ml-1"},{default:i(()=>{var r;return[m(o(((r=e.event_data)==null?void 0:r.project_name)||e.target.title||`项目 #${e.target.id}`),1)]}),_:2},1032,["to"])])):(n(),u("div",we,o(_.getTargetContent(e.target,e.type)),1))]))])]}),_:2},1024))),128))]),_:1}),t("div",Te,[_.hasMoreEvents?(n(),y(X,{key:0,loading:p.isLoadingMore,variant:"tonal",onClick:_.loadMore},{default:i(()=>a[5]||(a[5]=[m(" 加载更多 ",-1)])),_:1,__:[5]},8,["loading","onClick"])):p.timeline.events.length>0?(n(),u("div",Ve," 没有更多内容了 ")):k("",!0)])],64)}const Ce=q(H,[["render",Ie],["__scopeId","data-v-1c581644"]]);export{Ce as _};
