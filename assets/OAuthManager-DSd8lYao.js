import{_ as re,aZ as de,r as v,x as ie,b as fe,ag as _e,c as T,o as c,e as a,M as t,ae as $,f as d,O as g,L as l,a8 as D,X as V,$ as I,Q as j,F,W as q,R as J,Y as O,Z as Q,T as r,S as N,aa as R,ah as me,ai as k,ak as x,aj as b,aJ as W,N as Y,i as L,aF as G,C as ve,a5 as B,af as H,bs as P}from"./index-B0FU96U5.js";const ce={class:"oauth-binding"},pe={class:"d-flex align-center mb-2"},ye={class:"text-h6"},ge={class:"text-caption"},ke={class:"mt-2 text-caption"},xe={__name:"OAuthManager",setup(be){const K=de(),U=v([]),f=v(""),m=v("info");v(!1);const C=v(!1),h=v(""),o=v(null),X=v([]),ee="https://zerocat-api.houlangs.com",w=v(!1),z=v(!1),M=n=>{var s;const e=n.replace("oauth_","").toLowerCase();return((s=P[e])==null?void 0:s.icon)||P.default.icon},S=n=>{var s;const e=n.replace("oauth_","").toLowerCase();return((s=P[e])==null?void 0:s.name)||e.charAt(0).toUpperCase()+e.slice(1)},A=n=>{var e;return((e=P[n])==null?void 0:e.style)||P.default.style},E=n=>{const e=new Date(n);return new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e)},Z=async()=>{var n,e;try{const s=await B.post("/account/oauth/bound",{userid:H.user.value.id});s.data.status==="success"?U.value=s.data.data:(f.value=s.data.message,m.value="error")}catch(s){f.value=((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.message)||"获取绑定的 OAuth 账号失败",m.value="error"}},te=async()=>{var n,e;try{const s=await B.get("/account/emails");if(s.data.status==="success"){const i=s.data.data.find(p=>p.is_primary);i&&(h.value=i.contact_value)}else f.value=s.data.message,m.value="error"}catch(s){f.value=((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.message)||"获取邮箱列表失败",m.value="error"}},ae=async()=>{var n,e;try{const s=await B.get("/account/oauth/providers");s.data.status==="success"?X.value=s.data.data:(f.value=s.data.message,m.value="error")}catch(s){f.value=((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.message)||"获取可绑定的 OAuth 提供商失败",m.value="error"}},le=n=>{o.value=n,w.value=!0},se=()=>{w.value=!1,C.value=!0},ue=async()=>{var n,e;if(o.value){z.value=!0;try{const s=await K.requireSudo({title:"解绑 OAuth 账号",subtitle:`您正在尝试解绑 ${S(o.value.contact_type)} 账号。此操作需要验证您的身份。`,persistent:!0}),u=await B.post("/account/unlink-oauth",{provider:o.value.contact_type},{headers:{"X-Sudo-Token":s}});u.data.status==="success"?(f.value="成功解绑 OAuth 账号",m.value="success",Z(),C.value=!1):(f.value=u.data.message||"解绑失败",m.value="error")}catch(s){s.type!=="cancel"&&(f.value=((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.message)||"解绑 OAuth 账号失败",m.value="error")}finally{z.value=!1,o.value=null}}},oe=n=>{window.location.href=`${ee}/account/oauth/bind/${n}?token=${H.getToken()}`},ne=ie(()=>{const n=U.value.map(e=>e.contact_type.toLowerCase().replace("oauth_",""));return X.value.filter(e=>!n.includes(e.id.toLowerCase()))});return fe(()=>{Z(),te(),ae()}),(n,e)=>{const s=_e("v-list-item-content");return c(),T("div",ce,[a(O,null,{default:t(()=>[a($,{class:"d-flex align-center"},{default:t(()=>[a(g,{class:"mr-2"},{default:t(()=>e[4]||(e[4]=[l("mdi-link-variant",-1)])),_:1,__:[4]}),e[5]||(e[5]=d("h2",null,"已绑定的 OAuth 账号",-1))]),_:1,__:[5]}),a(D,null,{default:t(()=>[a(j,null,{default:t(()=>[(c(!0),T(F,null,q(U.value,(u,i)=>(c(),V(J,{key:i,cols:"12",md:"4",sm:"6"},{default:t(()=>[a(O,{class:"oauth-account-card",elevation:"2",onClick:p=>le(u)},{default:t(()=>[a(D,null,{default:t(()=>[d("div",pe,[a(Q,{color:A(u.contact_type.replace("oauth_","")).backgroundColor,class:"mr-3",size:"40"},{default:t(()=>[a(g,{color:A(u.contact_type.replace("oauth_","")).color},{default:t(()=>[l(r(M(u.contact_type)),1)]),_:2},1032,["color"])]),_:2},1032,["color"]),d("div",null,[d("div",ye,r(S(u.contact_type)),1),d("div",ge,"ID: "+r(u.contact_id),1)])]),a(N,{color:u.verified?"success":"warning",class:"mr-2",small:""},{default:t(()=>[l(r(u.verified?"已验证":"未验证"),1)]),_:2},1032,["color"]),a(N,{color:u.is_primary?"primary":"grey",class:"mr-2",small:""},{default:t(()=>[l(r(u.is_primary?"主账号":"关联账号"),1)]),_:2},1032,["color"]),d("div",ke," 绑定时间: "+r(E(u.created_at)),1)]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1}),f.value?(c(),V(R,{key:0,type:m.value,class:"mt-4"},{default:t(()=>[l(r(f.value),1)]),_:1},8,["type"])):I("",!0)]),_:1})]),_:1}),a(G,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=u=>w.value=u),"max-width":"500"},{default:t(()=>[a(O,null,{default:t(()=>[a($,{class:"headline d-flex align-center"},{default:t(()=>{var u,i;return[a(Q,{color:A(((i=(u=o.value)==null?void 0:u.contact_type)==null?void 0:i.replace("oauth_",""))||"").backgroundColor,class:"mr-3",size:"40"},{default:t(()=>{var p,_;return[a(g,{color:A(((_=(p=o.value)==null?void 0:p.contact_type)==null?void 0:_.replace("oauth_",""))||"").color},{default:t(()=>{var y;return[l(r(M(((y=o.value)==null?void 0:y.contact_type)||"")),1)]}),_:1},8,["color"])]}),_:1},8,["color"]),l(" "+r(o.value?S(o.value.contact_type):"")+" 账号详情 ",1)]}),_:1}),a(D,null,{default:t(()=>[a(me,{dense:""},{default:t(()=>{var u,i,p;return[a(k,null,{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[6]||(e[6]=[l("绑定 ID",-1)])),_:1,__:[6]}),a(b,null,{default:t(()=>{var _;return[l(r(((_=o.value)==null?void 0:_.contact_id)||"-"),1)]}),_:1})]),_:1})]),_:1}),(u=o.value)!=null&&u.metadata?(c(),V(k,{key:0},{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[7]||(e[7]=[l("平台用户 ID",-1)])),_:1,__:[7]}),a(b,null,{default:t(()=>[l(r(o.value.metadata.id||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),(i=o.value)!=null&&i.metadata?(c(),V(k,{key:1},{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[8]||(e[8]=[l("用户名",-1)])),_:1,__:[8]}),a(b,null,{default:t(()=>[l(r(o.value.metadata.name||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),(p=o.value)!=null&&p.metadata?(c(),V(k,{key:2},{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[9]||(e[9]=[l("邮箱",-1)])),_:1,__:[9]}),a(b,null,{default:t(()=>[l(r(o.value.metadata.email||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),a(k,null,{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[10]||(e[10]=[l("验证状态",-1)])),_:1,__:[10]}),a(b,null,{default:t(()=>{var _;return[a(N,{color:(_=o.value)!=null&&_.verified?"success":"warning",small:""},{default:t(()=>{var y;return[l(r((y=o.value)!=null&&y.verified?"已验证":"未验证"),1)]}),_:1},8,["color"])]}),_:1})]),_:1})]),_:1}),a(k,null,{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[11]||(e[11]=[l("账号类型",-1)])),_:1,__:[11]}),a(b,null,{default:t(()=>{var _;return[a(N,{color:(_=o.value)!=null&&_.is_primary?"primary":"grey",small:""},{default:t(()=>{var y;return[l(r((y=o.value)!=null&&y.is_primary?"主账号":"关联账号"),1)]}),_:1},8,["color"])]}),_:1})]),_:1})]),_:1}),a(k,null,{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[12]||(e[12]=[l("绑定时间",-1)])),_:1,__:[12]}),a(b,null,{default:t(()=>[l(r(o.value?E(o.value.created_at):"-"),1)]),_:1})]),_:1})]),_:1}),a(k,null,{default:t(()=>[a(s,null,{default:t(()=>[a(x,{class:"text--primary mb-1"},{default:t(()=>e[13]||(e[13]=[l("最后更新",-1)])),_:1,__:[13]}),a(b,null,{default:t(()=>[l(r(o.value?E(o.value.updated_at):"-"),1)]),_:1})]),_:1})]),_:1})]}),_:1})]),_:1}),a(W,null,{default:t(()=>[a(Y),a(L,{text:"",onClick:e[0]||(e[0]=u=>w.value=!1)},{default:t(()=>e[14]||(e[14]=[l("关闭",-1)])),_:1,__:[14]}),a(L,{disabled:!o.value,color:"error",text:"",onClick:se},{default:t(()=>[a(g,{left:""},{default:t(()=>e[15]||(e[15]=[l("mdi-link-variant-off",-1)])),_:1,__:[15]}),e[16]||(e[16]=l(" 解除绑定 ",-1))]),_:1,__:[16]},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(G,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=u=>C.value=u),"max-width":"500"},{default:t(()=>[a(O,null,{default:t(()=>[a($,{class:"headline"},{default:t(()=>[a(g,{color:"warning",left:""},{default:t(()=>e[17]||(e[17]=[l("mdi-alert",-1)])),_:1,__:[17]}),e[18]||(e[18]=l(" 确认解除绑定 ",-1))]),_:1,__:[18]}),a(D,null,{default:t(()=>[e[26]||(e[26]=d("p",{class:"mb-2"},"您确定要解除以下 OAuth 账号的绑定吗？",-1)),a(R,{dense:"",text:"",type:"warning"},{default:t(()=>{var u,i;return[e[22]||(e[22]=d("strong",null,"提供商：",-1)),l(r(o.value?S(o.value.contact_type):""),1),e[23]||(e[23]=d("br",null,null,-1)),e[24]||(e[24]=d("strong",null,"绑定 ID：",-1)),l(r(((u=o.value)==null?void 0:u.contact_id)||"-"),1),e[25]||(e[25]=d("br",null,null,-1)),(i=o.value)!=null&&i.metadata?(c(),T(F,{key:0},[e[19]||(e[19]=d("strong",null,"用户名：",-1)),l(r(o.value.metadata.name||"-"),1),e[20]||(e[20]=d("br",null,null,-1)),e[21]||(e[21]=d("strong",null,"平台邮箱：",-1)),l(r(o.value.metadata.email||"-"),1)],64)):I("",!0)]}),_:1,__:[22,23,24,25]}),e[27]||(e[27]=d("p",{class:"mt-2 text-caption"},"解除绑定后，您需要重新进行身份验证才能重新绑定此账号。",-1))]),_:1,__:[26,27]}),a(W,null,{default:t(()=>[a(Y),a(L,{text:"",onClick:e[2]||(e[2]=u=>C.value=!1)},{default:t(()=>e[28]||(e[28]=[l("取消",-1)])),_:1,__:[28]}),a(L,{loading:z.value,color:"error",onClick:ue},{default:t(()=>[a(g,{left:""},{default:t(()=>e[29]||(e[29]=[l("mdi-link-variant-off",-1)])),_:1,__:[29]}),e[30]||(e[30]=l(" 确认解除绑定 ",-1))]),_:1,__:[30]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(O,{class:"mt-4"},{default:t(()=>[a($,{class:"d-flex align-center"},{default:t(()=>[a(g,{class:"mr-2"},{default:t(()=>e[31]||(e[31]=[l("mdi-link-plus",-1)])),_:1,__:[31]}),e[32]||(e[32]=d("h2",null,"可绑定的 OAuth 提供商",-1))]),_:1,__:[32]}),a(D,null,{default:t(()=>[a(R,{text:"",type:"info"},{default:t(()=>e[33]||(e[33]=[l(" 不论怎样，你都需要确保对绑定账户内邮箱完全的控制。 ",-1)])),_:1,__:[33]}),a(j,{class:"mt-2"},{default:t(()=>[(c(!0),T(F,null,q(ne.value,(u,i)=>(c(),V(J,{key:i,cols:"12",md:"4",sm:"6"},{default:t(()=>[a(L,{style:ve(A(u.id)),block:"",class:"text-none",height:"50",onClick:p=>oe(u.id)},{default:t(()=>[a(g,{left:""},{default:t(()=>[l(r(M(u.id)),1)]),_:2},1024),l(" 绑定 "+r(u.name),1)]),_:2},1032,["style","onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})])}}},Ce=re(xe,[["__scopeId","data-v-245c0e87"]]);export{Ce as _};
