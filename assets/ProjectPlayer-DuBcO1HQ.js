import{_ as N}from"./UserRelationControls-BqLHlELf.js";import{_ as V,aa as D,ab as J,Y as f,o as l,N as s,e as r,aN as q,aO as K,a9 as E,L as n,X as d,aP as R,Z as A,n as O,W as _,a1 as $,i as u,O as S,a0 as b,az as ee,$ as y,j as te,ad as re,c as h,F as j,U as F,ae as x,aD as I,af as k,ag as ie,aE as L,aA as se,a3 as C,aB as P,m as ae,aQ as M,aR as oe,f as p,S as g,Q as ne,R as T,aS as le,an as de}from"./index-BySeSNft.js";import{c as ue,a as U,r as ce,u as me,s as pe,b as fe,d as he}from"./projectListService-DG0wXcXk.js";import{V as B}from"./VSpacer-CjVyWe_u.js";import{V as z}from"./VSelect-OdGzKFSb.js";import{_ as Q}from"./TimeAgo-hHS1cEeM.js";import{o as ge}from"./openEdit-AJJkPSPH.js";import{_ as G}from"./CodeRunTerminal-CCRokTkC.js";import{p as _e}from"./programming_languages-DsXmqGcu.js";import{V as W}from"./VTextarea-B995THNE.js";const ye={name:"ProjectAuthorCard",components:{UserRelationControls:N},props:{author:{type:Object,required:!0}},data(){return{localuser:J,loading:!1,error:null,s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await D("s3.staticurl")}};function je(e,t,i,w,a,m){const o=N;return l(),f(_,{hover:"",to:"/"+i.author.username,border:""},{default:s(()=>[r(q,null,K({prepend:s(()=>[r(A,null,{default:s(()=>[r(O,{alt:i.author.display_name,src:a.s3BucketUrl+"/user/"+i.author.avatar},null,8,["alt","src"])]),_:1})]),default:s(()=>[r(E,{class:"text-white"},{default:s(()=>[n(d(i.author.display_name),1)]),_:1}),r(R,{class:"text-white"},{default:s(()=>[n(d(i.author.bio),1)]),_:1})]),_:2},[a.localuser.id&&a.localuser.id!==i.author.id?{name:"append",fn:s(()=>[r(o,{"user-id":i.author.id,username:i.author.username,"display-name":i.author.display_name},null,8,["user-id","username","display-name"])]),key:"0"}:void 0]),1024)]),_:1},8,["to"])}const X=V(ye,[["render",je]]),Ve={props:{projectId:{type:[String,Number],required:!0,validator:e=>e==null?!1:typeof e=="string"?e.trim()!=="":typeof e=="number"?!isNaN(e)&&e>0:!1}},data(){return{isStarred:!1,starCount:0,starLoading:!1,listLoading:!1,creatingList:!1,isVisibleDialog:!1,menu:!1,myLists:[],newListInfo:{title:"",description:"",state:"private"},listStates:[{state:"私密",abbr:"private"},{state:"公开",abbr:"public"}],error:null}},computed:{isValidProjectId(){return this.projectId!==void 0&&this.projectId!==null&&(typeof this.projectId=="string"?this.projectId.trim()!=="":!isNaN(this.projectId)&&this.projectId>0)}},async created(){this.isValidProjectId?(await this.checkStarStatus(),await this.getStarCount()):(console.error("Invalid projectId provided:",this.projectId),this.error="无效的项目ID")},watch:{menu(e){e&&this.isValidProjectId&&this.fetchMyLists()},projectId:{immediate:!0,handler(e){this.isValidProjectId&&(this.checkStarStatus(),this.getStarCount())}}},methods:{async checkStarStatus(){if(this.isValidProjectId)try{const e=await he(this.projectId);if((e==null?void 0:e.status)==="success")this.isStarred=e.star;else throw new Error((e==null?void 0:e.message)||"检查收藏状态失败")}catch(e){console.error("检查收藏状态失败:",e),this.error=e.message||"检查收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}},async getStarCount(){if(this.isValidProjectId){try{const e=await fe(this.projectId);if((e==null?void 0:e.status)==="success")this.starCount=e.data;else throw new Error((e==null?void 0:e.message)||"获取收藏数失败")}catch(e){console.error("获取收藏数失败:",e),this.error=e.message||"获取收藏数失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}this.$emit("star-updated")}},async toggleStar(){if(!this.isValidProjectId){this.$toast.add({severity:"error",summary:"错误",detail:"无效的项目ID",life:3e3});return}this.starLoading=!0;try{const e=this.isStarred?await me(this.projectId):await pe(this.projectId);if((e==null?void 0:e.status)==="success")this.isStarred=!this.isStarred,await this.getStarCount(),this.$toast.add({severity:"success",summary:"成功",detail:e.message,life:2e3});else throw new Error((e==null?void 0:e.message)||"操作失败")}catch(e){console.error("切换收藏状态失败:",e),this.error=e.message||"切换收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.starLoading=!1}},async fetchMyLists(){var e,t;if(this.isValidProjectId){this.listLoading=!0;try{const i=await $.get(`/projectlist/lists/check?projectid=${this.projectId}`);if(((e=i==null?void 0:i.data)==null?void 0:e.status)==="success")this.myLists=i.data.data||[];else throw new Error(((t=i==null?void 0:i.data)==null?void 0:t.message)||"获取列表状态失败")}catch(i){console.error("获取我的列表失败:",i),this.error=i.message||"获取我的列表失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.listLoading=!1}}},async toggleListItem(e){const t=this.myLists.find(i=>i.id===e);if(t){t.loading=!0;try{let i;t.hasProject?(i=await ce(e,this.projectId),i.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已从列表中移除",life:3e3}),t.hasProject=!1)):(i=await U(e,this.projectId),i.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已添加到列表",life:3e3}),t.hasProject=!0))}catch(i){console.error("操作列表失败:",i),this.$toast.add({severity:"error",summary:"错误",detail:"操作失败",life:3e3})}finally{t.loading=!1}}},async createNewList(){if(this.newListInfo.title){this.creatingList=!0;try{const e=await ue(this.newListInfo);e.status==="success"?(this.$toast.add({severity:"success",summary:"成功",detail:"列表创建成功",life:3e3}),this.newListInfo={title:"",description:"",state:"private"},this.isVisibleDialog=!1,e.data&&e.data.id&&await U(e.data.id,this.projectId),await this.fetchMyLists()):this.$toast.add({severity:"error",summary:"错误",detail:e.message||"创建列表失败",life:3e3})}catch(e){console.error("创建列表失败:",e),this.$toast.add({severity:"error",summary:"错误",detail:"创建列表失败",life:3e3})}finally{this.creatingList=!1}}}}};function we(e,t,i,w,a,m){return l(),f(M,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:s(()=>[r(u,{onClick:m.toggleStar,variant:"tonal",class:"text-none",text:"Star",loading:a.starLoading},{prepend:s(()=>[r(S,{icon:a.isStarred?"mdi-star":"mdi-star-outline",color:a.isStarred?"yellow":""},null,8,["icon","color"])]),default:s(()=>[n(" "+d(a.isStarred?"Starred":"Star")+" "+d(a.starCount),1)]),_:1},8,["onClick","loading"]),r(b,{color:"surface-light",vertical:""}),r(ee,{"close-on-content-click":!1,modelValue:a.menu,"onUpdate:modelValue":t[8]||(t[8]=o=>a.menu=o)},{activator:s(({props:o})=>[r(u,ae({class:"px-5",icon:"mdi-menu-down"},o),null,16)]),default:s(()=>[r(_,{"min-width":"300","max-width":"400"},{default:s(()=>[a.listLoading?(l(),f(te,{key:0,indeterminate:"",color:"primary"})):y("",!0),r(re,null,{default:s(()=>[(l(!0),h(j,null,F(a.myLists,o=>(l(),h("div",{key:o.id},[r(x,{"prepend-icon":o.hasProject?"mdi-check-circle":"mdi-playlist-plus",active:o.hasProject,"prepend-icon-color":o.hasProject?"success":void 0,onClick:I(c=>m.toggleListItem(o.id),["stop"])},{default:s(()=>[r(k,null,{default:s(()=>[n(d(o.title),1)]),_:2},1024),r(ie,null,{default:s(()=>[n(d(o.description),1)]),_:2},1024)]),_:2},1032,["prepend-icon","active","prepend-icon-color","onClick"])]))),128)),r(b,{class:"my-2"}),r(x,{onClick:t[0]||(t[0]=I(o=>a.isVisibleDialog=!0,["stop"]))},{prepend:s(()=>[r(S,null,{default:s(()=>t[9]||(t[9]=[n("mdi-plus",-1)])),_:1,__:[9]})]),default:s(()=>[r(k,null,{default:s(()=>t[10]||(t[10]=[n("新建列表",-1)])),_:1,__:[10]})]),_:1})]),_:1}),r(L,null,{default:s(()=>[r(B),r(u,{text:"关闭",variant:"text",onClick:t[1]||(t[1]=o=>a.menu=!1)})]),_:1})]),_:1}),r(se,{modelValue:a.isVisibleDialog,"onUpdate:modelValue":t[6]||(t[6]=o=>a.isVisibleDialog=o),width:"auto","min-width":"400","onClick:outside":t[7]||(t[7]=o=>a.isVisibleDialog=!1)},{default:s(()=>[r(_,{"prepend-icon":"mdi-format-list-bulleted",title:"新建列表",border:""},{default:s(()=>[r(C,null,{default:s(()=>[r(P,{label:"标题",required:"",hint:"将便于查找",modelValue:a.newListInfo.title,"onUpdate:modelValue":t[2]||(t[2]=o=>a.newListInfo.title=o),rules:[o=>!!o||"标题不能为空"]},null,8,["modelValue","rules"]),r(P,{label:"简介",hint:"简要描述列表内容",modelValue:a.newListInfo.description,"onUpdate:modelValue":t[3]||(t[3]=o=>a.newListInfo.description=o)},null,8,["modelValue"]),r(z,{modelValue:a.newListInfo.state,"onUpdate:modelValue":t[4]||(t[4]=o=>a.newListInfo.state=o),items:a.listStates,"item-title":"state","item-value":"abbr",label:"列表状态"},null,8,["modelValue","items"])]),_:1}),r(b),r(L,null,{default:s(()=>[r(B),r(u,{text:"关闭",variant:"plain",onClick:t[5]||(t[5]=o=>a.isVisibleDialog=!1)}),r(u,{color:"primary",text:"创建",variant:"tonal",onClick:I(m.createNewList,["stop"]),loading:a.creatingList,disabled:!a.newListInfo.title},null,8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})}const Y=V(Ve,[["render",we]]),ve={name:"ProjectInfoCard",components:{TimeAgo:Q,ProjectStar:Y,ProjectAuthorCard:X},props:{project:{type:Object,required:!0},author:{type:Object,required:!0},username:{type:String,required:!0},projectname:{type:String,required:!0}},data(){return{openEditor:ge,loading:!1,error:null,stats:{pageviews:0,visitors:0},s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await D("s3.staticurl")},watch:{"project.id":{immediate:!0,handler(e){e&&this.loadProjectStats()}}},methods:{async loadProjectStats(){try{this.stats=await oe(this.project.id)}catch(e){console.error("Error fetching project stats:",e),this.stats={pageviews:0,visitors:0}}}}},be={class:"px-4 d-flex ga-2 mb-2"},Ie={class:"px-4 d-flex ga-2 mb-2"},Le={class:"px-4 d-flex ga-2 mb-2"},Ce={class:"px-4 d-flex ga-2 mb-2"},Se={class:"px-4 d-flex ga-2 mb-2"},xe={class:"px-4 d-flex ga-2 mb-2"},ke={class:"px-4 d-flex ga-2 mb-2"},Pe={class:"px-4"};function Te(e,t,i,w,a,m){const o=Q,c=Y,H=X;return l(),f(_,{hover:"",border:""},{default:s(()=>[r(q,null,{default:s(()=>[r(E,null,{default:s(()=>[n(d(i.project.title),1)]),_:1}),r(R,null,{default:s(()=>[n(d(i.project.description),1)]),_:1})]),_:1}),p("div",be,[r(g,{pill:""},{default:s(()=>[r(A,{start:""},{default:s(()=>[r(O,{src:a.s3BucketUrl+"/user/"+i.author.avatar},null,8,["src"])]),_:1}),n(d(i.author.display_name),1)]),_:1})]),p("div",Ie,[r(g,{pill:"","prepend-icon":"mdi-chart-line"},{default:s(()=>[n(d(a.stats.pageviews)+"浏览",1)]),_:1}),r(g,{pill:"","prepend-icon":"mdi-account-multiple"},{default:s(()=>[n(d(a.stats.visitors)+"访客",1)]),_:1}),r(g,{pill:"","prepend-icon":"mdi-clock"},{default:s(()=>[r(o,{date:i.project.time},null,8,["date"])]),_:1})]),p("div",Le,[i.project.state=="public"?(l(),f(g,{key:0,pill:"","prepend-icon":"mdi-xml"},{default:s(()=>t[1]||(t[1]=[n("开源作品",-1)])),_:1,__:[1]})):y("",!0),i.project.state=="private"?(l(),f(g,{key:1,pill:"","prepend-icon":"mdi-xml",color:"red",variant:"outlined"},{default:s(()=>t[2]||(t[2]=[n("私密作品",-1)])),_:1,__:[2]})):y("",!0),r(g,{pill:"","prepend-icon":"mdi-application"},{default:s(()=>[n(d(i.project.type),1)]),_:1})]),p("div",Ce,[(l(!0),h(j,null,F(i.project.tags,v=>(l(),h("div",null,[r(g,{to:`/app/projects/tag/${v.name}`},{default:s(()=>[n(d(v.name),1)]),_:2},1032,["to"])]))),256))]),p("div",Se,[r(c,{projectId:i.project.id,starcount:i.project.star_count},null,8,["projectId","starcount"])]),p("div",xe,[r(M,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:s(()=>[r(u,{to:`/${i.username}/${i.projectname}/fork`,variant:"tonal",class:"text-none"},{default:s(()=>t[3]||(t[3]=[n(" 分叉 ",-1)])),_:1,__:[3]},8,["to"]),r(u,{text:"",to:`/app/projects/fork/${i.project.id}`},{default:s(()=>[n(d(a.stats.forks),1)]),_:1},8,["to"])]),_:1})]),p("div",ke,[r(u,{onClick:t[0]||(t[0]=v=>a.openEditor(i.project.id,i.project.type)),variant:"text"},{default:s(()=>t[4]||(t[4]=[n("打开创造页",-1)])),_:1,__:[4]}),r(u,{to:`/${i.username}/${i.projectname}/edit`,variant:"text"},{default:s(()=>t[5]||(t[5]=[n("编辑源文件",-1)])),_:1,__:[5]},8,["to"])]),p("div",Pe,[r(H,{author:i.author},null,8,["author"])]),t[6]||(t[6]=p("br",null,null,-1))]),_:1,__:[6]})}const Xe=V(ve,[["render",Te]]),Ue={name:"CodeRunner",components:{CodeRunTerminal:G},props:{projectType:{type:String,required:!0,validator:e=>["scratch","code"].includes(e)},initialCode:{type:String,default:""},initialLanguage:{type:String,default:"python"}},data(){return{code:this.initialCode,selectedLanguage:this.initialLanguage,programmingLanguages:_e}},computed:{languageOptions(){return Object.entries(this.programmingLanguages).map(([e,t])=>({key:e,name:t.name}))},currentLanguage(){return this.programmingLanguages[this.selectedLanguage]||{}}},methods:{runCode(){this.$refs.terminal&&this.$refs.terminal.runCode()}},watch:{initialCode(e){this.code=e},initialLanguage(e){this.selectedLanguage=e}}};function Be(e,t,i,w,a,m){const o=G;return l(),h("div",null,[r(_,null,{default:s(()=>[r(C,null,{default:s(()=>[r(ne,null,{default:s(()=>[r(T,{cols:"12"},{default:s(()=>[r(z,{modelValue:a.selectedLanguage,"onUpdate:modelValue":t[0]||(t[0]=c=>a.selectedLanguage=c),items:m.languageOptions,"item-title":"name","item-value":"key",label:"Select Language",class:"mb-4"},null,8,["modelValue","items"])]),_:1}),r(T,{cols:"12"},{default:s(()=>[r(W,{modelValue:a.code,"onUpdate:modelValue":t[1]||(t[1]=c=>a.code=c),label:m.currentLanguage.placeholder||"Enter code here",placeholder:m.currentLanguage.sample,"auto-grow":"",rows:"10",class:"mb-4"},null,8,["modelValue","label","placeholder"])]),_:1})]),_:1})]),_:1})]),_:1}),r(o,{ref:"terminal",code:a.code,language:a.selectedLanguage,"auto-run":!1},null,8,["code","language"])])}const Z=V(Ue,[["render",Be],["__scopeId","data-v-e476c29b"]]),Ne={name:"ProjectPlayer",components:{CodeRunner:Z},props:{projectId:{type:[Number,String],required:!0},branch:{type:String,default:"main"},commitId:{type:String,default:"latest"},showplayer:{type:Boolean,required:!0},type:{type:String,default:"scratch"}},data(){return{initProject:de,projectType:this.type,projectCode:"",projectContent:"",projectLanguage:"python"}},computed:{embedurl(){const e=`/scratch/embed.html?id=${this.projectId}&embed=true`;return this.commitId!=="latest"?`${e}&ref=${this.commitId}`:`${e}&branch=${this.branch}&ref=${this.commitId}`}},methods:{async loadProjectContent(){if(!(!this.showplayer||this.projectType==="scratch"))try{const e=await le(this.projectId,this.branch,this.commitId);this.projectType==="text"?this.projectContent=e.code||"":(this.projectCode=e.code||"",this.projectLanguage=e.language||"python")}catch(e){console.error("Failed to load project content:",e)}}},async mounted(){await this.loadProjectContent()},watch:{projectId:{handler:"loadProjectContent",immediate:!0},branch:"loadProjectContent",commitId:"loadProjectContent",type:{handler(e){this.projectType=e,this.loadProjectContent()},immediate:!0}}},De=["src"];function qe(e,t,i,w,a,m){const o=Z;return l(),h("div",null,[a.projectType==="scratch"?(l(),h(j,{key:0},[i.showplayer?(l(),f(_,{key:0,hover:"",border:"",style:{"aspect-ratio":"4 / 3"}},{default:s(()=>[p("iframe",{src:m.embedurl,scrolling:"no",frameborder:"0",style:{width:"100%",height:"100%"}},null,8,De)]),_:1})):y("",!0)],64)):a.projectType==="text"?(l(),h(j,{key:1},[i.showplayer?(l(),f(_,{key:0,hover:"",border:""},{default:s(()=>[r(C,null,{default:s(()=>[r(W,{modelValue:a.projectContent,"onUpdate:modelValue":t[0]||(t[0]=c=>a.projectContent=c),readonly:"","auto-grow":"",rows:"10","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})):y("",!0)],64)):(l(),h(j,{key:2},[i.showplayer?(l(),f(o,{key:0,ref:"codeRunner","project-type":a.projectType,"initial-code":a.projectCode,"initial-language":a.projectLanguage},null,8,["project-type","initial-code","initial-language"])):y("",!0)],64)),i.showplayer?y("",!0):(l(),f(_,{key:3,hover:"",border:"",title:"项目尚未初始化"},{default:s(()=>[r(L,null,{default:s(()=>[r(u,{onClick:t[1]||(t[1]=c=>a.initProject(i.projectId,"scratch"))},{default:s(()=>t[5]||(t[5]=[n("以Scratch模板初始化项目",-1)])),_:1,__:[5]}),r(u,{onClick:t[2]||(t[2]=c=>a.initProject(i.projectId,"code"))},{default:s(()=>t[6]||(t[6]=[n("以代码模板初始化项目",-1)])),_:1,__:[6]}),r(u,{onClick:t[3]||(t[3]=c=>a.initProject(i.projectId,"text"))},{default:s(()=>t[7]||(t[7]=[n("以文本模板初始化项目",-1)])),_:1,__:[7]}),r(u,{onClick:t[4]||(t[4]=c=>a.initProject(i.projectId,"none"))},{default:s(()=>t[8]||(t[8]=[n("以空白模板初始化项目",-1)])),_:1,__:[8]})]),_:1})]),_:1}))])}const Ye=V(Ne,[["render",qe],["__scopeId","data-v-14f4d6ef"]]);export{Xe as _,Ye as a};
