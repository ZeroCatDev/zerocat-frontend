import{r as u,w as K,a5 as ee,X as g,o as c,M as a,e as s,Y as M,ae as F,L as o,T as w,a8 as U,f as d,$ as b,aG as z,aa as Y,aJ as A,N as L,i as p,aF as I,aZ as le,b as ae,c as W,F as te,W as se,S as X,aK as ue,aI as re,bh as oe,bi as ne,bj as ie,bk as de,bl as ve}from"./index-CmO9_o1Q.js";import{V as fe}from"./VTable-BYTLR-Bo.js";const ce={__name:"verifyEmail",props:{modelValue:Boolean,email:{type:String,required:!0},title:{type:String,default:"验证邮箱"}},emits:["update:modelValue","verified"],setup(q,{expose:B,emit:T}){const k=q,x=T,m=u(k.modelValue),y=u(""),r=u(""),f=u("info"),C=u(!1),V={required:n=>!!n||"此字段为必填项",length:n=>(n==null?void 0:n.length)===6||"验证码必须是6位数字"};K(()=>m.value,n=>{x("update:modelValue",n),n&&_()}),K(()=>k.modelValue,n=>{m.value=n});const _=async()=>{var n,i;r.value="",C.value=!0;try{const v=await ee.post("/account/send-verification-code",{email:k.email});v.data.status==="success"?(r.value="验证码已发送",f.value="success"):(r.value=v.data.message,f.value="error")}catch(v){r.value=((i=(n=v.response)==null?void 0:n.data)==null?void 0:i.message)||"发送验证码失败",f.value="error"}finally{C.value=!1}},S=()=>{if(!y.value||y.value.length!==6){r.value="请输入6位验证码",f.value="error";return}x("verified",y.value),E()},E=()=>{m.value=!1,y.value="",r.value=""};return B({sendCode:_}),(n,i)=>(c(),g(I,{modelValue:m.value,"onUpdate:modelValue":i[1]||(i[1]=v=>m.value=v),"max-width":"400px"},{default:a(()=>[s(M,null,{default:a(()=>[s(F,null,{default:a(()=>[o(w(q.title),1)]),_:1}),s(U,null,{default:a(()=>[d("p",null,"验证码将发送到邮箱 "+w(q.email),1),s(z,{modelValue:y.value,"onUpdate:modelValue":i[0]||(i[0]=v=>y.value=v),rules:[V.required,V.length],class:"mt-4",label:"验证码",maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"]),r.value?(c(),g(Y,{key:0,type:f.value,class:"mt-3",variant:"tonal"},{default:a(()=>[o(w(r.value),1)]),_:1},8,["type"])):b("",!0)]),_:1}),s(A,null,{default:a(()=>[s(L),s(p,{color:"grey",variant:"text",onClick:E},{default:a(()=>i[2]||(i[2]=[o("取消",-1)])),_:1,__:[2]}),s(p,{loading:C.value,color:"primary",onClick:S},{default:a(()=>i[3]||(i[3]=[o(" 确认 ",-1)])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},ye={__name:"EmailManager",setup(q,{expose:B}){const T=le(),k=u([]),x=u(!1),m=u(!1),y=u(!1),r=u(!1),f=u(""),C=u(""),V=u(null),_=u(""),S=u("info"),E=u(!1),n=u(""),i=u(""),v=u(null),N=u(null),$={required:l=>!!l||"此字段为必填项",email:l=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||"请输入有效的邮箱地址",length:l=>(l==null?void 0:l.length)===6||"验证码必须是6位数字"},D=async()=>{try{const l=await oe();l.status==="success"&&(k.value=l.data)}catch(l){console.error("获取邮箱列表失败:",l)}},Z=(l,e,t)=>{n.value=l,i.value=e,v.value=t,E.value=!0},H=l=>{v.value&&(v.value(l),v.value=null)},j=async()=>{if(f.value){r.value=!0;try{const l=await T.requireSudo({title:"添加邮箱",subtitle:"您正在尝试添加新的邮箱地址。此操作需要验证您的身份。",persistent:!0}),e=await ie(f.value,null,l);e.status==="success"?(await D(),P()):(_.value=e.message,S.value="error")}catch(l){l.type!=="cancel"&&(_.value="添加邮箱失败",S.value="error")}finally{r.value=!1}}},O=l=>{V.value=l,m.value=!0},Q=async l=>{if(l){r.value=!0;try{const e=await T.requireSudo({title:"设置主邮箱",subtitle:`您正在尝试将邮箱 ${l.contact_value} 设置为主邮箱。此操作需要验证您的身份。`,persistent:!0});(await ne(l.contact_value,e)).status==="success"&&await D()}catch(e){e.type!=="cancel"&&console.error("设置主邮箱失败:",e)}finally{r.value=!1}}},R=async()=>{if(V.value){r.value=!0;try{const l=await T.requireSudo({title:"删除邮箱",subtitle:`您正在尝试删除邮箱 ${V.value.contact_value}。此操作需要验证您的身份。`,persistent:!0});(await de(V.value.contact_value,l)).status==="success"&&(await D(),G())}catch(l){l.type!=="cancel"&&console.error("删除失败:",l)}finally{r.value=!1}}},P=()=>{x.value=!1,y.value=!1,f.value="",C.value="",_.value="",N.value&&N.value.reset()},G=()=>{m.value=!1,V.value=null},h=l=>{Z(l,"验证邮箱",async e=>{r.value=!0;try{(await ve(l,e)).status==="success"&&await D()}catch(t){console.error("验证失败:",t)}finally{r.value=!1}})};return ae(async()=>{await D()}),B({fetchEmails:D}),(l,e)=>(c(),g(M,{class:"mb-4"},{default:a(()=>[s(F,{class:"d-flex align-center justify-space-between"},{default:a(()=>[e[7]||(e[7]=d("span",null,"邮箱管理",-1)),s(p,{disabled:k.value.length>=5,color:"primary",onClick:e[0]||(e[0]=t=>x.value=!0)},{default:a(()=>e[6]||(e[6]=[o(" 添加邮箱 ",-1)])),_:1,__:[6]},8,["disabled"])]),_:1,__:[7]}),s(U,null,{default:a(()=>[s(fe,null,{default:a(()=>[e[12]||(e[12]=d("thead",null,[d("tr",null,[d("th",null,"邮箱地址"),d("th",null,"状态"),d("th",null,"添加时间"),d("th",null,"操作")])],-1)),d("tbody",null,[(c(!0),W(te,null,se(k.value,t=>(c(),W("tr",{key:t.contact_id},[d("td",null,[o(w(t.contact_value)+" ",1),t.is_primary?(c(),g(X,{key:0,class:"ml-2",color:"primary",size:"small"},{default:a(()=>e[8]||(e[8]=[o("主邮箱",-1)])),_:1,__:[8]})):b("",!0)]),d("td",null,[s(X,{color:t.verified?"success":"warning",size:"small"},{default:a(()=>[o(w(t.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),d("td",null,w(new Date(t.created_at).toLocaleString()),1),d("td",null,[t.verified?b("",!0):(c(),g(p,{key:0,color:"primary",size:"small",variant:"text",onClick:J=>h(t.contact_value)},{default:a(()=>e[9]||(e[9]=[o(" 验证 ",-1)])),_:2,__:[9]},1032,["onClick"])),!t.is_primary&&t.verified?(c(),g(p,{key:1,color:"secondary",size:"small",variant:"text",onClick:J=>Q(t)},{default:a(()=>e[10]||(e[10]=[o(" 设为主邮箱 ",-1)])),_:2,__:[10]},1032,["onClick"])):b("",!0),t.is_primary?b("",!0):(c(),g(p,{key:2,color:"error",size:"small",variant:"text",onClick:J=>O(t)},{default:a(()=>e[11]||(e[11]=[o(" 删除 ",-1)])),_:2,__:[11]},1032,["onClick"]))])]))),128))])]),_:1,__:[12]})]),_:1}),s(I,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=t=>x.value=t),"max-width":"500px"},{default:a(()=>[s(M,null,{default:a(()=>[s(F,null,{default:a(()=>e[13]||(e[13]=[o("添加新邮箱",-1)])),_:1,__:[13]}),s(U,null,{default:a(()=>[s(ue,{ref_key:"addForm",ref:N,onSubmit:re(j,["prevent"])},{default:a(()=>[s(z,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=t=>f.value=t),rules:[$.required,$.email],label:"新邮箱地址",variant:"outlined"},null,8,["modelValue","rules"]),y.value?(c(),g(z,{key:0,modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=t=>C.value=t),rules:[$.required,$.length],label:"主邮箱验证码",maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):b("",!0),_.value?(c(),g(Y,{key:1,type:S.value,class:"mt-3",variant:"tonal"},{default:a(()=>[o(w(_.value),1)]),_:1},8,["type"])):b("",!0)]),_:1},512)]),_:1}),s(A,null,{default:a(()=>[s(L),s(p,{color:"grey",variant:"text",onClick:P},{default:a(()=>e[14]||(e[14]=[o("取消",-1)])),_:1,__:[14]}),s(p,{loading:r.value,color:"primary",onClick:j},{default:a(()=>e[15]||(e[15]=[o(" 添加 ",-1)])),_:1,__:[15]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(I,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=t=>m.value=t),"max-width":"500px"},{default:a(()=>[s(M,null,{default:a(()=>[s(F,null,{default:a(()=>e[16]||(e[16]=[o("删除邮箱",-1)])),_:1,__:[16]}),s(U,null,{default:a(()=>{var t;return[d("p",null,"确认要删除邮箱 "+w((t=V.value)==null?void 0:t.contact_value)+" 吗？",1)]}),_:1}),s(A,null,{default:a(()=>[s(L),s(p,{color:"grey",variant:"text",onClick:G},{default:a(()=>e[17]||(e[17]=[o("取消",-1)])),_:1,__:[17]}),s(p,{loading:r.value,color:"error",onClick:R},{default:a(()=>e[18]||(e[18]=[o(" 删除 ",-1)])),_:1,__:[18]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ce,{modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=t=>E.value=t),email:n.value,title:i.value,onVerified:H},null,8,["modelValue","email","title"])]),_:1}))}};export{ye as _};
