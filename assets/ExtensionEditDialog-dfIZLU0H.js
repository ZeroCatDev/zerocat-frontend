import{_ as M}from"./ProjectSelector-BTYnMByG.js";import{_ as F,a6 as b,af as x,Z as f,o as m,N as t,e as s,X as g,ae as V,L as i,P as _,a8 as C,aJ as B,R as D,S as j,ai as P,b1 as E,b2 as A,a0 as v,aj as k,Y as c,ak as w,c as y,aF as S,a$ as N,i as p,ah as R,F as T,W as O,D as G,f as h,$ as L,n as I,aY as Y,a_ as J,aa as W,aI as X,O as Z,aE as q}from"./index-BhZBrlGg.js";import{V as H}from"./VSelect-CWcWmsqs.js";import{V as K,a as z}from"./VRadioGroup-ZofjN44p.js";import{V as Q}from"./VSwitch-wS9HwrLL.js";const $={name:"ExtensionEditDialog",components:{ProjectSelector:M},props:{modelValue:{type:Boolean,default:!1},extension:{type:Object,default:null}},emits:["update:modelValue","updated"],data(){return{formValid:!1,loading:!1,loadingCommits:!1,localuser:x,form:{branch:"",commit:"",image:"",samples:null,docs:"",scratchCompatible:!1},useLatestCommit:!0,imageMode:"project",commits:[],branches:[],myProjects:[],selectedSampleProject:null,selectedSampleProjectId:null}},computed:{dialog:{get(){return this.modelValue},set(o){this.$emit("update:modelValue",o)}},previewImage(){return this.imageMode==="project"?null:this.form.image?x.getUserAvatar(this.form.image):null}},watch:{async modelValue(o){o&&this.extension&&await this.initializeForm()},useLatestCommit(o){o?this.form.commit="":this.fetchCommits()},selectedSampleProjectId:{handler(o){o&&this.loadSampleProject(o)},immediate:!0}},async created(){await this.fetchMyProjects()},methods:{async initializeForm(){this.extension&&(this.form={branch:this.extension.branch||"",commit:this.extension.commit||"",image:this.extension.image||"",samples:this.extension.samples||null,docs:this.extension.docs||"",scratchCompatible:this.extension.scratchCompatible||!1},this.useLatestCommit=!this.extension.commit||this.extension.commit==="latest",this.imageMode=this.extension.image?"custom":"project",this.extension.sample_project&&(this.selectedSampleProject=this.extension.sample_project),await this.fetchBranches())},async fetchMyProjects(){try{const o=await b.get("/searchapi",{params:{search_userid:x.user.value.id,search_state:"public",limit:100}});o.data&&o.data.projects&&(this.myProjects=o.data.projects)}catch(o){console.error("Failed to fetch my projects:",o)}},async fetchBranches(){var o,e;if((e=(o=this.extension)==null?void 0:o.project)!=null&&e.id)try{const r=await b.get(`/project/branches?projectid=${this.extension.project.id}`);r.data.status==="success"?this.branches=r.data.data||[]:(console.error("加载分支列表失败:",r.data.message),this.branches=[])}catch(r){console.error("Failed to fetch branches:",r),this.branches=[]}},async fetchCommits(){var o,e;if((e=(o=this.extension)==null?void 0:o.project)!=null&&e.id){this.loadingCommits=!0;try{const r=await b.get(`/project/commits?projectid=${this.extension.project.id}&branch=${this.form.branch||"main"}`);r.data.status==="success"?(this.commits=r.data.data||[],this.commits=this.commits.map(d=>({...d,id:d.hash||d.id||"unknown",commit_message:d.message||d.commit_message||"无提交信息",date:d.date||new Date().toISOString(),author:d.author||{username:"未知用户"}}))):(console.error("加载提交历史失败:",r.data.message),this.commits=[])}catch(r){console.error("Failed to fetch commits:",r),this.commits=[]}finally{this.loadingCommits=!1}}},selectCommit(o){this.form.commit=o.id},async onBranchChange(){this.useLatestCommit||await this.fetchCommits()},async loadSampleProject(o){try{const r=(await b.post("/project/batch",{projectIds:[o]})).data.data||[];r.length>0&&(this.selectedSampleProject=r[0],this.form.samples=o)}catch(e){console.error("Failed to load sample project:",e)}},selectSampleProject(o){this.selectedSampleProject=o,this.form.samples=o.id,this.showProjectSelector=!1},clearSampleProject(){this.selectedSampleProject=null,this.selectedSampleProjectId=null,this.form.samples=null},async saveExtension(){if(this.extension){this.loading=!0;try{const o={...this.form.branch&&{branch:this.form.branch},...this.form.docs&&{docs:this.form.docs},...this.form.scratchCompatible!==void 0&&{scratchCompatible:this.form.scratchCompatible}};this.useLatestCommit?o.commit="latest":this.form.commit&&(o.commit=this.form.commit),this.imageMode==="project"||this.form.image&&(o.image=this.form.image),this.form.samples&&(o.samples=this.form.samples);const e=await b.put(`/extensions/manager/edit/${this.extension.id}`,o);e.data.status==="success"?(this.$emit("updated"),this.closeDialog(),this.showMessage("扩展更新成功","success")):this.showMessage(e.data.message||"更新失败","error")}catch(o){console.error("Failed to update extension:",o),this.showMessage("更新扩展失败","error")}finally{this.loading=!1}}},closeDialog(){this.dialog=!1},showMessage(o,e){console.log(o)}}},ee={key:0,class:"mt-3"},te={class:"d-flex align-center mt-4"},se={class:"text-caption text-grey"},le={class:"d-flex align-center mb-3"},oe={key:0,class:"selected-project"},ae={key:1,class:"text-center py-4 text-grey"},ie={class:"text-caption text-grey"};function re(o,e,r,d,l,n){const U=M;return m(),f(q,{modelValue:n.dialog,"onUpdate:modelValue":e[11]||(e[11]=a=>n.dialog=a),"max-width":"800",persistent:""},{default:t(()=>[s(g,null,{default:t(()=>[s(V,{class:"d-flex align-center"},{default:t(()=>[s(_,{class:"mr-2"},{default:t(()=>e[12]||(e[12]=[i("mdi-pencil",-1)])),_:1,__:[12]}),e[13]||(e[13]=i(" 编辑扩展 ",-1))]),_:1,__:[13]}),s(C,null,{default:t(()=>[s(B,{ref:"form",modelValue:l.formValid,"onUpdate:modelValue":e[10]||(e[10]=a=>l.formValid=a)},{default:t(()=>[s(g,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(V,{class:"text-subtitle-1"},{default:t(()=>e[14]||(e[14]=[i("基本信息",-1)])),_:1,__:[14]}),s(C,null,{default:t(()=>[s(D,null,{default:t(()=>[s(j,{cols:"12",md:"6"},{default:t(()=>[s(H,{modelValue:l.form.branch,"onUpdate:modelValue":[e[0]||(e[0]=a=>l.form.branch=a),n.onBranchChange],label:"分支名称",placeholder:"选择分支","prepend-inner-icon":"mdi-source-branch",variant:"outlined",density:"compact",items:l.branches,"item-title":"name","item-value":"name"},{item:t(({props:a,item:u})=>[s(P,E(A(a)),{prepend:t(()=>[s(_,{size:"small"},{default:t(()=>e[15]||(e[15]=[i("mdi-source-branch",-1)])),_:1,__:[15]})]),default:t(()=>[s(k,null,{default:t(()=>[i(c(u.raw.name),1)]),_:2},1024),u.raw.description?(m(),f(w,{key:0},{default:t(()=>[i(c(u.raw.description),1)]),_:2},1024)):v("",!0)]),_:2},1040)]),_:1},8,["modelValue","items","onUpdate:modelValue"])]),_:1}),s(j,{cols:"12",md:"6"},{default:t(()=>[s(S,{modelValue:l.form.commit,"onUpdate:modelValue":e[1]||(e[1]=a=>l.form.commit=a),label:"提交ID",placeholder:"留空或latest使用最新提交","prepend-inner-icon":"mdi-source-commit",variant:"outlined",density:"compact",readonly:l.useLatestCommit},null,8,["modelValue","readonly"]),s(N,{modelValue:l.useLatestCommit,"onUpdate:modelValue":e[4]||(e[4]=a=>l.useLatestCommit=a),class:"mt-2",variant:"outlined",density:"compact",divided:""},{default:t(()=>[s(p,{variant:l.useLatestCommit?"flat":"outlined",color:l.useLatestCommit?"primary":void 0,size:"small",onClick:e[2]||(e[2]=a=>l.useLatestCommit=!0)},{default:t(()=>e[16]||(e[16]=[i(" 最新 ",-1)])),_:1,__:[16]},8,["variant","color"]),s(p,{variant:l.useLatestCommit?"outlined":"flat",color:l.useLatestCommit?void 0:"primary",size:"small",onClick:e[3]||(e[3]=a=>l.useLatestCommit=!1)},{default:t(()=>e[17]||(e[17]=[i(" 指定 ",-1)])),_:1,__:[17]},8,["variant","color"])]),_:1},8,["modelValue"]),!l.useLatestCommit&&l.commits.length>0?(m(),y("div",ee,[s(R,{density:"compact","max-height":"200",class:"overflow-y-auto"},{default:t(()=>[(m(!0),y(T,null,O(l.commits,a=>(m(),f(P,{key:a.id,onClick:u=>n.selectCommit(a),active:l.form.commit===a.id,class:G({"v-list-item--active":l.form.commit===a.id})},{prepend:t(()=>[s(_,{size:"small"},{default:t(()=>e[18]||(e[18]=[i("mdi-source-commit",-1)])),_:1,__:[18]})]),default:t(()=>[s(k,{class:"text-caption"},{default:t(()=>[i(c(a.id.substring(0,8)),1)]),_:2},1024),s(w,{class:"text-caption"},{default:t(()=>[i(c(a.commit_message||"无提交信息"),1)]),_:2},1024)]),_:2},1032,["onClick","active","class"]))),128))]),_:1})])):v("",!0),l.useLatestCommit?v("",!0):(m(),f(p,{key:1,variant:"tonal",size:"small",class:"mt-2","prepend-icon":"mdi-refresh",onClick:n.fetchCommits,loading:l.loadingCommits},{default:t(()=>e[19]||(e[19]=[i(" 刷新提交列表 ",-1)])),_:1,__:[19]},8,["onClick","loading"]))]),_:1}),s(j,{cols:"12"},{default:t(()=>[s(S,{modelValue:l.form.docs,"onUpdate:modelValue":e[5]||(e[5]=a=>l.form.docs=a),label:"文档路径",placeholder:"/docs/extension","prepend-inner-icon":"mdi-book-open-variant",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),s(g,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(V,{class:"text-subtitle-1"},{default:t(()=>e[20]||(e[20]=[i("扩展图标",-1)])),_:1,__:[20]}),s(C,null,{default:t(()=>[s(K,{modelValue:l.imageMode,"onUpdate:modelValue":e[6]||(e[6]=a=>l.imageMode=a),inline:""},{default:t(()=>[s(z,{label:"跟随项目",value:"project"}),s(z,{label:"自定义图标",value:"custom"})]),_:1},8,["modelValue"]),l.imageMode==="custom"?(m(),f(S,{key:0,modelValue:l.form.image,"onUpdate:modelValue":e[7]||(e[7]=a=>l.form.image=a),label:"图标文件名",placeholder:"icon.png","prepend-inner-icon":"mdi-image",variant:"outlined",density:"compact",class:"mt-2"},null,8,["modelValue"])):v("",!0),h("div",te,[s(L,{size:"48",class:"mr-3"},{default:t(()=>[n.previewImage?(m(),f(I,{key:0,src:n.previewImage},null,8,["src"])):(m(),f(_,{key:1,size:"24"},{default:t(()=>e[21]||(e[21]=[i("mdi-puzzle",-1)])),_:1,__:[21]}))]),_:1}),h("div",null,[e[22]||(e[22]=h("div",{class:"text-body-2"},"预览",-1)),h("div",se,c(l.imageMode==="project"?"使用项目默认图标":l.form.image||"默认图标"),1)])])]),_:1})]),_:1}),s(g,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(V,{class:"text-subtitle-1"},{default:t(()=>e[23]||(e[23]=[i("示例项目",-1)])),_:1,__:[23]}),s(C,null,{default:t(()=>[h("div",le,[s(U,{modelValue:l.selectedSampleProjectId,"onUpdate:modelValue":e[8]||(e[8]=a=>l.selectedSampleProjectId=a),multiple:!1,author:"me"},{default:t(()=>[s(p,{class:"ml-2",variant:"outlined"},{default:t(()=>e[24]||(e[24]=[i(" 选择 ",-1)])),_:1,__:[24]})]),_:1},8,["modelValue"])]),l.selectedSampleProject?(m(),y("div",oe,[s(g,{variant:"outlined",class:"mb-2"},{default:t(()=>[s(Y,null,{prepend:t(()=>[s(L,null,{default:t(()=>{var a;return[s(I,{src:l.localuser.getUserAvatar((a=l.selectedSampleProject.author)==null?void 0:a.avatar)||""},null,8,["src"])]}),_:1})]),default:t(()=>[s(V,{class:"text-subtitle-2"},{default:t(()=>[i(c(l.selectedSampleProject.title),1)]),_:1}),s(J,null,{default:t(()=>{var a,u;return[i("by "+c(((a=l.selectedSampleProject.author)==null?void 0:a.display_name)||((u=l.selectedSampleProject.author)==null?void 0:u.username)),1)]}),_:1})]),_:1})]),_:1}),s(p,{size:"small",variant:"text",color:"error","prepend-icon":"mdi-close",onClick:n.clearSampleProject},{default:t(()=>e[25]||(e[25]=[i(" 移除示例项目 ",-1)])),_:1,__:[25]},8,["onClick"])])):(m(),y("div",ae,[s(_,{size:"48"},{default:t(()=>e[26]||(e[26]=[i("mdi-file-document-outline",-1)])),_:1,__:[26]}),e[27]||(e[27]=h("p",{class:"mt-2"},"未选择示例项目",-1))]))]),_:1})]),_:1}),s(g,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(V,{class:"text-subtitle-1"},{default:t(()=>[s(_,{class:"mr-2",color:"orange"},{default:t(()=>e[28]||(e[28]=[i("mdi-puzzle",-1)])),_:1,__:[28]}),e[29]||(e[29]=i(" Scratch兼容性 ",-1))]),_:1,__:[29]}),s(C,null,{default:t(()=>[s(W,{type:"info",variant:"tonal",density:"compact",class:"mb-4"},{default:t(()=>e[30]||(e[30]=[i(" 选择此扩展是否兼容原版Scratch平台。兼容原版Scratch的扩展可以在Scratch项目中使用。 ",-1)])),_:1,__:[30]}),s(Q,{modelValue:l.form.scratchCompatible,"onUpdate:modelValue":e[9]||(e[9]=a=>l.form.scratchCompatible=a),label:"兼容原版Scratch",color:"orange","hide-details":"",class:"mb-2"},null,8,["modelValue"]),h("div",ie,c(l.form.scratchCompatible?"此扩展将可以在Scratch项目中使用":"此扩展仅适用于其他平台"),1)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(X,null,{default:t(()=>[s(Z),s(p,{onClick:n.closeDialog},{default:t(()=>e[31]||(e[31]=[i("取消",-1)])),_:1,__:[31]},8,["onClick"]),s(p,{color:"primary",loading:l.loading,onClick:n.saveExtension},{default:t(()=>e[32]||(e[32]=[i(" 保存 ",-1)])),_:1,__:[32]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const fe=F($,[["render",re],["__scopeId","data-v-edb13836"]]);export{fe as _};
