import{_ as D}from"./ProjectSelector-CVs7qRHA.js";import{_ as L,a1 as k,aa as E,Y as m,o as d,N as t,e as s,W as h,a9 as x,L as r,O as f,a3 as y,aF as I,f as n,$ as C,S as v,X as u,c as P,ad as N,F as M,U as z,ae as R,af as W,i as V,aD as Z,Z as A,n as F,aE as U,aA as S,j as H,Q as w,R as b,aU as O,aW as Q,aT as X,T as Y,ab as j,M as q}from"./index-r6fcKOtS.js";import{V as G}from"./VCheckbox-1td-2P7t.js";import{V as B}from"./VSpacer-BLecZNSl.js";import{V as J}from"./VSkeletonLoader-C7c1U_4A.js";import"https://static.geetest.com/v4/gt4.js";import"./VCheckboxBtn-ClUg9APb.js";import"./VSelectionControl-Qfuz-I_M.js";const K={name:"ExtensionCreateDialog",components:{ProjectSelector:D},props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","created"],data(){return{formValid:!1,loading:!1,s3BucketUrl:"",selectedProjects:[],scratchCompatible:!1,showProjectSelector:!1,createProgress:{current:0,total:0,isVisible:!1}}},computed:{dialog:{get(){return this.modelValue},set(o){this.$emit("update:modelValue",o)}},selectedCount(){return this.selectedProjects.length}},watch:{modelValue(o){o&&this.resetForm()}},async created(){this.s3BucketUrl=await E("s3.staticurl")},methods:{addMultipleProjects(o){this.selectedProjects=o,this.showProjectSelector=!1},removeProject(o){const e=this.selectedProjects.findIndex(c=>c.id===o.id);e>-1&&this.selectedProjects.splice(e,1)},clearAllProjects(){this.selectedProjects=[]},async createExtensions(){if(this.selectedProjects.length!==0){this.loading=!0,this.createProgress={current:0,total:this.selectedProjects.length,isVisible:!0};try{let o=0,e=0;for(let c=0;c<this.selectedProjects.length;c++){const p=this.selectedProjects[c];this.createProgress.current=c+1;try{const l={projectid:p.id,scratchCompatible:this.scratchCompatible},i=await k.post("/extensions/manager/create",l);i.data.status==="success"?o++:(e++,console.error(`Failed to create extension for project ${p.id}:`,i.data))}catch(l){e++,console.error(`Failed to create extension for project ${p.id}:`,l)}}o>0?(this.$emit("created"),this.closeDialog(),e>0?this.showMessage(`成功创建 ${o} 个扩展，${e} 个失败`,"warning"):this.showMessage(`成功创建 ${o} 个扩展`,"success")):this.showMessage("所有扩展创建失败","error")}catch(o){console.error("Failed to create extensions:",o),this.showMessage("创建扩展失败","error")}finally{this.loading=!1,this.createProgress.isVisible=!1}}},resetForm(){this.selectedProjects=[],this.scratchCompatible=!1},closeDialog(){this.dialog=!1},formatDate(o){return o?new Date(o).toLocaleDateString("zh-CN"):""},showMessage(o,e){console.log(o)}}},$={class:"d-flex align-center"},ee={key:0,class:"selected-projects"},te={class:"text-caption text-grey mb-3"},se={class:"d-flex align-center"},le={class:"flex-grow-1"},oe={class:"font-weight-medium"},ae={class:"text-caption text-grey"},re={class:"d-flex align-center"},ie={class:"text-center py-4"},ne={class:"text-center mt-3"},de={class:"text-body-2"},ue={class:"text-caption text-grey"};function ce(o,e,c,p,l,i){const _=D;return d(),m(S,{modelValue:i.dialog,"onUpdate:modelValue":e[5]||(e[5]=a=>i.dialog=a),"max-width":"800",persistent:""},{default:t(()=>[s(h,null,{default:t(()=>[s(x,{class:"d-flex align-center"},{default:t(()=>[s(f,{class:"mr-2"},{default:t(()=>e[6]||(e[6]=[r("mdi-plus",-1)])),_:1,__:[6]}),e[7]||(e[7]=r(" 创建扩展 ",-1))]),_:1,__:[7]}),s(y,null,{default:t(()=>[s(I,{ref:"form",modelValue:l.formValid,"onUpdate:modelValue":e[2]||(e[2]=a=>l.formValid=a)},{default:t(()=>[s(h,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:t(()=>[s(x,{class:"text-subtitle-1 d-flex align-center justify-space-between"},{default:t(()=>[e[8]||(e[8]=n("span",null,"选择项目",-1)),n("div",$,[l.selectedProjects.length>0?(d(),m(v,{key:0,color:"primary",size:"small",variant:"tonal"},{default:t(()=>[r(u(l.selectedProjects.length)+" 个项目 ",1)]),_:1})):C("",!0)])]),_:1,__:[8]}),s(y,null,{default:t(()=>[l.selectedProjects.length>0?(d(),P("div",ee,[n("div",te," 已选择 "+u(l.selectedProjects.length)+" 个项目 ",1),s(N,{class:"project-list"},{default:t(()=>[(d(!0),P(M,null,z(l.selectedProjects,a=>(d(),m(R,{key:a.id,class:"project-item mb-2",variant:"outlined",rounded:""},{prepend:t(()=>[s(A,{size:"32",class:"mr-3"},{default:t(()=>[a.thumbnail?(d(),m(F,{key:0,src:`${l.s3BucketUrl}/${a.thumbnail}`,alt:a.title},null,8,["src","alt"])):(d(),m(f,{key:1},{default:t(()=>e[9]||(e[9]=[r("mdi-folder",-1)])),_:1,__:[9]}))]),_:2},1024)]),append:t(()=>[n("div",re,[a.state==="public"?(d(),m(v,{key:0,color:"success",size:"small",variant:"tonal",class:"mr-2"},{default:t(()=>e[10]||(e[10]=[r(" 公开 ",-1)])),_:1,__:[10]})):a.state==="private"?(d(),m(v,{key:1,color:"error",size:"small",variant:"tonal",class:"mr-2"},{default:t(()=>e[11]||(e[11]=[r(" 私密 ",-1)])),_:1,__:[11]})):C("",!0),s(V,{icon:"mdi-close",size:"small",variant:"text",color:"error",onClick:Z(g=>i.removeProject(a),["stop"])},null,8,["onClick"])])]),default:t(()=>[s(W,null,{default:t(()=>{var g;return[n("div",se,[n("div",le,[n("div",oe,u(a.title),1),n("div",ae,u(((g=a.author)==null?void 0:g.username)||"未知用户")+" • "+u(i.formatDate(a.updated_at)),1)])])]}),_:2},1024)]),_:2},1024))),128))]),_:1})])):C("",!0),n("div",ie,[s(V,{color:"primary",size:"large",onClick:e[0]||(e[0]=a=>l.showProjectSelector=!0)},{default:t(()=>[s(f,{class:"mr-2"},{default:t(()=>e[12]||(e[12]=[r("mdi-folder-multiple",-1)])),_:1,__:[12]}),r(" "+u(l.selectedProjects.length>0?"重新选择项目":"选择项目"),1)]),_:1}),l.selectedProjects.length>0?(d(),m(V,{key:0,variant:"outlined",color:"error",class:"ml-2",onClick:i.clearAllProjects},{default:t(()=>e[13]||(e[13]=[r(" 清空所有 ",-1)])),_:1,__:[13]},8,["onClick"])):C("",!0)])]),_:1})]),_:1}),s(h,{variant:"tonal",border:"",class:"mb-4"},{default:t(()=>[s(x,{class:"text-subtitle-1"},{default:t(()=>e[14]||(e[14]=[r("批量设置",-1)])),_:1,__:[14]}),s(y,null,{default:t(()=>[s(G,{modelValue:l.scratchCompatible,"onUpdate:modelValue":e[1]||(e[1]=a=>l.scratchCompatible=a),label:"兼容 Scratch","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(U,null,{default:t(()=>[s(B),s(V,{onClick:i.closeDialog},{default:t(()=>e[15]||(e[15]=[r("取消",-1)])),_:1,__:[15]},8,["onClick"]),s(V,{color:"primary",loading:l.loading,disabled:l.selectedProjects.length===0,onClick:i.createExtensions},{default:t(()=>[r(" 创建扩展 ("+u(l.selectedProjects.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1}),s(S,{modelValue:l.createProgress.isVisible,"onUpdate:modelValue":e[3]||(e[3]=a=>l.createProgress.isVisible=a),persistent:"","max-width":"400"},{default:t(()=>[s(h,null,{default:t(()=>[s(x,{class:"text-center"},{default:t(()=>e[16]||(e[16]=[r(" 正在创建扩展... ",-1)])),_:1,__:[16]}),s(y,null,{default:t(()=>[s(H,{"model-value":l.createProgress.current/l.createProgress.total*100,color:"primary",height:"8",rounded:""},null,8,["model-value"]),n("div",ne,[n("p",de,u(l.createProgress.current)+" / "+u(l.createProgress.total),1),n("p",ue," 正在处理第 "+u(l.createProgress.current)+" 个项目... ",1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(_,{modelValue:l.showProjectSelector,"onUpdate:modelValue":e[4]||(e[4]=a=>l.showProjectSelector=a),projects:[],onMultiSelect:i.addMultipleProjects},null,8,["modelValue","onMultiSelect"])]),_:1},8,["modelValue"])}const T=L(K,[["render",ce],["__scopeId","data-v-0ee0047a"]]),me={name:"ExtensionsManagement",components:{ExtensionCreateDialog:T},setup(){q({title:"扩展管理 - ZeroCat"})},data(){return{loading:!1,extensions:[],myProjects:[],s3BucketUrl:"",showCreateDialog:!1,showEditDialog:!1,editFormValid:!1,editLoading:!1,editTarget:null,editForm:{branch:"",commit:"",image:"",samples:null,docs:""},showDeleteDialog:!1,deleteLoading:!1,deleteTarget:null,pushAllLoading:!1,updateAllLoading:!1,snackbar:{show:!1,message:"",color:"success"}}},async created(){if(j.isLogin.value===!1){this.$router.push("/app/account/login");return}this.s3BucketUrl=await E("s3.staticurl"),await Promise.all([this.fetchExtensions(),this.fetchMyProjects()])},methods:{async fetchExtensions(){this.loading=!0;try{const o=await k.get("/extensions/manager/my");o.data.status==="success"&&(this.extensions=o.data.data)}catch(o){console.error("Failed to fetch extensions:",o),this.showMessage("扩展管理失败","error")}finally{this.loading=!1}},async fetchMyProjects(){try{console.log(j.user);const o=await k.get("/searchapi",{params:{search_userid:j.user.value.id,search_state:"public",limit:100}});o.data&&o.data.projects&&(this.myProjects=o.data.projects)}catch(o){console.error("Failed to fetch my projects:",o)}},getStatusColor(o){return{developing:"primary",pending:"warning",verified:"success",rejected:"error"}[o]||"grey"},getStatusText(o){return{developing:"开发中",pending:"待审核",verified:"已审核",rejected:"已拒绝"}[o]||"未知"},showMessage(o,e="success"){this.snackbar={show:!0,message:o,color:e}},async pushAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可推送的扩展","warning");return}this.pushAllLoading=!0;try{const o=this.extensions.map(l=>k.post(`/extensions/manager/submit/${l.id}`)),c=(await Promise.allSettled(o)).filter(l=>{var i,_;return l.status==="fulfilled"&&((_=(i=l.value)==null?void 0:i.data)==null?void 0:_.status)==="success"}).length,p=this.extensions.length-c;p===0?this.showMessage(`成功推送 ${c} 个扩展`,"success"):this.showMessage(`推送完成: ${c} 个成功, ${p} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to push all extensions:",o),this.showMessage("批量推送失败","error")}finally{this.pushAllLoading=!1}},async updateAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可更新的扩展","warning");return}this.updateAllLoading=!0;try{const o=this.extensions.map(l=>k.post(`/extensions/manager/update/${l.id}`)),c=(await Promise.allSettled(o)).filter(l=>{var i,_;return l.status==="fulfilled"&&((_=(i=l.value)==null?void 0:i.data)==null?void 0:_.status)==="success"}).length,p=this.extensions.length-c;p===0?this.showMessage(`成功更新 ${c} 个扩展`,"success"):this.showMessage(`更新完成: ${c} 个成功, ${p} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to update all extensions:",o),this.showMessage("批量更新失败","error")}finally{this.updateAllLoading=!1}}}},fe={class:"d-flex align-center mb-2"},ge={class:"text-caption"},pe={class:"d-flex align-center mb-2"},_e={class:"text-caption"},he={key:0,class:"d-flex align-center mb-2"},xe={class:"text-caption"},ye={class:"d-flex align-center mb-2"},Ve={class:"text-caption"};function be(o,e,c,p,l,i){const _=T;return d(),m(Y,null,{default:t(()=>[s(w,null,{default:t(()=>[s(b,{cols:"12"},{default:t(()=>[s(h,{variant:"flat"},{default:t(()=>[s(x,{class:"d-flex align-center"},{default:t(()=>[s(f,{class:"mr-2"},{default:t(()=>e[3]||(e[3]=[r("mdi-puzzle",-1)])),_:1,__:[3]}),e[5]||(e[5]=r(" 扩展管理 ",-1)),s(B),s(V,{color:"success","prepend-icon":"mdi-plus",onClick:e[0]||(e[0]=a=>l.showCreateDialog=!0)},{default:t(()=>e[4]||(e[4]=[r(" 创建扩展 ",-1)])),_:1,__:[4]})]),_:1,__:[5]}),s(y,null,{default:t(()=>[l.loading?(d(),m(w,{key:0},{default:t(()=>[(d(),P(M,null,z(6,a=>s(b,{key:a,cols:"12",md:"6",lg:"4"},{default:t(()=>[s(J,{type:"card"})]),_:2},1024)),64))]),_:1})):l.extensions.length===0?(d(),m(w,{key:1},{default:t(()=>[s(b,{cols:"12",class:"text-center py-8"},{default:t(()=>[s(f,{size:"64",color:"grey-lighten-1"},{default:t(()=>e[6]||(e[6]=[r("mdi-puzzle-outline",-1)])),_:1,__:[6]}),e[7]||(e[7]=n("p",{class:"text-h6 mt-4 text-grey-darken-1"},"扩展管理",-1)),e[8]||(e[8]=n("p",{class:"text-body-2 text-grey"},"扩展管理",-1))]),_:1,__:[7,8]})]),_:1})):(d(),m(w,{key:2},{default:t(()=>[(d(!0),P(M,null,z(l.extensions,a=>(d(),m(b,{key:a.id,cols:"12",md:"6",lg:"4"},{default:t(()=>[s(h,{class:"extension-card",variant:"tonal",border:"",hover:""},{default:t(()=>[s(O,null,{prepend:t(()=>[s(A,{size:"48"},{default:t(()=>[a.image?(d(),m(F,{key:0,src:l.s3BucketUrl+"/material/asset/"+a.image+".png"},null,8,["src"])):(d(),m(f,{key:1,size:"24"},{default:t(()=>e[9]||(e[9]=[r("mdi-puzzle",-1)])),_:1,__:[9]}))]),_:2},1024)]),append:t(()=>[s(v,{color:i.getStatusColor(a.status),size:"small",variant:"flat"},{default:t(()=>[r(u(i.getStatusText(a.status)),1)]),_:2},1032,["color"])]),default:t(()=>[s(x,null,{default:t(()=>{var g;return[r(u(((g=a.project)==null?void 0:g.title)||"扩展"),1)]}),_:2},1024),s(Q,null,{default:t(()=>{var g;return[r(u(((g=a.project)==null?void 0:g.description)||"扩展"),1)]}),_:2},1024)]),_:2},1024),s(y,null,{default:t(()=>{var g;return[n("div",fe,[s(f,{class:"mr-1",size:"small"},{default:t(()=>e[10]||(e[10]=[r("mdi-source-branch",-1)])),_:1,__:[10]}),n("span",ge,u(a.branch||"main"),1)]),n("div",pe,[s(f,{class:"mr-1",size:"small"},{default:t(()=>e[11]||(e[11]=[r("mdi-source-commit",-1)])),_:1,__:[11]}),n("span",_e,u(((g=a.commit)==null?void 0:g.substring(0,8))||"latest"),1)]),a.sample_project?(d(),P("div",he,[s(f,{class:"mr-1",size:"small"},{default:t(()=>e[12]||(e[12]=[r("mdi-file-document",-1)])),_:1,__:[12]}),n("span",xe,"示例项目: "+u(a.sample_project.title),1)])):C("",!0),n("div",ye,[s(f,{class:"mr-1",size:"small"},{default:t(()=>e[13]||(e[13]=[r("mdi-puzzle",-1)])),_:1,__:[13]}),n("span",Ve,u(a.scratchCompatible?"兼容原版Scratch":"不兼容原版Scratch"),1)])]}),_:2},1024),s(U,null,{default:t(()=>[s(V,{variant:"text",size:"small",to:`/app/extensions/my/${a.id}`},{default:t(()=>e[14]||(e[14]=[r(" 查看详情 ",-1)])),_:2,__:[14]},1032,["to"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1}),s(_,{modelValue:l.showCreateDialog,"onUpdate:modelValue":e[1]||(e[1]=a=>l.showCreateDialog=a),onCreated:i.fetchExtensions},null,8,["modelValue","onCreated"]),s(w,{class:"mt-6"},{default:t(()=>[s(b,{cols:"12"},{default:t(()=>[s(h,{variant:"flat",border:""},{default:t(()=>[s(x,{class:"d-flex align-center"},{default:t(()=>[s(f,{class:"mr-2"},{default:t(()=>e[15]||(e[15]=[r("mdi-cog",-1)])),_:1,__:[15]}),e[16]||(e[16]=r(" 高级设置 ",-1))]),_:1,__:[16]}),s(y,null,{default:t(()=>[s(w,null,{default:t(()=>[s(b,{cols:"12",md:"6"},{default:t(()=>[s(h,{variant:"tonal",border:""},{default:t(()=>[s(x,{class:"text-h6"},{default:t(()=>[s(f,{class:"mr-2",color:"primary"},{default:t(()=>e[17]||(e[17]=[r("mdi-cloud-upload",-1)])),_:1,__:[17]}),e[18]||(e[18]=r(" 批量推送 ",-1))]),_:1,__:[18]}),s(y,null,{default:t(()=>[e[19]||(e[19]=n("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 批量同步扩展时使用 ",-1)),s(V,{color:"primary",loading:l.pushAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-cloud-upload",onClick:i.pushAllExtensions,block:""},{default:t(()=>[r(" 全部推送 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1,__:[19]})]),_:1})]),_:1}),s(b,{cols:"12",md:"6"},{default:t(()=>[s(h,{variant:"tonal",border:""},{default:t(()=>[s(x,{class:"text-h6"},{default:t(()=>[s(f,{class:"mr-2",color:"success"},{default:t(()=>e[20]||(e[20]=[r("mdi-update",-1)])),_:1,__:[20]}),e[21]||(e[21]=r(" 批量更新 ",-1))]),_:1,__:[21]}),s(y,null,{default:t(()=>[e[22]||(e[22]=n("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 这是谁提的需求？ ",-1)),s(V,{color:"success",loading:l.updateAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-update",onClick:i.updateAllExtensions,block:""},{default:t(()=>[r(" 一键更新 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1,__:[22]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(X,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[2]||(e[2]=a=>l.snackbar.show=a),color:l.snackbar.color},{default:t(()=>[r(u(l.snackbar.message),1)]),_:1},8,["modelValue","color"])]),_:1})}const Se=L(me,[["render",be],["__scopeId","data-v-67c7404d"]]);export{Se as default};
