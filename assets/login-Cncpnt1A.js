import{_ as V}from"./LoadingDialog-Bn5c6Tga.js";import{_}from"./Recaptcha-BYnss2zs.js";import{_ as B,ad as b,a as g,o as c,M as h,h as s,N as r,U as R,ar as T,as as w,K as d,F as y,j as a,T as E,S as L,ah as u,Y as x,L as U,r as W}from"./index-MVQDERPj.js";import{l as N}from"./accountService-BGVq9Lkw.js";import{V as v,a as l}from"./VRow-ENHfMIVU.js";import{V as z}from"./VForm-deKCvaQi.js";import{V as m}from"./VTextField-54aRKAkU.js";import"./VDialog-5sI5h_yT.js";import"https://static.geetest.com/v4/gt4.js";/* empty css              */import"./VInput-CcppYf00.js";/* empty css                   */const A={components:{LoadingDialog:V,Recaptcha:_},data(){return{BASE_API:"https://zerocat-api.houlangs.com",username:"",password:"",verificationCode:"",loginType:"password",countdown:0,tryinguser:{},loading:!1,localuser:u,show1:W(!1),rules:{required:t=>!!t||"此字段为必填项",length:t=>(t==null?void 0:t.length)===6||"验证码必须是6位数字"},emailRules:[t=>t?!0:"必须填写邮箱",t=>/.+@.+\..+/.test(t)?!0:"不符合格式"],usernameRules:[t=>t?!0:"必须填写密码"]}},created(){u.isLogin.value===!0&&this.$router.push("/")},setup(){U({title:"登录"})},methods:{async handleLogin(){this.loginType==="password"?await this.loginWithPassword():await this.loginWithCode()},async loginWithPassword(){this.loading=!0;try{const t=await N({captcha:this.$refs.recaptcha.getResponse(),un:this.username,pw:this.password});this.handleLoginResponse(t)}catch(t){this.handleError(t)}finally{this.loading=!1}},async loginWithCode(){if(!this.verificationCode||this.verificationCode.length!==6){this.$toast.add({severity:"error",summary:"错误",detail:"请输入6位验证码",life:3e3});return}this.loading=!0;try{const t=await x.post("/account/login-with-code",{email:this.username,code:this.verificationCode});this.handleLoginResponse(t)}catch(t){this.handleError(t)}finally{this.loading=!1}},async sendVerificationCode(){if(!(this.countdown>0)){if(!this.username||!/.+@.+\..+/.test(this.username)){this.$toast.add({severity:"error",summary:"错误",detail:"请输入正确的邮箱地址",life:3e3});return}this.$refs.recaptcha.showBindCaptcha()}},async handleBindVerified(t){this.loading=!0;try{const e=await x.post("/account/send-login-code",{email:this.username,captcha:t});e.data.status==="success"?(this.$toast.add({severity:"success",summary:"成功",detail:"验证码已发送",life:3e3}),this.startCountdown()):this.$toast.add({severity:"error",summary:"错误",detail:e.data.message,life:3e3})}catch(e){this.handleError(e)}finally{this.loading=!1}},handleBindError(){this.$toast.add({severity:"error",summary:"错误",detail:"验证失败，请重试",life:3e3})},handleBindClose(){},startCountdown(){this.countdown=60;const t=setInterval(()=>{this.countdown--,this.countdown<=0&&clearInterval(t)},1e3)},async handleLoginResponse(t){this.tryinguser=t.data,this.tryinguser.status==="success"?(await u.setUser({token:this.tryinguser.token,refresh_token:this.tryinguser.refresh_token,expires_at:this.tryinguser.expires_at,refresh_expires_at:this.tryinguser.refresh_expires_at}),this.$toast.add({severity:"success",summary:"登录成功",detail:"欢迎回来，"+this.tryinguser.display_name,life:3e3}),window.location.replace("/app/explore")):this.$toast.add({severity:"info",summary:"info",detail:this.tryinguser.message,life:3e3})},handleError(t){var e,p;this.$toast.add({severity:"error",summary:"错误",detail:((p=(e=t.response)==null?void 0:e.data)==null?void 0:p.message)||t.message,life:3e3})},loginWithOAuth(t){const e=u.getToken();window.location.href=`https://zerocat-api.houlangs.com/account/oauth/${t}?token=${e}`}}},I={class:"auth-wrapper d-flex align-center justify-center pa-4"};function F(t,e,p,D,o,n){const f=b("v-cardtext"),C=_,k=V;return c(),g(y,null,[h("div",I,[s(L,{class:"auth-card pa-4 pt-7","max-width":"448",border:"",rounded:"lg"},{default:r(()=>[s(v,null,{default:r(()=>[s(l,{cols:"12"},{default:r(()=>[s(f,null,{default:r(()=>e[7]||(e[7]=[h("h5",{class:"text-h5 font-weight-semibold mb-1"}," 欢迎来到ZeroCat！ 👋🏻 ",-1),h("p",{class:"mb-0"},"登录你的账户",-1)])),_:1})]),_:1})]),_:1}),s(f,null,{default:r(()=>[s(z,null,{default:r(()=>[s(v,null,{default:r(()=>[s(l,{cols:"12"},{default:r(()=>[s(T,{modelValue:o.loginType,"onUpdate:modelValue":e[0]||(e[0]=i=>o.loginType=i),class:"mb-4"},{default:r(()=>[s(w,{value:"password",variant:"text"},{default:r(()=>e[8]||(e[8]=[d("密码登录")])),_:1}),s(w,{value:"code",variant:"text"},{default:r(()=>e[9]||(e[9]=[d("验证码登录")])),_:1})]),_:1},8,["modelValue"]),s(m,{label:"邮箱",type:"text",modelValue:o.username,"onUpdate:modelValue":e[1]||(e[1]=i=>o.username=i),variant:"outlined",rules:o.emailRules},null,8,["modelValue","rules"]),o.loginType==="password"?(c(),R(m,{key:0,label:"密码",modelValue:o.password,"onUpdate:modelValue":e[2]||(e[2]=i=>o.password=i),variant:"outlined",rules:o.usernameRules,"append-icon":o.show1?"mdi-eye":"mdi-eye-off",type:o.show1?"text":"password","onClick:append":e[3]||(e[3]=i=>o.show1=!o.show1)},null,8,["modelValue","rules","append-icon","type"])):(c(),g(y,{key:1},[s(m,{modelValue:o.verificationCode,"onUpdate:modelValue":e[4]||(e[4]=i=>o.verificationCode=i),label:"验证码",variant:"outlined",maxlength:"6",rules:[o.rules.required,o.rules.length]},null,8,["modelValue","rules"]),s(a,{class:"mb-4",variant:"text",onClick:n.sendVerificationCode,disabled:o.countdown>0},{default:r(()=>[d(E(o.countdown>0?`${o.countdown}秒后重新发送`:"发送验证码"),1)]),_:1},8,["onClick","disabled"])],64))]),_:1}),s(l,{cols:"9"},{default:r(()=>[s(C,{ref:"recaptcha",recaptchaId:"recaptcha-div",showNormal:o.loginType==="password",onBindVerified:n.handleBindVerified,onBindError:n.handleBindError,onBindClose:n.handleBindClose},null,8,["showNormal","onBindVerified","onBindError","onBindClose"])]),_:1}),s(l,{cols:"12"},{default:r(()=>[s(a,{class:"text-none",color:"primary",rounded:"xl",text:"登录",variant:"flat",size:"large",onClick:n.handleLogin,"append-icon":"mdi-arrow-right"},null,8,["onClick"])]),_:1}),s(l,{cols:"12"},{default:r(()=>[s(a,{class:"text-none",color:"white",rounded:"xl",text:"注册",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/register"}),s(a,{class:"text-none",color:"white",rounded:"xl",text:"找回密码",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/retrieve"})]),_:1}),s(l,{cols:"12"},{default:r(()=>[s(a,{onClick:e[5]||(e[5]=i=>n.loginWithOAuth("microsoft")),color:"blue","prepend-icon":"mdi-microsoft"},{default:r(()=>e[10]||(e[10]=[d("使用 Microsoft 登录")])),_:1}),s(a,{onClick:e[6]||(e[6]=i=>n.loginWithOAuth("github")),color:"black","prepend-icon":"mdi-github"},{default:r(()=>e[11]||(e[11]=[d("使用 GitHub 登录")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),s(k,{show:o.loading,text:"登录中"},null,8,["show"])],64)}const Q=B(A,[["render",F]]);export{Q as default};
