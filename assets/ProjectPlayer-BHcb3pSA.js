import{_ as B}from"./UserRelationControls-BTfh9Q2Y.js";import{_ as g,aa as N,ab as Q,Y as f,o as d,N as i,e,aN as U,aO as W,a9 as D,L as l,X as n,aP as q,Z as E,n as A,W as h,a1 as X,i as c,O as S,a0 as v,az as Y,$ as _,j as Z,ad as H,c as y,F as T,U as M,ae as x,aD as w,af as L,ag as J,aE as I,aA as K,a3 as $,aB as k,m as tt,aQ as O,aR as et,f as u,S as m,an as rt}from"./index-k6-8hKoX.js";import{c as st,a as P,r as it,u as at,s as ot,b as lt,d as nt}from"./projectListService-DEd1keDh.js";import{V as C}from"./VSpacer-BY-Xu9R1.js";import{V as dt}from"./VSelect-BWScM8_a.js";import{_ as F}from"./TimeAgo-DKQ-udHz.js";import{o as ut}from"./openEdit-AJJkPSPH.js";const ct={name:"ProjectAuthorCard",components:{UserRelationControls:B},props:{author:{type:Object,required:!0}},data(){return{localuser:Q,loading:!1,error:null,s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await N("s3.staticurl")}};function mt(t,s,r,j,a,p){const o=B;return d(),f(h,{hover:"",to:"/"+r.author.username,border:""},{default:i(()=>[e(U,null,W({prepend:i(()=>[e(E,null,{default:i(()=>[e(A,{alt:r.author.display_name,src:a.s3BucketUrl+"/user/"+r.author.avatar},null,8,["alt","src"])]),_:1})]),default:i(()=>[e(D,{class:"text-white"},{default:i(()=>[l(n(r.author.display_name),1)]),_:1}),e(q,{class:"text-white"},{default:i(()=>[l(n(r.author.bio),1)]),_:1})]),_:2},[a.localuser.id&&a.localuser.id!==r.author.id?{name:"append",fn:i(()=>[e(o,{"user-id":r.author.id,username:r.author.username,"display-name":r.author.display_name},null,8,["user-id","username","display-name"])]),key:"0"}:void 0]),1024)]),_:1},8,["to"])}const z=g(ct,[["render",mt]]),ft={props:{projectId:{type:[String,Number],required:!0,validator:t=>t==null?!1:typeof t=="string"?t.trim()!=="":typeof t=="number"?!isNaN(t)&&t>0:!1}},data(){return{isStarred:!1,starCount:0,starLoading:!1,listLoading:!1,creatingList:!1,isVisibleDialog:!1,menu:!1,myLists:[],newListInfo:{title:"",description:"",state:"private"},listStates:[{state:"私密",abbr:"private"},{state:"公开",abbr:"public"}],error:null}},computed:{isValidProjectId(){return this.projectId!==void 0&&this.projectId!==null&&(typeof this.projectId=="string"?this.projectId.trim()!=="":!isNaN(this.projectId)&&this.projectId>0)}},async created(){this.isValidProjectId?(await this.checkStarStatus(),await this.getStarCount()):(console.error("Invalid projectId provided:",this.projectId),this.error="无效的项目ID")},watch:{menu(t){t&&this.isValidProjectId&&this.fetchMyLists()},projectId:{immediate:!0,handler(t){this.isValidProjectId&&(this.checkStarStatus(),this.getStarCount())}}},methods:{async checkStarStatus(){if(this.isValidProjectId)try{const t=await nt(this.projectId);if((t==null?void 0:t.status)==="success")this.isStarred=t.star;else throw new Error((t==null?void 0:t.message)||"检查收藏状态失败")}catch(t){console.error("检查收藏状态失败:",t),this.error=t.message||"检查收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}},async getStarCount(){if(this.isValidProjectId){try{const t=await lt(this.projectId);if((t==null?void 0:t.status)==="success")this.starCount=t.data;else throw new Error((t==null?void 0:t.message)||"获取收藏数失败")}catch(t){console.error("获取收藏数失败:",t),this.error=t.message||"获取收藏数失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}this.$emit("star-updated")}},async toggleStar(){if(!this.isValidProjectId){this.$toast.add({severity:"error",summary:"错误",detail:"无效的项目ID",life:3e3});return}this.starLoading=!0;try{const t=this.isStarred?await at(this.projectId):await ot(this.projectId);if((t==null?void 0:t.status)==="success")this.isStarred=!this.isStarred,await this.getStarCount(),this.$toast.add({severity:"success",summary:"成功",detail:t.message,life:2e3});else throw new Error((t==null?void 0:t.message)||"操作失败")}catch(t){console.error("切换收藏状态失败:",t),this.error=t.message||"切换收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.starLoading=!1}},async fetchMyLists(){var t,s;if(this.isValidProjectId){this.listLoading=!0;try{const r=await X.get(`/projectlist/lists/check?projectid=${this.projectId}`);if(((t=r==null?void 0:r.data)==null?void 0:t.status)==="success")this.myLists=r.data.data||[];else throw new Error(((s=r==null?void 0:r.data)==null?void 0:s.message)||"获取列表状态失败")}catch(r){console.error("获取我的列表失败:",r),this.error=r.message||"获取我的列表失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.listLoading=!1}}},async toggleListItem(t){const s=this.myLists.find(r=>r.id===t);if(s){s.loading=!0;try{let r;s.hasProject?(r=await it(t,this.projectId),r.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已从列表中移除",life:3e3}),s.hasProject=!1)):(r=await P(t,this.projectId),r.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已添加到列表",life:3e3}),s.hasProject=!0))}catch(r){console.error("操作列表失败:",r),this.$toast.add({severity:"error",summary:"错误",detail:"操作失败",life:3e3})}finally{s.loading=!1}}},async createNewList(){if(this.newListInfo.title){this.creatingList=!0;try{const t=await st(this.newListInfo);t.status==="success"?(this.$toast.add({severity:"success",summary:"成功",detail:"列表创建成功",life:3e3}),this.newListInfo={title:"",description:"",state:"private"},this.isVisibleDialog=!1,t.data&&t.data.id&&await P(t.data.id,this.projectId),await this.fetchMyLists()):this.$toast.add({severity:"error",summary:"错误",detail:t.message||"创建列表失败",life:3e3})}catch(t){console.error("创建列表失败:",t),this.$toast.add({severity:"error",summary:"错误",detail:"创建列表失败",life:3e3})}finally{this.creatingList=!1}}}}};function pt(t,s,r,j,a,p){return d(),f(O,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:i(()=>[e(c,{onClick:p.toggleStar,variant:"tonal",class:"text-none",text:"Star",loading:a.starLoading},{prepend:i(()=>[e(S,{icon:a.isStarred?"mdi-star":"mdi-star-outline",color:a.isStarred?"yellow":""},null,8,["icon","color"])]),default:i(()=>[l(" "+n(a.isStarred?"Starred":"Star")+" "+n(a.starCount),1)]),_:1},8,["onClick","loading"]),e(v,{color:"surface-light",vertical:""}),e(Y,{"close-on-content-click":!1,modelValue:a.menu,"onUpdate:modelValue":s[8]||(s[8]=o=>a.menu=o)},{activator:i(({props:o})=>[e(c,tt({class:"px-5",icon:"mdi-menu-down"},o),null,16)]),default:i(()=>[e(h,{"min-width":"300","max-width":"400"},{default:i(()=>[a.listLoading?(d(),f(Z,{key:0,indeterminate:"",color:"primary"})):_("",!0),e(H,null,{default:i(()=>[(d(!0),y(T,null,M(a.myLists,o=>(d(),y("div",{key:o.id},[e(x,{"prepend-icon":o.hasProject?"mdi-check-circle":"mdi-playlist-plus",active:o.hasProject,"prepend-icon-color":o.hasProject?"success":void 0,onClick:w(b=>p.toggleListItem(o.id),["stop"])},{default:i(()=>[e(L,null,{default:i(()=>[l(n(o.title),1)]),_:2},1024),e(J,null,{default:i(()=>[l(n(o.description),1)]),_:2},1024)]),_:2},1032,["prepend-icon","active","prepend-icon-color","onClick"])]))),128)),e(v,{class:"my-2"}),e(x,{onClick:s[0]||(s[0]=w(o=>a.isVisibleDialog=!0,["stop"]))},{prepend:i(()=>[e(S,null,{default:i(()=>s[9]||(s[9]=[l("mdi-plus")])),_:1,__:[9]})]),default:i(()=>[e(L,null,{default:i(()=>s[10]||(s[10]=[l("新建列表")])),_:1,__:[10]})]),_:1})]),_:1}),e(I,null,{default:i(()=>[e(C),e(c,{text:"关闭",variant:"text",onClick:s[1]||(s[1]=o=>a.menu=!1)})]),_:1})]),_:1}),e(K,{modelValue:a.isVisibleDialog,"onUpdate:modelValue":s[6]||(s[6]=o=>a.isVisibleDialog=o),width:"auto","min-width":"400","onClick:outside":s[7]||(s[7]=o=>a.isVisibleDialog=!1)},{default:i(()=>[e(h,{"prepend-icon":"mdi-format-list-bulleted",title:"新建列表",border:""},{default:i(()=>[e($,null,{default:i(()=>[e(k,{label:"标题",required:"",hint:"将便于查找",modelValue:a.newListInfo.title,"onUpdate:modelValue":s[2]||(s[2]=o=>a.newListInfo.title=o),rules:[o=>!!o||"标题不能为空"]},null,8,["modelValue","rules"]),e(k,{label:"简介",hint:"简要描述列表内容",modelValue:a.newListInfo.description,"onUpdate:modelValue":s[3]||(s[3]=o=>a.newListInfo.description=o)},null,8,["modelValue"]),e(dt,{modelValue:a.newListInfo.state,"onUpdate:modelValue":s[4]||(s[4]=o=>a.newListInfo.state=o),items:a.listStates,"item-title":"state","item-value":"abbr",label:"列表状态"},null,8,["modelValue","items"])]),_:1}),e(v),e(I,null,{default:i(()=>[e(C),e(c,{text:"关闭",variant:"plain",onClick:s[5]||(s[5]=o=>a.isVisibleDialog=!1)}),e(c,{color:"primary",text:"创建",variant:"tonal",onClick:w(p.createNewList,["stop"]),loading:a.creatingList,disabled:!a.newListInfo.title},null,8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})}const R=g(ft,[["render",pt]]),ht={name:"ProjectInfoCard",components:{TimeAgo:F,ProjectStar:R,ProjectAuthorCard:z},props:{project:{type:Object,required:!0},author:{type:Object,required:!0},username:{type:String,required:!0},projectname:{type:String,required:!0}},data(){return{openEditor:ut,loading:!1,error:null,stats:{pageviews:0,visitors:0},s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await N("s3.staticurl")},watch:{"project.id":{immediate:!0,handler(t){t&&this.loadProjectStats()}}},methods:{async loadProjectStats(){try{this.stats=await et(this.project.id)}catch(t){console.error("Error fetching project stats:",t),this.stats={pageviews:0,visitors:0}}}}},_t={class:"px-4 d-flex ga-2 mb-2"},yt={class:"px-4 d-flex ga-2 mb-2"},gt={class:"px-4 d-flex ga-2 mb-2"},jt={class:"px-4 d-flex ga-2 mb-2"},Vt={class:"px-4 d-flex ga-2 mb-2"},vt={class:"px-4 d-flex ga-2 mb-2"},wt={class:"px-4 d-flex ga-2 mb-2"},It={class:"px-4"};function bt(t,s,r,j,a,p){const o=F,b=R,G=z;return d(),f(h,{hover:"",border:""},{default:i(()=>[e(U,null,{default:i(()=>[e(D,null,{default:i(()=>[l(n(r.project.title),1)]),_:1}),e(q,null,{default:i(()=>[l(n(r.project.description),1)]),_:1})]),_:1}),u("div",_t,[e(m,{pill:""},{default:i(()=>[e(E,{start:""},{default:i(()=>[e(A,{src:a.s3BucketUrl+"/user/"+r.author.avatar},null,8,["src"])]),_:1}),l(n(r.author.display_name),1)]),_:1})]),u("div",yt,[e(m,{pill:"","prepend-icon":"mdi-chart-line"},{default:i(()=>[l(n(a.stats.pageviews)+"浏览",1)]),_:1}),e(m,{pill:"","prepend-icon":"mdi-account-multiple"},{default:i(()=>[l(n(a.stats.visitors)+"访客",1)]),_:1}),e(m,{pill:"","prepend-icon":"mdi-clock"},{default:i(()=>[e(o,{date:r.project.time},null,8,["date"])]),_:1})]),u("div",gt,[r.project.state=="public"?(d(),f(m,{key:0,pill:"","prepend-icon":"mdi-xml"},{default:i(()=>s[1]||(s[1]=[l("开源作品")])),_:1,__:[1]})):_("",!0),r.project.state=="private"?(d(),f(m,{key:1,pill:"","prepend-icon":"mdi-xml",color:"red",variant:"outlined"},{default:i(()=>s[2]||(s[2]=[l("私密作品")])),_:1,__:[2]})):_("",!0),e(m,{pill:"","prepend-icon":"mdi-application"},{default:i(()=>[l(n(r.project.type),1)]),_:1})]),u("div",jt,[(d(!0),y(T,null,M(r.project.tags,V=>(d(),y("div",null,[e(m,{to:`/app/projects/tag/${V.name}`},{default:i(()=>[l(n(V.name),1)]),_:2},1032,["to"])]))),256))]),u("div",Vt,[e(b,{projectId:r.project.id,starcount:r.project.star_count},null,8,["projectId","starcount"])]),u("div",vt,[e(O,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:i(()=>[e(c,{to:`/${r.username}/${r.projectname}/fork`,variant:"tonal",class:"text-none"},{default:i(()=>s[3]||(s[3]=[l(" 分叉 ")])),_:1,__:[3]},8,["to"]),e(c,{text:"",to:`/app/projects/fork/${r.project.id}`},{default:i(()=>[l(n(a.stats.forks),1)]),_:1},8,["to"])]),_:1})]),u("div",wt,[e(c,{onClick:s[0]||(s[0]=V=>a.openEditor(r.project.id,r.project.type)),variant:"text"},{default:i(()=>s[4]||(s[4]=[l("打开创造页")])),_:1,__:[4]}),e(c,{to:`/${r.username}/${r.projectname}/edit`,variant:"text"},{default:i(()=>s[5]||(s[5]=[l("编辑源文件")])),_:1,__:[5]},8,["to"])]),u("div",It,[e(G,{author:r.author},null,8,["author"])]),s[6]||(s[6]=u("br",null,null,-1))]),_:1,__:[6]})}const qt=g(ht,[["render",bt]]),St={name:"ProjectPlayer",props:{projectId:{type:[Number,String],required:!0},branch:{type:String,default:"main"},commitId:{type:String,default:"latest"},showplayer:{type:Boolean,required:!0}},computed:{embedurl(){const t=`/scratch/embed.html?id=${this.projectId}&embed=true`;return this.commitId!=="latest"?`${t}&ref=${this.commitId}`:`${t}&branch=${this.branch}&ref=${this.commitId}`}},data(){return{initProject:rt}}},xt=["src"];function Lt(t,s,r,j,a,p){return d(),y("div",null,[r.showplayer?(d(),f(h,{key:0,hover:"",border:"",style:{"aspect-ratio":"4 / 3"}},{default:i(()=>[u("iframe",{src:p.embedurl,scrolling:"no",frameborder:"0",style:{width:"100%",height:"100%"}},null,8,xt)]),_:1})):_("",!0),r.showplayer?_("",!0):(d(),f(h,{key:1,hover:"",border:"",title:"项目尚未初始化"},{default:i(()=>[e(I,null,{default:i(()=>[e(c,{onClick:s[0]||(s[0]=o=>a.initProject(r.projectId))},{default:i(()=>s[1]||(s[1]=[l("以Scratch模板初始化项目")])),_:1,__:[1]})]),_:1})]),_:1}))])}const Et=g(St,[["render",Lt]]);export{qt as _,Et as a};
