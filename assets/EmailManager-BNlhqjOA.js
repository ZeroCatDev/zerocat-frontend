import{a1 as F,r,b as Z,Y as V,o as d,N as t,e as s,a9 as N,f as n,i as m,L as o,a3 as U,c as P,F as h,U as ee,$ as C,X as _,S as W,aA as X,W as M,aF as ae,aD as le,aB as Y,a5 as te,aE as G}from"./index-CqDYMkg5.js";import{_ as se}from"./verifyEmail-D3Uc7CAN.js";import{V as re}from"./VTable-DK4NZtam.js";import{V as H}from"./VSpacer-BmIOKXlY.js";const ne=async()=>(await F.get("/account/emails")).data,oe=async(v,f)=>(await F.post("/account/add-email",{email:v,verificationCode:f})).data,ue=async(v,f)=>(await F.post("/account/remove-email",{email:v,verificationCode:f})).data,ie=async(v,f)=>(await F.post("/account/verify-email",{email:v,token:f})).data,me={__name:"EmailManager",setup(v,{expose:f}){const u=r([]),x=r(!1),D=r(!1),E=r(!1),i=r(!1),p=r(""),y=r(""),g=r(null),c=r(""),w=r("info"),$=r(!1),S=r(""),q=r(""),b=r(null),A=r(null),T={required:l=>!!l||"此字段为必填项",email:l=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||"请输入有效的邮箱地址",length:l=>(l==null?void 0:l.length)===6||"验证码必须是6位数字"},k=async()=>{try{const l=await ne();l.status==="success"&&(u.value=l.data)}catch(l){console.error("获取邮箱列表失败:",l)}},B=(l,e,a)=>{S.value=l,q.value=e,b.value=a,$.value=!0},J=l=>{b.value&&(b.value(l),b.value=null)},z=async()=>{if(!p.value){c.value="请输入新邮箱地址",w.value="error";return}const l=u.value.find(e=>e.is_primary);if(!l){c.value="未找到主邮箱",w.value="error";return}B(l.contact_value,"验证主邮箱",e=>{y.value=e,L()})},L=async()=>{if(!(!p.value||!y.value)){i.value=!0;try{const l=await oe(p.value,y.value);l.status==="success"?(await k(),I()):(c.value=l.message,w.value="error")}catch{c.value="添加邮箱失败",w.value="error"}finally{i.value=!1}}},K=l=>{g.value=l,D.value=!0},O=()=>{const l=u.value.find(e=>e.is_primary);l&&g.value&&B(l.contact_value,"验证主邮箱",async e=>{i.value=!0;try{(await ue(g.value.contact_value,e)).status==="success"&&(await k(),j())}catch(a){console.error("删除失败:",a)}finally{i.value=!1}})},I=()=>{x.value=!1,E.value=!1,p.value="",y.value="",c.value="",A.value&&A.value.reset()},j=()=>{D.value=!1,g.value=null},Q=l=>{B(l,"验证邮箱",async e=>{i.value=!0;try{(await ie(l,e)).status==="success"&&await k()}catch(a){console.error("验证失败:",a)}finally{i.value=!1}})};return Z(async()=>{await k()}),f({fetchEmails:k}),(l,e)=>(d(),V(M,{class:"mb-4"},{default:t(()=>[s(N,{class:"d-flex align-center justify-space-between"},{default:t(()=>[e[8]||(e[8]=n("span",null,"邮箱管理",-1)),s(m,{color:"primary",onClick:e[0]||(e[0]=a=>x.value=!0),disabled:u.value.length>=5},{default:t(()=>e[7]||(e[7]=[o(" 添加邮箱 ")])),_:1,__:[7]},8,["disabled"])]),_:1,__:[8]}),s(U,null,{default:t(()=>[s(re,null,{default:t(()=>[e[12]||(e[12]=n("thead",null,[n("tr",null,[n("th",null,"邮箱地址"),n("th",null,"状态"),n("th",null,"添加时间"),n("th",null,"操作")])],-1)),n("tbody",null,[(d(!0),P(h,null,ee(u.value,a=>(d(),P("tr",{key:a.contact_id},[n("td",null,[o(_(a.contact_value)+" ",1),a.is_primary?(d(),V(W,{key:0,color:"primary",size:"small",class:"ml-2"},{default:t(()=>e[9]||(e[9]=[o("主邮箱")])),_:1,__:[9]})):C("",!0)]),n("td",null,[s(W,{color:a.verified?"success":"warning",size:"small"},{default:t(()=>[o(_(a.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),n("td",null,_(new Date(a.created_at).toLocaleString()),1),n("td",null,[a.verified?C("",!0):(d(),V(m,{key:0,variant:"text",color:"primary",size:"small",onClick:R=>Q(a.contact_value)},{default:t(()=>e[10]||(e[10]=[o(" 验证 ")])),_:2,__:[10]},1032,["onClick"])),a.is_primary?C("",!0):(d(),V(m,{key:1,variant:"text",color:"error",size:"small",onClick:R=>K(a)},{default:t(()=>e[11]||(e[11]=[o(" 删除 ")])),_:2,__:[11]},1032,["onClick"]))])]))),128))])]),_:1,__:[12]})]),_:1}),s(X,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=a=>x.value=a),"max-width":"500px"},{default:t(()=>[s(M,null,{default:t(()=>[s(N,null,{default:t(()=>e[13]||(e[13]=[o("添加新邮箱")])),_:1,__:[13]}),s(U,null,{default:t(()=>[s(ae,{onSubmit:le(z,["prevent"]),ref_key:"addForm",ref:A},{default:t(()=>[s(Y,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=a=>p.value=a),label:"新邮箱地址",rules:[T.required,T.email],variant:"outlined"},null,8,["modelValue","rules"]),E.value?(d(),V(Y,{key:0,modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=a=>y.value=a),label:"主邮箱验证码",rules:[T.required,T.length],maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):C("",!0),c.value?(d(),V(te,{key:1,type:w.value,variant:"tonal",class:"mt-3"},{default:t(()=>[o(_(c.value),1)]),_:1},8,["type"])):C("",!0)]),_:1},512)]),_:1}),s(G,null,{default:t(()=>[s(H),s(m,{color:"grey",variant:"text",onClick:I},{default:t(()=>e[14]||(e[14]=[o("取消")])),_:1,__:[14]}),s(m,{color:"primary",loading:i.value,onClick:e[3]||(e[3]=a=>E.value?L():z())},{default:t(()=>[o(_(E.value?"添加":"发送验证码"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(X,{modelValue:D.value,"onUpdate:modelValue":e[5]||(e[5]=a=>D.value=a),"max-width":"500px"},{default:t(()=>[s(M,null,{default:t(()=>[s(N,null,{default:t(()=>e[15]||(e[15]=[o("删除邮箱")])),_:1,__:[15]}),s(U,null,{default:t(()=>{var a;return[n("p",null,"确认要删除邮箱 "+_((a=g.value)==null?void 0:a.contact_value)+" 吗？",1)]}),_:1}),s(G,null,{default:t(()=>[s(H),s(m,{color:"grey",variant:"text",onClick:j},{default:t(()=>e[16]||(e[16]=[o("取消")])),_:1,__:[16]}),s(m,{color:"error",loading:i.value,onClick:O},{default:t(()=>e[17]||(e[17]=[o(" 删除 ")])),_:1,__:[17]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(se,{modelValue:$.value,"onUpdate:modelValue":e[6]||(e[6]=a=>$.value=a),email:S.value,title:q.value,onVerified:J},null,8,["modelValue","email","title"])]),_:1}))}};export{me as _};
