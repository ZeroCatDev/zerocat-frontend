import{_ as re}from"./UserRelationControls-CYdUYhfR.js";import{_ as T,af as z,X as f,o as r,M as s,e as t,a_ as H,a$ as je,ae as v,L as a,T as m,b0 as Y,Z as J,n as Q,Y as y,a5 as D,i as p,O as V,a4 as P,aE as be,$ as h,j as ve,ah as te,c as C,F as O,W as X,ai as k,aI as $,aj as L,ak as I,aJ as A,N,aF as W,a8 as S,aG as Z,aC as se,m as Ce,b1 as oe,b2 as we,f as g,S as w,Q as F,R as E,b3 as de,b4 as ue,aH as Ve,aK as ke,D as Le,aa as Se,a6 as Ie,a9 as Pe,U as G,aY as De,b5 as Ee,ar as ze}from"./index-3iUuPb_9.js";import{c as Ue,a as le,r as Me,u as Te,s as Oe,b as Fe,d as Ae}from"./projectListService-lCYwHtd8.js";import{_ as B}from"./TimeAgo-BdwmRecu.js";import{o as Ne}from"./openEdit-BX8FwpvB.js";import{_ as me}from"./CodeRunTerminal-DabRtOo1.js";import{l as ae}from"./programming_languages-Aq2ViMcP.js";import{V as ce}from"./VTextarea-BfezW_TO.js";import{_ as fe}from"./ProjectSelector-BQfBVXWt.js";import{V as Be,a as ne}from"./VRadioGroup-DKUeRlKi.js";import{V as qe}from"./VSwitch-DbWwwZay.js";import{V as Re,a as ee}from"./VTimeline-DejC6WMn.js";const Ke={name:"ProjectAuthorCard",components:{UserRelationControls:re},props:{author:{type:Object,required:!0}},data(){return{localuser:z,loading:!1,error:null,localuser:z}}};function Ge(o,e,l,j,i,d){const u=re;return r(),f(y,{to:"/"+l.author.username,border:"",hover:""},{default:s(()=>[t(H,null,je({prepend:s(()=>[t(J,null,{default:s(()=>[t(Q,{alt:l.author.display_name,src:i.localuser.getUserAvatar(l.author.avatar)},null,8,["alt","src"])]),_:1})]),default:s(()=>[t(v,{class:"text-white"},{default:s(()=>[a(m(l.author.display_name),1)]),_:1}),t(Y,{class:"text-white"},{default:s(()=>[a(m(l.author.bio),1)]),_:1})]),_:2},[i.localuser.id&&i.localuser.id!==l.author.id?{name:"append",fn:s(()=>[t(u,{"display-name":l.author.display_name,"user-id":l.author.id,username:l.author.username},null,8,["display-name","user-id","username"])]),key:"0"}:void 0]),1024)]),_:1},8,["to"])}const pe=T(Ke,[["render",Ge]]),Ze={props:{projectId:{type:[String,Number],required:!0,validator:o=>o==null?!1:typeof o=="string"?o.trim()!=="":typeof o=="number"?!isNaN(o)&&o>0:!1}},data(){return{isStarred:!1,starCount:0,starLoading:!1,listLoading:!1,creatingList:!1,isVisibleDialog:!1,menu:!1,myLists:[],newListInfo:{title:"",description:"",state:"private"},listStates:[{state:"私密",abbr:"private"},{state:"公开",abbr:"public"}],error:null}},computed:{isValidProjectId(){return this.projectId!==void 0&&this.projectId!==null&&(typeof this.projectId=="string"?this.projectId.trim()!=="":!isNaN(this.projectId)&&this.projectId>0)}},async created(){this.isValidProjectId?(await this.checkStarStatus(),await this.getStarCount()):(console.error("Invalid projectId provided:",this.projectId),this.error="无效的项目ID")},watch:{menu(o){o&&this.isValidProjectId&&this.fetchMyLists()},projectId:{immediate:!0,handler(o){this.isValidProjectId&&(this.checkStarStatus(),this.getStarCount())}}},methods:{async checkStarStatus(){if(this.isValidProjectId)try{const o=await Ae(this.projectId);if((o==null?void 0:o.status)==="success")this.isStarred=o.star;else throw new Error((o==null?void 0:o.message)||"检查收藏状态失败")}catch(o){console.error("检查收藏状态失败:",o),this.error=o.message||"检查收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}},async getStarCount(){if(this.isValidProjectId){try{const o=await Fe(this.projectId);if((o==null?void 0:o.status)==="success")this.starCount=o.data;else throw new Error((o==null?void 0:o.message)||"获取收藏数失败")}catch(o){console.error("获取收藏数失败:",o),this.error=o.message||"获取收藏数失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}this.$emit("star-updated")}},async toggleStar(){if(!this.isValidProjectId){this.$toast.add({severity:"error",summary:"错误",detail:"无效的项目ID",life:3e3});return}this.starLoading=!0;try{const o=this.isStarred?await Te(this.projectId):await Oe(this.projectId);if((o==null?void 0:o.status)==="success")this.isStarred=!this.isStarred,await this.getStarCount(),this.$toast.add({severity:"success",summary:"成功",detail:o.message,life:2e3});else throw new Error((o==null?void 0:o.message)||"操作失败")}catch(o){console.error("切换收藏状态失败:",o),this.error=o.message||"切换收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.starLoading=!1}},async fetchMyLists(){var o,e;if(this.isValidProjectId){this.listLoading=!0;try{const l=await D.get(`/projectlist/lists/check?projectid=${this.projectId}`);if(((o=l==null?void 0:l.data)==null?void 0:o.status)==="success")this.myLists=l.data.data||[];else throw new Error(((e=l==null?void 0:l.data)==null?void 0:e.message)||"获取列表状态失败")}catch(l){console.error("获取我的列表失败:",l),this.error=l.message||"获取我的列表失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.listLoading=!1}}},async toggleListItem(o){const e=this.myLists.find(l=>l.id===o);if(e){e.loading=!0;try{let l;e.hasProject?(l=await Me(o,this.projectId),l.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已从列表中移除",life:3e3}),e.hasProject=!1)):(l=await le(o,this.projectId),l.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已添加到列表",life:3e3}),e.hasProject=!0))}catch(l){console.error("操作列表失败:",l),this.$toast.add({severity:"error",summary:"错误",detail:"操作失败",life:3e3})}finally{e.loading=!1}}},async createNewList(){if(this.newListInfo.title){this.creatingList=!0;try{const o=await Ue(this.newListInfo);o.status==="success"?(this.$toast.add({severity:"success",summary:"成功",detail:"列表创建成功",life:3e3}),this.newListInfo={title:"",description:"",state:"private"},this.isVisibleDialog=!1,o.data&&o.data.id&&await le(o.data.id,this.projectId),await this.fetchMyLists()):this.$toast.add({severity:"error",summary:"错误",detail:o.message||"创建列表失败",life:3e3})}catch(o){console.error("创建列表失败:",o),this.$toast.add({severity:"error",summary:"错误",detail:"创建列表失败",life:3e3})}finally{this.creatingList=!1}}}}};function He(o,e,l,j,i,d){return r(),f(oe,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:s(()=>[t(p,{loading:i.starLoading,class:"text-none",text:"Star",variant:"tonal",onClick:d.toggleStar},{prepend:s(()=>[t(V,{color:i.isStarred?"yellow":"",icon:i.isStarred?"mdi-star":"mdi-star-outline"},null,8,["color","icon"])]),default:s(()=>[a(" "+m(i.isStarred?"Starred":"Star")+" "+m(i.starCount),1)]),_:1},8,["loading","onClick"]),t(P,{color:"surface-light",vertical:""}),t(be,{modelValue:i.menu,"onUpdate:modelValue":e[8]||(e[8]=u=>i.menu=u),"close-on-content-click":!1},{activator:s(({props:u})=>[t(p,Ce({class:"px-5",icon:"mdi-menu-down"},u),null,16)]),default:s(()=>[t(y,{"max-width":"400","min-width":"300"},{default:s(()=>[i.listLoading?(r(),f(ve,{key:0,color:"primary",indeterminate:""})):h("",!0),t(te,null,{default:s(()=>[(r(!0),C(O,null,X(i.myLists,u=>(r(),C("div",{key:u.id},[t(k,{active:u.hasProject,"prepend-icon":u.hasProject?"mdi-check-circle":"mdi-playlist-plus","prepend-icon-color":u.hasProject?"success":void 0,onClick:$(n=>d.toggleListItem(u.id),["stop"])},{default:s(()=>[t(L,null,{default:s(()=>[a(m(u.title),1)]),_:2},1024),t(I,null,{default:s(()=>[a(m(u.description),1)]),_:2},1024)]),_:2},1032,["active","prepend-icon","prepend-icon-color","onClick"])]))),128)),t(P,{class:"my-2"}),t(k,{onClick:e[0]||(e[0]=$(u=>i.isVisibleDialog=!0,["stop"]))},{prepend:s(()=>[t(V,null,{default:s(()=>e[9]||(e[9]=[a("mdi-plus",-1)])),_:1,__:[9]})]),default:s(()=>[t(L,null,{default:s(()=>e[10]||(e[10]=[a("新建列表",-1)])),_:1,__:[10]})]),_:1})]),_:1}),t(A,null,{default:s(()=>[t(N),t(p,{text:"关闭",variant:"text",onClick:e[1]||(e[1]=u=>i.menu=!1)})]),_:1})]),_:1}),t(W,{modelValue:i.isVisibleDialog,"onUpdate:modelValue":e[6]||(e[6]=u=>i.isVisibleDialog=u),"min-width":"400",width:"auto","onClick:outside":e[7]||(e[7]=u=>i.isVisibleDialog=!1)},{default:s(()=>[t(y,{border:"","prepend-icon":"mdi-format-list-bulleted",title:"新建列表"},{default:s(()=>[t(S,null,{default:s(()=>[t(Z,{modelValue:i.newListInfo.title,"onUpdate:modelValue":e[2]||(e[2]=u=>i.newListInfo.title=u),rules:[u=>!!u||"标题不能为空"],hint:"将便于查找",label:"标题",required:""},null,8,["modelValue","rules"]),t(Z,{modelValue:i.newListInfo.description,"onUpdate:modelValue":e[3]||(e[3]=u=>i.newListInfo.description=u),hint:"简要描述列表内容",label:"简介"},null,8,["modelValue"]),t(se,{modelValue:i.newListInfo.state,"onUpdate:modelValue":e[4]||(e[4]=u=>i.newListInfo.state=u),items:i.listStates,"item-title":"state","item-value":"abbr",label:"列表状态"},null,8,["modelValue","items"])]),_:1}),t(P),t(A,null,{default:s(()=>[t(N),t(p,{text:"关闭",variant:"plain",onClick:e[5]||(e[5]=u=>i.isVisibleDialog=!1)}),t(p,{disabled:!i.newListInfo.title,loading:i.creatingList,color:"primary",text:"创建",variant:"tonal",onClick:$(d.createNewList,["stop"])},null,8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})}const ge=T(Ze,[["render",He]]),Ye={name:"ProjectInfoCard",components:{TimeAgo:B,ProjectStar:ge,ProjectAuthorCard:pe},props:{project:{type:Object,required:!0},author:{type:Object,required:!0},username:{type:String,required:!0},projectname:{type:String,required:!0}},data(){return{openEditor:Ne,loading:!1,error:null,stats:{pageviews:0,visitors:0},localuser:z}},async mounted(){},watch:{"project.id":{immediate:!0,handler(o){o&&this.loadProjectStats()}}},methods:{async loadProjectStats(){try{this.stats=await we(this.project.id)}catch(o){console.error("Error fetching project stats:",o),this.stats={pageviews:0,visitors:0}}}}},Je={class:"px-4 d-flex ga-2 mb-2"},Qe={class:"px-4 d-flex ga-2 mb-2"},We={class:"px-4 d-flex ga-2 mb-2"},Xe={class:"px-4 d-flex ga-2 mb-2"},$e={class:"px-4 d-flex ga-2 mb-2"},et={class:"px-4 d-flex ga-2 mb-2"},tt={class:"px-4 d-flex ga-2 mb-2"},st={class:"px-4"};function ot(o,e,l,j,i,d){const u=B,n=ge,x=pe;return r(),f(y,{border:"",hover:""},{default:s(()=>[t(H,null,{default:s(()=>[t(v,null,{default:s(()=>[a(m(l.project.title),1)]),_:1}),t(Y,null,{default:s(()=>[a(m(l.project.description),1)]),_:1})]),_:1}),g("div",Je,[t(w,{pill:""},{default:s(()=>[t(J,{start:""},{default:s(()=>[t(Q,{src:i.localuser.getUserAvatar(l.author.avatar)},null,8,["src"])]),_:1}),a(" "+m(l.author.display_name),1)]),_:1})]),g("div",Qe,[t(w,{pill:"","prepend-icon":"mdi-chart-line"},{default:s(()=>[a(m(i.stats.pageviews)+"浏览",1)]),_:1}),t(w,{pill:"","prepend-icon":"mdi-account-multiple"},{default:s(()=>[a(m(i.stats.visitors)+"访客",1)]),_:1}),t(w,{pill:"","prepend-icon":"mdi-clock"},{default:s(()=>[t(u,{date:l.project.time},null,8,["date"])]),_:1})]),g("div",We,[l.project.state=="public"?(r(),f(w,{key:0,pill:"","prepend-icon":"mdi-xml"},{default:s(()=>e[1]||(e[1]=[a("开源作品 ",-1)])),_:1,__:[1]})):h("",!0),l.project.state=="private"?(r(),f(w,{key:1,color:"red",pill:"","prepend-icon":"mdi-xml",variant:"outlined"},{default:s(()=>e[2]||(e[2]=[a("私密作品 ",-1)])),_:1,__:[2]})):h("",!0),t(w,{pill:"","prepend-icon":"mdi-application"},{default:s(()=>[a(m(l.project.type),1)]),_:1})]),g("div",Xe,[(r(!0),C(O,null,X(l.project.tags,c=>(r(),C("div",null,[t(w,{to:`/app/projects/tag/${c.name}`},{default:s(()=>[a(m(c.name),1)]),_:2},1032,["to"])]))),256))]),g("div",$e,[t(n,{projectId:l.project.id,starcount:l.project.star_count},null,8,["projectId","starcount"])]),g("div",et,[t(oe,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:s(()=>[t(p,{to:`/${l.username}/${l.projectname}/fork`,class:"text-none",variant:"tonal"},{default:s(()=>e[3]||(e[3]=[a(" 复刻 ",-1)])),_:1,__:[3]},8,["to"]),t(p,{to:`/app/projects/fork/${l.project.id}`,text:""},{default:s(()=>[a(m(i.stats.forks),1)]),_:1},8,["to"])]),_:1})]),g("div",tt,[l.project.type=="scratch"?(r(),f(p,{key:0,variant:"text",onClick:e[0]||(e[0]=c=>i.openEditor(l.project.id,l.project.type)),border:"",hover:"","append-icon":"mdi-open-in-new",class:"text-none"},{default:s(()=>e[4]||(e[4]=[a("Scratch编辑器 ",-1)])),_:1,__:[4]})):h("",!0),t(p,{to:`/${l.username}/${l.projectname}/edit`,variant:"text",border:"",hover:"",class:"text-none"},{default:s(()=>e[5]||(e[5]=[a("编辑 ",-1)])),_:1,__:[5]},8,["to"])]),g("div",st,[t(x,{author:l.author},null,8,["author"])]),e[6]||(e[6]=g("br",null,null,-1))]),_:1,__:[6]})}const At=T(Ye,[["render",ot]]),it={name:"CodeRunner",components:{CodeRunTerminal:me},props:{projectType:{type:String,default:"python"},initialCode:{type:String,default:""}},data(){return{code:this.initialCode||"",selectedLanguage:this.getValidLanguage(),programmingLanguages:ae,originalCode:this.initialCode||""}},computed:{languageOptions(){return Object.entries(this.programmingLanguages).map(([o,e])=>({key:o,name:e.name}))},currentLanguage(){return this.programmingLanguages[this.selectedLanguage]||{}}},methods:{runCode(){this.$refs.terminal&&this.$refs.terminal.runCode()},clearCode(){this.code=this.originalCode},getValidLanguage(){return Object.keys(ae).includes(this.projectType)?this.projectType:"python"},getLanguageColor(o){return{python:"blue","python-2.7":"blue-darken-1","python-3.11":"blue","python-3.12":"blue-darken-2","python-3.13":"blue-darken-3",javascript:"yellow-darken-3","javascript-nodejs18":"green","javascript-nodejs20":"green-darken-1","javascript-nodejs22":"green-darken-2","javascript-nodejs24":"green-darken-3",rust:"orange-darken-3",golang:"cyan",ruby:"red",java:"orange","java-openjdk17":"orange-darken-1","java-openjdk21":"orange-darken-2","java-openjdk24":"orange-darken-3"}[o]||"grey"}},watch:{initialCode(o){this.code=o||""},projectType:{handler(o){this.selectedLanguage=o},immediate:!0}}},lt={class:"code-runner"};function at(o,e,l,j,i,d){const u=me;return r(),C("div",lt,[t(y,{class:"editor-card",elevation:"2"},{default:s(()=>[t(v,{class:"d-flex align-center pa-4"},{default:s(()=>[t(V,{icon:d.currentLanguage.icon||"mdi-code-tags",class:"me-3",size:"24"},null,8,["icon"]),e[2]||(e[2]=g("span",{class:"text-h6"},"代码编辑器",-1)),t(N),t(w,{color:d.getLanguageColor(i.selectedLanguage),variant:"flat",size:"small",class:"text-caption"},{default:s(()=>[a(m(d.currentLanguage.name||i.selectedLanguage),1)]),_:1},8,["color"])]),_:1,__:[2]}),t(P),t(S,{class:"pa-4"},{default:s(()=>[t(F,null,{default:s(()=>[t(E,{cols:"12"},{default:s(()=>[t(se,{modelValue:i.selectedLanguage,"onUpdate:modelValue":e[0]||(e[0]=n=>i.selectedLanguage=n),items:d.languageOptions,class:"mb-4","item-title":"name","item-value":"key",label:"选择编程语言",variant:"outlined","prepend-inner-icon":"mdi-code-braces","hide-details":""},{item:s(({props:n,item:x})=>[t(k,de(ue(n)),{prepend:s(()=>{var c;return[t(V,{icon:((c=i.programmingLanguages[x.value])==null?void 0:c.icon)||"mdi-code-tags",class:"me-3"},null,8,["icon"])]}),_:2},1040)]),_:1},8,["modelValue","items"])]),_:1}),t(E,{cols:"12"},{default:s(()=>[t(ce,{modelValue:i.code,"onUpdate:modelValue":e[1]||(e[1]=n=>i.code=n),label:d.currentLanguage.placeholder||"在此输入代码",placeholder:d.currentLanguage.sample,class:"mb-4",rows:"12",variant:"outlined",onKeydown:Ve(d.runCode,["enter"])},{"prepend-inner":s(()=>[t(V,{icon:"mdi-code-tags",class:"mt-1",size:"20",color:"grey"})]),_:1},8,["modelValue","label","placeholder","onKeydown"])]),_:1})]),_:1}),t(F,{class:"mt-2"},{default:s(()=>[t(E,{cols:"12",class:"d-flex justify-end"},{default:s(()=>[t(p,{onClick:d.clearCode,color:"grey",variant:"outlined","prepend-icon":"mdi-eraser",class:"me-2"},{default:s(()=>e[3]||(e[3]=[a(" 撤销所有编辑 ",-1)])),_:1,__:[3]},8,["onClick"]),e[5]||(e[5]=a()),t(p,{onClick:d.runCode,color:"primary",variant:"elevated","prepend-icon":"mdi-play"},{default:s(()=>e[4]||(e[4]=[a(" 运行代码 ",-1)])),_:1,__:[4]},8,["onClick"])]),_:1,__:[5]})]),_:1})]),_:1})]),_:1}),t(u,{ref:"terminal","auto-run":!1,code:i.code,language:i.selectedLanguage},null,8,["code","language"])])}const he=T(it,[["render",at],["__scopeId","data-v-a87ae1a8"]]),nt={name:"ExtensionEditDialog",components:{ProjectSelector:fe},props:{modelValue:{type:Boolean,default:!1},extension:{type:Object,default:null}},emits:["update:modelValue","updated"],data(){return{formValid:!1,loading:!1,loadingCommits:!1,localuser:z,form:{branch:"",commit:"",image:"",samples:null,docs:"",scratchCompatible:!1},useLatestCommit:!0,imageMode:"project",commits:[],branches:[],myProjects:[],selectedSampleProject:null,selectedSampleProjectId:null}},computed:{dialog:{get(){return this.modelValue},set(o){this.$emit("update:modelValue",o)}},previewImage(){return this.imageMode==="project"?null:this.form.image?z.getUserAvatar(this.form.image):null}},watch:{async modelValue(o){o&&this.extension&&await this.initializeForm()},useLatestCommit(o){o?this.form.commit="":this.fetchCommits()},selectedSampleProjectId:{handler(o){o&&this.loadSampleProject(o)},immediate:!0}},async created(){await this.fetchMyProjects()},methods:{async initializeForm(){this.extension&&(this.form={branch:this.extension.branch||"",commit:this.extension.commit||"",image:this.extension.image||"",samples:this.extension.samples||null,docs:this.extension.docs||"",scratchCompatible:this.extension.scratchCompatible||!1},this.useLatestCommit=!this.extension.commit||this.extension.commit==="latest",this.imageMode=this.extension.image?"custom":"project",this.extension.sample_project&&(this.selectedSampleProject=this.extension.sample_project),await this.fetchBranches())},async fetchMyProjects(){try{const o=await D.get("/searchapi",{params:{search_userid:z.user.value.id,search_state:"public",limit:100}});o.data&&o.data.projects&&(this.myProjects=o.data.projects)}catch(o){console.error("Failed to fetch my projects:",o)}},async fetchBranches(){var o,e;if((e=(o=this.extension)==null?void 0:o.project)!=null&&e.id)try{const l=await D.get(`/project/branches?projectid=${this.extension.project.id}`);l.data.status==="success"?this.branches=l.data.data||[]:(console.error("加载分支列表失败:",l.data.message),this.branches=[])}catch(l){console.error("Failed to fetch branches:",l),this.branches=[]}},async fetchCommits(){var o,e;if((e=(o=this.extension)==null?void 0:o.project)!=null&&e.id){this.loadingCommits=!0;try{const l=await D.get(`/project/commits?projectid=${this.extension.project.id}&branch=${this.form.branch||"main"}`);l.data.status==="success"?(this.commits=l.data.data||[],this.commits=this.commits.map(j=>({...j,id:j.hash||j.id||"unknown",commit_message:j.message||j.commit_message||"无提交信息",date:j.date||new Date().toISOString(),author:j.author||{username:"未知用户"}}))):(console.error("加载提交历史失败:",l.data.message),this.commits=[])}catch(l){console.error("Failed to fetch commits:",l),this.commits=[]}finally{this.loadingCommits=!1}}},selectCommit(o){this.form.commit=o.id},async onBranchChange(){this.useLatestCommit||await this.fetchCommits()},async loadSampleProject(o){try{const l=(await D.post("/project/batch",{projectIds:[o]})).data.data||[];l.length>0&&(this.selectedSampleProject=l[0],this.form.samples=o)}catch(e){console.error("Failed to load sample project:",e)}},selectSampleProject(o){this.selectedSampleProject=o,this.form.samples=o.id,this.showProjectSelector=!1},clearSampleProject(){this.selectedSampleProject=null,this.selectedSampleProjectId=null,this.form.samples=null},async saveExtension(){if(this.extension){this.loading=!0;try{const o={...this.form.branch&&{branch:this.form.branch},...this.form.docs&&{docs:this.form.docs},...this.form.scratchCompatible!==void 0&&{scratchCompatible:this.form.scratchCompatible}};this.useLatestCommit?o.commit="latest":this.form.commit&&(o.commit=this.form.commit),this.imageMode==="project"||this.form.image&&(o.image=this.form.image),this.form.samples&&(o.samples=this.form.samples);const e=await D.put(`/extensions/manager/edit/${this.extension.id}`,o);e.data.status==="success"?(this.$emit("updated"),this.closeDialog(),this.showMessage("扩展更新成功","success")):this.showMessage(e.data.message||"更新失败","error")}catch(o){console.error("Failed to update extension:",o),this.showMessage("更新扩展失败","error")}finally{this.loading=!1}}},closeDialog(){this.dialog=!1},showMessage(o,e){console.log(o)}}},rt={key:0,class:"mt-3"},dt={class:"d-flex align-center mt-4"},ut={class:"text-caption text-grey"},mt={class:"d-flex align-center mb-3"},ct={key:0,class:"selected-project"},ft={key:1,class:"text-center py-4 text-grey"},pt={class:"text-caption text-grey"};function gt(o,e,l,j,i,d){const u=fe;return r(),f(W,{modelValue:d.dialog,"onUpdate:modelValue":e[11]||(e[11]=n=>d.dialog=n),"max-width":"800",persistent:""},{default:s(()=>[t(y,null,{default:s(()=>[t(v,{class:"d-flex align-center"},{default:s(()=>[t(V,{class:"mr-2"},{default:s(()=>e[12]||(e[12]=[a("mdi-pencil",-1)])),_:1,__:[12]}),e[13]||(e[13]=a(" 编辑扩展 ",-1))]),_:1,__:[13]}),t(S,null,{default:s(()=>[t(ke,{ref:"form",modelValue:i.formValid,"onUpdate:modelValue":e[10]||(e[10]=n=>i.formValid=n)},{default:s(()=>[t(y,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(v,{class:"text-subtitle-1"},{default:s(()=>e[14]||(e[14]=[a("基本信息",-1)])),_:1,__:[14]}),t(S,null,{default:s(()=>[t(F,null,{default:s(()=>[t(E,{cols:"12",md:"6"},{default:s(()=>[t(se,{modelValue:i.form.branch,"onUpdate:modelValue":[e[0]||(e[0]=n=>i.form.branch=n),d.onBranchChange],label:"分支名称",placeholder:"选择分支","prepend-inner-icon":"mdi-source-branch",variant:"outlined",density:"compact",items:i.branches,"item-title":"name","item-value":"name"},{item:s(({props:n,item:x})=>[t(k,de(ue(n)),{prepend:s(()=>[t(V,{size:"small"},{default:s(()=>e[15]||(e[15]=[a("mdi-source-branch",-1)])),_:1,__:[15]})]),default:s(()=>[t(L,null,{default:s(()=>[a(m(x.raw.name),1)]),_:2},1024),x.raw.description?(r(),f(I,{key:0},{default:s(()=>[a(m(x.raw.description),1)]),_:2},1024)):h("",!0)]),_:2},1040)]),_:1},8,["modelValue","items","onUpdate:modelValue"])]),_:1}),t(E,{cols:"12",md:"6"},{default:s(()=>[t(Z,{modelValue:i.form.commit,"onUpdate:modelValue":e[1]||(e[1]=n=>i.form.commit=n),label:"提交ID",placeholder:"留空或latest使用最新提交","prepend-inner-icon":"mdi-source-commit",variant:"outlined",density:"compact",readonly:i.useLatestCommit},null,8,["modelValue","readonly"]),t(oe,{modelValue:i.useLatestCommit,"onUpdate:modelValue":e[4]||(e[4]=n=>i.useLatestCommit=n),class:"mt-2",variant:"outlined",density:"compact",divided:""},{default:s(()=>[t(p,{variant:i.useLatestCommit?"flat":"outlined",color:i.useLatestCommit?"primary":void 0,size:"small",onClick:e[2]||(e[2]=n=>i.useLatestCommit=!0)},{default:s(()=>e[16]||(e[16]=[a(" 最新 ",-1)])),_:1,__:[16]},8,["variant","color"]),t(p,{variant:i.useLatestCommit?"outlined":"flat",color:i.useLatestCommit?void 0:"primary",size:"small",onClick:e[3]||(e[3]=n=>i.useLatestCommit=!1)},{default:s(()=>e[17]||(e[17]=[a(" 指定 ",-1)])),_:1,__:[17]},8,["variant","color"])]),_:1},8,["modelValue"]),!i.useLatestCommit&&i.commits.length>0?(r(),C("div",rt,[t(te,{density:"compact","max-height":"200",class:"overflow-y-auto"},{default:s(()=>[(r(!0),C(O,null,X(i.commits,n=>(r(),f(k,{key:n.id,onClick:x=>d.selectCommit(n),active:i.form.commit===n.id,class:Le({"v-list-item--active":i.form.commit===n.id})},{prepend:s(()=>[t(V,{size:"small"},{default:s(()=>e[18]||(e[18]=[a("mdi-source-commit",-1)])),_:1,__:[18]})]),default:s(()=>[t(L,{class:"text-caption"},{default:s(()=>[a(m(n.id.substring(0,8)),1)]),_:2},1024),t(I,{class:"text-caption"},{default:s(()=>[a(m(n.commit_message||"无提交信息"),1)]),_:2},1024)]),_:2},1032,["onClick","active","class"]))),128))]),_:1})])):h("",!0),i.useLatestCommit?h("",!0):(r(),f(p,{key:1,variant:"tonal",size:"small",class:"mt-2","prepend-icon":"mdi-refresh",onClick:d.fetchCommits,loading:i.loadingCommits},{default:s(()=>e[19]||(e[19]=[a(" 刷新提交列表 ",-1)])),_:1,__:[19]},8,["onClick","loading"]))]),_:1}),t(E,{cols:"12"},{default:s(()=>[t(Z,{modelValue:i.form.docs,"onUpdate:modelValue":e[5]||(e[5]=n=>i.form.docs=n),label:"文档路径",placeholder:"/docs/extension","prepend-inner-icon":"mdi-book-open-variant",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(y,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(v,{class:"text-subtitle-1"},{default:s(()=>e[20]||(e[20]=[a("扩展图标",-1)])),_:1,__:[20]}),t(S,null,{default:s(()=>[t(Be,{modelValue:i.imageMode,"onUpdate:modelValue":e[6]||(e[6]=n=>i.imageMode=n),inline:""},{default:s(()=>[t(ne,{label:"跟随项目",value:"project"}),t(ne,{label:"自定义图标",value:"custom"})]),_:1},8,["modelValue"]),i.imageMode==="custom"?(r(),f(Z,{key:0,modelValue:i.form.image,"onUpdate:modelValue":e[7]||(e[7]=n=>i.form.image=n),label:"图标文件名",placeholder:"icon.png","prepend-inner-icon":"mdi-image",variant:"outlined",density:"compact",class:"mt-2"},null,8,["modelValue"])):h("",!0),g("div",dt,[t(J,{size:"48",class:"mr-3"},{default:s(()=>[d.previewImage?(r(),f(Q,{key:0,src:d.previewImage},null,8,["src"])):(r(),f(V,{key:1,size:"24"},{default:s(()=>e[21]||(e[21]=[a("mdi-puzzle",-1)])),_:1,__:[21]}))]),_:1}),g("div",null,[e[22]||(e[22]=g("div",{class:"text-body-2"},"预览",-1)),g("div",ut,m(i.imageMode==="project"?"使用项目默认图标":i.form.image||"默认图标"),1)])])]),_:1})]),_:1}),t(y,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(v,{class:"text-subtitle-1"},{default:s(()=>e[23]||(e[23]=[a("示例项目",-1)])),_:1,__:[23]}),t(S,null,{default:s(()=>[g("div",mt,[t(u,{modelValue:i.selectedSampleProjectId,"onUpdate:modelValue":e[8]||(e[8]=n=>i.selectedSampleProjectId=n),multiple:!1,author:"me"},{default:s(()=>[t(p,{class:"ml-2",variant:"outlined"},{default:s(()=>e[24]||(e[24]=[a(" 选择 ",-1)])),_:1,__:[24]})]),_:1},8,["modelValue"])]),i.selectedSampleProject?(r(),C("div",ct,[t(y,{variant:"outlined",class:"mb-2"},{default:s(()=>[t(H,null,{prepend:s(()=>[t(J,null,{default:s(()=>{var n;return[t(Q,{src:i.localuser.getUserAvatar((n=i.selectedSampleProject.author)==null?void 0:n.avatar)||""},null,8,["src"])]}),_:1})]),default:s(()=>[t(v,{class:"text-subtitle-2"},{default:s(()=>[a(m(i.selectedSampleProject.title),1)]),_:1}),t(Y,null,{default:s(()=>{var n,x;return[a("by "+m(((n=i.selectedSampleProject.author)==null?void 0:n.display_name)||((x=i.selectedSampleProject.author)==null?void 0:x.username)),1)]}),_:1})]),_:1})]),_:1}),t(p,{size:"small",variant:"text",color:"error","prepend-icon":"mdi-close",onClick:d.clearSampleProject},{default:s(()=>e[25]||(e[25]=[a(" 移除示例项目 ",-1)])),_:1,__:[25]},8,["onClick"])])):(r(),C("div",ft,[t(V,{size:"48"},{default:s(()=>e[26]||(e[26]=[a("mdi-file-document-outline",-1)])),_:1,__:[26]}),e[27]||(e[27]=g("p",{class:"mt-2"},"未选择示例项目",-1))]))]),_:1})]),_:1}),t(y,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(v,{class:"text-subtitle-1"},{default:s(()=>[t(V,{class:"mr-2",color:"orange"},{default:s(()=>e[28]||(e[28]=[a("mdi-puzzle",-1)])),_:1,__:[28]}),e[29]||(e[29]=a(" Scratch兼容性 ",-1))]),_:1,__:[29]}),t(S,null,{default:s(()=>[t(Se,{type:"info",variant:"tonal",density:"compact",class:"mb-4"},{default:s(()=>e[30]||(e[30]=[a(" 选择此扩展是否兼容原版Scratch平台。兼容原版Scratch的扩展可以在Scratch项目中使用。 ",-1)])),_:1,__:[30]}),t(qe,{modelValue:i.form.scratchCompatible,"onUpdate:modelValue":e[9]||(e[9]=n=>i.form.scratchCompatible=n),label:"兼容原版Scratch",color:"orange","hide-details":"",class:"mb-2"},null,8,["modelValue"]),g("div",pt,m(i.form.scratchCompatible?"此扩展将可以在Scratch项目中使用":"此扩展仅适用于其他平台"),1)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(A,null,{default:s(()=>[t(N),t(p,{onClick:d.closeDialog},{default:s(()=>e[31]||(e[31]=[a("取消",-1)])),_:1,__:[31]},8,["onClick"]),t(p,{color:"primary",loading:i.loading,onClick:d.saveExtension},{default:s(()=>e[32]||(e[32]=[a(" 保存 ",-1)])),_:1,__:[32]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const _e=T(nt,[["render",gt],["__scopeId","data-v-edb13836"]]),ht={name:"ExtensionDetailsCard",components:{TimeAgo:B},props:{extensionId:{type:[String,Number],required:!0},extension:{type:Object,default:()=>null},isOwner:{type:Boolean,default:!1},updateLoading:{type:Boolean,default:!1}},emits:["update-to-latest"]};function _t(o,e,l,j,i,d){const u=B;return l.extension?(r(),f(y,{key:0,border:"",class:"mb-6"},{default:s(()=>[t(v,null,{default:s(()=>e[1]||(e[1]=[a(" 扩展详细信息 ",-1)])),_:1,__:[1]}),t(S,{class:"pa-0"},{default:s(()=>[t(te,null,{default:s(()=>{var n,x,c,b,M,q,R,K;return[t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[2]||(e[2]=[a("扩展ID",-1)])),_:1,__:[2]}),t(I,{class:"text-body-2 font-weight-medium"},{default:s(()=>{var _;return[a(m(((_=l.extension)==null?void 0:_.id)||"N/A"),1)]}),_:1})]),_:1}),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[3]||(e[3]=[a("项目ID",-1)])),_:1,__:[3]}),t(I,{class:"text-body-2 font-weight-medium"},{default:s(()=>{var _,U;return[a(m(((U=(_=l.extension)==null?void 0:_.project)==null?void 0:U.id)||"N/A"),1)]}),_:1})]),_:1}),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[4]||(e[4]=[a("分支信息",-1)])),_:1,__:[4]}),t(I,null,{default:s(()=>[t(w,{color:"primary",variant:"tonal",size:"small","prepend-icon":"mdi-source-branch"},{default:s(()=>{var _;return[a(m(((_=l.extension)==null?void 0:_.branch)||"main"),1)]}),_:1})]),_:1})]),_:1}),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[5]||(e[5]=[a("提交信息",-1)])),_:1,__:[5]}),t(I,{class:"d-flex align-center"},{default:s(()=>{var _;return[t(w,{color:"success",variant:"tonal",size:"small","prepend-icon":"mdi-source-commit"},{default:s(()=>{var U,ie;return[a(m(((ie=(U=l.extension)==null?void 0:U.commit)==null?void 0:ie.substring(0,8))||"latest"),1)]}),_:1}),l.isOwner&&((_=l.extension)!=null&&_.commit)&&l.extension.commit!=="latest"?(r(),f(p,{key:0,size:"small",variant:"text","prepend-icon":"mdi-refresh",loading:l.updateLoading,onClick:e[0]||(e[0]=U=>o.$emit("update-to-latest")),class:"ml-2"},{default:s(()=>e[6]||(e[6]=[a(" 更新到最新 ",-1)])),_:1,__:[6]},8,["loading"])):h("",!0)]}),_:1})]),_:1}),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[7]||(e[7]=[a("创建时间",-1)])),_:1,__:[7]}),t(I,{class:"d-flex align-center"},{default:s(()=>{var _;return[t(V,{class:"mr-2",size:"small",color:"primary"},{default:s(()=>e[8]||(e[8]=[a("mdi-clock-outline",-1)])),_:1,__:[8]}),t(u,{date:(_=l.extension)==null?void 0:_.created_at},null,8,["date"])]}),_:1})]),_:1}),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[9]||(e[9]=[a("更新时间",-1)])),_:1,__:[9]}),t(I,{class:"d-flex align-center"},{default:s(()=>{var _;return[t(V,{class:"mr-2",size:"small",color:"primary"},{default:s(()=>e[10]||(e[10]=[a("mdi-clock-outline",-1)])),_:1,__:[10]}),t(u,{date:(_=l.extension)==null?void 0:_.updated_at},null,8,["date"])]}),_:1})]),_:1}),(n=l.extension)!=null&&n.has_docs&&((x=l.extension)!=null&&x.docs_url)?(r(),f(P,{key:0})):h("",!0),(c=l.extension)!=null&&c.has_docs&&((b=l.extension)!=null&&b.docs_url)?(r(),f(k,{key:1},{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[11]||(e[11]=[a("扩展文档",-1)])),_:1,__:[11]}),t(I,null,{default:s(()=>[t(p,{variant:"tonal",size:"small","prepend-icon":"mdi-book-open-variant",href:l.extension.docs_url,target:"_blank"},{default:s(()=>e[12]||(e[12]=[a(" 查看文档 ",-1)])),_:1,__:[12]},8,["href"])]),_:1})]),_:1})):h("",!0),t(P),t(k,null,{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[13]||(e[13]=[a("兼容性信息",-1)])),_:1,__:[13]}),t(I,null,{default:s(()=>{var _;return[t(w,{color:(_=l.extension)!=null&&_.scratchCompatible?"orange":"grey",variant:"tonal",size:"small","prepend-icon":"mdi-puzzle",class:"mb-2"},{default:s(()=>{var U;return[a(m((U=l.extension)!=null&&U.scratchCompatible?"兼容原版Scratch":"不兼容原版Scratch"),1)]}),_:1},8,["color"])]}),_:1})]),_:1}),(q=(M=l.extension)==null?void 0:M.project)!=null&&q.tags&&l.extension.project.tags.length>0?(r(),f(P,{key:2})):h("",!0),(K=(R=l.extension)==null?void 0:R.project)!=null&&K.tags&&l.extension.project.tags.length>0?(r(),f(k,{key:3},{default:s(()=>[t(L,{class:"text-caption text-medium-emphasis"},{default:s(()=>e[14]||(e[14]=[a("项目标签",-1)])),_:1,__:[14]}),t(I,null,{default:s(()=>[(r(!0),C(O,null,X(l.extension.project.tags,_=>(r(),f(w,{key:_,size:"small",variant:"outlined",class:"mr-1 mb-1"},{default:s(()=>[a(m(_),1)]),_:2},1024))),128))]),_:1})]),_:1})):h("",!0)]}),_:1})]),_:1})]),_:1})):h("",!0)}const ye=T(ht,[["render",_t]]),yt={name:"ExtensionDisplayContent",components:{TimeAgo:B,ExtensionDetailsCard:ye,ExtensionEditDialog:_e},props:{extensionId:{type:[String,Number],required:!1},projectId:{type:[String,Number],required:!1},scope:{type:String,default:"my"}},emits:["extension-deleted"],data(){return{loading:!0,extension:null,localuser:z,showEditDialog:!1,showDeleteDialog:!1,showCreateExtensionDialog:!1,deleteLoading:!1,createExtensionLoading:!1,submitLoading:!1,updateLoading:!1,snackbar:{show:!1,message:"",color:"success"}}},computed:{isOwner(){var o,e,l,j;return!this.extension||!z.isLogin.value?!1:((o=z.user.value)==null?void 0:o.id)===((j=(l=(e=this.extension)==null?void 0:e.project)==null?void 0:l.author)==null?void 0:j.id)},isCurrentUserProject(){var o;return!z.isLogin.value||!this.$route.params.username?!1:((o=z.user.value)==null?void 0:o.username)===this.$route.params.username}},watch:{extensionId:{immediate:!0,handler(o){o&&this.fetchExtensionDetail()}},projectId:{immediate:!0,handler(o){o&&this.fetchExtensionDetail()}}},methods:{async fetchExtensionDetail(){var o;if(this.loading=!0,!this.extensionId&&!this.projectId){this.loading=!1,this.extension=null;return}try{let e;this.projectId?e=await D.get(`/extensions/detailbyprojectid/${this.projectId}`):e=await D.get(`/extensions/detail/${this.extensionId}`),((o=e.data)==null?void 0:o.status)==="success"?(this.extension=e.data.data,this.updatePageTitle()):this.extension=null}catch(e){console.error("Failed to fetch extension detail:",e),this.extension=null}finally{this.loading=!1}},async handleSubmitExtension(){if(!(!this.extension||!this.isOwner)){this.submitLoading=!0;try{const o=await D.post(`/extensions/manager/submit/${this.extension.id}`);o.data.status==="success"?(this.showMessage("提交审核成功","success"),await this.fetchExtensionDetail()):this.showMessage(o.data.message||"提交失败","error")}catch(o){console.error("Failed to submit extension:",o),this.showMessage("提交失败","error")}finally{this.submitLoading=!1}}},async handleUpdateToLatestCommit(){if(!(!this.extension||!this.isOwner)){this.updateLoading=!0;try{const o=await D.post(`/extensions/manager/update/${this.extension.id}`);o.data.status==="success"?(this.showMessage("更新到最新提交成功","success"),await this.fetchExtensionDetail()):this.showMessage(o.data.message||"更新失败","error")}catch(o){console.error("Failed to update commit:",o),this.showMessage("更新失败","error")}finally{this.updateLoading=!1}}},async handleExtensionUpdated(){await this.fetchExtensionDetail()},async handleDeleteExtension(){if(!(!this.extension||!this.isOwner)){this.deleteLoading=!0;try{const o=await D.delete(`/extensions/manager/${this.extension.id}`);o.data.status==="success"?(this.showMessage("删除扩展成功","success"),this.$router.push("/app/dashboard"),this.showDeleteDialog=!1):this.showMessage(o.data.message||"删除扩展失败","error")}catch(o){console.error("Failed to delete extension:",o),this.showMessage("删除扩展失败","error")}finally{this.deleteLoading=!1}}},async handleCreateExtension(){if(!(!this.projectId||!this.isCurrentUserProject)){this.createExtensionLoading=!0;try{const o={projectid:this.projectId,scratchCompatible:!1},e=await D.post("/extensions/manager/create",o);e.data.status==="success"?(this.showMessage("创建扩展成功","success"),this.showCreateExtensionDialog=!1,await this.fetchExtensionDetail()):this.showMessage(e.data.message||"创建扩展失败","error")}catch(o){console.error("Failed to create extension:",o),this.showMessage("创建扩展失败","error")}finally{this.createExtensionLoading=!1}}},getStatusColor(o){return{developing:"primary",pending:"warning",verified:"success",rejected:"error"}[o]||"grey"},getStatusText(o){return{developing:"开发中",pending:"待审核",verified:"上架",rejected:"已拒绝"}[o]||"未知"},showMessage(o,e="success"){this.snackbar={show:!0,message:o,color:e}},updatePageTitle(){var o;this.extension&&Ie({title:`${((o=this.extension.project)==null?void 0:o.title)||"扩展"} - ZeroCat`})},async refresh(){await this.fetchExtensionDetail()}}},xt={key:1},jt={class:"text-caption text-medium-emphasis"},bt={class:"text-caption text-medium-emphasis"},vt={class:"mb-1"};function Ct(o,e,l,j,i,d){const u=ye,n=B,x=_e;return r(),C("div",null,[i.loading?(r(),f(G,{key:0,class:"d-flex justify-center align-center",style:{"min-height":"400px"}},{default:s(()=>[t(Pe,{indeterminate:"",size:"64",color:"primary"})]),_:1})):i.extension?(r(),C("div",xt,[t(G,null,{default:s(()=>[t(y,{variant:"elevated",border:""},{default:s(()=>[t(H,null,{default:s(()=>[t(v,null,{default:s(()=>{var c,b;return[a(m(((b=(c=i.extension)==null?void 0:c.project)==null?void 0:b.title)||"扩展"),1)]}),_:1}),t(Y,null,{default:s(()=>{var c,b;return[a(m(((b=(c=i.extension)==null?void 0:c.project)==null?void 0:b.description)||"暂无描述"),1)]}),_:1}),t(F,null,{default:s(()=>[t(E,{cols:"auto"},{default:s(()=>{var c;return[d.isOwner?(r(),f(w,{key:0,color:d.getStatusColor(i.extension.status),variant:"tonal",size:"default",class:"mr-2"},{default:s(()=>[a(m(d.getStatusText(i.extension.status)),1)]),_:1},8,["color"])):h("",!0),t(w,{color:(c=i.extension)!=null&&c.scratchCompatible?"orange":"grey",variant:"tonal","prepend-icon":"mdi-puzzle"},{default:s(()=>{var b;return[a(m((b=i.extension)!=null&&b.scratchCompatible?"兼容Scratch":"独立扩展"),1)]}),_:1},8,["color"])]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(G,null,{default:s(()=>[t(F,null,{default:s(()=>[t(E,{cols:"12",lg:"8"},{default:s(()=>[t(u,{"extension-id":l.extensionId,extension:i.extension,"is-owner":d.isOwner,"update-loading":i.updateLoading,onUpdateToLatest:d.handleUpdateToLatestCommit},null,8,["extension-id","extension","is-owner","update-loading","onUpdateToLatest"])]),_:1}),t(E,{cols:"12",lg:"4"},{default:s(()=>{var c,b,M,q,R,K;return[(c=i.extension)!=null&&c.sample_project?(r(),f(y,{key:0,border:"",class:"mb-6",to:`/${(q=(M=(b=i.extension)==null?void 0:b.sample_project)==null?void 0:M.author)==null?void 0:q.username}/${(K=(R=i.extension)==null?void 0:R.sample_project)==null?void 0:K.name}`},{default:s(()=>[t(v,null,{default:s(()=>e[9]||(e[9]=[a(" 示例项目 ",-1)])),_:1,__:[9]}),t(H,null,{default:s(()=>[t(v,null,{default:s(()=>[a(m(i.extension.sample_project.title),1)]),_:1}),t(Y,null,{default:s(()=>[a("by "+m(i.extension.sample_project.description||"ZeroCat 上的项目"),1)]),_:1})]),_:1})]),_:1},8,["to"])):h("",!0)]}),_:1})]),_:1})]),_:1}),d.isOwner&&i.extension?(r(),f(G,{key:0},{default:s(()=>[t(y,{border:""},{default:s(()=>[t(v,null,{default:s(()=>e[10]||(e[10]=[a(" 扩展管理 ",-1)])),_:1,__:[10]}),t(S,null,{default:s(()=>[t(F,{class:"mb-6"},{default:s(()=>[t(E,{cols:"12",md:"auto"},{default:s(()=>[t(p,{color:"primary","prepend-icon":"mdi-pencil",variant:"elevated",onClick:e[0]||(e[0]=c=>i.showEditDialog=!0)},{default:s(()=>e[11]||(e[11]=[a(" 编辑扩展 ",-1)])),_:1,__:[11]})]),_:1}),t(E,{cols:"12",md:"auto"},{default:s(()=>[i.extension.status==="developing"?(r(),f(p,{key:0,color:"success","prepend-icon":"mdi-upload",variant:"elevated",loading:i.submitLoading,onClick:d.handleSubmitExtension},{default:s(()=>e[12]||(e[12]=[a(" 提交审核 ",-1)])),_:1,__:[12]},8,["loading","onClick"])):h("",!0)]),_:1}),t(E,{cols:"12",md:"auto",class:"ml-auto"},{default:s(()=>[t(p,{color:"error","prepend-icon":"mdi-delete",variant:"outlined",onClick:e[1]||(e[1]=c=>i.showDeleteDialog=!0)},{default:s(()=>e[13]||(e[13]=[a(" 删除扩展 ",-1)])),_:1,__:[13]})]),_:1})]),_:1}),t(y,{variant:"tonal"},{default:s(()=>[t(v,{class:"d-flex align-center"},{default:s(()=>[t(V,{class:"mr-2"},{default:s(()=>e[14]||(e[14]=[a("mdi-history",-1)])),_:1,__:[14]}),e[15]||(e[15]=a(" 开发历史 ",-1))]),_:1,__:[15]}),t(S,null,{default:s(()=>[t(Re,{density:"compact",side:"end"},{default:s(()=>[t(ee,{"dot-color":"primary",size:"small"},{default:s(()=>[e[16]||(e[16]=g("div",{class:"mb-1"},[g("strong",null,"扩展创建")],-1)),g("div",jt,[t(n,{date:i.extension.created_at},null,8,["date"])])]),_:1,__:[16]}),i.extension.updated_at!==i.extension.created_at?(r(),f(ee,{key:0,"dot-color":"warning",size:"small"},{default:s(()=>[e[17]||(e[17]=g("div",{class:"mb-1"},[g("strong",null,"最后更新")],-1)),g("div",bt,[t(n,{date:i.extension.updated_at},null,8,["date"])])]),_:1,__:[17]})):h("",!0),t(ee,{"dot-color":d.getStatusColor(i.extension.status),size:"small"},{default:s(()=>[g("div",vt,[g("strong",null,m(d.getStatusText(i.extension.status)),1)]),e[18]||(e[18]=g("div",{class:"text-caption text-medium-emphasis"}," 当前状态 ",-1))]),_:1,__:[18]},8,["dot-color"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):h("",!0)])):i.extension?h("",!0):(r(),f(G,{key:2,class:"text-center py-8"},{default:s(()=>[t(V,{size:"64",color:"grey-lighten-1"},{default:s(()=>e[19]||(e[19]=[a("mdi-puzzle-remove",-1)])),_:1,__:[19]}),e[22]||(e[22]=g("p",{class:"text-h6 mt-4 text-grey-darken-1"},"扩展不存在",-1)),e[23]||(e[23]=g("p",{class:"text-body-2 text-grey"},"找不到指定的扩展信息",-1)),d.isCurrentUserProject?(r(),f(p,{key:0,class:"mt-4 mr-2",color:"success","prepend-icon":"mdi-plus",onClick:e[2]||(e[2]=c=>i.showCreateExtensionDialog=!0)},{default:s(()=>e[20]||(e[20]=[a(" 创建扩展 ",-1)])),_:1,__:[20]})):h("",!0),t(p,{class:"mt-4",to:"/app/extensions",color:"primary"},{default:s(()=>e[21]||(e[21]=[a(" 返回扩展列表 ",-1)])),_:1,__:[21]})]),_:1,__:[22,23]})),i.extension?(r(),f(x,{key:3,modelValue:i.showEditDialog,"onUpdate:modelValue":e[3]||(e[3]=c=>i.showEditDialog=c),extension:i.extension,onUpdated:d.handleExtensionUpdated},null,8,["modelValue","extension","onUpdated"])):h("",!0),i.extension?(r(),f(W,{key:4,modelValue:i.showDeleteDialog,"onUpdate:modelValue":e[5]||(e[5]=c=>i.showDeleteDialog=c),"max-width":"400"},{default:s(()=>[t(y,null,{default:s(()=>[t(v,null,{default:s(()=>e[24]||(e[24]=[a("删除扩展",-1)])),_:1,__:[24]}),t(S,null,{default:s(()=>{var c,b,M;return[a(' 确定要删除扩展"'+m(((b=(c=i.extension)==null?void 0:c.project)==null?void 0:b.title)||((M=i.extension)==null?void 0:M.name))+'"吗？此操作不可撤销。 ',1)]}),_:1}),t(A,null,{default:s(()=>[t(N),t(p,{onClick:e[4]||(e[4]=c=>i.showDeleteDialog=!1)},{default:s(()=>e[25]||(e[25]=[a("取消",-1)])),_:1,__:[25]}),t(p,{color:"error",loading:i.deleteLoading,onClick:d.handleDeleteExtension},{default:s(()=>e[26]||(e[26]=[a(" 删除 ",-1)])),_:1,__:[26]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):h("",!0),t(W,{modelValue:i.showCreateExtensionDialog,"onUpdate:modelValue":e[7]||(e[7]=c=>i.showCreateExtensionDialog=c),"max-width":"400"},{default:s(()=>[t(y,null,{default:s(()=>[t(v,null,{default:s(()=>e[27]||(e[27]=[a("创建扩展",-1)])),_:1,__:[27]}),t(S,null,{default:s(()=>e[28]||(e[28]=[a(" 确定要为此项目创建扩展吗？ ",-1)])),_:1,__:[28]}),t(A,null,{default:s(()=>[t(N),t(p,{onClick:e[6]||(e[6]=c=>i.showCreateExtensionDialog=!1)},{default:s(()=>e[29]||(e[29]=[a("取消",-1)])),_:1,__:[29]}),t(p,{color:"success",loading:i.createExtensionLoading,onClick:d.handleCreateExtension},{default:s(()=>e[30]||(e[30]=[a(" 创建 ",-1)])),_:1,__:[30]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(De,{modelValue:i.snackbar.show,"onUpdate:modelValue":e[8]||(e[8]=c=>i.snackbar.show=c),color:i.snackbar.color},{default:s(()=>[a(m(i.snackbar.message),1)]),_:1},8,["modelValue","color"])])}const xe=T(yt,[["render",Ct]]),wt={name:"ProjectPlayer",components:{CodeRunner:he,ExtensionDisplayContent:xe},props:{projectId:{type:[Number,String],required:!0},branch:{type:String,default:"main"},commitId:{type:String,default:"latest"},showplayer:{type:Boolean,required:!0},type:{type:String,default:"scratch"}},data(){return{initProject:ze,projectType:this.type,projectCode:"",projectContent:"",projectLanguage:"python"}},computed:{embedurl(){let o=`/scratch/embed.html?id=${this.projectId}&embed=true`;return localStorage.getItem("embedurl")&&(o=`${localStorage.getItem("embedurl")}/embed.html?id=${this.projectId}&embed=true`),this.commitId!=="latest"?`${o}&ref=${this.commitId}`:`${o}&branch=${this.branch}&ref=${this.commitId}`}},methods:{async loadProjectContent(){if(!(!this.showplayer||this.projectType==="scratch"))try{const o=await Ee(this.projectId,this.branch,this.commitId);this.projectType==="text"?this.projectContent=o.code||"":(this.projectCode=o.code||"",this.projectLanguage=o.language||"python")}catch(o){console.error("Failed to load project content:",o)}}},async mounted(){await this.loadProjectContent()},watch:{projectId:{handler:"loadProjectContent",immediate:!0},branch:"loadProjectContent",commitId:"loadProjectContent",type:{handler(o){this.projectType=o,this.loadProjectContent()},immediate:!0}}},Vt=["src"];function kt(o,e,l,j,i,d){const u=xe,n=he;return r(),C("div",null,[i.projectType==="scratch"?(r(),C(O,{key:0},[l.showplayer?(r(),f(y,{key:0,border:"",hover:"",style:{"aspect-ratio":"4 / 3"}},{default:s(()=>[g("iframe",{src:d.embedurl,frameborder:"0",scrolling:"no",style:{width:"100%",height:"100%"}},null,8,Vt)]),_:1})):h("",!0)],64)):i.projectType==="scratch-extension"?(r(),f(u,{key:1,"project-id":l.projectId},null,8,["project-id"])):i.projectType==="text"?(r(),C(O,{key:2},[l.showplayer?(r(),f(y,{key:0,border:"",hover:""},{default:s(()=>[t(S,null,{default:s(()=>[t(ce,{modelValue:i.projectContent,"onUpdate:modelValue":e[0]||(e[0]=x=>i.projectContent=x),"auto-grow":"","hide-details":"",readonly:"","max-rows":"16"},null,8,["modelValue"])]),_:1})]),_:1})):h("",!0)],64)):(r(),C(O,{key:3},[l.showplayer?(r(),f(n,{key:0,ref:"codeRunner","initial-code":i.projectCode,"initial-language":i.projectLanguage,"project-type":i.projectType},null,8,["initial-code","initial-language","project-type"])):h("",!0)],64)),l.showplayer?h("",!0):(r(),f(y,{key:4,border:"",hover:"",title:"项目尚未初始化"},{default:s(()=>[t(A,null,{default:s(()=>[t(p,{onClick:e[1]||(e[1]=x=>i.initProject(l.projectId,"scratch"))},{default:s(()=>e[3]||(e[3]=[a("以Scratch模板初始化项目",-1)])),_:1,__:[3]}),t(p,{onClick:e[2]||(e[2]=x=>i.initProject(l.projectId,"text"))},{default:s(()=>e[4]||(e[4]=[a("以文本模板初始化项目",-1)])),_:1,__:[4]})]),_:1})]),_:1}))])}const Nt=T(wt,[["render",kt],["__scopeId","data-v-2571f5a1"]]);export{At as _,Nt as a};
