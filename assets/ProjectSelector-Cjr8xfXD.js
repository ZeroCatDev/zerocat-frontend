import{_ as fe,r as p,x as R,w as _e,az as Y,b as ye,af as V,c,o,e as l,N as t,a8 as ge,f as u,a0 as b,Y as n,$ as K,aB as w,Z as y,F as k,W as z,T as h,L as i,P as _,X as C,ae as U,i as E,U as pe,R as F,S,aF as he,j as be,a9 as Ve,D as j,n as G,bU as ee,bT as te,aY as A,a_ as M,bA as xe,cc as we,aH as ke,aE as ze,a6 as ae}from"./index-D7ncyS9J.js";import{V as le}from"./VSelect-Da2a1Axq.js";const Ce={class:"flex-grow-1"},Se={key:0,class:"text-grey-600"},Ae={key:1,class:"d-flex align-center"},Ne={class:"text-subtitle-2"},Pe={class:"text-caption text-grey-600"},$e={key:2,class:"flex-grow-1"},De={class:"text-subtitle-2 mb-1"},Ie={class:"d-flex flex-wrap gap-1"},Ue={class:"text-h6"},Be={class:"pa-4"},Te={key:1,class:"text-center py-8"},Ee={key:2,class:"text-center py-8 text-grey-600"},Fe={class:"d-flex align-center gap-2"},Me={class:"d-flex align-center justify-space-between text-caption text-grey-600"},Oe={class:"d-flex align-center gap-3"},Le={class:"d-flex align-center"},Je={class:"d-flex align-center"},Re={key:0,class:"mt-2"},Ye={key:4,class:"d-flex justify-center mt-6"},Ge={key:0,class:"pa-4"},He={class:"d-flex align-center justify-space-between mb-3"},Qe={class:"d-flex flex-wrap gap-2 mb-4"},We={key:1,class:"pa-4"},Xe={class:"d-flex align-center justify-space-between mb-3"},Ze={class:"position-absolute",style:{top:"8px",right:"8px"}},qe={class:"d-flex align-center gap-2"},Ke={class:"d-flex align-center justify-space-between text-caption text-grey-600"},je={class:"d-flex align-center gap-3"},et={class:"d-flex align-center"},tt={class:"d-flex align-center"},at={key:0,class:"mt-2"},lt={__name:"ProjectSelector",props:{modelValue:{type:[Number,Array],default:()=>null},multiple:{type:Boolean,default:!1},limit:{type:Number,default:20},author:{type:[String,Number,Array],default:null}},emits:["update:modelValue"],setup(g,{emit:se}){const d=g,H=se,x=p(!1),B=p(!1),N=p([]),v=p(new Map),T=p(""),O=p("time_down"),L=p(""),P=p(1),J=p(0),ie=[{title:"最新发布",value:"time_down"},{title:"最早发布",value:"time_up"},{title:"最多观看",value:"view_down"},{title:"最少观看",value:"view_up"},{title:"最多点赞",value:"star_down"},{title:"最少点赞",value:"star_up"},{title:"ID降序",value:"id_down"},{title:"ID升序",value:"id_up"}],ne=[{title:"所有",value:""},{title:"公开",value:"public"},{title:"私有",value:"private"}],m=R(()=>Array.from(v.value.values())),$=R(()=>d.multiple||!d.modelValue?null:v.value.get(d.modelValue)||null),ue=R(()=>d.multiple?m.value.length>0:!!d.modelValue&&!!$.value),Q=s=>v.value.has(s),oe=async()=>{if(!d.author)return null;if(d.author==="me")return V.user.value.id;if(Array.isArray(d.author))return d.author.map(a=>Number(a)).filter(a=>!isNaN(a));const s=Number(d.author);return isNaN(s)?null:s},D=async(s=!0)=>{s&&(P.value=1),B.value=!0;try{const a={curr:P.value,limit:d.limit,search_orderby:O.value,search_state:L.value};T.value&&(a.search_title=T.value);const e=await oe();e!==null&&(a.search_userid=e);const r=(await ae.get("/searchapi",{params:a})).data;N.value=r.projects,J.value=r.totalCount}catch(a){console.error("Failed to load projects:",a)}finally{B.value=!1}},re=()=>{D()},de=s=>{P.value=s,D(!1)},ce=s=>{d.multiple?v.value.has(s.id)?v.value.delete(s.id):v.value.set(s.id,s):(v.value.clear(),v.value.set(s.id,s),H("update:modelValue",s.id),x.value=!1)},W=s=>{v.value.delete(s)},X=()=>{try{const s=Array.from(v.value.keys());console.log(s),H("update:modelValue",s),x.value=!1}catch(s){console.error("Error in confirmSelection:",s)}},ve=()=>{x.value=!0,N.value.length===0&&D()},Z=s=>new Date(s).toLocaleDateString("zh-CN"),me=async s=>{var a;if(!(!s||s.length===0))try{const e=await ae.post("/project/batch",{projectIds:s}),f=(a=e.data)==null?void 0:a.data;if(!f||!Array.isArray(f)){console.warn("Invalid project data received:",e.data);return}await Y(),f.forEach(r=>{r&&r.id&&v.value.has(r.id)&&v.value.set(r.id,r)})}catch(e){console.error("Failed to load project details:",e)}},q=async()=>{if(!v.value||(v.value.clear(),!d.modelValue))return;const s=[],a=e=>({id:e,title:`项目 ${e}`,loading:!0,author:{display_name:"加载中...",username:"",avatar:"",id:0},description:"加载中...",view_count:0,star_count:0,time:new Date().toISOString(),tags:"",state:"public"});try{d.multiple&&Array.isArray(d.modelValue)?d.modelValue.forEach(e=>{e&&typeof e=="number"&&(v.value.set(e,a(e)),s.push(e))}):!d.multiple&&typeof d.modelValue=="number"&&(v.value.set(d.modelValue,a(d.modelValue)),s.push(d.modelValue)),s.length>0&&await me(s)}catch(e){console.error("Error in initializeSelection:",e)}};return _e(()=>d.modelValue,async(s,a)=>{JSON.stringify(s)!==JSON.stringify(a)&&(await Y(),await q())},{immediate:!0,deep:!0}),ye(async()=>{await Y(),await q(),V.value=V}),(s,a)=>(o(),c("div",null,[l(C,{class:"cursor-pointer",onClick:ve,elevation:"1",rounded:"lg"},{default:t(()=>[l(ge,{class:"d-flex align-center justify-space-between"},{default:t(()=>[u("div",Ce,[ue.value?!g.multiple&&$.value?(o(),c("div",Ae,[l(K,{class:"me-2",image:w(V).getUserAvatar($.value.author.avatar)},null,8,["image"]),u("div",null,[u("div",Ne,n($.value.title),1),u("div",Pe," by "+n($.value.author.display_name),1)])])):g.multiple?(o(),c("div",$e,[u("div",De," 已选择 "+n(m.value.length)+" 个"+n(g.author==="me"?"我的":"")+"项目 ",1),u("div",Ie,[(o(!0),c(k,null,z(m.value.slice(0,3),e=>(o(),y(h,{key:e.id,size:"small",variant:"outlined",color:"primary"},{default:t(()=>[i(n(e.title),1)]),_:2},1024))),128)),m.value.length>3?(o(),y(h,{key:0,size:"small",variant:"outlined",color:"grey"},{default:t(()=>[i(" +"+n(m.value.length-3),1)]),_:1})):b("",!0)])])):b("",!0):(o(),c("div",Se,n(g.multiple?"选择项目...":"选择一个项目..."),1))]),l(_,null,{default:t(()=>a[6]||(a[6]=[i("mdi-chevron-down",-1)])),_:1,__:[6]})]),_:1})]),_:1}),l(ze,{modelValue:x.value,"onUpdate:modelValue":a[5]||(a[5]=e=>x.value=e),"max-width":s.$vuetify.display.mobile?void 0:"1200px",fullscreen:s.$vuetify.display.mobile,scrollable:"",transition:"dialog-transition"},{default:t(()=>[l(C,{border:"",hover:""},{default:t(()=>[l(U,{class:"d-flex align-center justify-space-between pa-4"},{default:t(()=>[u("span",Ue,n(g.multiple?"选择项目":"选择一个项目"),1),l(E,{icon:"",variant:"text",onClick:a[0]||(a[0]=e=>x.value=!1)},{default:t(()=>[l(_,null,{default:t(()=>a[7]||(a[7]=[i("mdi-close",-1)])),_:1,__:[7]})]),_:1})]),_:1}),l(pe,{fluid:"",class:"pa-0"},{default:t(()=>[l(F,{"no-gutters":""},{default:t(()=>[l(S,{cols:g.multiple&&m.value.length>0?s.$vuetify.display.mobile?12:8:12,order:s.$vuetify.display.mobile?2:1},{default:t(()=>[u("div",Be,[l(he,{modelValue:T.value,"onUpdate:modelValue":a[1]||(a[1]=e=>T.value=e),label:"搜索项目","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onInput:re},null,8,["modelValue"]),l(F,{class:"mb-4"},{default:t(()=>[l(S,{cols:"12",sm:"6"},{default:t(()=>[l(le,{modelValue:O.value,"onUpdate:modelValue":[a[2]||(a[2]=e=>O.value=e),D],items:ie,label:"排序",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),l(S,{cols:"12",sm:"6"},{default:t(()=>[l(le,{modelValue:L.value,"onUpdate:modelValue":[a[3]||(a[3]=e=>L.value=e),D],items:ne,label:"状态",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1})]),_:1}),B.value?(o(),y(be,{key:0,indeterminate:"",color:"primary",class:"mb-4"})):b("",!0),B.value&&N.value.length===0?(o(),c("div",Te,[l(Ve,{indeterminate:"",size:"48"}),a[8]||(a[8]=u("div",{class:"mt-4 text-h6"},"加载中...",-1))])):N.value.length===0?(o(),c("div",Ee,[l(_,{size:"64",class:"mb-4"},{default:t(()=>a[9]||(a[9]=[i("mdi-folder-open-outline",-1)])),_:1,__:[9]}),a[10]||(a[10]=u("div",{class:"text-h6"},"未找到项目",-1))])):(o(),y(F,{key:3},{default:t(()=>[(o(!0),c(k,null,z(N.value,e=>(o(),y(S,{key:e.id,cols:"6",sm:"6",md:"4",lg:"3"},{default:t(()=>[l(C,{class:j(["project-card",{selected:Q(e.id)}]),rounded:"lg",elevation:"2",onClick:f=>ce(e)},{default:t(()=>{var f;return[l(C,{rounded:"lg",style:{"aspect-ratio":"4/3"}},{default:t(()=>[l(G,{src:w(te)(e.thumbnail),class:"align-end",cover:"",gradient:"to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)",height:"100%","lazy-src":ee},{default:t(()=>[l(A,null,{default:t(()=>[l(U,{class:"text-white"},{default:t(()=>[i(n(e.title),1)]),_:2},1024),l(M,{class:"text-white"},{default:t(()=>[i(n(e.description),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["src"])]),_:2},1024),l(A,{"append-avatar":(f=e.author)!=null&&f.avatar?w(V).getUserAvatar(e.author.avatar):""},{append:t(()=>[u("div",Fe,[l(h,{color:e.state==="public"?"success":"warning",size:"small",variant:"outlined"},{default:t(()=>[i(n(e.state==="public"?"公开":"私有"),1)]),_:2},1032,["color"]),Q(e.id)?(o(),y(_,{key:0,color:"primary",size:"24"},{default:t(()=>a[11]||(a[11]=[i(" mdi-check-circle ",-1)])),_:1,__:[11]})):b("",!0)])]),default:t(()=>[l(U,null,{default:t(()=>{var r,I;return[i(n(((r=e.author)==null?void 0:r.display_name)||((I=e.author)==null?void 0:I.username)||"未知用户"),1)]}),_:2},1024),l(M,null,{default:t(()=>{var r;return[i("@"+n(((r=e.author)==null?void 0:r.username)||""),1)]}),_:2},1024)]),_:2},1032,["append-avatar"]),l(A,{class:"pt-0"},{default:t(()=>[u("div",Me,[u("div",Oe,[u("div",Le,[l(_,{size:"16",class:"me-1"},{default:t(()=>a[12]||(a[12]=[i("mdi-eye",-1)])),_:1,__:[12]}),i(" "+n(e.view_count),1)]),u("div",Je,[l(_,{size:"16",class:"me-1"},{default:t(()=>a[13]||(a[13]=[i("mdi-star",-1)])),_:1,__:[13]}),i(" "+n(e.star_count),1)])]),u("div",null,n(Z(e.time)),1)]),e.tags?(o(),c("div",Re,[(o(!0),c(k,null,z(e.tags.split(","),r=>(o(),y(h,{key:r,size:"x-small",variant:"outlined",class:"me-1"},{default:t(()=>[i(n(r.trim()),1)]),_:2},1024))),128))])):b("",!0)]),_:2},1024)]}),_:2},1032,["class","onClick"])]),_:2},1024))),128))]),_:1})),J.value>0?(o(),c("div",Ye,[l(xe,{modelValue:P.value,"onUpdate:modelValue":[a[4]||(a[4]=e=>P.value=e),de],length:Math.ceil(J.value/g.limit),"total-visible":7},null,8,["modelValue","length"])])):b("",!0)])]),_:1},8,["cols","order"]),g.multiple&&m.value.length>0?(o(),y(S,{key:0,cols:s.$vuetify.display.mobile?12:4,class:j({"border-s":!s.$vuetify.display.mobile,"border-b":s.$vuetify.display.mobile}),order:s.$vuetify.display.mobile?1:2},{default:t(()=>[s.$vuetify.display.mobile?(o(),c("div",Ge,[u("div",He,[a[14]||(a[14]=u("div",{class:"text-h6"},"已选择",-1)),l(h,{border:"",size:"small"},{default:t(()=>[i(n(m.value.length),1)]),_:1})]),u("div",Qe,[l(we,{column:""},{default:t(()=>[(o(!0),c(k,null,z(m.value,e=>(o(),y(h,{key:e.id,closable:"",border:"",variant:"text","onClick:close":f=>W(e.id)},{default:t(()=>[l(K,{start:"",size:"24",class:"me-2"},{default:t(()=>[l(G,{src:w(V).getUserAvatar(e.author.avatar),cover:""},{placeholder:t(()=>[l(_,{size:"12"},{default:t(()=>a[15]||(a[15]=[i("mdi-image",-1)])),_:1,__:[15]})]),_:2},1032,["src"])]),_:2},1024),i(" "+n(e.title),1)]),_:2},1032,["onClick:close"]))),128))]),_:1})]),l(E,{color:"primary",variant:"elevated",block:"",size:"large",onClick:X},{default:t(()=>[l(_,{start:""},{default:t(()=>a[16]||(a[16]=[i("mdi-check",-1)])),_:1,__:[16]}),i(" 确认选择 ("+n(m.value.length)+") ",1)]),_:1})])):(o(),c("div",We,[u("div",Xe,[a[17]||(a[17]=u("div",{class:"text-h6"},"已选择",-1)),l(h,{color:"primary",size:"small"},{default:t(()=>[i(n(m.value.length),1)]),_:1})]),u("div",null,[l(F,null,{default:t(()=>[(o(!0),c(k,null,z(m.value,e=>(o(),y(S,{key:e.id,cols:"12",sm:"6"},{default:t(()=>[l(C,{rounded:"lg",elevation:"2",border:"",hover:""},{default:t(()=>{var f;return[l(C,{rounded:"lg",style:{"aspect-ratio":"4/3"}},{default:t(()=>[l(G,{src:w(te)(e.thumbnail),class:"align-end",cover:"",gradient:"to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)",height:"100%","lazy-src":ee},{default:t(()=>[l(A,null,{default:t(()=>[l(U,{class:"text-white"},{default:t(()=>[i(n(e.title),1)]),_:2},1024),l(M,{class:"text-white"},{default:t(()=>[i(n(e.description),1)]),_:2},1024)]),_:2},1024),u("div",Ze,[l(E,{icon:"",size:"small",variant:"elevated",color:"error",onClick:ke(r=>W(e.id),["stop"])},{default:t(()=>[l(_,{size:"16"},{default:t(()=>a[18]||(a[18]=[i("mdi-close",-1)])),_:1,__:[18]})]),_:2},1032,["onClick"])])]),_:2},1032,["src"])]),_:2},1024),l(A,{"append-avatar":(f=e.author)!=null&&f.avatar?w(V).getUserAvatar(e.author.avatar):""},{append:t(()=>[u("div",qe,[l(h,{color:e.state==="public"?"success":"warning",size:"small",variant:"outlined"},{default:t(()=>[i(n(e.state==="public"?"公开":"私有"),1)]),_:2},1032,["color"])])]),default:t(()=>[l(U,null,{default:t(()=>{var r,I;return[i(n(((r=e.author)==null?void 0:r.display_name)||((I=e.author)==null?void 0:I.username)||"未知用户"),1)]}),_:2},1024),l(M,null,{default:t(()=>{var r;return[i("@"+n(((r=e.author)==null?void 0:r.username)||""),1)]}),_:2},1024)]),_:2},1032,["append-avatar"]),l(A,{class:"pt-0"},{default:t(()=>[u("div",Ke,[u("div",je,[u("div",et,[l(_,{size:"16",class:"me-1"},{default:t(()=>a[19]||(a[19]=[i("mdi-eye",-1)])),_:1,__:[19]}),i(" "+n(e.view_count),1)]),u("div",tt,[l(_,{size:"16",class:"me-1"},{default:t(()=>a[20]||(a[20]=[i("mdi-star",-1)])),_:1,__:[20]}),i(" "+n(e.star_count),1)])]),u("div",null,n(Z(e.time)),1)]),e.tags?(o(),c("div",at,[(o(!0),c(k,null,z(e.tags.split(","),r=>(o(),y(h,{key:r,size:"x-small",variant:"outlined",class:"me-1"},{default:t(()=>[i(n(r.trim()),1)]),_:2},1024))),128))])):b("",!0)]),_:2},1024)]}),_:2},1024)]),_:2},1024))),128))]),_:1})]),l(E,{color:"primary",variant:"elevated",block:"",class:"mt-3",size:"large",onClick:X},{default:t(()=>[l(_,{start:""},{default:t(()=>a[21]||(a[21]=[i("mdi-check",-1)])),_:1,__:[21]}),i(" 确认选择 ("+n(m.value.length)+") ",1)]),_:1})]))]),_:1},8,["cols","class","order"])):b("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","max-width","fullscreen"])]))}},nt=fe(lt,[["__scopeId","data-v-de56f006"]]);export{nt as _};
