import{_ as D}from"./ProjectSelector-CrQE6g96.js";import{_ as F,a6 as C,Y as y,o as g,N as s,e as t,Z as p,af as h,L as r,P as m,a9 as x,aK as z,aJ as U,O as L,i as w,U as u,aF as M,f as d,j as B,R as _,S as b,c as j,F as E,X as I,a_ as T,b0 as N,T as R,a0 as Y,aY as Z,W as H,ag as S,bg as J,a7 as K}from"./index-CMux7lMK.js";import{V as O}from"./VCheckbox-er18FCoX.js";import{V as W}from"./VSkeletonLoader-DS526Wdt.js";import"https://static.geetest.com/v4/gt4.js";const X={name:"ExtensionCreateDialog",components:{ProjectSelector:D},props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","created"],data(){return{formValid:!1,loading:!1,selectedProjectIds:[],scratchCompatible:!1,createProgress:{current:0,total:0,isVisible:!1}}},computed:{dialog:{get(){return this.modelValue},set(o){this.$emit("update:modelValue",o)}}},watch:{modelValue(o){o&&this.resetForm()}},methods:{async createExtensions(){if(!(!this.selectedProjectIds||this.selectedProjectIds.length===0)){this.loading=!0,this.createProgress={current:0,total:this.selectedProjectIds.length,isVisible:!0};try{let o=0,e=0;for(let i=0;i<this.selectedProjectIds.length;i++){const c=this.selectedProjectIds[i];this.createProgress.current=i+1;try{const l={projectid:c,scratchCompatible:this.scratchCompatible},n=await C.post("/extensions/manager/create",l);n.data.status==="success"?o++:(e++,console.error(`Failed to create extension for project ${c}:`,n.data))}catch(l){e++,console.error(`Failed to create extension for project ${c}:`,l)}}o>0?(this.$emit("created"),this.closeDialog(),e>0?this.showMessage(`成功创建 ${o} 个扩展，${e} 个失败`,"warning"):this.showMessage(`成功创建 ${o} 个扩展`,"success")):this.showMessage("所有扩展创建失败","error")}catch(o){console.error("Failed to create extensions:",o),this.showMessage("创建扩展失败","error")}finally{this.loading=!1,this.createProgress.isVisible=!1}}},resetForm(){this.selectedProjectIds=[],this.scratchCompatible=!1},closeDialog(){this.dialog=!1},showMessage(o,e){console.log(o)}}},q={class:"text-center mt-3"},G={class:"text-body-2"},Q={class:"text-caption text-grey"};function $(o,e,i,c,l,n){const f=D;return g(),y(M,{modelValue:n.dialog,"onUpdate:modelValue":e[4]||(e[4]=a=>n.dialog=a),"max-width":"800",persistent:""},{default:s(()=>[t(p,null,{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>[...e[5]||(e[5]=[r("mdi-plus",-1)])]),_:1}),e[6]||(e[6]=r(" 创建扩展 ",-1))]),_:1}),t(x,null,{default:s(()=>[t(z,{ref:"form",modelValue:l.formValid,"onUpdate:modelValue":e[2]||(e[2]=a=>l.formValid=a)},{default:s(()=>[t(p,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(h,{class:"text-subtitle-1"},{default:s(()=>[...e[7]||(e[7]=[r("选择项目",-1)])]),_:1}),t(x,null,{default:s(()=>[t(f,{modelValue:l.selectedProjectIds,"onUpdate:modelValue":e[0]||(e[0]=a=>l.selectedProjectIds=a),multiple:!0,author:"me"},null,8,["modelValue"])]),_:1})]),_:1}),t(p,{variant:"tonal",border:"",class:"mb-4"},{default:s(()=>[t(h,{class:"text-subtitle-1"},{default:s(()=>[...e[8]||(e[8]=[r("批量设置",-1)])]),_:1}),t(x,null,{default:s(()=>[t(O,{modelValue:l.scratchCompatible,"onUpdate:modelValue":e[1]||(e[1]=a=>l.scratchCompatible=a),label:"兼容 Scratch","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(U,null,{default:s(()=>[t(L),t(w,{onClick:n.closeDialog},{default:s(()=>[...e[9]||(e[9]=[r("取消",-1)])]),_:1},8,["onClick"]),t(w,{color:"primary",loading:l.loading,disabled:!l.selectedProjectIds||l.selectedProjectIds.length===0,onClick:n.createExtensions},{default:s(()=>[r(" 创建扩展 ("+u(l.selectedProjectIds?l.selectedProjectIds.length:0)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1}),t(M,{modelValue:l.createProgress.isVisible,"onUpdate:modelValue":e[3]||(e[3]=a=>l.createProgress.isVisible=a),persistent:"","max-width":"400"},{default:s(()=>[t(p,null,{default:s(()=>[t(h,{class:"text-center"},{default:s(()=>[...e[10]||(e[10]=[r(" 正在创建扩展... ",-1)])]),_:1}),t(x,null,{default:s(()=>[t(B,{"model-value":l.createProgress.current/l.createProgress.total*100,color:"primary",height:"8",rounded:""},null,8,["model-value"]),d("div",q,[d("p",G,u(l.createProgress.current)+" / "+u(l.createProgress.total),1),d("p",Q," 正在处理第 "+u(l.createProgress.current)+" 个项目... ",1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])}const A=F(X,[["render",$]]),ee={name:"ExtensionsManagement",components:{ExtensionCreateDialog:A},setup(){K({title:"扩展管理 - ZeroCat"})},data(){return{loading:!1,extensions:[],myProjects:[],s3BucketUrl:"",showCreateDialog:!1,showEditDialog:!1,editFormValid:!1,editLoading:!1,editTarget:null,editForm:{branch:"",commit:"",image:"",samples:null,docs:""},showDeleteDialog:!1,deleteLoading:!1,deleteTarget:null,pushAllLoading:!1,updateAllLoading:!1,snackbar:{show:!1,message:"",color:"success"}}},async mounted(){this.s3BucketUrl=J("s3.staticurl"),await Promise.all([this.fetchExtensions(),this.fetchMyProjects()])},methods:{async fetchExtensions(){this.loading=!0;try{const o=await C.get("/extensions/manager/my");o.data.status==="success"&&(this.extensions=o.data.data)}catch(o){console.error("Failed to fetch extensions:",o),this.showMessage("扩展管理失败","error")}finally{this.loading=!1}},async fetchMyProjects(){try{console.log(S.user);const o=await C.get("/searchapi",{params:{search_userid:S.user.value.id,search_state:"public",limit:100}});o.data&&o.data.projects&&(this.myProjects=o.data.projects)}catch(o){console.error("Failed to fetch my projects:",o)}},getStatusColor(o){return{developing:"primary",pending:"warning",verified:"success",rejected:"error"}[o]||"grey"},getStatusText(o){return{developing:"开发中",pending:"待审核",verified:"上架",rejected:"已拒绝"}[o]||"未知"},showMessage(o,e="success"){this.snackbar={show:!0,message:o,color:e}},async pushAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可推送的扩展","warning");return}this.pushAllLoading=!0;try{const o=this.extensions.map(l=>C.post(`/extensions/manager/submit/${l.id}`)),i=(await Promise.allSettled(o)).filter(l=>{var n,f;return l.status==="fulfilled"&&((f=(n=l.value)==null?void 0:n.data)==null?void 0:f.status)==="success"}).length,c=this.extensions.length-i;c===0?this.showMessage(`成功推送 ${i} 个扩展`,"success"):this.showMessage(`推送完成: ${i} 个成功, ${c} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to push all extensions:",o),this.showMessage("批量推送失败","error")}finally{this.pushAllLoading=!1}},async updateAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可更新的扩展","warning");return}this.updateAllLoading=!0;try{const o=this.extensions.map(l=>C.post(`/extensions/manager/update/${l.id}`)),i=(await Promise.allSettled(o)).filter(l=>{var n,f;return l.status==="fulfilled"&&((f=(n=l.value)==null?void 0:n.data)==null?void 0:f.status)==="success"}).length,c=this.extensions.length-i;c===0?this.showMessage(`成功更新 ${i} 个扩展`,"success"):this.showMessage(`更新完成: ${i} 个成功, ${c} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to update all extensions:",o),this.showMessage("批量更新失败","error")}finally{this.updateAllLoading=!1}}}},se={class:"d-flex align-center mb-2"},te={class:"text-caption"},le={class:"d-flex align-center mb-2"},oe={class:"text-caption"},ae={key:0,class:"d-flex align-center mb-2"},re={class:"text-caption"},ne={class:"d-flex align-center mb-2"},ie={class:"text-caption"};function de(o,e,i,c,l,n){const f=A;return g(),y(H,null,{default:s(()=>[t(_,null,{default:s(()=>[t(b,{cols:"12"},{default:s(()=>[t(p,{variant:"flat"},{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>[...e[3]||(e[3]=[r("mdi-puzzle",-1)])]),_:1}),e[5]||(e[5]=r(" 扩展管理 ",-1)),t(L),t(w,{color:"success","prepend-icon":"mdi-plus",onClick:e[0]||(e[0]=a=>l.showCreateDialog=!0)},{default:s(()=>[...e[4]||(e[4]=[r(" 创建扩展 ",-1)])]),_:1})]),_:1}),t(x,null,{default:s(()=>[l.loading?(g(),y(_,{key:0},{default:s(()=>[(g(),j(E,null,I(6,a=>t(b,{key:a,cols:"12",md:"6",lg:"4"},{default:s(()=>[t(W,{type:"card"})]),_:1})),64))]),_:1})):l.extensions.length===0?(g(),y(_,{key:1},{default:s(()=>[t(b,{cols:"12",class:"text-center py-8"},{default:s(()=>[t(m,{size:"64",color:"grey-lighten-1"},{default:s(()=>[...e[6]||(e[6]=[r("mdi-puzzle-outline",-1)])]),_:1}),e[7]||(e[7]=d("p",{class:"text-h6 mt-4 text-grey-darken-1"},"扩展管理",-1)),e[8]||(e[8]=d("p",{class:"text-body-2 text-grey"},"扩展管理",-1))]),_:1})]),_:1})):(g(),y(_,{key:2},{default:s(()=>[(g(!0),j(E,null,I(l.extensions,a=>(g(),y(b,{key:a.id,cols:"12",md:"6",lg:"4"},{default:s(()=>{var P,k,v;return[t(p,{border:"",hover:"",to:`/${(k=(P=a.project)==null?void 0:P.author)==null?void 0:k.username}/${(v=a.project)==null?void 0:v.name}`},{default:s(()=>[t(T,null,{append:s(()=>[t(R,{color:n.getStatusColor(a.status),size:"small",variant:"flat"},{default:s(()=>[r(u(n.getStatusText(a.status)),1)]),_:2},1032,["color"])]),default:s(()=>[t(h,null,{default:s(()=>{var V;return[r(u(((V=a.project)==null?void 0:V.title)||"扩展"),1)]}),_:2},1024),t(N,null,{default:s(()=>{var V;return[r(u(((V=a.project)==null?void 0:V.description)||"扩展"),1)]}),_:2},1024)]),_:2},1024),t(x,null,{default:s(()=>{var V;return[d("div",se,[t(m,{class:"mr-1",size:"small"},{default:s(()=>[...e[9]||(e[9]=[r("mdi-source-branch",-1)])]),_:1}),d("span",te,u(a.branch||"main"),1)]),d("div",le,[t(m,{class:"mr-1",size:"small"},{default:s(()=>[...e[10]||(e[10]=[r("mdi-source-commit",-1)])]),_:1}),d("span",oe,u(((V=a.commit)==null?void 0:V.substring(0,8))||"latest"),1)]),a.sample_project?(g(),j("div",ae,[t(m,{class:"mr-1",size:"small"},{default:s(()=>[...e[11]||(e[11]=[r("mdi-file-document",-1)])]),_:1}),d("span",re,"示例项目: "+u(a.sample_project.title),1)])):Y("",!0),d("div",ne,[t(m,{class:"mr-1",size:"small"},{default:s(()=>[...e[12]||(e[12]=[r("mdi-puzzle",-1)])]),_:1}),d("span",ie,u(a.scratchCompatible?"兼容原版Scratch":"不兼容原版Scratch"),1)])]}),_:2},1024)]),_:2},1032,["to"])]}),_:2},1024))),128))]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1}),t(f,{modelValue:l.showCreateDialog,"onUpdate:modelValue":e[1]||(e[1]=a=>l.showCreateDialog=a),onCreated:n.fetchExtensions},null,8,["modelValue","onCreated"]),t(_,{class:"mt-6"},{default:s(()=>[t(b,{cols:"12"},{default:s(()=>[t(p,{variant:"flat",border:""},{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>[...e[13]||(e[13]=[r("mdi-cog",-1)])]),_:1}),e[14]||(e[14]=r(" 高级设置 ",-1))]),_:1}),t(x,null,{default:s(()=>[t(_,null,{default:s(()=>[t(b,{cols:"12",md:"6"},{default:s(()=>[t(p,{variant:"tonal",border:""},{default:s(()=>[t(h,{class:"text-h6"},{default:s(()=>[t(m,{class:"mr-2",color:"primary"},{default:s(()=>[...e[15]||(e[15]=[r("mdi-cloud-upload",-1)])]),_:1}),e[16]||(e[16]=r(" 批量推送 ",-1))]),_:1}),t(x,null,{default:s(()=>[e[17]||(e[17]=d("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 批量同步扩展时使用 ",-1)),t(w,{color:"primary",loading:l.pushAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-cloud-upload",onClick:n.pushAllExtensions,block:""},{default:s(()=>[r(" 全部推送 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1}),t(b,{cols:"12",md:"6"},{default:s(()=>[t(p,{variant:"tonal",border:""},{default:s(()=>[t(h,{class:"text-h6"},{default:s(()=>[t(m,{class:"mr-2",color:"success"},{default:s(()=>[...e[18]||(e[18]=[r("mdi-update",-1)])]),_:1}),e[19]||(e[19]=r(" 批量更新 ",-1))]),_:1}),t(x,null,{default:s(()=>[e[20]||(e[20]=d("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 这是谁提的需求？ ",-1)),t(w,{color:"success",loading:l.updateAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-update",onClick:n.updateAllExtensions,block:""},{default:s(()=>[r(" 一键更新 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(Z,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[2]||(e[2]=a=>l.snackbar.show=a),color:l.snackbar.color},{default:s(()=>[r(u(l.snackbar.message),1)]),_:1},8,["modelValue","color"])]),_:1})}const pe=F(ee,[["render",de]]);export{pe as default};
