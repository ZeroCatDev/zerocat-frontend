import{_ as P,Y as T,o as j,N as s,e as t,Q as h,R as a,W as c,a3 as V,f as m,X as y,aB as u,i as f,S as D,P as B,eq as O,L as p,a0 as E,aA as x,a9 as _,aE as w,T as S,aT as Q,a1 as b}from"./index-DI76moR_.js";import{d as z}from"./debounce-BMmXVQ06.js";import{V as g}from"./VSelect-BPEXxhn-.js";import{V as N}from"./VDataTableServer-B8uBrgpM.js";import{V as v}from"./VSpacer-CzhVVz1U.js";import{V as A}from"./VTextarea-CUxfl8f1.js";import{V as C}from"./VSwitch-BlWEtB8p.js";import"https://static.geetest.com/v4/gt4.js";import"./VCheckboxBtn-B8dmKHWV.js";import"./VSelectionControl-Cz3PfTMn.js";import"./VDataTable-BvoGCn-c.js";import"./VTable-CGn6dmBv.js";import"./filter-Dz5Vmun4.js";const L={name:"ProjectPage",data(){return{headers:[{title:"ID",key:"id",sortable:!0},{title:"项目名",key:"name",sortable:!0},{title:"标题",key:"title",sortable:!0},{title:"状态",key:"state",sortable:!0},{title:"类型",key:"type",sortable:!0},{title:"浏览数",key:"view_count",sortable:!0},{title:"星标数",key:"star_count",sortable:!0},{title:"作者",key:"author.username",sortable:!1},{title:"操作",key:"actions",sortable:!1}],stateOptions:[{title:"公开",value:"public"},{title:"私有",value:"private"},{title:"草稿",value:"draft"},{title:"已删除",value:"deleted"}],typeOptions:[{title:"文本",value:"text"},{title:"Scratch",value:"scratch"},{title:"Python",value:"python"}],items:[],loading:!1,totalItems:0,itemsPerPage:10,searchQuery:"",filters:{state:null,type:null,authorid:null},stats:{totalProjects:0,projectsByState:[],projectsByType:[],mostViewed:[],mostStarred:[]},viewDialog:!1,editDialog:!1,deleteDialog:!1,selectedItem:null,editedItem:{},snackbar:{show:!1,text:"",color:"success"}}},methods:{getStateCount(i){var d;const e=(d=this.stats.projectsByState)==null?void 0:d.find(n=>n.state===i);return(e==null?void 0:e._count)||0},getTypeCount(i){var d;const e=(d=this.stats.projectsByType)==null?void 0:d.find(n=>n.type===i);return(e==null?void 0:e._count)||0},getStateColor(i){return{public:"success",private:"warning",draft:"info",deleted:"error"}[i]||"default"},getStateText(i){return{public:"公开",private:"私有",draft:"草稿",deleted:"已删除"}[i]||i},getTypeColor(i){return{text:"primary",scratch:"success",python:"info"}[i]||"default"},getTypeText(i){return{text:"文本",scratch:"Scratch",python:"Python"}[i]||i},async loadItems(i){try{this.loading=!0;const{page:e=1,itemsPerPage:d=10,sortBy:n=[],sortDesc:l=[]}=i||{};let r="id",o="asc";n.length>0&&(r=n[0].key||"id",o=n[0].order);const I={page:e,limit:d,sortBy:r,sortOrder:o,search:this.searchQuery,...this.filters};console.log("Sorting details:",{sortBy:n,sortDesc:l,sortField:r,sortOrder:o,sortIndex:n.findIndex(U=>U.key===r)}),console.log("Request params:",I);const k=await b.get("/admin/projects",{params:I});this.items=k.data.data,this.totalItems=k.data.pagination.total}catch(e){console.error("Error loading items:",e),this.showError("加载项目列表失败")}finally{this.loading=!1}},async loadStats(){try{const i=await b.get("/admin/projects/stats/overview");this.stats=i.data}catch{this.showError("加载统计数据失败")}},async viewProject(i){try{const e=await b.get(`/admin/projects/${i.id}`);this.selectedItem=e.data,this.viewDialog=!0}catch{this.showError("加载项目详情失败")}},editProject(i){const e=i.time?new Date(i.time).toISOString().slice(0,16):null;this.editedItem={...i,time:e},this.editDialog=!0},async saveProject(){var i,e;try{const d={...this.editedItem,authorid:parseInt(this.editedItem.authorid),view_count:parseInt(this.editedItem.view_count),like_count:parseInt(this.editedItem.like_count),star_count:parseInt(this.editedItem.star_count),history:!!this.editedItem.history,devenv:!!this.editedItem.devenv};if(this.editedItem.time){const n=new Date(this.editedItem.time);d.time=n.toISOString()}await b.put(`/admin/projects/${this.editedItem.id}`,d),this.editDialog=!1,this.showSuccess("项目更新成功"),this.loadItems(),this.loadStats()}catch(d){(e=(i=d.response)==null?void 0:i.data)!=null&&e.error?this.showError(d.response.data.error):this.showError("更新项目失败")}},confirmDelete(i){this.selectedItem=i,this.deleteDialog=!0},async deleteProject(){try{await b.delete(`/admin/projects/${this.selectedItem.id}`),this.deleteDialog=!1,this.showSuccess("项目删除成功"),this.loadItems(),this.loadStats()}catch{this.showError("删除项目失败")}},refreshData(){this.loadItems(),this.loadStats()},debouncedSearch:z(function(){this.loadItems()},300),showSuccess(i){this.snackbar={show:!0,text:i,color:"success"}},showError(i){this.snackbar={show:!0,text:i,color:"error"}},formatDateTime(i){if(!i)return"未设置";try{return new Date(i).toLocaleString()}catch{return"无效日期"}}},mounted(){this.loadItems(),this.loadStats()}},R={class:"text-h4 mb-2"},q={class:"text-h4 mb-2"},F={class:"text-h4 mb-2"},G={class:"text-h4 mb-2"},J={class:"project-json"},M={class:"text-h5"};function W(i,e,d,n,l,r){return j(),T(S,{fluid:""},{default:s(()=>[t(h,null,{default:s(()=>[t(a,{cols:"12",md:"3",sm:"6"},{default:s(()=>[t(c,null,{default:s(()=>[t(V,{class:"text-center"},{default:s(()=>[m("div",R,y(l.stats.totalProjects||0),1),e[28]||(e[28]=m("div",{class:"text-body-2"},"总项目数",-1))]),_:1,__:[28]})]),_:1})]),_:1}),t(a,{cols:"12",md:"3",sm:"6"},{default:s(()=>[t(c,null,{default:s(()=>[t(V,{class:"text-center"},{default:s(()=>[m("div",q,y(r.getStateCount("public")),1),e[29]||(e[29]=m("div",{class:"text-body-2"},"公开项目",-1))]),_:1,__:[29]})]),_:1})]),_:1}),t(a,{cols:"12",md:"3",sm:"6"},{default:s(()=>[t(c,null,{default:s(()=>[t(V,{class:"text-center"},{default:s(()=>[m("div",F,y(r.getStateCount("private")),1),e[30]||(e[30]=m("div",{class:"text-body-2"},"私有项目",-1))]),_:1,__:[30]})]),_:1})]),_:1}),t(a,{cols:"12",md:"3",sm:"6"},{default:s(()=>[t(c,null,{default:s(()=>[t(V,{class:"text-center"},{default:s(()=>[m("div",G,y(r.getTypeCount("scratch")),1),e[31]||(e[31]=m("div",{class:"text-body-2"},"Scratch项目",-1))]),_:1,__:[31]})]),_:1})]),_:1})]),_:1}),t(h,{class:"mt-4"},{default:s(()=>[t(a,{cols:"12",md:"3",sm:"4"},{default:s(()=>[t(u,{modelValue:l.searchQuery,"onUpdate:modelValue":[e[0]||(e[0]=o=>l.searchQuery=o),r.debouncedSearch],clearable:"",label:"搜索项目","prepend-icon":"mdi-magnify"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(a,{cols:"12",md:"3",sm:"4"},{default:s(()=>[t(g,{modelValue:l.filters.state,"onUpdate:modelValue":[e[1]||(e[1]=o=>l.filters.state=o),r.loadItems],items:l.stateOptions,clearable:"",label:"项目状态"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),t(a,{cols:"12",md:"3",sm:"4"},{default:s(()=>[t(g,{modelValue:l.filters.type,"onUpdate:modelValue":[e[2]||(e[2]=o=>l.filters.type=o),r.loadItems],items:l.typeOptions,clearable:"",label:"项目类型"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),t(a,{cols:"12",md:"3",sm:"4"},{default:s(()=>[t(u,{modelValue:l.filters.authorid,"onUpdate:modelValue":[e[3]||(e[3]=o=>l.filters.authorid=o),r.loadItems],clearable:"",label:"作者ID",type:"number"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1}),t(N,{"items-per-page":l.itemsPerPage,"onUpdate:itemsPerPage":e[4]||(e[4]=o=>l.itemsPerPage=o),headers:l.headers,items:l.items,"items-length":l.totalItems,loading:l.loading,search:l.searchQuery,class:"elevation-1 mt-4","onUpdate:options":r.loadItems},{top:s(()=>[t(B,{flat:""},{default:s(()=>[t(O,null,{default:s(()=>e[32]||(e[32]=[p("项目管理",-1)])),_:1,__:[32]}),t(E,{class:"mx-4",inset:"",vertical:""}),t(v),t(f,{color:"primary","prepend-icon":"mdi-refresh",onClick:r.refreshData},{default:s(()=>e[33]||(e[33]=[p(" 刷新 ",-1)])),_:1,__:[33]},8,["onClick"])]),_:1})]),"item.state":s(({item:o})=>[t(D,{color:r.getStateColor(o.state),text:r.getStateText(o.state),size:"small"},null,8,["color","text"])]),"item.type":s(({item:o})=>[t(D,{color:r.getTypeColor(o.type),text:r.getTypeText(o.type),size:"small"},null,8,["color","text"])]),"item.actions":s(({item:o})=>[t(f,{class:"mr-2",icon:"mdi-eye",size:"small",variant:"text",onClick:I=>r.viewProject(o)},null,8,["onClick"]),t(f,{class:"mr-2",icon:"mdi-pencil",size:"small",variant:"text",onClick:I=>r.editProject(o)},null,8,["onClick"]),t(f,{color:"error",icon:"mdi-delete",size:"small",variant:"text",onClick:I=>r.confirmDelete(o)},null,8,["onClick"])]),_:1},8,["items-per-page","headers","items","items-length","loading","search","onUpdate:options"]),t(x,{modelValue:l.viewDialog,"onUpdate:modelValue":e[6]||(e[6]=o=>l.viewDialog=o),"max-width":"800px"},{default:s(()=>[t(c,null,{default:s(()=>[t(_,null,{default:s(()=>e[34]||(e[34]=[m("span",{class:"text-h5"},"项目详情",-1)])),_:1,__:[34]}),t(V,null,{default:s(()=>[m("pre",J,y(JSON.stringify(l.selectedItem,null,2)),1)]),_:1}),t(w,null,{default:s(()=>[t(v),t(f,{color:"primary",variant:"text",onClick:e[5]||(e[5]=o=>l.viewDialog=!1)},{default:s(()=>e[35]||(e[35]=[p(" 关闭 ",-1)])),_:1,__:[35]})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(x,{modelValue:l.editDialog,"onUpdate:modelValue":e[23]||(e[23]=o=>l.editDialog=o),"max-width":"800px"},{default:s(()=>[t(c,null,{default:s(()=>[t(_,null,{default:s(()=>[m("span",M,"编辑项目 #"+y(l.editedItem.id),1)]),_:1}),t(V,null,{default:s(()=>[t(S,null,{default:s(()=>[t(h,null,{default:s(()=>[t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.name,"onUpdate:modelValue":e[7]||(e[7]=o=>l.editedItem.name=o),hint:"项目的唯一标识符",label:"项目名称","persistent-hint":""},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.title,"onUpdate:modelValue":e[8]||(e[8]=o=>l.editedItem.title=o),label:"标题"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.authorid,"onUpdate:modelValue":e[9]||(e[9]=o=>l.editedItem.authorid=o),hint:"新作者的用户ID",label:"作者ID","persistent-hint":"",type:"number"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(g,{modelValue:l.editedItem.state,"onUpdate:modelValue":e[10]||(e[10]=o=>l.editedItem.state=o),items:l.stateOptions,label:"状态"},null,8,["modelValue","items"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(g,{modelValue:l.editedItem.type,"onUpdate:modelValue":e[11]||(e[11]=o=>l.editedItem.type=o),items:l.typeOptions,label:"项目类型"},null,8,["modelValue","items"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.license,"onUpdate:modelValue":e[12]||(e[12]=o=>l.editedItem.license=o),hint:"例如：MIT, GPL, Apache-2.0",label:"许可证","persistent-hint":""},null,8,["modelValue"])]),_:1}),t(a,{cols:"12"},{default:s(()=>[t(A,{modelValue:l.editedItem.description,"onUpdate:modelValue":e[13]||(e[13]=o=>l.editedItem.description=o),label:"描述",rows:"3"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12"},{default:s(()=>[t(u,{modelValue:l.editedItem.tags,"onUpdate:modelValue":e[14]||(e[14]=o=>l.editedItem.tags=o),label:"标签 (用逗号分隔)"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.default_branch,"onUpdate:modelValue":e[15]||(e[15]=o=>l.editedItem.default_branch=o),hint:"例如：main, master",label:"默认分支","persistent-hint":""},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(u,{modelValue:l.editedItem.time,"onUpdate:modelValue":e[16]||(e[16]=o=>l.editedItem.time=o),hint:"项目创建时间",label:"创建时间","persistent-hint":"",type:"datetime-local"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"4"},{default:s(()=>[t(u,{modelValue:l.editedItem.view_count,"onUpdate:modelValue":e[17]||(e[17]=o=>l.editedItem.view_count=o),label:"浏览数",type:"number"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"4"},{default:s(()=>[t(u,{modelValue:l.editedItem.like_count,"onUpdate:modelValue":e[18]||(e[18]=o=>l.editedItem.like_count=o),label:"点赞数",type:"number"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"4"},{default:s(()=>[t(u,{modelValue:l.editedItem.star_count,"onUpdate:modelValue":e[19]||(e[19]=o=>l.editedItem.star_count=o),label:"星标数",type:"number"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(C,{modelValue:l.editedItem.history,"onUpdate:modelValue":e[20]||(e[20]=o=>l.editedItem.history=o),color:"primary","hide-details":"",label:"启用历史记录"},null,8,["modelValue"])]),_:1}),t(a,{cols:"12",sm:"6"},{default:s(()=>[t(C,{modelValue:l.editedItem.devenv,"onUpdate:modelValue":e[21]||(e[21]=o=>l.editedItem.devenv=o),color:"primary","hide-details":"",label:"启用开发环境"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(w,null,{default:s(()=>[t(v),t(f,{color:"primary",variant:"text",onClick:e[22]||(e[22]=o=>l.editDialog=!1)},{default:s(()=>e[36]||(e[36]=[p(" 取消 ",-1)])),_:1,__:[36]}),t(f,{color:"error",variant:"text",onClick:r.saveProject},{default:s(()=>e[37]||(e[37]=[p(" 保存 ",-1)])),_:1,__:[37]},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(x,{modelValue:l.deleteDialog,"onUpdate:modelValue":e[25]||(e[25]=o=>l.deleteDialog=o),"max-width":"500px"},{default:s(()=>[t(c,null,{default:s(()=>[t(_,{class:"text-h5"},{default:s(()=>e[38]||(e[38]=[p("确认删除",-1)])),_:1,__:[38]}),t(V,null,{default:s(()=>e[39]||(e[39]=[p(" 确定要删除这个项目吗？此操作不可撤销。",-1)])),_:1,__:[39]}),t(w,null,{default:s(()=>[t(v),t(f,{color:"primary",variant:"text",onClick:e[24]||(e[24]=o=>l.deleteDialog=!1)},{default:s(()=>e[40]||(e[40]=[p(" 取消 ",-1)])),_:1,__:[40]}),t(f,{color:"error",variant:"text",onClick:r.deleteProject},{default:s(()=>e[41]||(e[41]=[p(" 确认 ",-1)])),_:1,__:[41]},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Q,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[27]||(e[27]=o=>l.snackbar.show=o),color:l.snackbar.color},{actions:s(()=>[t(f,{variant:"text",onClick:e[26]||(e[26]=o=>l.snackbar.show=!1)},{default:s(()=>e[42]||(e[42]=[p("关闭",-1)])),_:1,__:[42]})]),default:s(()=>[p(y(l.snackbar.text)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}const ae=P(L,[["render",W],["__scopeId","data-v-8625a494"]]);export{ae as default};
