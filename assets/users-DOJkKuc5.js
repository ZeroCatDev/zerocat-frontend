const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RegionSelector-Dxa_tgMR.js","assets/index-B0FU96U5.js","assets/index-ByScMQIc.css","assets/RegionSelector-CHugFwEI.css"])))=>i.map(i=>d[i]);
import{_ as N,a5 as h,aQ as $,bg as ee,X as x,o as p,M as a,e as l,Y as _,a_ as te,ae as O,L as s,b0 as le,O as C,T as m,i as c,a4 as M,a8 as b,aK as q,al as oe,am as F,V as ae,q as T,U as S,Q as k,R as u,aG as g,aC as y,f,N as D,c as V,$ as E,S as H,Z as L,n as Y,aJ as I,aF as P,F as G,W,D as K,eL as ie,aV as z,aI as A,aa as ne,aY as se,m as de}from"./index-B0FU96U5.js";import{_ as X}from"./RegionSelector-Dxa_tgMR.js";import{_ as J}from"./ProjectSelector-Cl0E4Vy5.js";import{V as re}from"./VTextarea-C9vyXJl_.js";import{V as ue}from"./VDataTable-CInb-SNW.js";import{V as me}from"./VSwitch-Bm74H8jq.js";import{d as j,r as ce}from"./zh-cn-B7cKHLiE.js";import{d as fe}from"./debounce-BMmXVQ06.js";import{V as ge}from"./VDataTableServer-D-j4tKkU.js";import{T as Q}from"./index-wjr7Dkz7.js";import"https://static.geetest.com/v4/gt4.js";import"./VTable-CEYRstKJ.js";import"./filter-C16qh8vV.js";import"./_commonjsHelpers-BosuxZz1.js";import"./VTooltip-C-1LDPa5.js";const pe={name:"UserEditor",components:{RegionSelector:X,ProjectSelector:J},props:{modelValue:{type:Boolean,required:!0},user:{type:Object,required:!0,default:()=>({})}},emits:["update:modelValue","save"],data(){return{tabIndex:1,formValid:!0,saving:!1,showRegionSelector:!1,selectedRegion:null,regionOptions:[],statusOptions:[{text:"活跃",value:"active"},{text:"已暂停",value:"suspended"},{text:"已封禁",value:"banned"},{text:"待验证",value:"pending"}],typeOptions:[{text:"访客",value:"guest"},{text:"普通用户",value:"user"},{text:"管理员",value:"admin"}],sexOptions:[{text:"男",value:"male"},{text:"女",value:"female"},{text:"其他",value:"other"}],contactTypes:[{text:"邮箱",value:"email"},{text:"电话",value:"phone"},{text:"QQ",value:"qq"},{text:"Google",value:"oauth_google"},{text:"GitHub",value:"oauth_github"},{text:"Microsoft",value:"oauth_microsoft"},{text:"40code",value:"oauth_40code"},{text:"LinuxDo",value:"oauth_linuxdo"},{text:"其他",value:"other"}],userData:this.initUserData(),connections:[],loadingConnections:!1,connectionHeaders:[{title:"类型",key:"contact_type",width:"150px"},{title:"验证状态",key:"verified",width:"100px"},{title:"创建时间",key:"created_at",width:"180px"},{title:"操作",key:"actions",width:"100px",sortable:!1}],oauthTypes:[{title:"Google",value:"oauth_google"},{title:"GitHub",value:"oauth_github"},{title:"Microsoft",value:"oauth_microsoft"},{title:"40code",value:"oauth_40code"},{title:"LinuxDo",value:"oauth_linuxdo"},{title:"email",value:"email"},{title:"phone",value:"phone"},{title:"qq",value:"qq"},{title:"other",value:"other"}],connectionDialog:{show:!1,isEdit:!1,valid:!0,saving:!1,data:this.initConnectionData(),infoKeys:[],metadataKeys:[]},deleteConnectionDialog:{show:!1,deleting:!1,connection:null},s3BucketUrl:""}},async created(){try{const t=await $(()=>import("./RegionSelector-Dxa_tgMR.js").then(e=>e.a),__vite__mapDeps([0,1,2,3]));this.regionOptions=Object.entries(t.default).map(([e,r])=>({value:e,text:r}))}catch(t){console.error("Error loading region options:",t),this.regionOptions=[]}this.s3BucketUrl=ee("s3.staticurl")},watch:{user:{handler(t){if(!t){this.userData=this.initUserData(),this.selectedRegion=null;return}if(this.userData=this.initUserData(t),t!=null&&t.region){const e=this.getRegionText(t.region);e?this.selectedRegion={value:t.region,text:e}:this.selectedRegion=null}else this.selectedRegion=null;t!=null&&t.id&&this.loadConnections()},immediate:!0}},methods:{initUserData(t={}){return{id:(t==null?void 0:t.id)??null,username:(t==null?void 0:t.username)??"",display_name:(t==null?void 0:t.display_name)??"",status:(t==null?void 0:t.status)??"active",type:(t==null?void 0:t.type)??"user",email:(t==null?void 0:t.email)??"",featured_projects:(t==null?void 0:t.featured_projects)??"",motto:(t==null?void 0:t.motto)??"",bio:(t==null?void 0:t.bio)??"",location:(t==null?void 0:t.location)??"",region:(t==null?void 0:t.region)??"",birthday:(t==null?void 0:t.birthday)??"",sex:(t==null?void 0:t.sex)??"",url:(t==null?void 0:t.url)??"",custom_status:(t==null?void 0:t.custom_status)??{emoji:"",text:""},avatar:(t==null?void 0:t.avatar)??"",featured_projects:(t==null?void 0:t.featured_projects)??[],contacts:((t==null?void 0:t.contacts)??[]).map(e=>({contact_type:(e==null?void 0:e.contact_type)??"",contact_value:(e==null?void 0:e.contact_value)??"",is_primary:(e==null?void 0:e.is_primary)??!1,verified:(e==null?void 0:e.verified)??!1,contact_info:(e==null?void 0:e.contact_info)??"",metadata:(e==null?void 0:e.metadata)??{}}))}},getRegionText(t){if(!t)return"";const e=this.regionOptions.find(r=>r.value===t);return e?e.text:t},addContact(){this.userData.contacts.push({contact_type:"",contact_value:"",is_primary:!1,verified:!1,contact_info:"",metadata:{}})},removeContact(t){this.userData.contacts.splice(t,1)},onRegionSelect(t){this.selectedRegion=t,this.userData.region=t.value,this.showRegionSelector=!1},onRegionClear(){this.selectedRegion=null,this.userData.region=null,this.showRegionSelector=!1},close(){this.$emit("update:modelValue",!1)},async save(){if(this.$refs.editForm.validate()){this.saving=!0;try{await this.$emit("save",this.userData),this.close()}finally{this.saving=!1}}},initConnectionData(){return{contact_type:"",contact_value:"",contact_info:"",metadata:{},verified:!1}},async loadConnections(){if(this.userData.id){this.loadingConnections=!0;try{const{data:t}=await h.get(`/admin/users/${this.userData.id}/connections`);this.connections=t}catch(t){console.error("Error loading connections:",t)}finally{this.loadingConnections=!1}}},showAddConnectionDialog(){this.connectionDialog.isEdit=!1,this.connectionDialog.data=this.initConnectionData(),this.connectionDialog.infoKeys=[],this.connectionDialog.metadataKeys=[],this.connectionDialog.show=!0},editConnection(t){this.connectionDialog.isEdit=!0,this.connectionDialog.data={...t,metadata:{...t.metadata}},this.connectionDialog.metadataKeys=Object.keys(t.metadata||{}),this.connectionDialog.show=!0},addMetadataField(){const t=`field_${this.connectionDialog.metadataKeys.length+1}`;this.$set(this.connectionDialog.data.metadata,t,""),this.connectionDialog.metadataKeys.push(t)},updateMetadataKey(t,e,r){if(r&&r!==e){const v=this.connectionDialog.data.metadata[e];this.$delete(this.connectionDialog.data.metadata,e),this.$set(this.connectionDialog.data.metadata,r,v),this.connectionDialog.metadataKeys[t]=r}},removeMetadataField(t){this.$delete(this.connectionDialog.data.metadata,t);const e=this.connectionDialog.metadataKeys.indexOf(t);e>-1&&this.connectionDialog.metadataKeys.splice(e,1)},async saveConnection(){var t;if((t=this.$refs.connectionForm)!=null&&t.validate()){this.connectionDialog.saving=!0;try{this.connectionDialog.isEdit?await h.put(`/admin/users/${this.userData.id}/connections/${this.connectionDialog.data.contact_id}`,{contact_info:this.connectionDialog.data.contact_info,contact_value:this.connectionDialog.data.contact_value,metadata:this.connectionDialog.data.metadata,contact_type:this.connectionDialog.data.contact_type,verified:this.connectionDialog.data.verified}):await h.post(`/admin/users/${this.userData.id}/connections`,{contact_info:this.connectionDialog.data.contact_info,contact_value:this.connectionDialog.data.contact_value,metadata:this.connectionDialog.data.metadata,contact_type:this.connectionDialog.data.contact_type,verified:this.connectionDialog.data.verified}),await this.loadConnections(),this.connectionDialog.show=!1}catch(e){console.error("Error saving connection:",e)}finally{this.connectionDialog.saving=!1}}},confirmDeleteConnection(t){this.deleteConnectionDialog.connection=t,this.deleteConnectionDialog.show=!0},async deleteConnection(){if(this.deleteConnectionDialog.connection){this.deleteConnectionDialog.deleting=!0;try{await h.delete(`/admin/users/${this.userData.id}/connections/${this.deleteConnectionDialog.connection.contact_id}`),await this.loadConnections(),this.deleteConnectionDialog.show=!1}catch(t){console.error("Error deleting connection:",t)}finally{this.deleteConnectionDialog.deleting=!1}}},getConnectionTypeText(t){const e=this.oauthTypes.find(r=>r.value===t);return e?e.title:t},getConnectionTypeColor(t){return{oauth_google:"red",oauth_github:"grey-darken-3",oauth_microsoft:"blue",oauth_40code:"purple",oauth_linuxdo:"green"}[t]||"grey"}}},ve={class:"d-flex align-center mb-4"},_e={key:0},he={key:0},De={key:1,class:"text-caption"},Ve={key:1,class:"text-caption"},ye={class:"d-flex align-center mb-4"},xe={class:"d-flex align-center mb-4"};function Ce(t,e,r,v,o,d){const B=J,n=X;return p(),x(P,{"model-value":r.modelValue,"max-width":"800px",persistent:"","onUpdate:modelValue":e[29]||(e[29]=i=>t.$emit("update:modelValue",i))},{default:a(()=>[l(_,null,{default:a(()=>[l(te,null,{append:a(()=>[l(c,{icon:"",onClick:d.close},{default:a(()=>[l(C,null,{default:a(()=>e[32]||(e[32]=[s("mdi-close",-1)])),_:1,__:[32]})]),_:1},8,["onClick"])]),default:a(()=>[l(O,{class:"headline"},{default:a(()=>e[30]||(e[30]=[s(" 编辑用户信息 ",-1)])),_:1,__:[30]}),l(le,null,{default:a(()=>[l(C,null,{default:a(()=>e[31]||(e[31]=[s("mdi-account",-1)])),_:1,__:[31]}),s(" "+m(o.userData.username),1)]),_:1})]),_:1}),l(M),l(b,{class:"pt-4"},{default:a(()=>[l(q,{ref:"editForm",modelValue:o.formValid,"onUpdate:modelValue":e[16]||(e[16]=i=>o.formValid=i)},{default:a(()=>[l(oe,{"model-value":o.tabIndex,"onUpdate:modelValue":e[0]||(e[0]=i=>o.tabIndex=i)},{default:a(()=>[l(F,{value:1},{default:a(()=>e[33]||(e[33]=[s("个人资料",-1)])),_:1,__:[33]}),l(F,{value:2},{default:a(()=>e[34]||(e[34]=[s("账户连接",-1)])),_:1,__:[34]}),l(F,{value:3},{default:a(()=>e[35]||(e[35]=[s("头像设置",-1)])),_:1,__:[35]}),l(F,{value:4},{default:a(()=>e[36]||(e[36]=[s("数据",-1)])),_:1,__:[36]})]),_:1},8,["model-value"]),l(b,null,{default:a(()=>[l(ae,{"model-value":o.tabIndex,"onUpdate:modelValue":e[15]||(e[15]=i=>o.tabIndex=i)},{default:a(()=>[l(T,{value:0},{default:a(()=>[l(S,null,{default:a(()=>[l(k)]),_:1})]),_:1}),l(T,{value:1},{default:a(()=>[l(S,null,{default:a(()=>[l(k,null,{default:a(()=>[l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.display_name,"onUpdate:modelValue":e[1]||(e[1]=i=>o.userData.display_name=i),rules:[i=>!!i||"显示名称不能为空"],dense:"",label:"显示名称",outlined:""},null,8,["modelValue","rules"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.username,"onUpdate:modelValue":e[2]||(e[2]=i=>o.userData.username=i),dense:"",label:"用户名",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(y,{modelValue:o.userData.status,"onUpdate:modelValue":e[3]||(e[3]=i=>o.userData.status=i),items:o.statusOptions,dense:"","item-title":"text","item-value":"value",label:"用户状态",outlined:""},null,8,["modelValue","items"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(y,{modelValue:o.userData.type,"onUpdate:modelValue":e[4]||(e[4]=i=>o.userData.type=i),items:o.typeOptions,dense:"","item-title":"text","item-value":"value",label:"用户类型",outlined:""},null,8,["modelValue","items"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.email,"onUpdate:modelValue":e[5]||(e[5]=i=>o.userData.email=i),dense:"",label:"邮箱",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(B,{modelValue:o.userData.featured_projects,"onUpdate:modelValue":e[6]||(e[6]=i=>o.userData.featured_projects=i),multiple:!1,author:o.userData.id},null,8,["modelValue","author"]),l(g,{modelValue:o.userData.featured_projects,"onUpdate:modelValue":e[7]||(e[7]=i=>o.userData.featured_projects=i),dense:"",label:"精选项目",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.motto,"onUpdate:modelValue":e[8]||(e[8]=i=>o.userData.motto=i),dense:"",label:"一句话简介",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.location,"onUpdate:modelValue":e[9]||(e[9]=i=>o.userData.location=i),dense:"",label:"位置",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{"model-value":o.selectedRegion?o.selectedRegion.text:"",dense:"",label:"地区",outlined:"",readonly:"",onClick:e[10]||(e[10]=i=>o.showRegionSelector=!0)},null,8,["model-value"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(g,{modelValue:o.userData.url,"onUpdate:modelValue":e[11]||(e[11]=i=>o.userData.url=i),dense:"",label:"个人主页",outlined:""},null,8,["modelValue"])]),_:1}),l(u,{cols:"12",sm:"6"},{default:a(()=>[l(y,{modelValue:o.userData.sex,"onUpdate:modelValue":e[12]||(e[12]=i=>o.userData.sex=i),items:o.sexOptions,dense:"","item-title":"text","item-value":"value",label:"性别",outlined:""},null,8,["modelValue","items"])]),_:1}),l(u,{cols:"12"},{default:a(()=>[l(re,{modelValue:o.userData.bio,"onUpdate:modelValue":e[13]||(e[13]=i=>o.userData.bio=i),dense:"",hint:"支持 Markdown 格式",label:"个人简介",outlined:"","persistent-hint":"",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),l(T,{value:2},{default:a(()=>[l(S,null,{default:a(()=>[l(k,null,{default:a(()=>[l(u,{cols:"12"},{default:a(()=>[f("div",ve,[e[38]||(e[38]=f("h3",{class:"text-h6"},"连接",-1)),l(D),l(c,{color:"primary","prepend-icon":"mdi-plus",onClick:d.showAddConnectionDialog},{default:a(()=>e[37]||(e[37]=[s(" 添加连接 ",-1)])),_:1,__:[37]},8,["onClick"])]),l(ue,{headers:o.connectionHeaders,items:o.connections,loading:o.loadingConnections,class:"elevation-1"},{"item.contact_type":a(({item:i})=>[l(H,{color:d.getConnectionTypeColor(i.contact_type),size:"small"},{default:a(()=>[s(m(d.getConnectionTypeText(i.contact_type)),1)]),_:2},1032,["color"])]),"item.verified":a(({item:i})=>[l(C,{color:i.verified?"success":"warning",icon:i.verified?"mdi-check-circle":"mdi-alert-circle"},null,8,["color","icon"]),s(" "+m(i.verified?"已验证":"未验证"),1)]),"item.contact_info":a(({item:i})=>[i.contact_info?(p(),V("div",_e,[i.contact_info.username?(p(),V("div",he," 用户名: "+m(i.contact_info.username),1)):E("",!0),i.contact_info.email?(p(),V("div",De," 邮箱: "+m(i.contact_info.email),1)):E("",!0)])):(p(),V("span",Ve,"无详细信息"))]),"item.actions":a(({item:i})=>[l(c,{class:"mr-2",icon:"mdi-pencil",size:"small",onClick:U=>d.editConnection(i)},null,8,["onClick"]),l(c,{color:"error",icon:"mdi-delete",size:"small",onClick:U=>d.confirmDeleteConnection(i)},null,8,["onClick"])]),_:1},8,["headers","items","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),l(T,{value:3},{default:a(()=>[l(S,null,{default:a(()=>[l(k,{align:"center",justify:"center"},{default:a(()=>[l(u,{class:"text-center",cols:"12"},{default:a(()=>[l(L,{class:"mb-4",size:"150"},{default:a(()=>[l(Y,{src:o.s3BucketUrl+"/user/"+o.userData.avatar},null,8,["src"])]),_:1}),f("div",null,[l(g,{modelValue:o.userData.avatar,"onUpdate:modelValue":e[14]||(e[14]=i=>o.userData.avatar=i),class:"mt-4",dense:"",label:"头像图片哈希",outlined:""},null,8,["modelValue"])])]),_:1})]),_:1})]),_:1})]),_:1}),l(T,{value:4},{default:a(()=>[f("pre",null,m(o.userData),1)]),_:1})]),_:1},8,["model-value"])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(M),l(I,null,{default:a(()=>[l(D),l(c,{text:"",onClick:d.close},{default:a(()=>e[39]||(e[39]=[s("取消",-1)])),_:1,__:[39]},8,["onClick"]),l(c,{disabled:!o.formValid||o.saving,loading:o.saving,color:"primary",onClick:d.save},{default:a(()=>e[40]||(e[40]=[s(" 保存 ",-1)])),_:1,__:[40]},8,["disabled","loading","onClick"])]),_:1})]),_:1}),l(n,{modelValue:o.showRegionSelector,"onUpdate:modelValue":e[17]||(e[17]=i=>o.showRegionSelector=i),"selected-region":o.selectedRegion,onClear:d.onRegionClear,onSelect:d.onRegionSelect},null,8,["modelValue","selected-region","onClear","onSelect"]),l(P,{modelValue:o.connectionDialog.show,"onUpdate:modelValue":e[26]||(e[26]=i=>o.connectionDialog.show=i),"max-width":"800px"},{default:a(()=>[l(_,null,{default:a(()=>[l(O,null,{default:a(()=>[s(m(o.connectionDialog.isEdit?"编辑连接 #"+o.connectionDialog.data.contact_id:"添加新连接"),1)]),_:1}),l(b,null,{default:a(()=>[l(q,{ref:"connectionForm",modelValue:o.connectionDialog.valid,"onUpdate:modelValue":e[24]||(e[24]=i=>o.connectionDialog.valid=i)},{default:a(()=>[o.connectionDialog.isEdit?E("",!0):(p(),x(y,{key:0,modelValue:o.connectionDialog.data.contact_type,"onUpdate:modelValue":e[18]||(e[18]=i=>o.connectionDialog.data.contact_type=i),items:o.oauthTypes,rules:[i=>!!i||"请选择连接类型"],label:"连接类型",required:""},null,8,["modelValue","items","rules"])),o.connectionDialog.isEdit?E("",!0):(p(),x(g,{key:1,modelValue:o.connectionDialog.data.contact_value,"onUpdate:modelValue":e[19]||(e[19]=i=>o.connectionDialog.data.contact_value=i),rules:[i=>!!i||"请输入提供商用户ID"],label:"提供商用户ID",required:""},null,8,["modelValue","rules"])),l(_,{class:"mt-4 pa-4",variant:"outlined"},{default:a(()=>[f("div",ye,[e[41]||(e[41]=f("div",{class:"text-subtitle-1"},"连接信息",-1)),l(D)]),l(g,{modelValue:o.connectionDialog.data.contact_value,"onUpdate:modelValue":e[20]||(e[20]=i=>o.connectionDialog.data.contact_value=i),dense:"",label:"连接值",outlined:""},null,8,["modelValue"]),l(g,{modelValue:o.connectionDialog.data.contact_info,"onUpdate:modelValue":e[21]||(e[21]=i=>o.connectionDialog.data.contact_info=i),dense:"",label:"随机值",outlined:""},null,8,["modelValue"]),l(y,{modelValue:o.connectionDialog.data.contact_type,"onUpdate:modelValue":e[22]||(e[22]=i=>o.connectionDialog.data.contact_type=i),items:o.oauthTypes,dense:"",label:"连接类型",outlined:""},null,8,["modelValue","items"])]),_:1}),l(_,{class:"mt-4 pa-4",variant:"outlined"},{default:a(()=>[f("div",xe,[e[43]||(e[43]=f("div",{class:"text-subtitle-1"},"元数据",-1)),l(D),l(c,{color:"primary","prepend-icon":"mdi-plus",size:"small",onClick:d.addMetadataField},{default:a(()=>e[42]||(e[42]=[s(" 添加字段 ",-1)])),_:1,__:[42]},8,["onClick"])]),(p(!0),V(G,null,W(o.connectionDialog.data.metadata,(i,U,R)=>(p(),V("div",{key:R,class:"d-flex align-center mb-2 gap-2"},[l(g,{modelValue:o.connectionDialog.metadataKeys[R],"onUpdate:modelValue":[w=>o.connectionDialog.metadataKeys[R]=w,w=>d.updateMetadataKey(R,U,w)],class:"flex-grow-0",density:"compact","hide-details":"",label:"字段名",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),l(g,{modelValue:o.connectionDialog.data.metadata[U],"onUpdate:modelValue":w=>o.connectionDialog.data.metadata[U]=w,label:"值",class:"flex-grow-1",density:"compact","hide-details":""},null,8,["modelValue","onUpdate:modelValue"]),l(c,{color:"error",icon:"mdi-delete",size:"small",variant:"text",onClick:w=>d.removeMetadataField(U)},null,8,["onClick"])]))),128))]),_:1}),l(me,{modelValue:o.connectionDialog.data.verified,"onUpdate:modelValue":e[23]||(e[23]=i=>o.connectionDialog.data.verified=i),class:"mt-4",color:"success","hide-details":"",label:"已验证"},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(I,null,{default:a(()=>[l(D),l(c,{text:"",onClick:e[25]||(e[25]=i=>o.connectionDialog.show=!1)},{default:a(()=>e[44]||(e[44]=[s(" 取消",-1)])),_:1,__:[44]}),l(c,{disabled:!o.connectionDialog.valid||o.connectionDialog.saving,loading:o.connectionDialog.saving,color:"primary",onClick:d.saveConnection},{default:a(()=>e[45]||(e[45]=[s(" 保存 ",-1)])),_:1,__:[45]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(P,{modelValue:o.deleteConnectionDialog.show,"onUpdate:modelValue":e[28]||(e[28]=i=>o.deleteConnectionDialog.show=i),"max-width":"400px"},{default:a(()=>[l(_,null,{default:a(()=>[l(O,{class:"text-h5 text-error"},{default:a(()=>e[46]||(e[46]=[s(" 确认删除连接",-1)])),_:1,__:[46]}),l(b,null,{default:a(()=>{var i;return[s(" 确定要删除这个 "+m(d.getConnectionTypeText((i=o.deleteConnectionDialog.connection)==null?void 0:i.contact_type))+" 连接吗？此操作不可撤销。 ",1)]}),_:1}),l(I,null,{default:a(()=>[l(D),l(c,{text:"",onClick:e[27]||(e[27]=i=>o.deleteConnectionDialog.show=!1)},{default:a(()=>e[47]||(e[47]=[s(" 取消 ",-1)])),_:1,__:[47]}),l(c,{loading:o.deleteConnectionDialog.deleting,color:"error",onClick:d.deleteConnection},{default:a(()=>e[48]||(e[48]=[s(" 确认删除 ",-1)])),_:1,__:[48]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["model-value"])}const Z=N(pe,[["render",Ce],["__scopeId","data-v-a61c8f14"]]);j.extend(ce);j.locale("zh-cn");const be={name:"UsersPage",components:{UserEditor:Z},data(){return{userStats:[{title:"总用户数",value:0,type:"total",icon:"mdi-account-group"},{title:"活跃用户",value:0,type:"active",icon:"mdi-account-check"}],users:[],total:0,loading:!1,refreshing:!1,options:{page:1,itemsPerPage:10,sortBy:["id"],sortDesc:[!1],groupBy:[],groupDesc:[],multiSort:!1},headers:[{title:"ID",value:"id",width:"80px",sortable:!1},{title:"用户",value:"username",width:"250px",sortable:!1},{title:"邮箱",value:"email",sortable:!1},{title:"状态",value:"status",width:"120px",sortable:!1},{title:"类型",value:"type",width:"120px",sortable:!1},{title:"注册时间",value:"regTime",width:"180px",sortable:!1},{title:"操作",value:"actions",sortable:!1,width:"150px",align:"center"}],searchQuery:"",statusFilter:"",typeFilter:"",statusOptions:[{title:"活跃",value:"active"},{title:"已暂停",value:"suspended"},{title:"已封禁",value:"banned"},{title:"待验证",value:"pending"}],typeOptions:[{title:"访客",value:"guest"},{title:"普通用户",value:"user"},{title:"管理员",value:"administrator"}],editDialog:!1,deleteDialog:!1,deleteConfirmation:"",selectedUser:null,deleting:!1,snackbar:{show:!1,text:"",color:"success",timeout:3e3}}},methods:{async loadUsers(){this.loading=!0;try{const t={page:this.options.page,itemsPerPage:this.options.itemsPerPage,sort_by:this.options.sortBy[0]||"id",sort_order:this.options.sortDesc[0]?"desc":"asc"};this.searchQuery&&(t.search=this.searchQuery),this.statusFilter&&(t.status=this.statusFilter),this.typeFilter&&(t.type=this.typeFilter);const{data:e}=await h.get("/admin/users",{params:t});this.users=e.items.map(r=>({...r,id:r.id,username:r.username,email:r.email||"",status:r.status||"pending",type:r.type||"user",regTime:r.regTime,avatar:r.avatar})),this.total=Number(e.total)}catch(t){this.showError("加载用户列表失败"),console.error("Error loading users:",t)}finally{this.loading=!1}},async loadUserStats(){var t;try{const{data:e}=await h.get("/admin/users/stats/overview");this.userStats[0].value=e.totalUsers,this.userStats[1].value=((t=e.usersByStatus.find(r=>r.status==="active"))==null?void 0:t._count)||0}catch(e){console.error("Error loading user stats:",e)}},async refreshData(){if(!(this.refreshing||this.loading)){this.refreshing=!0;try{await Promise.all([this.loadUsers(),this.loadUserStats()]),this.showSuccess("数据已更新")}catch(t){this.showError("刷新数据失败"),console.error("Error refreshing data:",t)}finally{this.refreshing=!1}}},editUser(t){this.selectedUser=t,this.editDialog=!0},async saveUser(t){var e,r;try{const{data:v}=await h.put(`/admin/users/${t.id}`,t),o=this.users.findIndex(d=>d.id===t.id);o!==-1&&(this.users[o]={...this.users[o],...v}),this.showSuccess("用户信息更新成功")}catch(v){throw this.showError(((r=(e=v.response)==null?void 0:e.data)==null?void 0:r.error)||"保存用户信息失败"),console.error("Error saving user:",v),v}},confirmDelete(t){this.selectedUser=t,this.deleteConfirmation="",this.deleteDialog=!0},async deleteUser(){this.deleting=!0;try{await h.delete(`/admin/users/${this.selectedUser.id}`),this.showSuccess("用户删除成功"),this.loadUsers(),this.loadUserStats(),this.deleteDialog=!1}catch(t){this.showError("删除用户失败"),console.error("Error deleting user:",t)}finally{this.deleting=!1}},getStatusText(t){const e=this.statusOptions.find(r=>r.value===t);return e?e.title:t},getTypeText(t){const e=this.typeOptions.find(r=>r.value===t);return e?e.title:t},formatDate(t){return j(t).format("YYYY-MM-DD HH:mm:ss")},formatTimeAgo(t){return j(t).fromNow()},getStatusColor(t){return{active:"success",suspended:"warning",banned:"error",pending:"info"}[t]||"grey"},getAvatarUrl(t){return t?t.startsWith("http")?t:`/api/avatar/${t}`:"/default-avatar.png"},showSuccess(t){this.snackbar={show:!0,text:t,color:"success",timeout:3e3}},showError(t){this.snackbar={show:!0,text:t,color:"error",timeout:5e3}},debouncedSearch:fe(function(){this.loadUsers()},300)},mounted(){this.loadUsers(),this.loadUserStats()}},Ue={class:"users-admin"},we={class:"text-overline mb-2"},ke={class:"text-h4"},Te={class:"d-flex align-center"},Se={class:"font-weight-medium"},Ee={class:"caption grey--text"},Re={class:"caption grey--text"};function Fe(t,e,r,v,o,d){const B=Z;return p(),x(S,null,{default:a(()=>[f("div",Ue,[l(k,{class:"mb-4"},{default:a(()=>[(p(!0),V(G,null,W(o.userStats,n=>(p(),x(u,{key:n.title,cols:"12",md:"3",sm:"6"},{default:a(()=>[l(_,{class:K(["stat-card",`stat-${n.type}`]),elevation:"2"},{default:a(()=>[l(b,null,{default:a(()=>[f("div",we,m(n.title),1),f("div",ke,m(n.value),1),l(C,{class:"stat-icon",large:""},{default:a(()=>[s(m(n.icon),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}),l(_,{class:"mb-4"},{default:a(()=>[l(b,null,{default:a(()=>[l(k,{align:"center"},{default:a(()=>[l(u,{cols:"12",sm:"4"},{default:a(()=>[l(g,{modelValue:o.searchQuery,"onUpdate:modelValue":e[0]||(e[0]=n=>o.searchQuery=n),clearable:"","hide-details":"",label:"搜索用户","prepend-icon":"mdi-magnify",onInput:d.debouncedSearch},null,8,["modelValue","onInput"])]),_:1}),l(u,{cols:"12",sm:"3"},{default:a(()=>[l(y,{modelValue:o.statusFilter,"onUpdate:modelValue":e[1]||(e[1]=n=>o.statusFilter=n),items:o.statusOptions,clearable:"","hide-details":"",label:"状态过滤","prepend-icon":"mdi-filter",onChange:d.loadUsers},null,8,["modelValue","items","onChange"])]),_:1}),l(u,{cols:"12",sm:"3"},{default:a(()=>[l(y,{modelValue:o.typeFilter,"onUpdate:modelValue":e[2]||(e[2]=n=>o.typeFilter=n),items:o.typeOptions,clearable:"","hide-details":"",label:"类型过滤","prepend-icon":"mdi-account-filter",onChange:d.loadUsers},null,8,["modelValue","items","onChange"])]),_:1}),l(u,{class:"d-flex justify-end",cols:"12",sm:"2"},{default:a(()=>[l(c,{disabled:o.loading,loading:o.refreshing,color:"primary",onClick:d.refreshData},{default:a(()=>[l(C,{class:K({rotate:o.refreshing}),left:""},{default:a(()=>e[11]||(e[11]=[s("mdi-refresh ",-1)])),_:1,__:[11]},8,["class"]),e[12]||(e[12]=s(" 刷新 ",-1))]),_:1,__:[12]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1})]),_:1}),l(_,null,{default:a(()=>[l(ge,{"items-per-page":o.options.itemsPerPage,"onUpdate:itemsPerPage":e[3]||(e[3]=n=>o.options.itemsPerPage=n),page:o.options.page,"onUpdate:page":e[4]||(e[4]=n=>o.options.page=n),headers:o.headers,items:o.users,"items-length":o.total,loading:o.loading,"loading-text":"加载中...","no-data-text":"暂无数据","no-results-text":"未找到匹配的数据","onUpdate:options":d.loadUsers},{"item.username":a(({item:n})=>[f("div",Te,[l(L,{class:"mr-2",size:"32"},{default:a(()=>[l(Y,{alt:n.username,src:d.getAvatarUrl(n.avatar)},null,8,["alt","src"])]),_:2},1024),f("div",null,[f("div",Se,m(n.username),1),f("div",Ee,m(n.display_name),1)])])]),"item.status":a(({item:n})=>[l(H,{color:d.getStatusColor(n.status),class:"status-chip",small:""},{default:a(()=>[s(m(d.getStatusText(n.status)),1)]),_:2},1032,["color"])]),"item.type":a(({item:n})=>[s(m(d.getTypeText(n.type)),1)]),"item.regTime":a(({item:n})=>[f("div",null,m(d.formatDate(n.regTime)),1),f("div",Re,m(d.formatTimeAgo(n.regTime)),1)]),"item.actions":a(({item:n})=>[l(ie,{group:""},{default:a(()=>[z((p(),x(c,{class:"action-btn",icon:"",small:"",onClick:A(i=>d.editUser(n),["stop"])},{default:a(()=>[l(C,null,{default:a(()=>e[13]||(e[13]=[s("mdi-pencil",-1)])),_:1,__:[13]})]),_:2},1032,["onClick"])),[[Q,"编辑用户"]]),n.type!=="administrator"?z((p(),x(c,{key:0,class:"action-btn",icon:"",small:"",onClick:A(i=>d.confirmDelete(n),["stop"])},{default:a(()=>[l(C,null,{default:a(()=>e[14]||(e[14]=[s("mdi-delete",-1)])),_:1,__:[14]})]),_:2},1032,["onClick"])),[[Q,"删除用户"]]):E("",!0)]),_:2},1024)]),_:1},8,["items-per-page","page","headers","items","items-length","loading","onUpdate:options"])]),_:1}),l(B,{modelValue:o.editDialog,"onUpdate:modelValue":e[5]||(e[5]=n=>o.editDialog=n),user:o.selectedUser,onSave:d.saveUser},null,8,["modelValue","user","onSave"]),l(P,{modelValue:o.deleteDialog,"onUpdate:modelValue":e[8]||(e[8]=n=>o.deleteDialog=n),"max-width":"400px",transition:"dialog-bottom-transition"},{default:a(()=>[l(_,null,{default:a(()=>[l(O,{class:"headline error--text"},{default:a(()=>e[15]||(e[15]=[s("确认删除",-1)])),_:1,__:[15]}),l(b,{class:"pt-4"},{default:a(()=>[l(ne,{dense:"",text:"",type:"warning"},{default:a(()=>{var n;return[e[16]||(e[16]=s(" 此操作将永久删除用户 ",-1)),f("strong",null,m((n=o.selectedUser)==null?void 0:n.username),1),e[17]||(e[17]=s(" 及其所有相关数据，此操作不可撤销。 ",-1))]}),_:1,__:[16,17]}),l(g,{modelValue:o.deleteConfirmation,"onUpdate:modelValue":e[6]||(e[6]=n=>o.deleteConfirmation=n),rules:[n=>{var i;return!n||n===((i=o.selectedUser)==null?void 0:i.username)||"用户名不匹配"}],class:"mt-4",dense:"",label:"请输入用户名以确认删除",outlined:""},null,8,["modelValue","rules"])]),_:1}),l(I,null,{default:a(()=>{var n;return[l(D),l(c,{text:"",onClick:e[7]||(e[7]=i=>o.deleteDialog=!1)},{default:a(()=>e[18]||(e[18]=[s("取消",-1)])),_:1,__:[18]}),l(c,{disabled:o.deleteConfirmation!==((n=o.selectedUser)==null?void 0:n.username),loading:o.deleting,color:"error",text:"",onClick:d.deleteUser},{default:a(()=>e[19]||(e[19]=[s(" 确认删除 ",-1)])),_:1,__:[19]},8,["disabled","loading","onClick"])]}),_:1})]),_:1})]),_:1},8,["modelValue"]),l(se,{modelValue:o.snackbar.show,"onUpdate:modelValue":e[10]||(e[10]=n=>o.snackbar.show=n),color:o.snackbar.color,timeout:o.snackbar.timeout,top:""},{action:a(({attrs:n})=>[l(c,de({text:""},n,{onClick:e[9]||(e[9]=i=>o.snackbar.show=!1)}),{default:a(()=>e[20]||(e[20]=[s(" 关闭 ",-1)])),_:2,__:[20]},1040)]),default:a(()=>[s(m(o.snackbar.text)+" ",1)]),_:1},8,["modelValue","color","timeout"])])]),_:1})}const Ge=N(be,[["render",Fe],["__scopeId","data-v-45204cdb"]]);export{Ge as default};
