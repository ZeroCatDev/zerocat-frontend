import{_ as E}from"./TimeAgo-DefCx_l6.js";import{_ as C}from"./ProjectCard-BYWSBxv8.js";import{_ as I}from"./Timeline-C7xeVeog.js";import{_ as F,Y as n,o as l,N as t,e as s,aL as K,a9 as _,L as r,i as v,a3 as h,aB as N,aC as D,ad as T,c as g,ae as x,af as j,F as y,U as P,$ as L,X as p,S as w,ag as M,f as c,O as d,Z as R,n as U,aE as Z,Q as k,R as V,ej as H,W as b,bj as O,a4 as Q,bK as W,T as X,r as Y,M as q,a1 as u,ab as G}from"./index-CqDYMkg5.js";import{V as J}from"./VSpacer-BmIOKXlY.js";import{V as $}from"./VSkeletonLoader-LVRm47j6.js";const ee={name:"Dashboard",components:{Timeline:I,TimeAgo:E,ProjectCard:C},data(){return{localuser:G,isLoadingTopProjects:!1,isLoadingExplore:!1,search:{title:"",state:"public",limit:10},exploreSearch:{page:1,limit:20,hasMore:!0},topProjects:[],latestProjects:[],exploreProjects:[],timeline:{events:[],pagination:{current:1,size:20,total:0}},isLoadingMore:!1,recentActivities:[],VITE_APP_S3_BUCKET:"https://zerocat-bitiful.houlangs.com"}},methods:{async fetchTopProjects(){this.isLoadingTopProjects=!0;try{this.search.title!=""&&(this.search.limit=40);const a=await u.get("/searchapi",{params:{search_userid:this.localuser.user.id,search_title:this.search.title,search_state:this.search.state,limit:this.search.limit}});a.data&&a.data.projects&&(this.topProjects=a.data.projects)}catch(a){console.error("Failed to fetch top projects:",a),this.topProjects=[]}finally{this.isLoadingTopProjects=!1}},async fetchLatestProjects(){try{const a=await u.get("/projectlist/latest",{params:{limit:6,state:"public"}});a.data.status==="success"&&(this.latestProjects=a.data.data)}catch(a){console.error("Failed to fetch latest projects:",a)}},async fetchTimeline(a=1){try{const e=await u.get("/timeline/following",{params:{page:a,limit:this.timeline.pagination.size}});e.data.status==="success"&&(a===1?this.timeline=e.data.data:(this.timeline.events=[...this.timeline.events,...e.data.data.events],this.timeline.pagination=e.data.data.pagination))}catch(e){console.error("Failed to fetch timeline:",e)}},async fetchRecentActivities(){try{const a=await u.get("/timeline/me",{params:{page:1,limit:100}});a.data.status==="success"&&(this.recentActivities=a.data.data.events.map(e=>{var f;return{id:e.id,text:((f=e.event_data)==null?void 0:f.project_title)||e.type,icon:this.getEventIcon(e.type),color:this.getEventColor(e.type),date:e.created_at}}))}catch(a){console.error("Failed to fetch recent activities:",a)}},getEventIcon(a){return{project_create:"mdi-plus-circle",project_publish:"mdi-upload",project_fork:"mdi-source-fork",project_delete:"mdi-delete",user_profile_update:"mdi-account-edit",project_commit:"mdi-source-commit",project_rename:"mdi-rename-box",project_info_update:"mdi-file-document-edit"}[a]||"mdi-bell"},getEventColor(a){return{project_create:"success",project_publish:"info",project_fork:"warning",project_delete:"error",user_profile_update:"info",project_commit:"info",project_rename:"warning",project_info_update:"info"}[a]||"primary"},resetSearch(){this.search={title:"",state:"public"},this.fetchTopProjects()},async searchProjects(){await this.fetchTopProjects()},async loadMoreEvents(){if(!this.isLoadingMore)try{this.isLoadingMore=!0,await this.fetchTimeline(this.timeline.pagination.current+1)}finally{this.isLoadingMore=!1}},async loadMoreExploreProjects(){if(!(this.isLoadingExplore||!this.exploreSearch.hasMore)){this.isLoadingExplore=!0;try{const a=await u.get("/searchapi",{params:{search_title:"",search_state:"public",search_orderby:"view_down",curr:this.exploreSearch.page,limit:this.exploreSearch.limit}});if(a.data&&a.data.projects){if(a.data.projects.length===0){this.exploreSearch.hasMore=!1;return}this.exploreProjects=[...this.exploreProjects,...a.data.projects],this.exploreSearch.page++}}catch(a){console.error("Failed to fetch more explore projects:",a)}finally{this.isLoadingExplore=!1}}},onIntersect(a){a&&this.loadMoreExploreProjects()}},async created(){q({title:"Dashboard - ZeroCat"}),await Promise.all([this.fetchTopProjects(),this.fetchLatestProjects(),this.fetchTimeline(),this.fetchRecentActivities(),this.loadMoreExploreProjects()])},setup(){return{loadMoreTrigger:Y(null)}}},te={class:"d-flex align-center gap-2"},se={class:"d-flex align-center"},ae={class:"text-caption"},oe={class:"d-flex align-center"},re={class:"text-caption"},ie={class:"d-flex justify-center my-4"},le={style:{height:"20px"}};function ne(a,e,f,ce,i,m){const S=H,A=I,z=C,B=E;return l(),n(X,{fluid:""},{default:t(()=>[s(K,null,{default:t(()=>[s(_,{class:"text-subtitle-1 font-weight-bold d-flex align-center"},{default:t(()=>[e[2]||(e[2]=r(" 我的项目 ")),s(J),s(v,{to:"/app/new",color:"success",variant:"tonal","prepend-icon":"mdi-plus",size:"small"},{default:t(()=>e[1]||(e[1]=[r("新建")])),_:1,__:[1]})]),_:1,__:[2]}),s(h,{class:"pt-2 pb-0"},{default:t(()=>[s(N,{modelValue:i.search.title,"onUpdate:modelValue":e[0]||(e[0]=o=>i.search.title=o),density:"compact",variant:"outlined",label:"项目名称","hide-details":"",class:"mb-2",onInput:m.searchProjects,onKeyup:D(m.searchProjects,["enter"]),placeholder:"输入项目名称搜索","single-line":""},null,8,["modelValue","onInput","onKeyup"])]),_:1}),s(T,{density:"compact"},{default:t(()=>[i.isLoadingTopProjects?(l(),n($,{key:0,type:"text",width:"80%"})):i.topProjects.length===0?(l(),n(x,{key:1},{default:t(()=>[s(j,{class:"text-center text-medium-emphasis"},{default:t(()=>e[3]||(e[3]=[r(" 暂无项目 ")])),_:1,__:[3]})]),_:1})):(l(!0),g(y,{key:2},P(i.topProjects,o=>(l(),n(x,{key:o.id,to:`/${o.author.username}/${o.name}`},{prepend:t(()=>[s(R,{size:"32"},{default:t(()=>[s(U,{src:i.VITE_APP_S3_BUCKET+"/user/"+o.author.avatar},null,8,["src"])]),_:2},1024)]),append:t(()=>[c("div",te,[c("div",se,[s(d,{size:"small",class:"mr-1"},{default:t(()=>e[5]||(e[5]=[r("mdi-eye")])),_:1,__:[5]}),c("span",ae,p(o.view_count),1)]),c("div",oe,[s(d,{size:"small",class:"mr-1"},{default:t(()=>e[6]||(e[6]=[r("mdi-star")])),_:1,__:[6]}),c("span",re,p(o.star_count),1)])])]),default:t(()=>[s(j,{class:"text-body-2 d-flex align-center"},{default:t(()=>[r(p(o.title)+" ",1),o.state==="private"?(l(),n(w,{key:0,size:"x-small",color:"error",class:"ml-2"},{default:t(()=>e[4]||(e[4]=[r("私密")])),_:1,__:[4]})):L("",!0)]),_:2},1024),s(M,{class:"text-caption"},{default:t(()=>[r(p(o.description),1)]),_:2},1024)]),_:2},1032,["to"]))),128))]),_:1}),s(Z,{class:"justify-center"},{default:t(()=>[s(v,{variant:"text",block:"",to:"/app/project",class:"text-none"},{default:t(()=>[e[8]||(e[8]=r(" 查看全部 ")),s(d,{end:""},{default:t(()=>e[7]||(e[7]=[r("mdi-chevron-right")])),_:1,__:[7]})]),_:1,__:[8]})]),_:1})]),_:1}),s(k,null,{default:t(()=>[s(V,{cols:"12",md:"9"},{default:t(()=>[s(S,{mode:"dialog"}),e[13]||(e[13]=c("br",null,null,-1)),s(b,{class:"mb-4",variant:"flat"},{default:t(()=>[s(_,{class:"d-flex align-center"},{default:t(()=>[s(d,{icon:"mdi-timeline-clock",color:"primary",class:"mr-2"}),e[9]||(e[9]=r(" 时间线 "))]),_:1,__:[9]}),s(h,null,{default:t(()=>[s(A,{timeline:i.timeline,"is-loading-more":i.isLoadingMore,onLoadMore:m.loadMoreEvents},null,8,["timeline","is-loading-more","onLoadMore"])]),_:1})]),_:1}),s(_,{class:"text-subtitle-1 font-weight-bold"},{default:t(()=>[s(d,{start:""},{default:t(()=>e[10]||(e[10]=[r("mdi-compass")])),_:1,__:[10]}),e[11]||(e[11]=r(" 热门项目 "))]),_:1,__:[11]}),s(h,{class:"pa-2"},{default:t(()=>[s(k,null,{default:t(()=>[(l(!0),g(y,null,P(i.exploreProjects,o=>(l(),n(V,{key:o.id,cols:"3",sm:"4",md:"4",lg:"3",xl:"3"},{default:t(()=>[s(z,{"project-data":o,"author-data":o.author,"show-author":!0,to:o.author?`/${o.author.username}/${o.name}`:`/app/link/project?id=${o.id}`},null,8,["project-data","author-data","to"])]),_:2},1024))),128))]),_:1}),c("div",ie,[i.isLoadingExplore?(l(),n(Q,{key:0,indeterminate:"",color:"primary"})):i.exploreSearch.hasMore?L("",!0):(l(),n(w,{key:1,color:"primary",variant:"flat"},{default:t(()=>e[12]||(e[12]=[r(" 已加载全部项目 ")])),_:1,__:[12]}))]),O(c("div",le,null,512),[[W,{handler:m.onIntersect,options:{threshold:[0,.5,1]}}]])]),_:1})]),_:1,__:[13]}),s(V,{cols:"12",md:"3"},{default:t(()=>[s(b,{variant:"tonal"},{default:t(()=>[s(_,{class:"text-subtitle-1 font-weight-bold"},{default:t(()=>[s(d,{start:""},{default:t(()=>e[14]||(e[14]=[r("mdi-clock-outline")])),_:1,__:[14]}),e[15]||(e[15]=r(" 最近活动 "))]),_:1,__:[15]}),s(T,{density:"compact"},{default:t(()=>[(l(!0),g(y,null,P(i.recentActivities,o=>(l(),n(x,{key:o.id},{prepend:t(()=>[s(d,{color:o.color,size:"small"},{default:t(()=>[r(p(o.icon),1)]),_:2},1032,["color"])]),default:t(()=>[s(j,{class:"text-body-2"},{default:t(()=>[r(p(o.text),1)]),_:2},1024),s(M,null,{default:t(()=>[s(B,{date:o.date},null,8,["date"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(b,{variant:"flat",class:"mt-4"})]),_:1})]),_:1})]),_:1})}const he=F(ee,[["render",ne],["__scopeId","data-v-ad7409d6"]]);export{he as default};
