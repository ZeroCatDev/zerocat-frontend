const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RegionSelector-DSgoFvje.js","assets/index-DtKAxHsk.js","assets/index-I2H4g2bF.css","assets/VSpacer-CFVqpMjn.js","assets/RegionSelector-CHugFwEI.css"])))=>i.map(i=>d[i]);
import{_ as Q,a1 as _,aL as Z,aa as J,Y as x,o as g,N as i,e as l,W as h,aU as $,a9 as F,L as n,aW as ee,O as C,X as u,i as m,a0 as j,a3 as b,aF as q,ah as te,ai as R,V as le,q as k,T,Q as U,R as r,aB as f,f as c,c as D,$ as S,S as N,Z as H,n as L,aE as O,aA as I,F as W,U as Y,D as M,eq as oe,aQ as A,aD as z,a5 as ae,aT as ie,m as ne}from"./index-DtKAxHsk.js";import{_ as G}from"./RegionSelector-DSgoFvje.js";import{V as y}from"./VSelect-CLC6V_6T.js";import{V as se}from"./VTextarea-DxqmyO9J.js";import{V}from"./VSpacer-CFVqpMjn.js";import{V as de}from"./VDataTable-CZ4xG2Bj.js";import{V as re}from"./VSwitch-CvGeW0QQ.js";import{T as K,d as P,r as ue}from"./index-gC2UrHeT.js";import{d as me}from"./debounce-BMmXVQ06.js";import{V as ce}from"./VDataTableServer-DT_Ggm5w.js";import"https://static.geetest.com/v4/gt4.js";import"./VCheckboxBtn-g1l4zUQ2.js";import"./VSelectionControl-DMoYNkco.js";import"./VTable-N2etu4_U.js";import"./filter-DDFf_2Tr.js";import"./_commonjsHelpers-BosuxZz1.js";import"./VTooltip-BAqlLSdT.js";const fe={name:"UserEditor",components:{RegionSelector:G},props:{modelValue:{type:Boolean,required:!0},user:{type:Object,required:!0,default:()=>({})}},emits:["update:modelValue","save"],data(){return{tabIndex:1,formValid:!0,saving:!1,showRegionSelector:!1,selectedRegion:null,regionOptions:[],statusOptions:[{text:"活跃",value:"active"},{text:"已暂停",value:"suspended"},{text:"已封禁",value:"banned"},{text:"待验证",value:"pending"}],typeOptions:[{text:"访客",value:"guest"},{text:"普通用户",value:"user"},{text:"管理员",value:"admin"}],sexOptions:[{text:"男",value:"male"},{text:"女",value:"female"},{text:"其他",value:"other"}],contactTypes:[{text:"邮箱",value:"email"},{text:"电话",value:"phone"},{text:"QQ",value:"qq"},{text:"Google",value:"oauth_google"},{text:"GitHub",value:"oauth_github"},{text:"Microsoft",value:"oauth_microsoft"},{text:"40code",value:"oauth_40code"},{text:"LinuxDo",value:"oauth_linuxdo"},{text:"其他",value:"other"}],userData:this.initUserData(),connections:[],loadingConnections:!1,connectionHeaders:[{title:"类型",key:"contact_type",width:"150px"},{title:"验证状态",key:"verified",width:"100px"},{title:"创建时间",key:"created_at",width:"180px"},{title:"操作",key:"actions",width:"100px",sortable:!1}],oauthTypes:[{title:"Google",value:"oauth_google"},{title:"GitHub",value:"oauth_github"},{title:"Microsoft",value:"oauth_microsoft"},{title:"40code",value:"oauth_40code"},{title:"LinuxDo",value:"oauth_linuxdo"},{title:"email",value:"email"},{title:"phone",value:"phone"},{title:"qq",value:"qq"},{title:"other",value:"other"}],connectionDialog:{show:!1,isEdit:!1,valid:!0,saving:!1,data:this.initConnectionData(),infoKeys:[],metadataKeys:[]},deleteConnectionDialog:{show:!1,deleting:!1,connection:null},s3BucketUrl:""}},async created(){try{const t=await Z(()=>import("./RegionSelector-DSgoFvje.js").then(e=>e.a),__vite__mapDeps([0,1,2,3,4]));this.regionOptions=Object.entries(t.default).map(([e,d])=>({value:e,text:d}))}catch(t){console.error("Error loading region options:",t),this.regionOptions=[]}this.s3BucketUrl=await J("s3.staticurl")},watch:{user:{handler(t){if(!t){this.userData=this.initUserData(),this.selectedRegion=null;return}if(this.userData=this.initUserData(t),t!=null&&t.region){const e=this.getRegionText(t.region);e?this.selectedRegion={value:t.region,text:e}:this.selectedRegion=null}else this.selectedRegion=null;t!=null&&t.id&&this.loadConnections()},immediate:!0}},methods:{initUserData(t={}){return{id:(t==null?void 0:t.id)??null,username:(t==null?void 0:t.username)??"",display_name:(t==null?void 0:t.display_name)??"",status:(t==null?void 0:t.status)??"active",type:(t==null?void 0:t.type)??"user",email:(t==null?void 0:t.email)??"",featured_projects:(t==null?void 0:t.featured_projects)??"",motto:(t==null?void 0:t.motto)??"",bio:(t==null?void 0:t.bio)??"",location:(t==null?void 0:t.location)??"",region:(t==null?void 0:t.region)??"",birthday:(t==null?void 0:t.birthday)??"",sex:(t==null?void 0:t.sex)??"",url:(t==null?void 0:t.url)??"",custom_status:(t==null?void 0:t.custom_status)??{emoji:"",text:""},avatar:(t==null?void 0:t.avatar)??"",featured_projects:(t==null?void 0:t.featured_projects)??[],contacts:((t==null?void 0:t.contacts)??[]).map(e=>({contact_type:(e==null?void 0:e.contact_type)??"",contact_value:(e==null?void 0:e.contact_value)??"",is_primary:(e==null?void 0:e.is_primary)??!1,verified:(e==null?void 0:e.verified)??!1,contact_info:(e==null?void 0:e.contact_info)??"",metadata:(e==null?void 0:e.metadata)??{}}))}},getRegionText(t){if(!t)return"";const e=this.regionOptions.find(d=>d.value===t);return e?e.text:t},addContact(){this.userData.contacts.push({contact_type:"",contact_value:"",is_primary:!1,verified:!1,contact_info:"",metadata:{}})},removeContact(t){this.userData.contacts.splice(t,1)},onRegionSelect(t){this.selectedRegion=t,this.userData.region=t.value,this.showRegionSelector=!1},onRegionClear(){this.selectedRegion=null,this.userData.region=null,this.showRegionSelector=!1},close(){this.$emit("update:modelValue",!1)},async save(){if(this.$refs.editForm.validate()){this.saving=!0;try{await this.$emit("save",this.userData),this.close()}finally{this.saving=!1}}},initConnectionData(){return{contact_type:"",contact_value:"",contact_info:"",metadata:{},verified:!1}},async loadConnections(){if(this.userData.id){this.loadingConnections=!0;try{const{data:t}=await _.get(`/admin/users/${this.userData.id}/connections`);this.connections=t}catch(t){console.error("Error loading connections:",t)}finally{this.loadingConnections=!1}}},showAddConnectionDialog(){this.connectionDialog.isEdit=!1,this.connectionDialog.data=this.initConnectionData(),this.connectionDialog.infoKeys=[],this.connectionDialog.metadataKeys=[],this.connectionDialog.show=!0},editConnection(t){this.connectionDialog.isEdit=!0,this.connectionDialog.data={...t,metadata:{...t.metadata}},this.connectionDialog.metadataKeys=Object.keys(t.metadata||{}),this.connectionDialog.show=!0},addMetadataField(){const t=`field_${this.connectionDialog.metadataKeys.length+1}`;this.$set(this.connectionDialog.data.metadata,t,""),this.connectionDialog.metadataKeys.push(t)},updateMetadataKey(t,e,d){if(d&&d!==e){const v=this.connectionDialog.data.metadata[e];this.$delete(this.connectionDialog.data.metadata,e),this.$set(this.connectionDialog.data.metadata,d,v),this.connectionDialog.metadataKeys[t]=d}},removeMetadataField(t){this.$delete(this.connectionDialog.data.metadata,t);const e=this.connectionDialog.metadataKeys.indexOf(t);e>-1&&this.connectionDialog.metadataKeys.splice(e,1)},async saveConnection(){var t;if((t=this.$refs.connectionForm)!=null&&t.validate()){this.connectionDialog.saving=!0;try{this.connectionDialog.isEdit?await _.put(`/admin/users/${this.userData.id}/connections/${this.connectionDialog.data.contact_id}`,{contact_info:this.connectionDialog.data.contact_info,contact_value:this.connectionDialog.data.contact_value,metadata:this.connectionDialog.data.metadata,contact_type:this.connectionDialog.data.contact_type,verified:this.connectionDialog.data.verified}):await _.post(`/admin/users/${this.userData.id}/connections`,{contact_info:this.connectionDialog.data.contact_info,contact_value:this.connectionDialog.data.contact_value,metadata:this.connectionDialog.data.metadata,contact_type:this.connectionDialog.data.contact_type,verified:this.connectionDialog.data.verified}),await this.loadConnections(),this.connectionDialog.show=!1}catch(e){console.error("Error saving connection:",e)}finally{this.connectionDialog.saving=!1}}},confirmDeleteConnection(t){this.deleteConnectionDialog.connection=t,this.deleteConnectionDialog.show=!0},async deleteConnection(){if(this.deleteConnectionDialog.connection){this.deleteConnectionDialog.deleting=!0;try{await _.delete(`/admin/users/${this.userData.id}/connections/${this.deleteConnectionDialog.connection.contact_id}`),await this.loadConnections(),this.deleteConnectionDialog.show=!1}catch(t){console.error("Error deleting connection:",t)}finally{this.deleteConnectionDialog.deleting=!1}}},getConnectionTypeText(t){const e=this.oauthTypes.find(d=>d.value===t);return e?e.title:t},getConnectionTypeColor(t){return{oauth_google:"red",oauth_github:"grey-darken-3",oauth_microsoft:"blue",oauth_40code:"purple",oauth_linuxdo:"green"}[t]||"grey"}}},ge={class:"d-flex align-center mb-4"},pe={key:0},ve={key:0},he={key:1,class:"text-caption"},_e={key:1,class:"text-caption"},De={class:"d-flex align-center mb-4"},Ve={class:"d-flex align-center mb-4"};function ye(t,e,d,v,a,s){const B=G;return g(),x(I,{"model-value":d.modelValue,"max-width":"800px",persistent:"","onUpdate:modelValue":e[28]||(e[28]=o=>t.$emit("update:modelValue",o))},{default:i(()=>[l(h,null,{default:i(()=>[l($,null,{append:i(()=>[l(m,{icon:"",onClick:s.close},{default:i(()=>[l(C,null,{default:i(()=>e[31]||(e[31]=[n("mdi-close",-1)])),_:1,__:[31]})]),_:1},8,["onClick"])]),default:i(()=>[l(F,{class:"headline"},{default:i(()=>e[29]||(e[29]=[n(" 编辑用户信息 ",-1)])),_:1,__:[29]}),l(ee,null,{default:i(()=>[l(C,null,{default:i(()=>e[30]||(e[30]=[n("mdi-account",-1)])),_:1,__:[30]}),n(" "+u(a.userData.username),1)]),_:1})]),_:1}),l(j),l(b,{class:"pt-4"},{default:i(()=>[l(q,{ref:"editForm",modelValue:a.formValid,"onUpdate:modelValue":e[15]||(e[15]=o=>a.formValid=o)},{default:i(()=>[l(te,{"model-value":a.tabIndex,"onUpdate:modelValue":e[0]||(e[0]=o=>a.tabIndex=o)},{default:i(()=>[l(R,{value:1},{default:i(()=>e[32]||(e[32]=[n("个人资料",-1)])),_:1,__:[32]}),l(R,{value:2},{default:i(()=>e[33]||(e[33]=[n("账户连接",-1)])),_:1,__:[33]}),l(R,{value:3},{default:i(()=>e[34]||(e[34]=[n("头像设置",-1)])),_:1,__:[34]}),l(R,{value:4},{default:i(()=>e[35]||(e[35]=[n("数据",-1)])),_:1,__:[35]})]),_:1},8,["model-value"]),l(b,null,{default:i(()=>[l(le,{"model-value":a.tabIndex,"onUpdate:modelValue":e[14]||(e[14]=o=>a.tabIndex=o)},{default:i(()=>[l(k,{value:0},{default:i(()=>[l(T,null,{default:i(()=>[l(U)]),_:1})]),_:1}),l(k,{value:1},{default:i(()=>[l(T,null,{default:i(()=>[l(U,null,{default:i(()=>[l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.display_name,"onUpdate:modelValue":e[1]||(e[1]=o=>a.userData.display_name=o),rules:[o=>!!o||"显示名称不能为空"],dense:"",label:"显示名称",outlined:""},null,8,["modelValue","rules"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.username,"onUpdate:modelValue":e[2]||(e[2]=o=>a.userData.username=o),dense:"",label:"用户名",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(y,{modelValue:a.userData.status,"onUpdate:modelValue":e[3]||(e[3]=o=>a.userData.status=o),items:a.statusOptions,dense:"","item-title":"text","item-value":"value",label:"用户状态",outlined:""},null,8,["modelValue","items"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(y,{modelValue:a.userData.type,"onUpdate:modelValue":e[4]||(e[4]=o=>a.userData.type=o),items:a.typeOptions,dense:"","item-title":"text","item-value":"value",label:"用户类型",outlined:""},null,8,["modelValue","items"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.email,"onUpdate:modelValue":e[5]||(e[5]=o=>a.userData.email=o),dense:"",label:"邮箱",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.featured_projects,"onUpdate:modelValue":e[6]||(e[6]=o=>a.userData.featured_projects=o),dense:"",label:"精选项目",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.motto,"onUpdate:modelValue":e[7]||(e[7]=o=>a.userData.motto=o),dense:"",label:"一句话简介",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.location,"onUpdate:modelValue":e[8]||(e[8]=o=>a.userData.location=o),dense:"",label:"位置",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{"model-value":a.selectedRegion?a.selectedRegion.text:"",dense:"",label:"地区",outlined:"",readonly:"",onClick:e[9]||(e[9]=o=>a.showRegionSelector=!0)},null,8,["model-value"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(f,{modelValue:a.userData.url,"onUpdate:modelValue":e[10]||(e[10]=o=>a.userData.url=o),dense:"",label:"个人主页",outlined:""},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",sm:"6"},{default:i(()=>[l(y,{modelValue:a.userData.sex,"onUpdate:modelValue":e[11]||(e[11]=o=>a.userData.sex=o),items:a.sexOptions,dense:"","item-title":"text","item-value":"value",label:"性别",outlined:""},null,8,["modelValue","items"])]),_:1}),l(r,{cols:"12"},{default:i(()=>[l(se,{modelValue:a.userData.bio,"onUpdate:modelValue":e[12]||(e[12]=o=>a.userData.bio=o),dense:"",hint:"支持 Markdown 格式",label:"个人简介",outlined:"","persistent-hint":"",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),l(k,{value:2},{default:i(()=>[l(T,null,{default:i(()=>[l(U,null,{default:i(()=>[l(r,{cols:"12"},{default:i(()=>[c("div",ge,[e[37]||(e[37]=c("h3",{class:"text-h6"},"连接",-1)),l(V),l(m,{color:"primary","prepend-icon":"mdi-plus",onClick:s.showAddConnectionDialog},{default:i(()=>e[36]||(e[36]=[n(" 添加连接 ",-1)])),_:1,__:[36]},8,["onClick"])]),l(de,{headers:a.connectionHeaders,items:a.connections,loading:a.loadingConnections,class:"elevation-1"},{"item.contact_type":i(({item:o})=>[l(N,{color:s.getConnectionTypeColor(o.contact_type),size:"small"},{default:i(()=>[n(u(s.getConnectionTypeText(o.contact_type)),1)]),_:2},1032,["color"])]),"item.verified":i(({item:o})=>[l(C,{color:o.verified?"success":"warning",icon:o.verified?"mdi-check-circle":"mdi-alert-circle"},null,8,["color","icon"]),n(" "+u(o.verified?"已验证":"未验证"),1)]),"item.contact_info":i(({item:o})=>[o.contact_info?(g(),D("div",pe,[o.contact_info.username?(g(),D("div",ve," 用户名: "+u(o.contact_info.username),1)):S("",!0),o.contact_info.email?(g(),D("div",he," 邮箱: "+u(o.contact_info.email),1)):S("",!0)])):(g(),D("span",_e,"无详细信息"))]),"item.actions":i(({item:o})=>[l(m,{class:"mr-2",icon:"mdi-pencil",size:"small",onClick:p=>s.editConnection(o)},null,8,["onClick"]),l(m,{color:"error",icon:"mdi-delete",size:"small",onClick:p=>s.confirmDeleteConnection(o)},null,8,["onClick"])]),_:1},8,["headers","items","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),l(k,{value:3},{default:i(()=>[l(T,null,{default:i(()=>[l(U,{align:"center",justify:"center"},{default:i(()=>[l(r,{class:"text-center",cols:"12"},{default:i(()=>[l(H,{class:"mb-4",size:"150"},{default:i(()=>[l(L,{src:a.s3BucketUrl+"/user/"+a.userData.avatar},null,8,["src"])]),_:1}),c("div",null,[l(f,{modelValue:a.userData.avatar,"onUpdate:modelValue":e[13]||(e[13]=o=>a.userData.avatar=o),class:"mt-4",dense:"",label:"头像图片哈希",outlined:""},null,8,["modelValue"])])]),_:1})]),_:1})]),_:1})]),_:1}),l(k,{value:4},{default:i(()=>[c("pre",null,u(a.userData),1)]),_:1})]),_:1},8,["model-value"])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(j),l(O,null,{default:i(()=>[l(V),l(m,{text:"",onClick:s.close},{default:i(()=>e[38]||(e[38]=[n("取消",-1)])),_:1,__:[38]},8,["onClick"]),l(m,{disabled:!a.formValid||a.saving,loading:a.saving,color:"primary",onClick:s.save},{default:i(()=>e[39]||(e[39]=[n(" 保存 ",-1)])),_:1,__:[39]},8,["disabled","loading","onClick"])]),_:1})]),_:1}),l(B,{modelValue:a.showRegionSelector,"onUpdate:modelValue":e[16]||(e[16]=o=>a.showRegionSelector=o),"selected-region":a.selectedRegion,onClear:s.onRegionClear,onSelect:s.onRegionSelect},null,8,["modelValue","selected-region","onClear","onSelect"]),l(I,{modelValue:a.connectionDialog.show,"onUpdate:modelValue":e[25]||(e[25]=o=>a.connectionDialog.show=o),"max-width":"800px"},{default:i(()=>[l(h,null,{default:i(()=>[l(F,null,{default:i(()=>[n(u(a.connectionDialog.isEdit?"编辑连接 #"+a.connectionDialog.data.contact_id:"添加新连接"),1)]),_:1}),l(b,null,{default:i(()=>[l(q,{ref:"connectionForm",modelValue:a.connectionDialog.valid,"onUpdate:modelValue":e[23]||(e[23]=o=>a.connectionDialog.valid=o)},{default:i(()=>[a.connectionDialog.isEdit?S("",!0):(g(),x(y,{key:0,modelValue:a.connectionDialog.data.contact_type,"onUpdate:modelValue":e[17]||(e[17]=o=>a.connectionDialog.data.contact_type=o),items:a.oauthTypes,rules:[o=>!!o||"请选择连接类型"],label:"连接类型",required:""},null,8,["modelValue","items","rules"])),a.connectionDialog.isEdit?S("",!0):(g(),x(f,{key:1,modelValue:a.connectionDialog.data.contact_value,"onUpdate:modelValue":e[18]||(e[18]=o=>a.connectionDialog.data.contact_value=o),rules:[o=>!!o||"请输入提供商用户ID"],label:"提供商用户ID",required:""},null,8,["modelValue","rules"])),l(h,{class:"mt-4 pa-4",variant:"outlined"},{default:i(()=>[c("div",De,[e[40]||(e[40]=c("div",{class:"text-subtitle-1"},"连接信息",-1)),l(V)]),l(f,{modelValue:a.connectionDialog.data.contact_value,"onUpdate:modelValue":e[19]||(e[19]=o=>a.connectionDialog.data.contact_value=o),dense:"",label:"连接值",outlined:""},null,8,["modelValue"]),l(f,{modelValue:a.connectionDialog.data.contact_info,"onUpdate:modelValue":e[20]||(e[20]=o=>a.connectionDialog.data.contact_info=o),dense:"",label:"随机值",outlined:""},null,8,["modelValue"]),l(y,{modelValue:a.connectionDialog.data.contact_type,"onUpdate:modelValue":e[21]||(e[21]=o=>a.connectionDialog.data.contact_type=o),items:a.oauthTypes,dense:"",label:"连接类型",outlined:""},null,8,["modelValue","items"])]),_:1}),l(h,{class:"mt-4 pa-4",variant:"outlined"},{default:i(()=>[c("div",Ve,[e[42]||(e[42]=c("div",{class:"text-subtitle-1"},"元数据",-1)),l(V),l(m,{color:"primary","prepend-icon":"mdi-plus",size:"small",onClick:s.addMetadataField},{default:i(()=>e[41]||(e[41]=[n(" 添加字段 ",-1)])),_:1,__:[41]},8,["onClick"])]),(g(!0),D(W,null,Y(a.connectionDialog.data.metadata,(o,p,E)=>(g(),D("div",{key:E,class:"d-flex align-center mb-2 gap-2"},[l(f,{modelValue:a.connectionDialog.metadataKeys[E],"onUpdate:modelValue":[w=>a.connectionDialog.metadataKeys[E]=w,w=>s.updateMetadataKey(E,p,w)],class:"flex-grow-0",density:"compact","hide-details":"",label:"字段名",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),l(f,{modelValue:a.connectionDialog.data.metadata[p],"onUpdate:modelValue":w=>a.connectionDialog.data.metadata[p]=w,label:"值",class:"flex-grow-1",density:"compact","hide-details":""},null,8,["modelValue","onUpdate:modelValue"]),l(m,{color:"error",icon:"mdi-delete",size:"small",variant:"text",onClick:w=>s.removeMetadataField(p)},null,8,["onClick"])]))),128))]),_:1}),l(re,{modelValue:a.connectionDialog.data.verified,"onUpdate:modelValue":e[22]||(e[22]=o=>a.connectionDialog.data.verified=o),class:"mt-4",color:"success","hide-details":"",label:"已验证"},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(O,null,{default:i(()=>[l(V),l(m,{text:"",onClick:e[24]||(e[24]=o=>a.connectionDialog.show=!1)},{default:i(()=>e[43]||(e[43]=[n(" 取消",-1)])),_:1,__:[43]}),l(m,{disabled:!a.connectionDialog.valid||a.connectionDialog.saving,loading:a.connectionDialog.saving,color:"primary",onClick:s.saveConnection},{default:i(()=>e[44]||(e[44]=[n(" 保存 ",-1)])),_:1,__:[44]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(I,{modelValue:a.deleteConnectionDialog.show,"onUpdate:modelValue":e[27]||(e[27]=o=>a.deleteConnectionDialog.show=o),"max-width":"400px"},{default:i(()=>[l(h,null,{default:i(()=>[l(F,{class:"text-h5 text-error"},{default:i(()=>e[45]||(e[45]=[n(" 确认删除连接",-1)])),_:1,__:[45]}),l(b,null,{default:i(()=>{var o;return[n(" 确定要删除这个 "+u(s.getConnectionTypeText((o=a.deleteConnectionDialog.connection)==null?void 0:o.contact_type))+" 连接吗？此操作不可撤销。 ",1)]}),_:1}),l(O,null,{default:i(()=>[l(V),l(m,{text:"",onClick:e[26]||(e[26]=o=>a.deleteConnectionDialog.show=!1)},{default:i(()=>e[46]||(e[46]=[n(" 取消 ",-1)])),_:1,__:[46]}),l(m,{loading:a.deleteConnectionDialog.deleting,color:"error",onClick:s.deleteConnection},{default:i(()=>e[47]||(e[47]=[n(" 确认删除 ",-1)])),_:1,__:[47]},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["model-value"])}const X=Q(fe,[["render",ye],["__scopeId","data-v-5b6c25d1"]]);P.extend(ue);P.locale("zh-cn");const xe={name:"UsersPage",components:{UserEditor:X},data(){return{userStats:[{title:"总用户数",value:0,type:"total",icon:"mdi-account-group"},{title:"活跃用户",value:0,type:"active",icon:"mdi-account-check"}],users:[],total:0,loading:!1,refreshing:!1,options:{page:1,itemsPerPage:10,sortBy:["id"],sortDesc:[!1],groupBy:[],groupDesc:[],multiSort:!1},headers:[{title:"ID",value:"id",width:"80px",sortable:!1},{title:"用户",value:"username",width:"250px",sortable:!1},{title:"邮箱",value:"email",sortable:!1},{title:"状态",value:"status",width:"120px",sortable:!1},{title:"类型",value:"type",width:"120px",sortable:!1},{title:"注册时间",value:"regTime",width:"180px",sortable:!1},{title:"操作",value:"actions",sortable:!1,width:"150px",align:"center"}],searchQuery:"",statusFilter:"",typeFilter:"",statusOptions:[{title:"活跃",value:"active"},{title:"已暂停",value:"suspended"},{title:"已封禁",value:"banned"},{title:"待验证",value:"pending"}],typeOptions:[{title:"访客",value:"guest"},{title:"普通用户",value:"user"},{title:"管理员",value:"administrator"}],editDialog:!1,deleteDialog:!1,deleteConfirmation:"",selectedUser:null,deleting:!1,snackbar:{show:!1,text:"",color:"success",timeout:3e3}}},methods:{async loadUsers(){this.loading=!0;try{const t={page:this.options.page,itemsPerPage:this.options.itemsPerPage,sort_by:this.options.sortBy[0]||"id",sort_order:this.options.sortDesc[0]?"desc":"asc"};this.searchQuery&&(t.search=this.searchQuery),this.statusFilter&&(t.status=this.statusFilter),this.typeFilter&&(t.type=this.typeFilter);const{data:e}=await _.get("/admin/users",{params:t});this.users=e.items.map(d=>({...d,id:d.id,username:d.username,email:d.email||"",status:d.status||"pending",type:d.type||"user",regTime:d.regTime,avatar:d.avatar})),this.total=Number(e.total)}catch(t){this.showError("加载用户列表失败"),console.error("Error loading users:",t)}finally{this.loading=!1}},async loadUserStats(){var t;try{const{data:e}=await _.get("/admin/users/stats/overview");this.userStats[0].value=e.totalUsers,this.userStats[1].value=((t=e.usersByStatus.find(d=>d.status==="active"))==null?void 0:t._count)||0}catch(e){console.error("Error loading user stats:",e)}},async refreshData(){if(!(this.refreshing||this.loading)){this.refreshing=!0;try{await Promise.all([this.loadUsers(),this.loadUserStats()]),this.showSuccess("数据已更新")}catch(t){this.showError("刷新数据失败"),console.error("Error refreshing data:",t)}finally{this.refreshing=!1}}},editUser(t){this.selectedUser=t,this.editDialog=!0},async saveUser(t){var e,d;try{const{data:v}=await _.put(`/admin/users/${t.id}`,t),a=this.users.findIndex(s=>s.id===t.id);a!==-1&&(this.users[a]={...this.users[a],...v}),this.showSuccess("用户信息更新成功")}catch(v){throw this.showError(((d=(e=v.response)==null?void 0:e.data)==null?void 0:d.error)||"保存用户信息失败"),console.error("Error saving user:",v),v}},confirmDelete(t){this.selectedUser=t,this.deleteConfirmation="",this.deleteDialog=!0},async deleteUser(){this.deleting=!0;try{await _.delete(`/admin/users/${this.selectedUser.id}`),this.showSuccess("用户删除成功"),this.loadUsers(),this.loadUserStats(),this.deleteDialog=!1}catch(t){this.showError("删除用户失败"),console.error("Error deleting user:",t)}finally{this.deleting=!1}},getStatusText(t){const e=this.statusOptions.find(d=>d.value===t);return e?e.title:t},getTypeText(t){const e=this.typeOptions.find(d=>d.value===t);return e?e.title:t},formatDate(t){return P(t).format("YYYY-MM-DD HH:mm:ss")},formatTimeAgo(t){return P(t).fromNow()},getStatusColor(t){return{active:"success",suspended:"warning",banned:"error",pending:"info"}[t]||"grey"},getAvatarUrl(t){return t?t.startsWith("http")?t:`/api/avatar/${t}`:"/default-avatar.png"},showSuccess(t){this.snackbar={show:!0,text:t,color:"success",timeout:3e3}},showError(t){this.snackbar={show:!0,text:t,color:"error",timeout:5e3}},debouncedSearch:me(function(){this.loadUsers()},300)},mounted(){this.loadUsers(),this.loadUserStats()}},Ce={class:"users-admin"},be={class:"text-overline mb-2"},we={class:"text-h4"},Ue={class:"d-flex align-center"},ke={class:"font-weight-medium"},Te={class:"caption grey--text"},Se={class:"caption grey--text"};function Ee(t,e,d,v,a,s){const B=X;return g(),x(T,null,{default:i(()=>[c("div",Ce,[l(U,{class:"mb-4"},{default:i(()=>[(g(!0),D(W,null,Y(a.userStats,o=>(g(),x(r,{key:o.title,cols:"12",md:"3",sm:"6"},{default:i(()=>[l(h,{class:M(["stat-card",`stat-${o.type}`]),elevation:"2"},{default:i(()=>[l(b,null,{default:i(()=>[c("div",be,u(o.title),1),c("div",we,u(o.value),1),l(C,{class:"stat-icon",large:""},{default:i(()=>[n(u(o.icon),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}),l(h,{class:"mb-4"},{default:i(()=>[l(b,null,{default:i(()=>[l(U,{align:"center"},{default:i(()=>[l(r,{cols:"12",sm:"4"},{default:i(()=>[l(f,{modelValue:a.searchQuery,"onUpdate:modelValue":e[0]||(e[0]=o=>a.searchQuery=o),clearable:"","hide-details":"",label:"搜索用户","prepend-icon":"mdi-magnify",onInput:s.debouncedSearch},null,8,["modelValue","onInput"])]),_:1}),l(r,{cols:"12",sm:"3"},{default:i(()=>[l(y,{modelValue:a.statusFilter,"onUpdate:modelValue":e[1]||(e[1]=o=>a.statusFilter=o),items:a.statusOptions,clearable:"","hide-details":"",label:"状态过滤","prepend-icon":"mdi-filter",onChange:s.loadUsers},null,8,["modelValue","items","onChange"])]),_:1}),l(r,{cols:"12",sm:"3"},{default:i(()=>[l(y,{modelValue:a.typeFilter,"onUpdate:modelValue":e[2]||(e[2]=o=>a.typeFilter=o),items:a.typeOptions,clearable:"","hide-details":"",label:"类型过滤","prepend-icon":"mdi-account-filter",onChange:s.loadUsers},null,8,["modelValue","items","onChange"])]),_:1}),l(r,{class:"d-flex justify-end",cols:"12",sm:"2"},{default:i(()=>[l(m,{disabled:a.loading,loading:a.refreshing,color:"primary",onClick:s.refreshData},{default:i(()=>[l(C,{class:M({rotate:a.refreshing}),left:""},{default:i(()=>e[11]||(e[11]=[n("mdi-refresh ",-1)])),_:1,__:[11]},8,["class"]),e[12]||(e[12]=n(" 刷新 ",-1))]),_:1,__:[12]},8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1})]),_:1}),l(h,null,{default:i(()=>[l(ce,{"items-per-page":a.options.itemsPerPage,"onUpdate:itemsPerPage":e[3]||(e[3]=o=>a.options.itemsPerPage=o),page:a.options.page,"onUpdate:page":e[4]||(e[4]=o=>a.options.page=o),headers:a.headers,items:a.users,"items-length":a.total,loading:a.loading,"loading-text":"加载中...","no-data-text":"暂无数据","no-results-text":"未找到匹配的数据","onUpdate:options":s.loadUsers},{"item.username":i(({item:o})=>[c("div",Ue,[l(H,{class:"mr-2",size:"32"},{default:i(()=>[l(L,{alt:o.username,src:s.getAvatarUrl(o.avatar)},null,8,["alt","src"])]),_:2},1024),c("div",null,[c("div",ke,u(o.username),1),c("div",Te,u(o.display_name),1)])])]),"item.status":i(({item:o})=>[l(N,{color:s.getStatusColor(o.status),class:"status-chip",small:""},{default:i(()=>[n(u(s.getStatusText(o.status)),1)]),_:2},1032,["color"])]),"item.type":i(({item:o})=>[n(u(s.getTypeText(o.type)),1)]),"item.regTime":i(({item:o})=>[c("div",null,u(s.formatDate(o.regTime)),1),c("div",Se,u(s.formatTimeAgo(o.regTime)),1)]),"item.actions":i(({item:o})=>[l(oe,{group:""},{default:i(()=>[A((g(),x(m,{class:"action-btn",icon:"",small:"",onClick:z(p=>s.editUser(o),["stop"])},{default:i(()=>[l(C,null,{default:i(()=>e[13]||(e[13]=[n("mdi-pencil",-1)])),_:1,__:[13]})]),_:2},1032,["onClick"])),[[K,"编辑用户"]]),o.type!=="administrator"?A((g(),x(m,{key:0,class:"action-btn",icon:"",small:"",onClick:z(p=>s.confirmDelete(o),["stop"])},{default:i(()=>[l(C,null,{default:i(()=>e[14]||(e[14]=[n("mdi-delete",-1)])),_:1,__:[14]})]),_:2},1032,["onClick"])),[[K,"删除用户"]]):S("",!0)]),_:2},1024)]),_:1},8,["items-per-page","page","headers","items","items-length","loading","onUpdate:options"])]),_:1}),l(B,{modelValue:a.editDialog,"onUpdate:modelValue":e[5]||(e[5]=o=>a.editDialog=o),user:a.selectedUser,onSave:s.saveUser},null,8,["modelValue","user","onSave"]),l(I,{modelValue:a.deleteDialog,"onUpdate:modelValue":e[8]||(e[8]=o=>a.deleteDialog=o),"max-width":"400px",transition:"dialog-bottom-transition"},{default:i(()=>[l(h,null,{default:i(()=>[l(F,{class:"headline error--text"},{default:i(()=>e[15]||(e[15]=[n("确认删除",-1)])),_:1,__:[15]}),l(b,{class:"pt-4"},{default:i(()=>[l(ae,{dense:"",text:"",type:"warning"},{default:i(()=>{var o;return[e[16]||(e[16]=n(" 此操作将永久删除用户 ",-1)),c("strong",null,u((o=a.selectedUser)==null?void 0:o.username),1),e[17]||(e[17]=n(" 及其所有相关数据，此操作不可撤销。 ",-1))]}),_:1,__:[16,17]}),l(f,{modelValue:a.deleteConfirmation,"onUpdate:modelValue":e[6]||(e[6]=o=>a.deleteConfirmation=o),rules:[o=>{var p;return!o||o===((p=a.selectedUser)==null?void 0:p.username)||"用户名不匹配"}],class:"mt-4",dense:"",label:"请输入用户名以确认删除",outlined:""},null,8,["modelValue","rules"])]),_:1}),l(O,null,{default:i(()=>{var o;return[l(V),l(m,{text:"",onClick:e[7]||(e[7]=p=>a.deleteDialog=!1)},{default:i(()=>e[18]||(e[18]=[n("取消",-1)])),_:1,__:[18]}),l(m,{disabled:a.deleteConfirmation!==((o=a.selectedUser)==null?void 0:o.username),loading:a.deleting,color:"error",text:"",onClick:s.deleteUser},{default:i(()=>e[19]||(e[19]=[n(" 确认删除 ",-1)])),_:1,__:[19]},8,["disabled","loading","onClick"])]}),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ie,{modelValue:a.snackbar.show,"onUpdate:modelValue":e[10]||(e[10]=o=>a.snackbar.show=o),color:a.snackbar.color,timeout:a.snackbar.timeout,top:""},{action:i(({attrs:o})=>[l(m,ne({text:""},o,{onClick:e[9]||(e[9]=p=>a.snackbar.show=!1)}),{default:i(()=>e[20]||(e[20]=[n(" 关闭 ",-1)])),_:2,__:[20]},1040)]),default:i(()=>[n(u(a.snackbar.text)+" ",1)]),_:1},8,["modelValue","color","timeout"])])]),_:1})}const Ye=Q(xe,[["render",Ee],["__scopeId","data-v-45204cdb"]]);export{Ye as default};
