import{_ as M,b0 as P,b4 as j,r as v,x as D,b as W,Y as _,o as i,N as e,e as a,$ as h,Q as w,R as q,W as $,aU as O,a9 as Q,L as n,aW as X,f as p,X as f,Z as Y,a0 as x,a3 as C,O as z,ad as Z,c as G,F as H,U as J,ae as K,af as ee,ag as ae,aE as te,i as I,a5 as le,a4 as re,T as se,a1 as k}from"./index-_2MgdHBD.js";import{V as oe}from"./VSelect-DsIYCbsR.js";import"https://static.geetest.com/v4/gt4.js";import"./VCheckboxBtn-BqBysgLi.js";import"./VSelectionControl-BPngQ81N.js";const ie={class:"font-weight-bold"},ne={class:"d-flex align-center mb-4"},ue=["href"],ce={class:"text-body-1"},de={__name:"authorize",setup(me){const u=P(),L=j(),r=v(null),c=v(!1),s=v(null),d=v([]),m=v(null),y=u.query.client_id,g=u.query.redirect_uri,V=u.query.scope,b=u.query.state,S=u.query.code_challenge,A=u.query.code_challenge_method,B={"user:basic":{icon:"mdi-account",title:"查看您的基本信息",description:"包括您的用户名、显示名称和头像"},"user:email":{icon:"mdi-email",title:"查看您的邮箱地址",description:"访问您的主要邮箱地址"}},E=D(()=>V?V.split(" ").map(l=>({name:l,...B[l]})):[]),N=()=>y?g?!0:(s.value="缺少必要的redirect_uri参数",!1):(s.value="缺少必要的client_id参数",!1),R=async()=>{if(N()){c.value=!0;try{const l=await k.get(`/oauth/applications/${y}`);r.value=l.data,r.value.redirect_uris.includes(g)||(s.value="无效的回调地址",r.value=null)}catch(l){s.value="无法加载应用信息",console.error("Failed to load application:",l)}c.value=!1}},T=async()=>{try{const l=await k.get("/oauth/user/emails");if(d.value=l.data.map(t=>({email:t.contact_value,primary:t.is_primary})),d.value.length>0){const t=d.value.find(o=>o.primary);m.value=t?t.email:d.value[0].email}}catch(l){console.error("Failed to load emails:",l)}},U=async()=>{if(!m.value){s.value="请选择要授权的邮箱";return}c.value=!0;try{const l=await k.post("/oauth/authorize/confirm",{client_id:y,redirect_uri:g,scope:V,state:b,authorized_email:m.value,code_challenge:S,code_challenge_method:A});l.data.redirect_url&&(window.location.href=l.data.redirect_url)}catch(l){s.value="授权失败，请重试",console.error("Authorization failed:",l)}c.value=!1},F=()=>{new URLSearchParams({error:"access_denied",error_description:"用户拒绝了应用程序的访问请求",state:b||""}),L.push({path:"/app/oauth/error",query:{error:"access_denied",error_description:"用户拒绝了应用程序的访问请求",state:b||""}})};return W(()=>{R(),T()}),(l,t)=>(i(),_(se,{class:"pa-4"},{default:e(()=>[a(w,{justify:"center"},{default:e(()=>[a(q,{cols:"12",lg:"6",md:"8",sm:"10"},{default:e(()=>[r.value?(i(),_($,{key:0,class:"mb-4"},{default:e(()=>[a(O,null,{prepend:e(()=>[a(Y,{image:r.value.logo_url||"/default-app-logo.png",class:"mr-4",size:"64"},null,8,["image"])]),default:e(()=>[a(Q,{class:"text-h5"},{default:e(()=>t[1]||(t[1]=[n(" 授权请求 ",-1)])),_:1,__:[1]}),a(X,null,{default:e(()=>[p("span",ie,f(r.value.name),1),t[2]||(t[2]=n(" 想要访问您的账号 ",-1))]),_:1,__:[2]})]),_:1}),a(x),a(C,{class:"pt-4"},{default:e(()=>[p("div",ne,[a(z,{class:"mr-2",icon:"mdi-web"}),p("a",{href:r.value.homepage_url,class:"text-decoration-none",target:"_blank"},f(r.value.homepage_url),9,ue)]),p("p",ce,f(r.value.description),1)]),_:1}),a(x),a(C,null,{default:e(()=>[t[3]||(t[3]=p("h3",{class:"text-h6 mb-4"},"此应用将获得以下权限：",-1)),a(Z,null,{default:e(()=>[(i(!0),G(H,null,J(E.value,o=>(i(),_(K,{key:o.name,class:"mb-2"},{prepend:e(()=>[a(z,{icon:o.icon,class:"mr-2",color:"primary"},null,8,["icon"])]),default:e(()=>[a(ee,{class:"font-weight-bold"},{default:e(()=>[n(f(o.title),1)]),_:2},1024),a(ae,null,{default:e(()=>[n(f(o.description),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[3]}),d.value.length>0?(i(),_(C,{key:0},{default:e(()=>[t[4]||(t[4]=p("h3",{class:"text-h6 mb-4"},"选择授权邮箱：",-1)),a(oe,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),items:d.value,class:"mb-4",density:"comfortable","item-title":"email","item-value":"email",label:"选择要授权的邮箱",variant:"outlined"},null,8,["modelValue","items"])]),_:1,__:[4]})):h("",!0),a(x),a(te,{class:"pa-4"},{default:e(()=>[a(I,{class:"mr-2",color:"error",variant:"outlined",onClick:F},{default:e(()=>t[5]||(t[5]=[n(" 取消 ",-1)])),_:1,__:[5]}),a(I,{disabled:!m.value,loading:c.value,color:"primary",onClick:U},{default:e(()=>t[6]||(t[6]=[n(" 授权应用 ",-1)])),_:1,__:[6]},8,["disabled","loading"])]),_:1})]),_:1})):h("",!0),s.value?(i(),_(le,{key:1,class:"mb-4",closable:"",type:"error",variant:"tonal"},{default:e(()=>[n(f(s.value),1)]),_:1})):h("",!0)]),_:1})]),_:1}),c.value&&!r.value?(i(),_(w,{key:0,justify:"center"},{default:e(()=>[a(q,{class:"text-center",cols:"12"},{default:e(()=>[a(re,{color:"primary",indeterminate:"",size:"64"})]),_:1})]),_:1})):h("",!0)]),_:1}))}},ye=M(de,[["__scopeId","data-v-689d34f2"]]);export{ye as default};
