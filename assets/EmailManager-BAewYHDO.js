import{r as u,w as G,a1 as F,Y as D,o as g,N as a,e as s,W as $,a9 as A,L as r,X as k,a3 as N,f as v,$ as T,aB as M,a5 as K,aE as z,i as x,aA as I,b as ee,c as H,F as le,U as ae,S as J,aF as te,aD as se}from"./index-CQDSP-11.js";import{V as j}from"./VSpacer-0JHjHF4H.js";import{V as ue}from"./VTable-D7AGu9lU.js";const ne={__name:"verifyEmail",props:{modelValue:Boolean,email:{type:String,required:!0},title:{type:String,default:"验证邮箱"}},emits:["update:modelValue","verified"],setup(m,{expose:_,emit:p}){const C=m,b=p,y=u(C.modelValue),i=u(""),d=u(""),f=u("info"),w=u(!1),V={required:n=>!!n||"此字段为必填项",length:n=>(n==null?void 0:n.length)===6||"验证码必须是6位数字"};G(()=>y.value,n=>{b("update:modelValue",n),n&&E()}),G(()=>C.modelValue,n=>{y.value=n});const E=async()=>{var n,o;d.value="",w.value=!0;try{const c=await F.post("/account/send-verification-code",{email:C.email});c.data.status==="success"?(d.value="验证码已发送",f.value="success"):(d.value=c.data.message,f.value="error")}catch(c){d.value=((o=(n=c.response)==null?void 0:n.data)==null?void 0:o.message)||"发送验证码失败",f.value="error"}finally{w.value=!1}},U=()=>{if(!i.value||i.value.length!==6){d.value="请输入6位验证码",f.value="error";return}b("verified",i.value),q()},q=()=>{y.value=!1,i.value="",d.value=""};return _({sendCode:E}),(n,o)=>(g(),D(I,{modelValue:y.value,"onUpdate:modelValue":o[1]||(o[1]=c=>y.value=c),"max-width":"400px"},{default:a(()=>[s($,null,{default:a(()=>[s(A,null,{default:a(()=>[r(k(m.title),1)]),_:1}),s(N,null,{default:a(()=>[v("p",null,"验证码将发送到邮箱 "+k(m.email),1),s(M,{modelValue:i.value,"onUpdate:modelValue":o[0]||(o[0]=c=>i.value=c),label:"验证码",rules:[V.required,V.length],maxlength:"6",variant:"outlined",class:"mt-4"},null,8,["modelValue","rules"]),d.value?(g(),D(K,{key:0,type:f.value,variant:"tonal",class:"mt-3"},{default:a(()=>[r(k(d.value),1)]),_:1},8,["type"])):T("",!0)]),_:1}),s(z,null,{default:a(()=>[s(j),s(x,{color:"grey",variant:"text",onClick:q},{default:a(()=>o[2]||(o[2]=[r("取消")])),_:1,__:[2]}),s(x,{color:"primary",loading:w.value,onClick:U},{default:a(()=>o[3]||(o[3]=[r(" 确认 ")])),_:1,__:[3]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},re=async()=>(await F.get("/account/emails")).data,oe=async(m,_)=>(await F.post("/account/add-email",{email:m,verificationCode:_})).data,ie=async(m,_)=>(await F.post("/account/remove-email",{email:m,verificationCode:_})).data,de=async(m,_)=>(await F.post("/account/verify-email",{email:m,token:_})).data,me={__name:"EmailManager",setup(m,{expose:_}){const p=u([]),C=u(!1),b=u(!1),y=u(!1),i=u(!1),d=u(""),f=u(""),w=u(null),V=u(""),E=u("info"),U=u(!1),q=u(""),n=u(""),o=u(null),c=u(null),S={required:t=>!!t||"此字段为必填项",email:t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||"请输入有效的邮箱地址",length:t=>(t==null?void 0:t.length)===6||"验证码必须是6位数字"},B=async()=>{try{const t=await re();t.status==="success"&&(p.value=t.data)}catch(t){console.error("获取邮箱列表失败:",t)}},L=(t,e,l)=>{q.value=t,n.value=e,o.value=l,U.value=!0},O=t=>{o.value&&(o.value(t),o.value=null)},P=async()=>{if(!d.value){V.value="请输入新邮箱地址",E.value="error";return}const t=p.value.find(e=>e.is_primary);if(!t){V.value="未找到主邮箱",E.value="error";return}L(t.contact_value,"验证主邮箱",e=>{f.value=e,W()})},W=async()=>{if(!(!d.value||!f.value)){i.value=!0;try{const t=await oe(d.value,f.value);t.status==="success"?(await B(),X()):(V.value=t.message,E.value="error")}catch{V.value="添加邮箱失败",E.value="error"}finally{i.value=!1}}},Q=t=>{w.value=t,b.value=!0},R=()=>{const t=p.value.find(e=>e.is_primary);t&&w.value&&L(t.contact_value,"验证主邮箱",async e=>{i.value=!0;try{(await ie(w.value.contact_value,e)).status==="success"&&(await B(),Y())}catch(l){console.error("删除失败:",l)}finally{i.value=!1}})},X=()=>{C.value=!1,y.value=!1,d.value="",f.value="",V.value="",c.value&&c.value.reset()},Y=()=>{b.value=!1,w.value=null},Z=t=>{L(t,"验证邮箱",async e=>{i.value=!0;try{(await de(t,e)).status==="success"&&await B()}catch(l){console.error("验证失败:",l)}finally{i.value=!1}})};return ee(async()=>{await B()}),_({fetchEmails:B}),(t,e)=>(g(),D($,{class:"mb-4"},{default:a(()=>[s(A,{class:"d-flex align-center justify-space-between"},{default:a(()=>[e[8]||(e[8]=v("span",null,"邮箱管理",-1)),s(x,{color:"primary",onClick:e[0]||(e[0]=l=>C.value=!0),disabled:p.value.length>=5},{default:a(()=>e[7]||(e[7]=[r(" 添加邮箱 ")])),_:1,__:[7]},8,["disabled"])]),_:1,__:[8]}),s(N,null,{default:a(()=>[s(ue,null,{default:a(()=>[e[12]||(e[12]=v("thead",null,[v("tr",null,[v("th",null,"邮箱地址"),v("th",null,"状态"),v("th",null,"添加时间"),v("th",null,"操作")])],-1)),v("tbody",null,[(g(!0),H(le,null,ae(p.value,l=>(g(),H("tr",{key:l.contact_id},[v("td",null,[r(k(l.contact_value)+" ",1),l.is_primary?(g(),D(J,{key:0,color:"primary",size:"small",class:"ml-2"},{default:a(()=>e[9]||(e[9]=[r("主邮箱")])),_:1,__:[9]})):T("",!0)]),v("td",null,[s(J,{color:l.verified?"success":"warning",size:"small"},{default:a(()=>[r(k(l.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),v("td",null,k(new Date(l.created_at).toLocaleString()),1),v("td",null,[l.verified?T("",!0):(g(),D(x,{key:0,variant:"text",color:"primary",size:"small",onClick:h=>Z(l.contact_value)},{default:a(()=>e[10]||(e[10]=[r(" 验证 ")])),_:2,__:[10]},1032,["onClick"])),l.is_primary?T("",!0):(g(),D(x,{key:1,variant:"text",color:"error",size:"small",onClick:h=>Q(l)},{default:a(()=>e[11]||(e[11]=[r(" 删除 ")])),_:2,__:[11]},1032,["onClick"]))])]))),128))])]),_:1,__:[12]})]),_:1}),s(I,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=l=>C.value=l),"max-width":"500px"},{default:a(()=>[s($,null,{default:a(()=>[s(A,null,{default:a(()=>e[13]||(e[13]=[r("添加新邮箱")])),_:1,__:[13]}),s(N,null,{default:a(()=>[s(te,{onSubmit:se(P,["prevent"]),ref_key:"addForm",ref:c},{default:a(()=>[s(M,{modelValue:d.value,"onUpdate:modelValue":e[1]||(e[1]=l=>d.value=l),label:"新邮箱地址",rules:[S.required,S.email],variant:"outlined"},null,8,["modelValue","rules"]),y.value?(g(),D(M,{key:0,modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=l=>f.value=l),label:"主邮箱验证码",rules:[S.required,S.length],maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):T("",!0),V.value?(g(),D(K,{key:1,type:E.value,variant:"tonal",class:"mt-3"},{default:a(()=>[r(k(V.value),1)]),_:1},8,["type"])):T("",!0)]),_:1},512)]),_:1}),s(z,null,{default:a(()=>[s(j),s(x,{color:"grey",variant:"text",onClick:X},{default:a(()=>e[14]||(e[14]=[r("取消")])),_:1,__:[14]}),s(x,{color:"primary",loading:i.value,onClick:e[3]||(e[3]=l=>y.value?W():P())},{default:a(()=>[r(k(y.value?"添加":"发送验证码"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(I,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=l=>b.value=l),"max-width":"500px"},{default:a(()=>[s($,null,{default:a(()=>[s(A,null,{default:a(()=>e[15]||(e[15]=[r("删除邮箱")])),_:1,__:[15]}),s(N,null,{default:a(()=>{var l;return[v("p",null,"确认要删除邮箱 "+k((l=w.value)==null?void 0:l.contact_value)+" 吗？",1)]}),_:1}),s(z,null,{default:a(()=>[s(j),s(x,{color:"grey",variant:"text",onClick:Y},{default:a(()=>e[16]||(e[16]=[r("取消")])),_:1,__:[16]}),s(x,{color:"error",loading:i.value,onClick:R},{default:a(()=>e[17]||(e[17]=[r(" 删除 ")])),_:1,__:[17]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ne,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=l=>U.value=l),email:q.value,title:n.value,onVerified:O},null,8,["modelValue","email","title"])]),_:1}))}};export{me as _};
