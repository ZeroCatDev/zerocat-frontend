import{_ as N}from"./LoadingDialog-BdXwkqGQ.js";import{_ as S}from"./AuthCard-CtasAUoZ.js";import{_ as U}from"./OAuthButtons-VJ5aGhM6.js";import{_ as W}from"./Recaptcha-2W3JBfdD.js";import{_ as Q,c as E,o as k,e as n,N as l,aF as X,Q as Y,R as p,Y as G,$ as F,ah as J,ai as b,L as h,aB as T,F as K,i as _,X as Z,bc as $,r as u,ab as ee,M as ae,w as oe}from"./index-CqDYMkg5.js";import{A as y}from"./authService-w9KrMMhD.js";import{o as te}from"./oauth_providers-BTwCArWd.js";import"https://static.geetest.com/v4/gt4.js";const ne={components:{LoadingDialog:N,Recaptcha:W,AuthCard:S,OAuthButtons:U},setup(){const x=$(),o=u(""),g=u(""),a=u(""),c=u("password"),v=u(0),s=u(!1),V=u(!1),m=u(null),f=u(!1),r={required:e=>!!e||"此字段为必填项",length:e=>(e==null?void 0:e.length)===6||"验证码必须是6位数字"},z=[e=>!!e||"必须填写邮箱",e=>/.+@.+\..+/.test(e)||"不符合格式"],D=[e=>!!e||"必须填写密码"];ee.isLogin.value===!0&&x.push("/app/dashboard"),ae({title:"登录"}),Object.entries(te).filter(([e])=>e!=="default").map(([e,t])=>({id:e,...t}));const I=()=>c.value==="password"?"登录":c.value==="code"?a.value?"登录":"发送验证码":c.value==="magiclink"?f.value?"已发送，请检查邮箱":"发送登录链接":"登录",M=async()=>{switch(c.value){case"password":await L();break;case"code":a.value?await R():await C();break;case"magiclink":await A();break}},L=async()=>{var e;if(!o.value||!g.value){i("请输入邮箱和密码");return}s.value=!0;try{const t=((e=m.value)==null?void 0:e.getResponse())||null,d=await y.loginWithPassword(o.value,g.value,t);P(d)}catch(t){w(t)}finally{s.value=!1}},R=async()=>{if(!o.value||!a.value){i("请输入邮箱和验证码");return}s.value=!0;try{const e=await y.loginWithCode(o.value,a.value);P(e)}catch(e){w(e)}finally{s.value=!1}},C=async()=>{var e;if(!(v.value>0)){if(!o.value||!/.+@.+\..+/.test(o.value)){i("请输入正确的邮箱地址");return}s.value=!0;try{const t=((e=m.value)==null?void 0:e.getResponse())||null,d=await y.sendLoginCode(o.value,t);d.status==="success"?(B("验证码已发送"),O()):i(d.message)}catch(t){w(t)}finally{s.value=!1}}},A=async()=>{var e;if(!f.value){if(!o.value||!/.+@.+\..+/.test(o.value)){i("请输入正确的邮箱地址");return}s.value=!0;try{const t=((e=m.value)==null?void 0:e.getResponse())||null;if(!t){i("请完成人机验证"),s.value=!1;return}const d=await y.generateMagicLink(o.value,window.location.origin+"/app/account/magiclink/validate",t);d.status==="success"?(B("登录链接已发送到您的邮箱"),f.value=!0):i(d.message)}catch(t){w(t)}finally{s.value=!1}}},P=e=>{e.status==="success"?(B("登录成功，欢迎回来，"+e.display_name),setTimeout(()=>{x.push("/app/dashboard")},1e3)):i(e.message)},w=e=>{var t,d;i(((d=(t=e.response)==null?void 0:t.data)==null?void 0:d.message)||e.message)},B=e=>{var t;(t=this==null?void 0:this.$toast)==null||t.add({severity:"success",summary:"成功",detail:e,life:3e3})},i=e=>{var t;(t=this==null?void 0:this.$toast)==null||t.add({severity:"error",summary:"错误",detail:e,life:3e3})},O=()=>{v.value=60;const e=setInterval(()=>{v.value--,v.value<=0&&clearInterval(e)},1e3)},q=e=>{c.value==="code"&&!a.value&&C()},j=()=>{i("验证失败，请重试")},H=()=>{};return oe(c,e=>{a.value="",f.value=!1,setTimeout(()=>{m.value&&m.value.resetCaptcha()},100)}),{email:o,password:g,verificationCode:a,loginType:c,countdown:v,loading:s,showPassword:V,rules:r,emailRules:z,passwordRules:D,recaptcha:m,magicLinkSent:f,getLoginButtonText:I,handleLoginAction:M,loginWithPassword:L,loginWithCode:R,sendVerificationCode:C,sendMagicLink:A,handleBindVerified:q,handleBindError:j,handleBindClose:H}}};function le(x,o,g,a,c,v){const s=W,V=U,m=S,f=N;return k(),E("div",null,[n(m,{subtitle:"登录你的账户"},{default:l(()=>[n(X,null,{default:l(()=>[n(Y,null,{default:l(()=>[n(p,{cols:"12"},{default:l(()=>[n(J,{modelValue:a.loginType,"onUpdate:modelValue":o[0]||(o[0]=r=>a.loginType=r),class:"mb-4"},{default:l(()=>[n(b,{value:"password",variant:"text"},{default:l(()=>o[5]||(o[5]=[h("密码登录")])),_:1,__:[5]}),n(b,{value:"code",variant:"text"},{default:l(()=>o[6]||(o[6]=[h("验证码登录")])),_:1,__:[6]}),n(b,{value:"magiclink",variant:"text"},{default:l(()=>o[7]||(o[7]=[h("魔术链接登录")])),_:1,__:[7]})]),_:1},8,["modelValue"]),n(T,{label:"邮箱",type:"text",modelValue:a.email,"onUpdate:modelValue":o[1]||(o[1]=r=>a.email=r),variant:"outlined",rules:a.emailRules},null,8,["modelValue","rules"]),a.loginType==="password"?(k(),G(T,{key:0,label:"密码",modelValue:a.password,"onUpdate:modelValue":o[2]||(o[2]=r=>a.password=r),variant:"outlined",rules:a.passwordRules,"append-icon":a.showPassword?"mdi-eye":"mdi-eye-off",type:a.showPassword?"text":"password","onClick:append":o[3]||(o[3]=r=>a.showPassword=!a.showPassword)},null,8,["modelValue","rules","append-icon","type"])):F("",!0),a.loginType==="code"?(k(),E(K,{key:1},[n(T,{modelValue:a.verificationCode,"onUpdate:modelValue":o[4]||(o[4]=r=>a.verificationCode=r),label:"验证码",variant:"outlined",maxlength:"6",rules:[a.rules.required,a.rules.length]},null,8,["modelValue","rules"]),n(_,{class:"mb-4",variant:"text",onClick:a.sendVerificationCode,disabled:a.countdown>0},{default:l(()=>[h(Z(a.countdown>0?`${a.countdown}秒后重新发送`:"发送验证码"),1)]),_:1},8,["onClick","disabled"])],64)):F("",!0)]),_:1}),n(p,{cols:"12"},{default:l(()=>[n(s,{ref:"recaptcha",recaptchaId:"recaptcha-div",showNormal:!0,onBindVerified:a.handleBindVerified,onBindError:a.handleBindError,onBindClose:a.handleBindClose},null,8,["onBindVerified","onBindError","onBindClose"])]),_:1}),n(p,{cols:"12"},{default:l(()=>[n(_,{class:"text-none",color:"primary",rounded:"xl",text:a.getLoginButtonText(),variant:"flat",size:"large",onClick:a.handleLoginAction,"append-icon":"mdi-arrow-right",loading:a.loading},null,8,["text","onClick","loading"])]),_:1}),n(p,{cols:"12"},{default:l(()=>[n(_,{class:"text-none",color:"white",rounded:"xl",text:"注册",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/register"}),n(_,{class:"text-none",color:"white",rounded:"xl",text:"找回密码",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/retrieve"})]),_:1}),n(p,{cols:"12"},{default:l(()=>[n(V,{mode:"login","divider-text":"或使用以下方式登录"})]),_:1})]),_:1})]),_:1})]),_:1}),n(f,{show:a.loading,text:"登录中"},null,8,["show"])])}const ve=Q(ne,[["render",le]]);export{ve as default};
