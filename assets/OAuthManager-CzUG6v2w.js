import{_ as ne,r as c,x as de,b as ie,ac as fe,c as U,o as v,e as a,N as t,a9 as $,f as d,O as g,L as s,a3 as D,Y as b,$ as I,Q as Y,F as R,U as Z,R as j,W as L,Z as q,X as n,S as N,a5 as Q,ad as me,ae as V,ag as k,af as x,aE as G,i as O,aA as H,C as _e,a1 as S,ab as J}from"./index-CqDYMkg5.js";import{_ as ve}from"./verifyEmail-D3Uc7CAN.js";import{o as P}from"./oauth_providers-BTwCArWd.js";import{V as K}from"./VSpacer-BmIOKXlY.js";const pe={class:"oauth-binding"},ce={class:"d-flex align-center mb-2"},ye={class:"text-h6"},ge={class:"text-caption"},Ve={class:"mt-2 text-caption"},ke={__name:"OAuthManager",setup(xe){const T=c([]),f=c(""),_=c("info"),B=c(!1),C=c(!1),z=c(""),o=c(null),W=c([]),h="https://zerocat-api.houlangs.com",w=c(!1),E=r=>{var u;const e=r.replace("oauth_","").toLowerCase();return((u=P[e])==null?void 0:u.icon)||P.default.icon},F=r=>{var u;const e=r.replace("oauth_","").toLowerCase();return((u=P[e])==null?void 0:u.name)||e.charAt(0).toUpperCase()+e.slice(1)},A=r=>{var e;return((e=P[r])==null?void 0:e.style)||P.default.style},M=r=>{const e=new Date(r);return new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e)},X=async()=>{var r,e;try{const u=await S.post("/account/oauth/bound",{userid:J.user.value.id});u.data.status==="success"?T.value=u.data.data:(f.value=u.data.message,_.value="error")}catch(u){f.value=((e=(r=u.response)==null?void 0:r.data)==null?void 0:e.message)||"获取绑定的 OAuth 账号失败",_.value="error"}},ee=async()=>{var r,e;try{const u=await S.get("/account/emails");if(u.data.status==="success"){const i=u.data.data.find(p=>p.is_primary);i&&(z.value=i.contact_value)}else f.value=u.data.message,_.value="error"}catch(u){f.value=((e=(r=u.response)==null?void 0:r.data)==null?void 0:e.message)||"获取邮箱列表失败",_.value="error"}},te=async()=>{var r,e;try{const u=await S.get("/account/oauth/providers");u.data.status==="success"?W.value=u.data.data:(f.value=u.data.message,_.value="error")}catch(u){f.value=((e=(r=u.response)==null?void 0:r.data)==null?void 0:e.message)||"获取可绑定的 OAuth 提供商失败",_.value="error"}},ae=r=>{o.value=r,w.value=!0},le=()=>{w.value=!1,C.value=!0},se=()=>{C.value=!1,B.value=!0},ue=async r=>{var e,u;try{const l=await S.post("/account/confirm-unlink-oauth",{email:z.value,code:r,provider:o.value.contact_type});l.data.status==="success"?(f.value="成功解绑 OAuth 账号",_.value="success",X()):(f.value=l.data.message||"解绑失败",_.value="error")}catch(l){f.value=((u=(e=l.response)==null?void 0:e.data)==null?void 0:u.message)||"解绑 OAuth 账号失败",_.value="error"}finally{o.value=null}},oe=r=>{window.location.href=`${h}/account/oauth/bind/${r}?token=${J.getToken()}`},re=de(()=>{const r=T.value.map(e=>e.contact_type.toLowerCase().replace("oauth_",""));return W.value.filter(e=>!r.includes(e.id.toLowerCase()))});return ie(()=>{X(),ee(),te()}),(r,e)=>{const u=fe("v-list-item-content");return v(),U("div",pe,[a(L,null,{default:t(()=>[a($,{class:"d-flex align-center"},{default:t(()=>[a(g,{class:"mr-2"},{default:t(()=>e[5]||(e[5]=[s("mdi-link-variant")])),_:1,__:[5]}),e[6]||(e[6]=d("h2",null,"已绑定的 OAuth 账号",-1))]),_:1,__:[6]}),a(D,null,{default:t(()=>[a(Y,null,{default:t(()=>[(v(!0),U(R,null,Z(T.value,(l,i)=>(v(),b(j,{key:i,cols:"12",sm:"6",md:"4"},{default:t(()=>[a(L,{elevation:"2",class:"oauth-account-card",onClick:p=>ae(l)},{default:t(()=>[a(D,null,{default:t(()=>[d("div",ce,[a(q,{color:A(l.contact_type.replace("oauth_","")).backgroundColor,size:"40",class:"mr-3"},{default:t(()=>[a(g,{color:A(l.contact_type.replace("oauth_","")).color},{default:t(()=>[s(n(E(l.contact_type)),1)]),_:2},1032,["color"])]),_:2},1032,["color"]),d("div",null,[d("div",ye,n(F(l.contact_type)),1),d("div",ge,"ID: "+n(l.contact_id),1)])]),a(N,{small:"",color:l.verified?"success":"warning",class:"mr-2"},{default:t(()=>[s(n(l.verified?"已验证":"未验证"),1)]),_:2},1032,["color"]),a(N,{small:"",color:l.is_primary?"primary":"grey",class:"mr-2"},{default:t(()=>[s(n(l.is_primary?"主账号":"关联账号"),1)]),_:2},1032,["color"]),d("div",Ve," 绑定时间: "+n(M(l.created_at)),1)]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1}),f.value?(v(),b(Q,{key:0,type:_.value,class:"mt-4"},{default:t(()=>[s(n(f.value),1)]),_:1},8,["type"])):I("",!0)]),_:1})]),_:1}),a(H,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=l=>w.value=l),"max-width":"500"},{default:t(()=>[a(L,null,{default:t(()=>[a($,{class:"headline d-flex align-center"},{default:t(()=>{var l,i;return[a(q,{color:A(((i=(l=o.value)==null?void 0:l.contact_type)==null?void 0:i.replace("oauth_",""))||"").backgroundColor,size:"40",class:"mr-3"},{default:t(()=>{var p,m;return[a(g,{color:A(((m=(p=o.value)==null?void 0:p.contact_type)==null?void 0:m.replace("oauth_",""))||"").color},{default:t(()=>{var y;return[s(n(E(((y=o.value)==null?void 0:y.contact_type)||"")),1)]}),_:1},8,["color"])]}),_:1},8,["color"]),s(" "+n(o.value?F(o.value.contact_type):"")+" 账号详情 ",1)]}),_:1}),a(D,null,{default:t(()=>[a(me,{dense:""},{default:t(()=>{var l,i,p;return[a(V,null,{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[7]||(e[7]=[s("绑定 ID")])),_:1,__:[7]}),a(x,null,{default:t(()=>{var m;return[s(n(((m=o.value)==null?void 0:m.contact_id)||"-"),1)]}),_:1})]),_:1})]),_:1}),(l=o.value)!=null&&l.metadata?(v(),b(V,{key:0},{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[8]||(e[8]=[s("平台用户 ID")])),_:1,__:[8]}),a(x,null,{default:t(()=>[s(n(o.value.metadata.id||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),(i=o.value)!=null&&i.metadata?(v(),b(V,{key:1},{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[9]||(e[9]=[s("用户名")])),_:1,__:[9]}),a(x,null,{default:t(()=>[s(n(o.value.metadata.name||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),(p=o.value)!=null&&p.metadata?(v(),b(V,{key:2},{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[10]||(e[10]=[s("邮箱")])),_:1,__:[10]}),a(x,null,{default:t(()=>[s(n(o.value.metadata.email||"-"),1)]),_:1})]),_:1})]),_:1})):I("",!0),a(V,null,{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[11]||(e[11]=[s("验证状态")])),_:1,__:[11]}),a(x,null,{default:t(()=>{var m;return[a(N,{small:"",color:(m=o.value)!=null&&m.verified?"success":"warning"},{default:t(()=>{var y;return[s(n((y=o.value)!=null&&y.verified?"已验证":"未验证"),1)]}),_:1},8,["color"])]}),_:1})]),_:1})]),_:1}),a(V,null,{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[12]||(e[12]=[s("账号类型")])),_:1,__:[12]}),a(x,null,{default:t(()=>{var m;return[a(N,{small:"",color:(m=o.value)!=null&&m.is_primary?"primary":"grey"},{default:t(()=>{var y;return[s(n((y=o.value)!=null&&y.is_primary?"主账号":"关联账号"),1)]}),_:1},8,["color"])]}),_:1})]),_:1})]),_:1}),a(V,null,{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[13]||(e[13]=[s("绑定时间")])),_:1,__:[13]}),a(x,null,{default:t(()=>[s(n(o.value?M(o.value.created_at):"-"),1)]),_:1})]),_:1})]),_:1}),a(V,null,{default:t(()=>[a(u,null,{default:t(()=>[a(k,{class:"text--primary mb-1"},{default:t(()=>e[14]||(e[14]=[s("最后更新")])),_:1,__:[14]}),a(x,null,{default:t(()=>[s(n(o.value?M(o.value.updated_at):"-"),1)]),_:1})]),_:1})]),_:1})]}),_:1})]),_:1}),a(G,null,{default:t(()=>[a(K),a(O,{text:"",onClick:e[0]||(e[0]=l=>w.value=!1)},{default:t(()=>e[15]||(e[15]=[s("关闭")])),_:1,__:[15]}),a(O,{color:"error",text:"",onClick:le,disabled:!o.value},{default:t(()=>[a(g,{left:""},{default:t(()=>e[16]||(e[16]=[s("mdi-link-variant-off")])),_:1,__:[16]}),e[17]||(e[17]=s(" 解除绑定 "))]),_:1,__:[17]},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(H,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=l=>C.value=l),"max-width":"500"},{default:t(()=>[a(L,null,{default:t(()=>[a($,{class:"headline"},{default:t(()=>[a(g,{left:"",color:"warning"},{default:t(()=>e[18]||(e[18]=[s("mdi-alert")])),_:1,__:[18]}),e[19]||(e[19]=s(" 确认解除绑定 "))]),_:1,__:[19]}),a(D,null,{default:t(()=>[e[27]||(e[27]=d("p",{class:"mb-2"},"您确定要解除以下 OAuth 账号的绑定吗？",-1)),a(Q,{type:"warning",text:"",dense:""},{default:t(()=>{var l,i;return[e[23]||(e[23]=d("strong",null,"提供商：",-1)),s(n(o.value?F(o.value.contact_type):""),1),e[24]||(e[24]=d("br",null,null,-1)),e[25]||(e[25]=d("strong",null,"绑定 ID：",-1)),s(n(((l=o.value)==null?void 0:l.contact_id)||"-"),1),e[26]||(e[26]=d("br",null,null,-1)),(i=o.value)!=null&&i.metadata?(v(),U(R,{key:0},[e[20]||(e[20]=d("strong",null,"用户名：",-1)),s(n(o.value.metadata.name||"-"),1),e[21]||(e[21]=d("br",null,null,-1)),e[22]||(e[22]=d("strong",null,"平台邮箱：",-1)),s(n(o.value.metadata.email||"-"),1)],64)):I("",!0)]}),_:1,__:[23,24,25,26]}),e[28]||(e[28]=d("p",{class:"mt-2 text-caption"},"解除绑定后，您需要重新进行身份验证才能重新绑定此账号。",-1))]),_:1,__:[27,28]}),a(G,null,{default:t(()=>[a(K),a(O,{text:"",onClick:e[2]||(e[2]=l=>C.value=!1)},{default:t(()=>e[29]||(e[29]=[s("取消")])),_:1,__:[29]}),a(O,{color:"error",onClick:se},{default:t(()=>[a(g,{left:""},{default:t(()=>e[30]||(e[30]=[s("mdi-link-variant-off")])),_:1,__:[30]}),e[31]||(e[31]=s(" 确认解除绑定 "))]),_:1,__:[31]})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ve,{modelValue:B.value,"onUpdate:modelValue":e[4]||(e[4]=l=>B.value=l),email:z.value,onVerified:ue},null,8,["modelValue","email"]),a(L,{class:"mt-4"},{default:t(()=>[a($,{class:"d-flex align-center"},{default:t(()=>[a(g,{class:"mr-2"},{default:t(()=>e[32]||(e[32]=[s("mdi-link-plus")])),_:1,__:[32]}),e[33]||(e[33]=d("h2",null,"可绑定的 OAuth 提供商",-1))]),_:1,__:[33]}),a(D,null,{default:t(()=>[a(Q,{type:"info",text:""},{default:t(()=>e[34]||(e[34]=[s(" 不论怎样，你都需要确保对绑定账户内邮箱完全的控制。 ")])),_:1,__:[34]}),a(Y,{class:"mt-2"},{default:t(()=>[(v(!0),U(R,null,Z(re.value,(l,i)=>(v(),b(j,{key:i,cols:"12",sm:"6",md:"4"},{default:t(()=>[a(O,{block:"",height:"50",style:_e(A(l.id)),onClick:p=>oe(l.id),class:"text-none"},{default:t(()=>[a(g,{left:""},{default:t(()=>[s(n(E(l.id)),1)]),_:2},1024),s(" 绑定 "+n(l.name),1)]),_:2},1032,["style","onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})])}}},De=ne(ke,[["__scopeId","data-v-aee03934"]]);export{De as _};
