import{_ as U,bm as j,bo as M,b as D,o as i,Y as p,N as e,e as a,R as w,S as q,Z as $,a_ as J,af as W,C as n,b0 as X,f,U as _,$ as Y,a5 as C,a9 as x,P as z,ai as Z,c as G,F as H,X as K,aj as O,ak as Q,al as ee,aC as ae,a0 as h,aJ as te,i as I,ab as le,aa as re,W as se,a6 as k,r as v,A as oe}from"./index-C30_-gqw.js";import"https://static.geetest.com/v4/gt4.js";const ie={class:"font-weight-bold"},ne={class:"d-flex align-center mb-4"},ue=["href"],ce={class:"text-body-1"},de={__name:"authorize",setup(me){const u=j(),S=M(),r=v(null),c=v(!1),s=v(null),d=v([]),m=v(null),y=u.query.client_id,g=u.query.redirect_uri,V=u.query.scope,b=u.query.state,A=u.query.code_challenge,L=u.query.code_challenge_method,B={"user:basic":{icon:"mdi-account",title:"查看您的基本信息",description:"包括您的用户名、显示名称和头像"},"user:email":{icon:"mdi-email",title:"查看您的邮箱地址",description:"访问您的主要邮箱地址"}},N=oe(()=>V?V.split(" ").map(l=>({name:l,...B[l]})):[]),R=()=>y?g?!0:(s.value="缺少必要的redirect_uri参数",!1):(s.value="缺少必要的client_id参数",!1),E=async()=>{if(R()){c.value=!0;try{const l=await k.get(`/oauth/applications/${y}`);r.value=l.data,r.value.redirect_uris.includes(g)||(s.value="无效的回调地址",r.value=null)}catch(l){s.value="无法加载应用信息",console.error("Failed to load application:",l)}c.value=!1}},F=async()=>{try{const l=await k.get("/oauth/user/emails");if(d.value=l.data.map(t=>({email:t.contact_value,primary:t.is_primary})),d.value.length>0){const t=d.value.find(o=>o.primary);m.value=t?t.email:d.value[0].email}}catch(l){console.error("Failed to load emails:",l)}},P=async()=>{if(!m.value){s.value="请选择要授权的邮箱";return}c.value=!0;try{const l=await k.post("/oauth/authorize/confirm",{client_id:y,redirect_uri:g,scope:V,state:b,authorized_email:m.value,code_challenge:A,code_challenge_method:L});l.data.redirect_url&&(window.location.href=l.data.redirect_url)}catch(l){s.value="授权失败，请重试",console.error("Authorization failed:",l)}c.value=!1},T=()=>{new URLSearchParams({error:"access_denied",error_description:"用户拒绝了应用程序的访问请求",state:b||""}),S.push({path:"/app/oauth/error",query:{error:"access_denied",error_description:"用户拒绝了应用程序的访问请求",state:b||""}})};return D(()=>{E(),F()}),(l,t)=>(i(),p(se,{class:"pa-4"},{default:e(()=>[a(w,{justify:"center"},{default:e(()=>[a(q,{cols:"12",lg:"6",md:"8",sm:"10"},{default:e(()=>[r.value?(i(),p($,{key:0,class:"mb-4"},{default:e(()=>[a(J,null,{prepend:e(()=>[a(Y,{image:r.value.logo_url||"/default-app-logo.png",class:"mr-4",size:"64"},null,8,["image"])]),default:e(()=>[a(W,{class:"text-h5"},{default:e(()=>[...t[1]||(t[1]=[n(" 授权请求 ",-1)])]),_:1}),a(X,null,{default:e(()=>[f("span",ie,_(r.value.name),1),t[2]||(t[2]=n(" 想要访问您的账号 ",-1))]),_:1})]),_:1}),a(C),a(x,{class:"pt-4"},{default:e(()=>[f("div",ne,[a(z,{class:"mr-2",icon:"mdi-web"}),f("a",{href:r.value.homepage_url,class:"text-decoration-none",target:"_blank"},_(r.value.homepage_url),9,ue)]),f("p",ce,_(r.value.description),1)]),_:1}),a(C),a(x,null,{default:e(()=>[t[3]||(t[3]=f("h3",{class:"text-h6 mb-4"},"此应用将获得以下权限：",-1)),a(Z,null,{default:e(()=>[(i(!0),G(H,null,K(N.value,o=>(i(),p(O,{key:o.name,class:"mb-2"},{prepend:e(()=>[a(z,{icon:o.icon,class:"mr-2",color:"primary"},null,8,["icon"])]),default:e(()=>[a(Q,{class:"font-weight-bold"},{default:e(()=>[n(_(o.title),1)]),_:2},1024),a(ee,null,{default:e(()=>[n(_(o.description),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),d.value.length>0?(i(),p(x,{key:0},{default:e(()=>[t[4]||(t[4]=f("h3",{class:"text-h6 mb-4"},"选择授权邮箱：",-1)),a(ae,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),items:d.value,class:"mb-4",density:"comfortable","item-title":"email","item-value":"email",label:"选择要授权的邮箱",variant:"outlined"},null,8,["modelValue","items"])]),_:1})):h("",!0),a(C),a(te,{class:"pa-4"},{default:e(()=>[a(I,{class:"mr-2",color:"error",variant:"outlined",onClick:T},{default:e(()=>[...t[5]||(t[5]=[n(" 取消 ",-1)])]),_:1}),a(I,{disabled:!m.value,loading:c.value,color:"primary",onClick:P},{default:e(()=>[...t[6]||(t[6]=[n(" 授权应用 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):h("",!0),s.value?(i(),p(le,{key:1,class:"mb-4",closable:"",type:"error",variant:"tonal"},{default:e(()=>[n(_(s.value),1)]),_:1})):h("",!0)]),_:1})]),_:1}),c.value&&!r.value?(i(),p(w,{key:0,justify:"center"},{default:e(()=>[a(q,{class:"text-center",cols:"12"},{default:e(()=>[a(re,{color:"primary",indeterminate:"",size:"64"})]),_:1})]),_:1})):h("",!0)]),_:1}))}},_e=U(de,[["__scopeId","data-v-689d34f2"]]);export{_e as default};
