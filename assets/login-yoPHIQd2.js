import{_ as U}from"./LoadingDialog-CG6K3oVf.js";import{_ as z}from"./AuthCard-m8_R_cpw.js";import{_ as D}from"./Recaptcha-Bgc5LvB2.js";import{_ as J,c as B,o as v,e as l,N as s,aF as K,Q as Z,R as p,Y as N,$ as W,ah as $,ai as b,L as g,aB as T,F,i as w,X as S,f as ee,U as ae,C as oe,bd as te,r as u,ab as ne,M as le,w as se}from"./index-CVzQ_EZ_.js";import{A as h}from"./authService-D--AZ0_c.js";import{o as ie}from"./oauth_providers-BTwCArWd.js";import"https://static.geetest.com/v4/gt4.js";const re={components:{LoadingDialog:U,Recaptcha:D,AuthCard:z},setup(){const x=te(),o=u(""),y=u(""),a=u(""),c=u("password"),m=u(0),i=u(!1),V=u(!1),f=u(null),n=u(!1),L={required:e=>!!e||"此字段为必填项",length:e=>(e==null?void 0:e.length)===6||"验证码必须是6位数字"},I=[e=>!!e||"必须填写邮箱",e=>/.+@.+\..+/.test(e)||"不符合格式"],M=[e=>!!e||"必须填写密码"];ne.isLogin.value===!0&&x.push("/app/dashboard"),le({title:"登录"});const O=Object.entries(ie).filter(([e])=>e!=="default").map(([e,t])=>({id:e,...t})),j=()=>c.value==="password"?"登录":c.value==="code"?a.value?"登录":"发送验证码":c.value==="magiclink"?n.value?"已发送，请检查邮箱":"发送登录链接":"登录",q=async()=>{switch(c.value){case"password":await R();break;case"code":a.value?await A():await C();break;case"magiclink":await P();break}},R=async()=>{var e;if(!o.value||!y.value){r("请输入邮箱和密码");return}i.value=!0;try{const t=((e=f.value)==null?void 0:e.getResponse())||null,d=await h.loginWithPassword(o.value,y.value,t);E(d)}catch(t){_(t)}finally{i.value=!1}},A=async()=>{if(!o.value||!a.value){r("请输入邮箱和验证码");return}i.value=!0;try{const e=await h.loginWithCode(o.value,a.value);E(e)}catch(e){_(e)}finally{i.value=!1}},C=async()=>{var e;if(!(m.value>0)){if(!o.value||!/.+@.+\..+/.test(o.value)){r("请输入正确的邮箱地址");return}i.value=!0;try{const t=((e=f.value)==null?void 0:e.getResponse())||null,d=await h.sendLoginCode(o.value,t);d.status==="success"?(k("验证码已发送"),Q()):r(d.message)}catch(t){_(t)}finally{i.value=!1}}},P=async()=>{var e;if(!n.value){if(!o.value||!/.+@.+\..+/.test(o.value)){r("请输入正确的邮箱地址");return}i.value=!0;try{const t=((e=f.value)==null?void 0:e.getResponse())||null;if(!t){r("请完成人机验证"),i.value=!1;return}const d=await h.generateMagicLink(o.value,window.location.origin+"/app/account/magiclink/validate",t);d.status==="success"?(k("登录链接已发送到您的邮箱"),n.value=!0):r(d.message)}catch(t){_(t)}finally{i.value=!1}}},H=e=>{window.location.href=h.oauthRedirect(e)},E=e=>{e.status==="success"?(k("登录成功，欢迎回来，"+e.display_name),setTimeout(()=>{x.push("/app/dashboard")},1e3)):r(e.message)},_=e=>{var t,d;r(((d=(t=e.response)==null?void 0:t.data)==null?void 0:d.message)||e.message)},k=e=>{var t;(t=this==null?void 0:this.$toast)==null||t.add({severity:"success",summary:"成功",detail:e,life:3e3})},r=e=>{var t;(t=this==null?void 0:this.$toast)==null||t.add({severity:"error",summary:"错误",detail:e,life:3e3})},Q=()=>{m.value=60;const e=setInterval(()=>{m.value--,m.value<=0&&clearInterval(e)},1e3)},X=e=>{c.value==="code"&&!a.value&&C()},Y=()=>{r("验证失败，请重试")},G=()=>{};return se(c,e=>{a.value="",n.value=!1,setTimeout(()=>{f.value&&f.value.resetCaptcha()},100)}),{email:o,password:y,verificationCode:a,loginType:c,countdown:m,loading:i,showPassword:V,rules:L,emailRules:I,passwordRules:M,recaptcha:f,magicLinkSent:n,getLoginButtonText:j,handleLoginAction:q,loginWithPassword:R,loginWithCode:A,sendVerificationCode:C,sendMagicLink:P,loginWithOAuth:H,handleBindVerified:X,handleBindError:Y,handleBindClose:G,providers:O}}},de={class:"d-flex flex-wrap gap-2 justify-start mt-4"};function ue(x,o,y,a,c,m){const i=D,V=z,f=U;return v(),B("div",null,[l(V,{subtitle:"登录你的账户"},{default:s(()=>[l(K,null,{default:s(()=>[l(Z,null,{default:s(()=>[l(p,{cols:"12"},{default:s(()=>[l($,{modelValue:a.loginType,"onUpdate:modelValue":o[0]||(o[0]=n=>a.loginType=n),class:"mb-4"},{default:s(()=>[l(b,{value:"password",variant:"text"},{default:s(()=>o[5]||(o[5]=[g("密码登录")])),_:1,__:[5]}),l(b,{value:"code",variant:"text"},{default:s(()=>o[6]||(o[6]=[g("验证码登录")])),_:1,__:[6]}),l(b,{value:"magiclink",variant:"text"},{default:s(()=>o[7]||(o[7]=[g("魔术链接登录")])),_:1,__:[7]})]),_:1},8,["modelValue"]),l(T,{label:"邮箱",type:"text",modelValue:a.email,"onUpdate:modelValue":o[1]||(o[1]=n=>a.email=n),variant:"outlined",rules:a.emailRules},null,8,["modelValue","rules"]),a.loginType==="password"?(v(),N(T,{key:0,label:"密码",modelValue:a.password,"onUpdate:modelValue":o[2]||(o[2]=n=>a.password=n),variant:"outlined",rules:a.passwordRules,"append-icon":a.showPassword?"mdi-eye":"mdi-eye-off",type:a.showPassword?"text":"password","onClick:append":o[3]||(o[3]=n=>a.showPassword=!a.showPassword)},null,8,["modelValue","rules","append-icon","type"])):W("",!0),a.loginType==="code"?(v(),B(F,{key:1},[l(T,{modelValue:a.verificationCode,"onUpdate:modelValue":o[4]||(o[4]=n=>a.verificationCode=n),label:"验证码",variant:"outlined",maxlength:"6",rules:[a.rules.required,a.rules.length]},null,8,["modelValue","rules"]),l(w,{class:"mb-4",variant:"text",onClick:a.sendVerificationCode,disabled:a.countdown>0},{default:s(()=>[g(S(a.countdown>0?`${a.countdown}秒后重新发送`:"发送验证码"),1)]),_:1},8,["onClick","disabled"])],64)):W("",!0)]),_:1}),l(p,{cols:"12"},{default:s(()=>[l(i,{ref:"recaptcha",recaptchaId:"recaptcha-div",showNormal:!0,onBindVerified:a.handleBindVerified,onBindError:a.handleBindError,onBindClose:a.handleBindClose},null,8,["onBindVerified","onBindError","onBindClose"])]),_:1}),l(p,{cols:"12"},{default:s(()=>[l(w,{class:"text-none",color:"primary",rounded:"xl",text:a.getLoginButtonText(),variant:"flat",size:"large",onClick:a.handleLoginAction,"append-icon":"mdi-arrow-right",loading:a.loading},null,8,["text","onClick","loading"])]),_:1}),l(p,{cols:"12"},{default:s(()=>[l(w,{class:"text-none",color:"white",rounded:"xl",text:"注册",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/register"}),l(w,{class:"text-none",color:"white",rounded:"xl",text:"找回密码",variant:"text",size:"large","append-icon":"mdi-arrow-right",to:"/app/account/retrieve"})]),_:1}),l(p,{cols:"12"},{default:s(()=>[ee("div",de,[(v(!0),B(F,null,ae(a.providers,n=>(v(),N(w,{class:"text-none mr-1 mb-1",key:n.id,onClick:L=>a.loginWithOAuth(n.id),style:oe(n.style),"prepend-icon":n.icon,variant:"flat"},{default:s(()=>[g(S(n.name),1)]),_:2},1032,["onClick","style","prepend-icon"]))),128))])]),_:1})]),_:1})]),_:1})]),_:1}),l(f,{show:a.loading,text:"登录中"},null,8,["show"])])}const he=J(re,[["render",ue]]);export{he as default};
