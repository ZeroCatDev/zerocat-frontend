import{_ as M,X as b,o as f,M as o,f as n,e as t,aV as T,Y as c,a_ as O,ae as _,L as a,b0 as A,O as p,Q as h,c as k,F as U,W as R,R as r,D as L,a8 as g,T as d,al as z,am as x,aK as B,$ as P,aC as v,aG as y,aJ as Y,N as j,i as F,aW as N,S as D,Z as q,n as H,aY as W,m as G,U as J,a5 as S}from"./index-CoinsG4v.js";import{d as w,r as K}from"./zh-cn-B7cKHLiE.js";import{d as Q}from"./debounce-BMmXVQ06.js";import{V as X,a as I}from"./VRadioGroup-DlFnFLJd.js";import{V as E}from"./VTextarea-CFfjX5wL.js";import{V as Z}from"./VCombobox-ncQHD134.js";import{V as C}from"./VSwitch-BzOs5Pil.js";import{V as $}from"./VDataTableServer-BlfexYaV.js";import"https://static.geetest.com/v4/gt4.js";import"./_commonjsHelpers-BosuxZz1.js";import"./filter-RK4bGFdn.js";import"./VDataTable-DdoL51RU.js";import"./VTable-D6lPv54T.js";w.extend(K);w.locale("zh-cn");const ee={name:"NotificationsAdmin",data(){return{activeTab:"send",notificationStats:[{title:"总通知数",value:0,type:"total",icon:"mdi-bell"},{title:"未读通知",value:0,type:"unread",icon:"mdi-bell-alert"},{title:"今日发送",value:0,type:"today",icon:"mdi-clock"},{title:"本周发送",value:0,type:"week",icon:"mdi-calendar-week"}],detailedStats:{},sendMode:"single",sendFormValid:!1,sending:!1,singleRecipient:"",batchRecipients:"",notificationForm:{recipient_type:"user_id",title:"",content:"",link:"",push_channels:["browser"],hidden:!1,high_priority:!1,notification_type:"admin_notification",target_type:"",target_id:"",metadata:{}},recipientTypes:[{title:"用户ID",value:"user_id"},{title:"用户名",value:"username"},{title:"邮箱",value:"email"}],pushChannels:[{title:"浏览器通知",value:"browser"},{title:"邮件通知",value:"email"}],targetTypes:[{title:"项目",value:"project"},{title:"用户",value:"user"},{title:"系统",value:"system"}],notificationTypes:[{title:"管理员通知",value:"admin_notification"},{title:"系统公告",value:"system_announcement"},{title:"用户互动",value:"user_interaction"},{title:"功能公告",value:"feature_announcement"},{title:"安全提醒",value:"security_alert"},{title:"维护通知",value:"maintenance_notice"}],notifications:[],notificationTotal:0,loadingNotifications:!1,refreshingNotifications:!1,notificationOptions:{page:1,itemsPerPage:10,sortBy:["created_at"],sortDesc:[!0]},notificationHeaders:[{title:"ID",value:"id",width:"80px",sortable:!1},{title:"通知内容",value:"content",sortable:!1},{title:"接收用户",value:"user",width:"150px",sortable:!1},{title:"类型",value:"notification_type",width:"120px",sortable:!1},{title:"状态",value:"read",width:"100px",sortable:!1},{title:"创建时间",value:"created_at",width:"180px",sortable:!1}],listFilters:{search:"",notification_type:"",unread_only:!1},snackbar:{show:!1,text:"",color:"success",timeout:3e3}}},methods:{async sendNotification(){var s,e;if(this.$refs.sendForm.validate()){this.sending=!0;try{const u={...this.notificationForm};this.sendMode==="single"?u.recipients=this.singleRecipient:u.recipients=this.batchRecipients.split(",").map(l=>l.trim()).filter(l=>l),u.target_type||(delete u.target_type,delete u.target_id),u.link||delete u.link;const{data:V}=await S.post("/admin/notifications/send",u);V.success?(this.showSuccess(V.message),this.showSendResults(V.result)):this.showError(V.message||"发送通知失败"),this.resetForm(),this.loadStats()}catch(u){this.showError(((e=(s=u.response)==null?void 0:s.data)==null?void 0:e.message)||"发送通知失败"),console.error("Error sending notification:",u)}finally{this.sending=!1}}},showSendResults(s){if(s.failed&&s.failed.length>0){const e=s.errors.map(u=>`${u.original_recipient}: ${u.error}`).join(`
`);this.showError(`部分发送失败:
${e}`)}},resetForm(){var s;this.notificationForm={recipient_type:"user_id",title:"",content:"",link:"",push_channels:["browser"],hidden:!1,high_priority:!1,notification_type:"admin_notification",target_type:"",target_id:"",metadata:{}},this.singleRecipient="",this.batchRecipients="",(s=this.$refs.sendForm)==null||s.resetValidation()},getRecipientLabel(){return{user_id:"接收用户ID",username:"接收用户名",email:"接收邮箱"}[this.notificationForm.recipient_type]||"接收者"},getRecipientPlaceholder(){return{user_id:"输入用户ID，如：123",username:"输入用户名，如：john_doe",email:"输入邮箱，如：user@example.com"}[this.notificationForm.recipient_type]||"输入接收者"},async loadStats(){try{const{data:s}=await S.get("/admin/notifications/stats");this.detailedStats=s.stats,this.notificationStats[0].value=s.stats.total||0,this.notificationStats[1].value=s.stats.unread||0,this.notificationStats[2].value=s.stats.today||0,this.notificationStats[3].value=s.stats.week||0}catch(s){console.error("Error loading stats:",s)}},async loadNotifications(){this.loadingNotifications=!0;try{const s={limit:this.notificationOptions.itemsPerPage,offset:(this.notificationOptions.page-1)*this.notificationOptions.itemsPerPage};this.listFilters.search&&(s.user_id=this.listFilters.search),this.listFilters.notification_type&&(s.notification_type=this.listFilters.notification_type),this.listFilters.unread_only&&(s.unread_only=!0);const{data:e}=await S.get("/admin/notifications/list",{params:s});this.notifications=e.notifications,this.notificationTotal=e.total}catch(s){this.showError("加载通知列表失败"),console.error("Error loading notifications:",s)}finally{this.loadingNotifications=!1}},async refreshNotifications(){if(!(this.refreshingNotifications||this.loadingNotifications)){this.refreshingNotifications=!0;try{await this.loadNotifications(),this.showSuccess("通知列表已更新")}catch{this.showError("刷新失败")}finally{this.refreshingNotifications=!1}}},getAvatarUrl(s){return s?s.startsWith("http")?s:`/api/avatar/${s}`:"/default-avatar.png"},getTypeText(s){const e=this.notificationTypes.find(u=>u.value===s);return e?e.title:s},getTypeColor(s){return{admin_notification:"indigo",system_announcement:"blue",user_interaction:"green",feature_announcement:"purple",security_alert:"red",maintenance_notice:"orange"}[s]||"grey"},formatDate(s){return w(s).format("YYYY-MM-DD HH:mm:ss")},formatTimeAgo(s){return w(s).fromNow()},truncateText(s,e){return s?s.length>e?s.substring(0,e)+"...":s:""},showSuccess(s){this.snackbar={show:!0,text:s,color:"success",timeout:3e3}},showError(s){this.snackbar={show:!0,text:s,color:"error",timeout:5e3}},debouncedLoadNotifications:Q(function(){this.loadNotifications()},300)},mounted(){this.loadStats(),this.loadNotifications()}},te={class:"notifications-admin"},ie={class:"text-overline mb-2"},le={class:"text-h4"},oe={class:"notification-content"},se={class:"font-weight-medium"},ne={class:"text-caption text--secondary"},ae={class:"d-flex align-center"},re={class:"text-caption text--secondary"},de={class:"stat-item"},ue={class:"stat-item"},me={class:"stat-item"},fe={class:"stat-item"};function ce(s,e,u,V,l,m){return f(),b(J,null,{default:o(()=>[n("div",te,[t(c,{class:"mb-6",elevation:"2"},{default:o(()=>[t(O,null,{prepend:o(()=>[t(p,{class:"me-4",color:"primary",icon:"mdi-bell-ring",size:"large"})]),default:o(()=>[t(_,{class:"text-h5"},{default:o(()=>e[22]||(e[22]=[a("通知管理",-1)])),_:1,__:[22]}),t(A,{class:"mt-2"},{default:o(()=>e[23]||(e[23]=[a("系统通知发送和管理",-1)])),_:1,__:[23]})]),_:1})]),_:1}),t(h,{class:"mb-4"},{default:o(()=>[(f(!0),k(U,null,R(l.notificationStats,i=>(f(),b(r,{key:i.title,cols:"12",md:"3",sm:"6"},{default:o(()=>[t(c,{class:L(["stat-card",`stat-${i.type}`]),elevation:"2"},{default:o(()=>[t(g,null,{default:o(()=>[n("div",ie,d(i.title),1),n("div",le,d(i.value),1),t(p,{class:"stat-icon",large:""},{default:o(()=>[a(d(i.icon),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}),t(z,{modelValue:l.activeTab,"onUpdate:modelValue":e[0]||(e[0]=i=>l.activeTab=i),class:"mb-4"},{default:o(()=>[t(x,{value:"send"},{default:o(()=>e[24]||(e[24]=[a("发送通知",-1)])),_:1,__:[24]}),t(x,{value:"list"},{default:o(()=>e[25]||(e[25]=[a("通知列表",-1)])),_:1,__:[25]}),t(x,{value:"stats"},{default:o(()=>e[26]||(e[26]=[a("统计信息",-1)])),_:1,__:[26]})]),_:1},8,["modelValue"]),T(t(c,null,{default:o(()=>[t(_,null,{default:o(()=>[t(p,{class:"mr-2"},{default:o(()=>e[27]||(e[27]=[a("mdi-send",-1)])),_:1,__:[27]}),e[28]||(e[28]=a(" 发送通知 ",-1))]),_:1,__:[28]}),t(g,null,{default:o(()=>[t(B,{ref:"sendForm",modelValue:l.sendFormValid,"onUpdate:modelValue":e[14]||(e[14]=i=>l.sendFormValid=i)},{default:o(()=>[t(h,null,{default:o(()=>[t(r,{cols:"12",md:"6"},{default:o(()=>[t(v,{modelValue:l.notificationForm.recipient_type,"onUpdate:modelValue":e[1]||(e[1]=i=>l.notificationForm.recipient_type=i),items:l.recipientTypes,label:"接收者类型",required:""},null,8,["modelValue","items"])]),_:1}),t(r,{cols:"12",md:"6"},{default:o(()=>[t(X,{modelValue:l.sendMode,"onUpdate:modelValue":e[2]||(e[2]=i=>l.sendMode=i),row:""},{default:o(()=>[t(I,{label:"单个",value:"single"}),t(I,{label:"批量",value:"batch"})]),_:1},8,["modelValue"])]),_:1}),l.sendMode==="single"?(f(),b(r,{key:0,cols:"12"},{default:o(()=>[t(y,{modelValue:l.singleRecipient,"onUpdate:modelValue":e[3]||(e[3]=i=>l.singleRecipient=i),rules:[i=>!!i||"请输入接收者"],label:m.getRecipientLabel(),placeholder:m.getRecipientPlaceholder(),required:""},null,8,["modelValue","rules","label","placeholder"])]),_:1})):P("",!0),l.sendMode==="batch"?(f(),b(r,{key:1,cols:"12"},{default:o(()=>[t(E,{modelValue:l.batchRecipients,"onUpdate:modelValue":e[4]||(e[4]=i=>l.batchRecipients=i),rules:[i=>!!i||"请输入接收者"],label:`批量${m.getRecipientLabel()}（多个用逗号分隔）`,placeholder:`输入多个${m.getRecipientPlaceholder()}，用逗号分隔`,required:"",rows:"3"},null,8,["modelValue","rules","label","placeholder"])]),_:1})):P("",!0),t(r,{cols:"12"},{default:o(()=>[t(y,{modelValue:l.notificationForm.title,"onUpdate:modelValue":e[5]||(e[5]=i=>l.notificationForm.title=i),rules:[i=>!!i||"请输入通知标题"],label:"通知标题",required:""},null,8,["modelValue","rules"])]),_:1}),t(r,{cols:"12"},{default:o(()=>[t(E,{modelValue:l.notificationForm.content,"onUpdate:modelValue":e[6]||(e[6]=i=>l.notificationForm.content=i),rules:[i=>!!i||"请输入通知内容"],label:"通知内容",required:"",rows:"4"},null,8,["modelValue","rules"])]),_:1}),t(r,{cols:"12"},{default:o(()=>[t(Z,{modelValue:l.notificationForm.push_channels,"onUpdate:modelValue":e[7]||(e[7]=i=>l.notificationForm.push_channels=i),chips:"",multiple:"",label:"推送渠道",items:["browser","email"]},null,8,["modelValue"])]),_:1}),t(r,{cols:"12",md:"4"},{default:o(()=>[t(v,{modelValue:l.notificationForm.notification_type,"onUpdate:modelValue":e[8]||(e[8]=i=>l.notificationForm.notification_type=i),items:l.notificationTypes,label:"通知类型"},null,8,["modelValue","items"])]),_:1}),t(r,{cols:"12",md:"4"},{default:o(()=>[t(C,{modelValue:l.notificationForm.high_priority,"onUpdate:modelValue":e[9]||(e[9]=i=>l.notificationForm.high_priority=i),color:"orange",label:"高优先级通知"},null,8,["modelValue"])]),_:1}),t(r,{cols:"12",md:"4"},{default:o(()=>[t(C,{modelValue:l.notificationForm.hidden,"onUpdate:modelValue":e[10]||(e[10]=i=>l.notificationForm.hidden=i),color:"info",label:"隐藏通知"},null,8,["modelValue"])]),_:1}),t(r,{cols:"12",md:"6"},{default:o(()=>[t(y,{modelValue:l.notificationForm.link,"onUpdate:modelValue":e[11]||(e[11]=i=>l.notificationForm.link=i),label:"可点击链接（可选）",placeholder:"https://example.com"},null,8,["modelValue"])]),_:1}),t(r,{cols:"12",md:"3"},{default:o(()=>[t(v,{modelValue:l.notificationForm.target_type,"onUpdate:modelValue":e[12]||(e[12]=i=>l.notificationForm.target_type=i),items:l.targetTypes,label:"目标类型（可选）",clearable:""},null,8,["modelValue","items"])]),_:1}),t(r,{cols:"12",md:"3"},{default:o(()=>[t(y,{modelValue:l.notificationForm.target_id,"onUpdate:modelValue":e[13]||(e[13]=i=>l.notificationForm.target_id=i),disabled:!l.notificationForm.target_type,label:"目标ID（可选）",type:"number"},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(Y,null,{default:o(()=>[t(j),t(F,{onClick:m.resetForm},{default:o(()=>e[29]||(e[29]=[a("重置",-1)])),_:1,__:[29]},8,["onClick"]),t(F,{disabled:!l.sendFormValid,loading:l.sending,color:"primary",onClick:m.sendNotification},{default:o(()=>[t(p,{left:""},{default:o(()=>e[30]||(e[30]=[a("mdi-send",-1)])),_:1,__:[30]}),a(" "+d(l.sendMode==="single"?"发送通知":"批量发送"),1)]),_:1},8,["disabled","loading","onClick"])]),_:1})]),_:1},512),[[N,l.activeTab==="send"]]),T(t(c,null,{default:o(()=>[t(_,null,{default:o(()=>[t(p,{class:"mr-2"},{default:o(()=>e[31]||(e[31]=[a("mdi-format-list-bulleted",-1)])),_:1,__:[31]}),e[32]||(e[32]=a(" 通知列表 ",-1))]),_:1,__:[32]}),t(g,null,{default:o(()=>[t(h,{class:"mb-4"},{default:o(()=>[t(r,{cols:"12",sm:"4"},{default:o(()=>[t(y,{modelValue:l.listFilters.search,"onUpdate:modelValue":e[15]||(e[15]=i=>l.listFilters.search=i),clearable:"","hide-details":"",label:"搜索通知","prepend-icon":"mdi-magnify",onInput:m.debouncedLoadNotifications},null,8,["modelValue","onInput"])]),_:1}),t(r,{cols:"12",sm:"3"},{default:o(()=>[t(v,{modelValue:l.listFilters.notification_type,"onUpdate:modelValue":e[16]||(e[16]=i=>l.listFilters.notification_type=i),items:l.notificationTypes,clearable:"","hide-details":"",label:"通知类型",onChange:m.loadNotifications},null,8,["modelValue","items","onChange"])]),_:1}),t(r,{cols:"12",sm:"3"},{default:o(()=>[t(C,{modelValue:l.listFilters.unread_only,"onUpdate:modelValue":e[17]||(e[17]=i=>l.listFilters.unread_only=i),"hide-details":"",label:"仅显示未读",onChange:m.loadNotifications},null,8,["modelValue","onChange"])]),_:1}),t(r,{class:"d-flex justify-end",cols:"12",sm:"2"},{default:o(()=>[t(F,{disabled:l.loadingNotifications,loading:l.refreshingNotifications,color:"primary",onClick:m.refreshNotifications},{default:o(()=>[t(p,null,{default:o(()=>e[33]||(e[33]=[a("mdi-refresh",-1)])),_:1,__:[33]}),e[34]||(e[34]=a(" 刷新 ",-1))]),_:1,__:[34]},8,["disabled","loading","onClick"])]),_:1})]),_:1}),t($,{"items-per-page":l.notificationOptions.itemsPerPage,"onUpdate:itemsPerPage":e[18]||(e[18]=i=>l.notificationOptions.itemsPerPage=i),page:l.notificationOptions.page,"onUpdate:page":e[19]||(e[19]=i=>l.notificationOptions.page=i),headers:l.notificationHeaders,items:l.notifications,"items-length":l.notificationTotal,loading:l.loadingNotifications,"loading-text":"加载中...","no-data-text":"暂无通知","onUpdate:options":m.loadNotifications},{"item.content":o(({item:i})=>[n("div",oe,[n("div",se,d(i.title),1),n("div",ne,d(m.truncateText(i.content,50)),1)])]),"item.user":o(({item:i})=>[n("div",ae,[t(q,{class:"mr-2",size:"24"},{default:o(()=>[t(H,{src:m.getAvatarUrl(i.user_avatar)},null,8,["src"])]),_:2},1024),n("span",null,d(i.username),1)])]),"item.notification_type":o(({item:i})=>[t(D,{color:m.getTypeColor(i.notification_type),size:"small"},{default:o(()=>[a(d(m.getTypeText(i.notification_type)),1)]),_:2},1032,["color"])]),"item.read":o(({item:i})=>[t(D,{color:i.read?"success":"warning",size:"small"},{default:o(()=>[a(d(i.read?"已读":"未读"),1)]),_:2},1032,["color"])]),"item.created_at":o(({item:i})=>[n("div",null,d(m.formatDate(i.created_at)),1),n("div",re,d(m.formatTimeAgo(i.created_at)),1)]),_:1},8,["items-per-page","page","headers","items","items-length","loading","onUpdate:options"])]),_:1})]),_:1},512),[[N,l.activeTab==="list"]]),T(t(c,null,{default:o(()=>[t(_,null,{default:o(()=>[t(p,{class:"mr-2"},{default:o(()=>e[35]||(e[35]=[a("mdi-chart-bar",-1)])),_:1,__:[35]}),e[36]||(e[36]=a(" 统计信息 ",-1))]),_:1,__:[36]}),t(g,null,{default:o(()=>[t(h,null,{default:o(()=>[t(r,{cols:"12",md:"6"},{default:o(()=>[t(c,{outlined:""},{default:o(()=>[t(_,{class:"text-h6"},{default:o(()=>e[37]||(e[37]=[a("基础统计",-1)])),_:1,__:[37]}),t(g,null,{default:o(()=>[n("div",de,[e[38]||(e[38]=n("span",null,"总通知数：",-1)),n("strong",null,d(l.detailedStats.total||0),1)]),n("div",ue,[e[39]||(e[39]=n("span",null,"未读通知数：",-1)),n("strong",null,d(l.detailedStats.unread||0),1)]),n("div",me,[e[40]||(e[40]=n("span",null,"今日通知：",-1)),n("strong",null,d(l.detailedStats.today||0),1)]),n("div",fe,[e[41]||(e[41]=n("span",null,"本周通知：",-1)),n("strong",null,d(l.detailedStats.week||0),1)])]),_:1})]),_:1})]),_:1}),t(r,{cols:"12",md:"6"},{default:o(()=>[t(c,{outlined:""},{default:o(()=>[t(_,{class:"text-h6"},{default:o(()=>e[42]||(e[42]=[a("通知类型分布",-1)])),_:1,__:[42]}),t(g,null,{default:o(()=>[(f(!0),k(U,null,R(l.detailedStats.byType,i=>(f(),k("div",{class:"stat-item",key:i.type},[n("span",null,d(i.type)+"：",1),n("strong",null,d(i.count||0),1)]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},512),[[N,l.activeTab==="stats"]]),t(W,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[21]||(e[21]=i=>l.snackbar.show=i),color:l.snackbar.color,timeout:l.snackbar.timeout,top:""},{action:o(({attrs:i})=>[t(F,G({text:""},i,{onClick:e[20]||(e[20]=pe=>l.snackbar.show=!1)}),{default:o(()=>e[43]||(e[43]=[a(" 关闭 ",-1)])),_:2,__:[43]},1040)]),default:o(()=>[a(d(l.snackbar.text)+" ",1)]),_:1},8,["modelValue","color","timeout"])])]),_:1})}const Se=M(ee,[["render",ce],["__scopeId","data-v-8877656d"]]);export{Se as default};
