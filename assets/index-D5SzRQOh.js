import{_ as E}from"./ProjectSelector-B9Wxmg62.js";import{_ as S,a1 as C,Y as y,o as p,N as s,e as t,W as g,a9 as h,L as r,O as m,a3 as _,aE as L,aD as F,i as w,X as u,az as j,f as d,j as z,Q as b,R as V,c as k,F as v,U as M,aT as A,aV as U,S as T,$ as B,aS as N,T as R,aa as P,a$ as H,M as O}from"./index-ChEdcxRM.js";import{V as Q}from"./VCheckbox-Dq0H2tLz.js";import{V as I}from"./VSpacer-BWaOZO4t.js";import{V as W}from"./VSkeletonLoader-Bjz0gnZt.js";import"./VSelect-BfDLNQp2.js";import"./VCheckboxBtn-K5rTH3v3.js";import"./VSelectionControl-Cd3p_wbm.js";import"https://static.geetest.com/v4/gt4.js";const X={name:"ExtensionCreateDialog",components:{ProjectSelector:E},props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","created"],data(){return{formValid:!1,loading:!1,selectedProjectIds:[],scratchCompatible:!1,createProgress:{current:0,total:0,isVisible:!1}}},computed:{dialog:{get(){return this.modelValue},set(o){this.$emit("update:modelValue",o)}}},watch:{modelValue(o){o&&this.resetForm()}},methods:{async createExtensions(){if(!(!this.selectedProjectIds||this.selectedProjectIds.length===0)){this.loading=!0,this.createProgress={current:0,total:this.selectedProjectIds.length,isVisible:!0};try{let o=0,e=0;for(let i=0;i<this.selectedProjectIds.length;i++){const c=this.selectedProjectIds[i];this.createProgress.current=i+1;try{const l={projectid:c,scratchCompatible:this.scratchCompatible},n=await C.post("/extensions/manager/create",l);n.data.status==="success"?o++:(e++,console.error(`Failed to create extension for project ${c}:`,n.data))}catch(l){e++,console.error(`Failed to create extension for project ${c}:`,l)}}o>0?(this.$emit("created"),this.closeDialog(),e>0?this.showMessage(`成功创建 ${o} 个扩展，${e} 个失败`,"warning"):this.showMessage(`成功创建 ${o} 个扩展`,"success")):this.showMessage("所有扩展创建失败","error")}catch(o){console.error("Failed to create extensions:",o),this.showMessage("创建扩展失败","error")}finally{this.loading=!1,this.createProgress.isVisible=!1}}},resetForm(){this.selectedProjectIds=[],this.scratchCompatible=!1},closeDialog(){this.dialog=!1},showMessage(o,e){console.log(o)}}},Y={class:"text-center mt-3"},Z={class:"text-body-2"},q={class:"text-caption text-grey"};function G(o,e,i,c,l,n){const f=E;return p(),y(j,{modelValue:n.dialog,"onUpdate:modelValue":e[4]||(e[4]=a=>n.dialog=a),"max-width":"800",persistent:""},{default:s(()=>[t(g,null,{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>e[5]||(e[5]=[r("mdi-plus",-1)])),_:1,__:[5]}),e[6]||(e[6]=r(" 创建扩展 ",-1))]),_:1,__:[6]}),t(_,null,{default:s(()=>[t(L,{ref:"form",modelValue:l.formValid,"onUpdate:modelValue":e[2]||(e[2]=a=>l.formValid=a)},{default:s(()=>[t(g,{variant:"tonal",border:"",hover:"",class:"mb-4"},{default:s(()=>[t(h,{class:"text-subtitle-1"},{default:s(()=>e[7]||(e[7]=[r("选择项目",-1)])),_:1,__:[7]}),t(_,null,{default:s(()=>[t(f,{modelValue:l.selectedProjectIds,"onUpdate:modelValue":e[0]||(e[0]=a=>l.selectedProjectIds=a),multiple:!0,author:"me"},null,8,["modelValue"])]),_:1})]),_:1}),t(g,{variant:"tonal",border:"",class:"mb-4"},{default:s(()=>[t(h,{class:"text-subtitle-1"},{default:s(()=>e[8]||(e[8]=[r("批量设置",-1)])),_:1,__:[8]}),t(_,null,{default:s(()=>[t(Q,{modelValue:l.scratchCompatible,"onUpdate:modelValue":e[1]||(e[1]=a=>l.scratchCompatible=a),label:"兼容 Scratch","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(F,null,{default:s(()=>[t(I),t(w,{onClick:n.closeDialog},{default:s(()=>e[9]||(e[9]=[r("取消",-1)])),_:1,__:[9]},8,["onClick"]),t(w,{color:"primary",loading:l.loading,disabled:!l.selectedProjectIds||l.selectedProjectIds.length===0,onClick:n.createExtensions},{default:s(()=>[r(" 创建扩展 ("+u(l.selectedProjectIds?l.selectedProjectIds.length:0)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1}),t(j,{modelValue:l.createProgress.isVisible,"onUpdate:modelValue":e[3]||(e[3]=a=>l.createProgress.isVisible=a),persistent:"","max-width":"400"},{default:s(()=>[t(g,null,{default:s(()=>[t(h,{class:"text-center"},{default:s(()=>e[10]||(e[10]=[r(" 正在创建扩展... ",-1)])),_:1,__:[10]}),t(_,null,{default:s(()=>[t(z,{"model-value":l.createProgress.current/l.createProgress.total*100,color:"primary",height:"8",rounded:""},null,8,["model-value"]),d("div",Y,[d("p",Z,u(l.createProgress.current)+" / "+u(l.createProgress.total),1),d("p",q," 正在处理第 "+u(l.createProgress.current)+" 个项目... ",1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])}const D=S(X,[["render",G]]),J={name:"ExtensionsManagement",components:{ExtensionCreateDialog:D},setup(){O({title:"扩展管理 - ZeroCat"})},data(){return{loading:!1,extensions:[],myProjects:[],s3BucketUrl:"",showCreateDialog:!1,showEditDialog:!1,editFormValid:!1,editLoading:!1,editTarget:null,editForm:{branch:"",commit:"",image:"",samples:null,docs:""},showDeleteDialog:!1,deleteLoading:!1,deleteTarget:null,pushAllLoading:!1,updateAllLoading:!1,snackbar:{show:!1,message:"",color:"success"}}},async created(){if(P.isLogin.value===!1){this.$router.push("/app/account/login");return}this.s3BucketUrl=H("s3.staticurl"),await Promise.all([this.fetchExtensions(),this.fetchMyProjects()])},methods:{async fetchExtensions(){this.loading=!0;try{const o=await C.get("/extensions/manager/my");o.data.status==="success"&&(this.extensions=o.data.data)}catch(o){console.error("Failed to fetch extensions:",o),this.showMessage("扩展管理失败","error")}finally{this.loading=!1}},async fetchMyProjects(){try{console.log(P.user);const o=await C.get("/searchapi",{params:{search_userid:P.user.value.id,search_state:"public",limit:100}});o.data&&o.data.projects&&(this.myProjects=o.data.projects)}catch(o){console.error("Failed to fetch my projects:",o)}},getStatusColor(o){return{developing:"primary",pending:"warning",verified:"success",rejected:"error"}[o]||"grey"},getStatusText(o){return{developing:"开发中",pending:"待审核",verified:"已审核",rejected:"已拒绝"}[o]||"未知"},showMessage(o,e="success"){this.snackbar={show:!0,message:o,color:e}},async pushAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可推送的扩展","warning");return}this.pushAllLoading=!0;try{const o=this.extensions.map(l=>C.post(`/extensions/manager/submit/${l.id}`)),i=(await Promise.allSettled(o)).filter(l=>{var n,f;return l.status==="fulfilled"&&((f=(n=l.value)==null?void 0:n.data)==null?void 0:f.status)==="success"}).length,c=this.extensions.length-i;c===0?this.showMessage(`成功推送 ${i} 个扩展`,"success"):this.showMessage(`推送完成: ${i} 个成功, ${c} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to push all extensions:",o),this.showMessage("批量推送失败","error")}finally{this.pushAllLoading=!1}},async updateAllExtensions(){if(this.extensions.length===0){this.showMessage("没有可更新的扩展","warning");return}this.updateAllLoading=!0;try{const o=this.extensions.map(l=>C.post(`/extensions/manager/update/${l.id}`)),i=(await Promise.allSettled(o)).filter(l=>{var n,f;return l.status==="fulfilled"&&((f=(n=l.value)==null?void 0:n.data)==null?void 0:f.status)==="success"}).length,c=this.extensions.length-i;c===0?this.showMessage(`成功更新 ${i} 个扩展`,"success"):this.showMessage(`更新完成: ${i} 个成功, ${c} 个失败`,"warning"),await this.fetchExtensions()}catch(o){console.error("Failed to update all extensions:",o),this.showMessage("批量更新失败","error")}finally{this.updateAllLoading=!1}}}},K={class:"d-flex align-center mb-2"},$={class:"text-caption"},ee={class:"d-flex align-center mb-2"},se={class:"text-caption"},te={key:0,class:"d-flex align-center mb-2"},le={class:"text-caption"},oe={class:"d-flex align-center mb-2"},ae={class:"text-caption"};function re(o,e,i,c,l,n){const f=D;return p(),y(R,null,{default:s(()=>[t(b,null,{default:s(()=>[t(V,{cols:"12"},{default:s(()=>[t(g,{variant:"flat"},{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>e[3]||(e[3]=[r("mdi-puzzle",-1)])),_:1,__:[3]}),e[5]||(e[5]=r(" 扩展管理 ",-1)),t(I),t(w,{color:"success","prepend-icon":"mdi-plus",onClick:e[0]||(e[0]=a=>l.showCreateDialog=!0)},{default:s(()=>e[4]||(e[4]=[r(" 创建扩展 ",-1)])),_:1,__:[4]})]),_:1,__:[5]}),t(_,null,{default:s(()=>[l.loading?(p(),y(b,{key:0},{default:s(()=>[(p(),k(v,null,M(6,a=>t(V,{key:a,cols:"12",md:"6",lg:"4"},{default:s(()=>[t(W,{type:"card"})]),_:2},1024)),64))]),_:1})):l.extensions.length===0?(p(),y(b,{key:1},{default:s(()=>[t(V,{cols:"12",class:"text-center py-8"},{default:s(()=>[t(m,{size:"64",color:"grey-lighten-1"},{default:s(()=>e[6]||(e[6]=[r("mdi-puzzle-outline",-1)])),_:1,__:[6]}),e[7]||(e[7]=d("p",{class:"text-h6 mt-4 text-grey-darken-1"},"扩展管理",-1)),e[8]||(e[8]=d("p",{class:"text-body-2 text-grey"},"扩展管理",-1))]),_:1,__:[7,8]})]),_:1})):(p(),y(b,{key:2},{default:s(()=>[(p(!0),k(v,null,M(l.extensions,a=>(p(),y(V,{key:a.id,cols:"12",md:"6",lg:"4"},{default:s(()=>[t(g,{border:"",hover:"",to:`/app/extensions/my/${a.id}`},{default:s(()=>[t(A,null,{append:s(()=>[t(T,{color:n.getStatusColor(a.status),size:"small",variant:"flat"},{default:s(()=>[r(u(n.getStatusText(a.status)),1)]),_:2},1032,["color"])]),default:s(()=>[t(h,null,{default:s(()=>{var x;return[r(u(((x=a.project)==null?void 0:x.title)||"扩展"),1)]}),_:2},1024),t(U,null,{default:s(()=>{var x;return[r(u(((x=a.project)==null?void 0:x.description)||"扩展"),1)]}),_:2},1024)]),_:2},1024),t(_,null,{default:s(()=>{var x;return[d("div",K,[t(m,{class:"mr-1",size:"small"},{default:s(()=>e[9]||(e[9]=[r("mdi-source-branch",-1)])),_:1,__:[9]}),d("span",$,u(a.branch||"main"),1)]),d("div",ee,[t(m,{class:"mr-1",size:"small"},{default:s(()=>e[10]||(e[10]=[r("mdi-source-commit",-1)])),_:1,__:[10]}),d("span",se,u(((x=a.commit)==null?void 0:x.substring(0,8))||"latest"),1)]),a.sample_project?(p(),k("div",te,[t(m,{class:"mr-1",size:"small"},{default:s(()=>e[11]||(e[11]=[r("mdi-file-document",-1)])),_:1,__:[11]}),d("span",le,"示例项目: "+u(a.sample_project.title),1)])):B("",!0),d("div",oe,[t(m,{class:"mr-1",size:"small"},{default:s(()=>e[12]||(e[12]=[r("mdi-puzzle",-1)])),_:1,__:[12]}),d("span",ae,u(a.scratchCompatible?"兼容原版Scratch":"不兼容原版Scratch"),1)])]}),_:2},1024)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1}),t(f,{modelValue:l.showCreateDialog,"onUpdate:modelValue":e[1]||(e[1]=a=>l.showCreateDialog=a),onCreated:n.fetchExtensions},null,8,["modelValue","onCreated"]),t(b,{class:"mt-6"},{default:s(()=>[t(V,{cols:"12"},{default:s(()=>[t(g,{variant:"flat",border:""},{default:s(()=>[t(h,{class:"d-flex align-center"},{default:s(()=>[t(m,{class:"mr-2"},{default:s(()=>e[13]||(e[13]=[r("mdi-cog",-1)])),_:1,__:[13]}),e[14]||(e[14]=r(" 高级设置 ",-1))]),_:1,__:[14]}),t(_,null,{default:s(()=>[t(b,null,{default:s(()=>[t(V,{cols:"12",md:"6"},{default:s(()=>[t(g,{variant:"tonal",border:""},{default:s(()=>[t(h,{class:"text-h6"},{default:s(()=>[t(m,{class:"mr-2",color:"primary"},{default:s(()=>e[15]||(e[15]=[r("mdi-cloud-upload",-1)])),_:1,__:[15]}),e[16]||(e[16]=r(" 批量推送 ",-1))]),_:1,__:[16]}),t(_,null,{default:s(()=>[e[17]||(e[17]=d("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 批量同步扩展时使用 ",-1)),t(w,{color:"primary",loading:l.pushAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-cloud-upload",onClick:n.pushAllExtensions,block:""},{default:s(()=>[r(" 全部推送 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1,__:[17]})]),_:1})]),_:1}),t(V,{cols:"12",md:"6"},{default:s(()=>[t(g,{variant:"tonal",border:""},{default:s(()=>[t(h,{class:"text-h6"},{default:s(()=>[t(m,{class:"mr-2",color:"success"},{default:s(()=>e[18]||(e[18]=[r("mdi-update",-1)])),_:1,__:[18]}),e[19]||(e[19]=r(" 批量更新 ",-1))]),_:1,__:[19]}),t(_,null,{default:s(()=>[e[20]||(e[20]=d("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 这是谁提的需求？ ",-1)),t(w,{color:"success",loading:l.updateAllLoading,disabled:l.extensions.length===0,"prepend-icon":"mdi-update",onClick:n.updateAllExtensions,block:""},{default:s(()=>[r(" 一键更新 ("+u(l.extensions.length)+") ",1)]),_:1},8,["loading","disabled","onClick"])]),_:1,__:[20]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),t(N,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[2]||(e[2]=a=>l.snackbar.show=a),color:l.snackbar.color},{default:s(()=>[r(u(l.snackbar.message),1)]),_:1},8,["modelValue","color"])]),_:1})}const he=S(J,[["render",re]]);export{he as default};
