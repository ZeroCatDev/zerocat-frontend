import{b as Q,p as ee,z as ae,ae as le,f as te,h as s,i as u,n as H,q as se,G as ne,H as oe,J as re,L as ue,M as ie,a2 as h,r,e as de,Z as _,o as m,P as t,aC as z,k as y,N as i,a3 as N,a as I,F as ve,W as fe,a0 as D,Y as w,U as j,aw as G,X as U,aP as ce,as as me,ax as J,a5 as pe,av as R}from"./index-CZXZYWWV.js";import{_ as ye}from"./verifyEmail-Bp23nIMk.js";import{V as W}from"./VSpacer-DouPY6VY.js";const Ve=ee({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...ie(),...ue(),...re(),...oe()},"VTable"),ge=Q()({name:"VTable",props:Ve(),setup(o,v){let{slots:n,emit:b}=v;const{themeClasses:V}=ae(o),{densityClasses:g}=le(o);return te(()=>s(o.tag,{class:ne(["v-table",{"v-table--fixed-height":!!o.height,"v-table--fixed-header":o.fixedHeader,"v-table--fixed-footer":o.fixedFooter,"v-table--has-top":!!n.top,"v-table--has-bottom":!!n.bottom,"v-table--hover":o.hover},V.value,g.value,o.class]),style:H(o.style)},{default:()=>{var d,f,c;return[(d=n.top)==null?void 0:d.call(n),n.default?u("div",{class:"v-table__wrapper",style:H({height:se(o.height)})},[u("table",null,[n.default()])]):(f=n.wrapper)==null?void 0:f.call(n),(c=n.bottom)==null?void 0:c.call(n)]}})),{}}}),_e=async()=>(await h.get("/account/emails")).data,we=async(o,v)=>(await h.post("/account/add-email",{email:o,verificationCode:v})).data,be=async(o,v)=>(await h.post("/account/remove-email",{email:o,verificationCode:v})).data,ke=async(o,v)=>(await h.post("/account/verify-email",{email:o,token:v})).data,Te={__name:"EmailManager",setup(o,{expose:v}){const n=r([]),b=r(!1),V=r(!1),g=r(!1),d=r(!1),f=r(""),c=r(""),k=r(null),p=r(""),x=r("info"),F=r(!1),M=r(""),S=r(""),T=r(null),B=r(null),E={required:l=>!!l||"此字段为必填项",email:l=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||"请输入有效的邮箱地址",length:l=>(l==null?void 0:l.length)===6||"验证码必须是6位数字"},C=async()=>{try{const l=await _e();l.status==="success"&&(n.value=l.data)}catch(l){console.error("获取邮箱列表失败:",l)}},P=(l,e,a)=>{M.value=l,S.value=e,T.value=a,F.value=!0},X=l=>{T.value&&(T.value(l),T.value=null)},$=async()=>{if(!f.value){p.value="请输入新邮箱地址",x.value="error";return}const l=n.value.find(e=>e.is_primary);if(!l){p.value="未找到主邮箱",x.value="error";return}P(l.contact_value,"验证主邮箱",e=>{c.value=e,q()})},q=async()=>{if(!(!f.value||!c.value)){d.value=!0;try{const l=await we(f.value,c.value);l.status==="success"?(await C(),A()):(p.value=l.message,x.value="error")}catch{p.value="添加邮箱失败",x.value="error"}finally{d.value=!1}}},Y=l=>{k.value=l,V.value=!0},Z=()=>{const l=n.value.find(e=>e.is_primary);l&&k.value&&P(l.contact_value,"验证主邮箱",async e=>{d.value=!0;try{(await be(k.value.contact_value,e)).status==="success"&&(await C(),L())}catch(a){console.error("删除失败:",a)}finally{d.value=!1}})},A=()=>{b.value=!1,g.value=!1,f.value="",c.value="",p.value="",B.value&&B.value.reset()},L=()=>{V.value=!1,k.value=null},K=l=>{P(l,"验证邮箱",async e=>{d.value=!0;try{(await ke(l,e)).status==="success"&&await C()}catch(a){console.error("验证失败:",a)}finally{d.value=!1}})};return de(async()=>{await C()}),v({fetchEmails:C}),(l,e)=>(m(),_(U,{class:"mb-4"},{default:t(()=>[s(z,{class:"d-flex align-center justify-space-between"},{default:t(()=>[e[8]||(e[8]=u("span",null,"邮箱管理",-1)),s(y,{color:"primary",onClick:e[0]||(e[0]=a=>b.value=!0),disabled:n.value.length>=5},{default:t(()=>e[7]||(e[7]=[i(" 添加邮箱 ")])),_:1,__:[7]},8,["disabled"])]),_:1,__:[8]}),s(N,null,{default:t(()=>[s(ge,null,{default:t(()=>[e[12]||(e[12]=u("thead",null,[u("tr",null,[u("th",null,"邮箱地址"),u("th",null,"状态"),u("th",null,"添加时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(m(!0),I(ve,null,fe(n.value,a=>(m(),I("tr",{key:a.contact_id},[u("td",null,[i(w(a.contact_value)+" ",1),a.is_primary?(m(),_(j,{key:0,color:"primary",size:"small",class:"ml-2"},{default:t(()=>e[9]||(e[9]=[i("主邮箱")])),_:1,__:[9]})):D("",!0)]),u("td",null,[s(j,{color:a.verified?"success":"warning",size:"small"},{default:t(()=>[i(w(a.verified?"已验证":"未验证"),1)]),_:2},1032,["color"])]),u("td",null,w(new Date(a.created_at).toLocaleString()),1),u("td",null,[a.verified?D("",!0):(m(),_(y,{key:0,variant:"text",color:"primary",size:"small",onClick:O=>K(a.contact_value)},{default:t(()=>e[10]||(e[10]=[i(" 验证 ")])),_:2,__:[10]},1032,["onClick"])),a.is_primary?D("",!0):(m(),_(y,{key:1,variant:"text",color:"error",size:"small",onClick:O=>Y(a)},{default:t(()=>e[11]||(e[11]=[i(" 删除 ")])),_:2,__:[11]},1032,["onClick"]))])]))),128))])]),_:1,__:[12]})]),_:1}),s(G,{modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=a=>b.value=a),"max-width":"500px"},{default:t(()=>[s(U,null,{default:t(()=>[s(z,null,{default:t(()=>e[13]||(e[13]=[i("添加新邮箱")])),_:1,__:[13]}),s(N,null,{default:t(()=>[s(ce,{onSubmit:me($,["prevent"]),ref_key:"addForm",ref:B},{default:t(()=>[s(J,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=a=>f.value=a),label:"新邮箱地址",rules:[E.required,E.email],variant:"outlined"},null,8,["modelValue","rules"]),g.value?(m(),_(J,{key:0,modelValue:c.value,"onUpdate:modelValue":e[2]||(e[2]=a=>c.value=a),label:"主邮箱验证码",rules:[E.required,E.length],maxlength:"6",variant:"outlined"},null,8,["modelValue","rules"])):D("",!0),p.value?(m(),_(pe,{key:1,type:x.value,variant:"tonal",class:"mt-3"},{default:t(()=>[i(w(p.value),1)]),_:1},8,["type"])):D("",!0)]),_:1},512)]),_:1}),s(R,null,{default:t(()=>[s(W),s(y,{color:"grey",variant:"text",onClick:A},{default:t(()=>e[14]||(e[14]=[i("取消")])),_:1,__:[14]}),s(y,{color:"primary",loading:d.value,onClick:e[3]||(e[3]=a=>g.value?q():$())},{default:t(()=>[i(w(g.value?"添加":"发送验证码"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(G,{modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=a=>V.value=a),"max-width":"500px"},{default:t(()=>[s(U,null,{default:t(()=>[s(z,null,{default:t(()=>e[15]||(e[15]=[i("删除邮箱")])),_:1,__:[15]}),s(N,null,{default:t(()=>{var a;return[u("p",null,"确认要删除邮箱 "+w((a=k.value)==null?void 0:a.contact_value)+" 吗？",1)]}),_:1}),s(R,null,{default:t(()=>[s(W),s(y,{color:"grey",variant:"text",onClick:L},{default:t(()=>e[16]||(e[16]=[i("取消")])),_:1,__:[16]}),s(y,{color:"error",loading:d.value,onClick:Z},{default:t(()=>e[17]||(e[17]=[i(" 删除 ")])),_:1,__:[17]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ye,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=a=>F.value=a),email:M.value,title:S.value,onVerified:X},null,8,["modelValue","email","title"])]),_:1}))}};export{ge as V,Te as _,Ve as m};
