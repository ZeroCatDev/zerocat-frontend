import{_ as P,ac as S,c as m,o as d,e as t,N as s,Y as _,$ as p,a9 as w,L as i,aP as N,a0 as E,W as k,i as h,O as x,a3 as g,f as o,S as A,X as r,a5 as v,F as V,U as C,aA as B,aE as M,ab as f}from"./index-CqDYMkg5.js";import{V as L}from"./VSpacer-BmIOKXlY.js";import{V as I,a as D}from"./VExpansionPanels-TbU22qXq.js";import{V as U}from"./VCheckbox-DkDtMvcS.js";import"./VCheckboxBtn-8mXxa5va.js";import"./VSelectionControl-DLr9dD2N.js";const O={name:"TokenDebugPage",data(){return{isLogin:!1,token:null,refreshToken:null,isTokenValid:!1,isRefreshTokenValid:!1,tokenExpiration:0,isAutoRefreshActive:!1,autoRefreshStatus:null,checkingStatus:!1,isAutoRefreshEnabled:f.AUTO_REFRESH_ENABLED,devicesData:null,devicesLoading:!1,tokensData:null,tokensLoading:!1,includeLocation:!0,tokenDetail:null,tokenDetailLoading:!1,refreshLoading:!1,revokeLoading:null,logoutAllLoading:!1,confirmDialog:!1,confirmMessage:"",pendingAction:null,pendingParams:null,lastResponse:null,lastResponseStatus:null,lastResponseTime:null}},computed:{formattedResponse(){if(!this.lastResponse)return"";try{return JSON.stringify(this.lastResponse,null,2)}catch{return String(this.lastResponse)}}},mounted(){this.refreshTokenState(),this.checkAutoRefreshStatus()},methods:{refreshTokenState(){this.isLogin=f.isLogin,this.token=f.getToken(),this.refreshToken=f.getRefreshToken(),this.isTokenValid=f.isTokenValid(),this.isRefreshTokenValid=f.isRefreshTokenValid(),this.tokenExpiration=f.getTokenExpirationTime(),this.checkAutoRefreshStatus()},checkAutoRefreshStatus(){this.isAutoRefreshActive=!!window.tokenRefreshTimer,!this.autoRefreshStatus&&this.isLogin&&this.isAutoRefreshEnabled&&this.checkTokenRefreshStatus()},async checkTokenRefreshStatus(){this.checkingStatus=!0;try{const l=Date.now(),e=f.getTokenExpirationTime(),c=e<=0||e<=5*60;this.lastResponseTime=Date.now()-l,this.autoRefreshStatus={type:c?"warning":"success",message:c?`令牌将在${this.formatTime(e)}后过期，需要刷新`:`令牌状态良好，还有${this.formatTime(e)}过期`},this.lastResponse={token_expiration:e,refresh_needed:c,auto_refresh_active:this.isAutoRefreshActive},this.lastResponseStatus=200}catch(l){this.handleError(l)}finally{this.checkingStatus=!1}},async startAutoRefresh(){try{const l=Date.now();f.startTokenRefreshTimer(),this.lastResponseTime=Date.now()-l,this.checkAutoRefreshStatus(),this.autoRefreshStatus={type:"success",message:"令牌自动刷新已重新启用"},this.lastResponse={status:"success",message:"自动刷新功能已重新启用",active:!0},this.lastResponseStatus=200}catch(l){this.handleError(l)}},async stopAutoRefresh(){try{const l=Date.now();f.stopTokenRefreshTimer(),this.lastResponseTime=Date.now()-l,this.checkAutoRefreshStatus(),this.autoRefreshStatus={type:"warning",message:"令牌自动刷新已临时停用（刷新页面或重新登录后将自动恢复）"},this.lastResponse={status:"success",message:"自动刷新功能已临时停用",active:!1},this.lastResponseStatus=200}catch(l){this.handleError(l)}},async refreshAccessToken(){this.refreshLoading=!0;try{const l=Date.now(),e=await f.refreshAccessToken();this.lastResponseTime=Date.now()-l,this.lastResponse={success:e,message:e?"令牌刷新成功":"令牌刷新失败"},this.lastResponseStatus=e?200:400,this.refreshTokenState()}catch(l){this.handleError(l)}finally{this.refreshLoading=!1}},async fetchDevicesList(){this.devicesLoading=!0;try{const l=Date.now(),e=await f.getDevices();this.lastResponseTime=Date.now()-l,this.devicesData=e,this.lastResponse={status:"success",data:e},this.lastResponseStatus=200}catch(l){this.handleError(l)}finally{this.devicesLoading=!1}},async fetchActiveTokens(){this.tokensLoading=!0;try{const l=Date.now(),e=await f.getActiveTokens(this.includeLocation);this.lastResponseTime=Date.now()-l,this.tokensData=e,this.lastResponse={status:"success",data:e},this.lastResponseStatus=200}catch(l){this.handleError(l)}finally{this.tokensLoading=!1}},async getTokenDetail(l){this.tokenDetailLoading=!0;try{const e=Date.now(),c=await f.getTokenDetails(l,this.includeLocation);this.lastResponseTime=Date.now()-e,this.tokenDetail=c,this.lastResponse={status:"success",data:c},this.lastResponseStatus=200}catch(e){this.handleError(e)}finally{this.tokenDetailLoading=!1}},async revokeSelectedToken(l){this.confirmMessage=`确定要撤销令牌 #${l} 吗？`,this.pendingAction=this.doRevokeToken,this.pendingParams=l,this.confirmDialog=!0},async doRevokeToken(l){this.revokeLoading=l;try{const e=Date.now(),c=await f.revokeToken(l);this.lastResponseTime=Date.now()-e,this.lastResponse={status:c?"success":"error",message:c?"令牌已成功撤销":"撤销令牌失败"},this.lastResponseStatus=c?200:400,c&&(await this.fetchActiveTokens(),this.tokenDetail&&this.tokenDetail.id===l&&(this.tokenDetail=null))}catch(e){this.handleError(e)}finally{this.revokeLoading=null}},confirmLogoutAllDevices(){this.confirmMessage="确定要登出所有设备吗？此操作将使所有设备上的会话失效，包括当前会话。",this.pendingAction=this.doLogoutAllDevices,this.confirmDialog=!0},async doLogoutAllDevices(){this.logoutAllLoading=!0;try{const l=Date.now(),e=await f.logoutAllDevices();this.lastResponseTime=Date.now()-l,this.lastResponse={status:e?"success":"error",message:e?"已成功登出所有设备":"登出所有设备失败"},this.lastResponseStatus=e?200:400,this.refreshTokenState()}catch(l){this.handleError(l)}finally{this.logoutAllLoading=!1}},confirmAction(){this.confirmDialog=!1,this.pendingAction&&(this.pendingAction(this.pendingParams),this.pendingAction=null,this.pendingParams=null)},handleError(l){var e;console.error("API Error:",l),this.lastResponse={status:"error",message:l.message||"未知错误",error:l.toString()},this.lastResponseStatus=((e=l.response)==null?void 0:e.status)||500},formatDate(l){return l?new Date(l).toLocaleString():"未知"},formatTime(l){return l<60?`${l}秒`:l<3600?`${Math.floor(l/60)}分${l%60}秒`:`${Math.floor(l/3600)}小时${Math.floor(l%3600/60)}分`},formatKey(l){return l.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},formatValue(l,e){return e==null?"无":l.includes("time")||l.includes("date")||l.includes("at")?this.formatDate(e):typeof e=="object"?JSON.stringify(e):e},getStatusColor(l){return l?l>=200&&l<300?"success":l>=300&&l<400?"info":l>=400&&l<500?"warning":"error":"grey"}}},F={class:"token-debug-container"},J={class:"text-truncate",style:{"max-width":"300px"}},K={key:0,class:"ml-2"},j={class:"text-truncate",style:{"max-width":"300px"}},H={class:"d-flex align-center mb-3"},W={key:0,class:"d-flex align-center mb-4"},X={key:0},Y={key:0},q={key:0},z={class:"font-weight-bold"},G={class:"d-flex align-center mb-2"},Q={class:"response-body pa-3"};function Z(l,e,c,$,n,u){const b=S("v-simple-table"),T=S("v-expansion-panel-header"),R=S("v-expansion-panel-content");return d(),m("div",F,[t(k,{class:"pa-4"},{default:s(()=>[t(w,null,{default:s(()=>e[4]||(e[4]=[i("Token Debug Tool")])),_:1,__:[4]}),t(N,null,{default:s(()=>e[5]||(e[5]=[i("测试和调试用户身份验证令牌API")])),_:1,__:[5]}),t(E,{class:"my-3"}),t(k,{outlined:"",class:"mb-4"},{default:s(()=>[t(w,{class:"subtitle-1"},{default:s(()=>[e[8]||(e[8]=i(" 当前Token状态 ")),t(L),t(h,{color:"primary",onClick:u.refreshTokenState,small:""},{default:s(()=>[t(x,{left:"",small:""},{default:s(()=>e[6]||(e[6]=[i("mdi-refresh")])),_:1,__:[6]}),e[7]||(e[7]=i("刷新 "))]),_:1,__:[7]},8,["onClick"])]),_:1,__:[8]}),t(g,null,{default:s(()=>[t(b,{dense:""},{default:s(()=>[o("tbody",null,[o("tr",null,[e[9]||(e[9]=o("td",{class:"font-weight-bold"},"登录状态",-1)),o("td",null,[t(A,{color:n.isLogin?"success":"error",small:"","text-color":"white"},{default:s(()=>[i(r(n.isLogin?"已登录":"未登录"),1)]),_:1},8,["color"])])]),o("tr",null,[e[10]||(e[10]=o("td",{class:"font-weight-bold"},"Access Token",-1)),o("td",J,r(n.token||"无"),1)]),o("tr",null,[e[11]||(e[11]=o("td",{class:"font-weight-bold"},"Access Token有效性",-1)),o("td",null,[t(A,{color:n.isTokenValid?"success":"error",small:"","text-color":"white"},{default:s(()=>[i(r(n.isTokenValid?"有效":"无效"),1)]),_:1},8,["color"]),n.tokenExpiration>0?(d(),m("span",K," (剩余"+r(u.formatTime(n.tokenExpiration))+") ",1)):p("",!0)])]),o("tr",null,[e[12]||(e[12]=o("td",{class:"font-weight-bold"},"Refresh Token",-1)),o("td",j,r(n.refreshToken||"无"),1)]),o("tr",null,[e[13]||(e[13]=o("td",{class:"font-weight-bold"},"Refresh Token有效性",-1)),o("td",null,[t(A,{color:n.isRefreshTokenValid?"success":"error",small:"","text-color":"white"},{default:s(()=>[i(r(n.isRefreshTokenValid?"有效":"无效"),1)]),_:1},8,["color"])])])])]),_:1})]),_:1})]),_:1}),t(I,null,{default:s(()=>[t(D,null,{default:s(()=>[t(T,null,{default:s(()=>e[14]||(e[14]=[i(" 自动刷新令牌设置 ")])),_:1,__:[14]}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[t(v,{type:"info",outlined:"",class:"mb-3"},{default:s(()=>e[15]||(e[15]=[i(" 自动刷新功能已默认启用，将在令牌即将过期前自动更新，保持登录状态。 ")])),_:1,__:[15]}),o("div",H,[e[18]||(e[18]=o("span",{class:"mr-2"},"自动刷新状态:",-1)),t(A,{color:n.isAutoRefreshActive?"success":"grey",small:"","text-color":"white"},{default:s(()=>[i(r(n.isAutoRefreshActive?"已启用":"已停用"),1)]),_:1},8,["color"]),t(L),n.isAutoRefreshActive?(d(),_(h,{key:0,color:"warning",small:"",onClick:u.stopAutoRefresh,disabled:!n.isLogin},{default:s(()=>e[16]||(e[16]=[i(" 临时停用自动刷新 ")])),_:1,__:[16]},8,["onClick","disabled"])):(d(),_(h,{key:1,color:"primary",small:"",onClick:u.startAutoRefresh,disabled:!n.isLogin},{default:s(()=>e[17]||(e[17]=[i(" 重新启用自动刷新 ")])),_:1,__:[17]},8,["onClick","disabled"]))]),n.tokenExpiration>0?(d(),m("div",W,[t(x,{color:n.tokenExpiration<=300?"error":"success",small:"",class:"mr-2"},{default:s(()=>[i(r(n.tokenExpiration<=300?"mdi-clock-alert-outline":"mdi-clock-outline"),1)]),_:1},8,["color"]),o("span",null,[e[19]||(e[19]=i(" 当前令牌有效期还剩：")),o("strong",null,r(u.formatTime(n.tokenExpiration)),1),n.tokenExpiration<=300?(d(),m("span",X," (即将过期)")):p("",!0)])])):p("",!0),n.autoRefreshStatus?(d(),_(v,{key:1,type:n.autoRefreshStatus.type,text:"",outlined:""},{default:s(()=>[i(r(n.autoRefreshStatus.message),1)]),_:1},8,["type"])):p("",!0),t(h,{color:"primary",onClick:u.checkTokenRefreshStatus,loading:n.checkingStatus,disabled:!n.isLogin,class:"mb-4"},{default:s(()=>e[20]||(e[20]=[i(" 检查刷新状态 ")])),_:1,__:[20]},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),t(D,null,{default:s(()=>[t(T,null,{default:s(()=>e[21]||(e[21]=[i(" 刷新访问令牌 (Refresh Token) ")])),_:1,__:[21]}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[e[23]||(e[23]=o("p",{class:"mb-3"},"手动刷新Access Token，使用当前的Refresh Token获取新的Access Token。",-1)),t(h,{color:"primary",onClick:u.refreshAccessToken,loading:n.refreshLoading,disabled:!n.isRefreshTokenValid},{default:s(()=>e[22]||(e[22]=[i(" 刷新令牌 ")])),_:1,__:[22]},8,["onClick","loading","disabled"])]),_:1,__:[23]})]),_:1})]),_:1})]),_:1}),t(D,null,{default:s(()=>[t(T,null,{default:s(()=>e[24]||(e[24]=[i(" 获取设备列表 ")])),_:1,__:[24]}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[t(h,{color:"primary",onClick:u.fetchDevicesList,loading:n.devicesLoading,disabled:!n.isLogin,class:"mb-4"},{default:s(()=>e[25]||(e[25]=[i(" 获取设备列表 ")])),_:1,__:[25]},8,["onClick","loading","disabled"]),n.devicesData&&n.devicesData.length>0?(d(),m("div",Y,[t(b,null,{default:s(()=>[e[26]||(e[26]=o("thead",null,[o("tr",null,[o("th",null,"设备ID"),o("th",null,"设备名称"),o("th",null,"最后登录时间"),o("th",null,"IP地址")])],-1)),o("tbody",null,[(d(!0),m(V,null,C(n.devicesData,a=>(d(),m("tr",{key:a.id},[o("td",null,r(a.id),1),o("td",null,r(a.device_name),1),o("td",null,r(u.formatDate(a.last_login)),1),o("td",null,r(a.ip),1)]))),128))])]),_:1,__:[26]})])):n.devicesData?(d(),_(v,{key:1,type:"info",outlined:""},{default:s(()=>e[27]||(e[27]=[i(" 没有设备数据 ")])),_:1,__:[27]})):p("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(D,null,{default:s(()=>[t(T,null,{default:s(()=>e[28]||(e[28]=[i(" 获取活跃令牌列表 ")])),_:1,__:[28]}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[t(U,{modelValue:n.includeLocation,"onUpdate:modelValue":e[0]||(e[0]=a=>n.includeLocation=a),label:"包含位置信息",disabled:!n.isLogin},null,8,["modelValue","disabled"]),t(h,{color:"primary",onClick:u.fetchActiveTokens,loading:n.tokensLoading,disabled:!n.isLogin,class:"mb-4"},{default:s(()=>e[29]||(e[29]=[i(" 获取活跃令牌 ")])),_:1,__:[29]},8,["onClick","loading","disabled"]),n.tokensData&&n.tokensData.length>0?(d(),m("div",q,[t(b,null,{default:s(()=>[e[32]||(e[32]=o("thead",null,[o("tr",null,[o("th",null,"令牌ID"),o("th",null,"设备名称"),o("th",null,"创建时间"),o("th",null,"过期时间"),o("th",null,"位置信息"),o("th",null,"操作")])],-1)),o("tbody",null,[(d(!0),m(V,null,C(n.tokensData,a=>(d(),m("tr",{key:a.id},[o("td",null,r(a.id),1),o("td",null,r(a.device_name),1),o("td",null,r(u.formatDate(a.created_at)),1),o("td",null,r(u.formatDate(a.expires_at)),1),o("td",null,r(a.location||"无"),1),o("td",null,[t(h,{color:"error",small:"",text:"",onClick:y=>u.revokeSelectedToken(a.id),loading:n.revokeLoading===a.id},{default:s(()=>e[30]||(e[30]=[i(" 撤销 ")])),_:2,__:[30]},1032,["onClick","loading"]),t(h,{color:"info",small:"",text:"",onClick:y=>u.getTokenDetail(a.id)},{default:s(()=>e[31]||(e[31]=[i(" 详情 ")])),_:2,__:[31]},1032,["onClick"])])]))),128))])]),_:1,__:[32]})])):n.tokensData?(d(),_(v,{key:1,type:"info",outlined:""},{default:s(()=>e[33]||(e[33]=[i(" 没有活跃令牌数据 ")])),_:1,__:[33]})):p("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),n.tokenDetail?(d(),_(D,{key:0},{default:s(()=>[t(T,null,{default:s(()=>[i(" 令牌详情 #"+r(n.tokenDetail.id),1)]),_:1}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[t(b,{dense:""},{default:s(()=>[o("tbody",null,[(d(!0),m(V,null,C(n.tokenDetail,(a,y)=>(d(),m("tr",{key:y},[o("td",z,r(u.formatKey(y)),1),o("td",null,r(u.formatValue(y,a)),1)]))),128))])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):p("",!0),t(D,null,{default:s(()=>[t(T,{class:"error--text"},{default:s(()=>e[34]||(e[34]=[i(" 登出所有设备 ")])),_:1,__:[34]}),t(R,null,{default:s(()=>[t(k,{flat:""},{default:s(()=>[t(g,null,{default:s(()=>[t(v,{type:"warning",outlined:"",class:"mb-3"},{default:s(()=>e[35]||(e[35]=[i(" 警告：此操作将使所有设备上的会话失效，包括当前会话。 ")])),_:1,__:[35]}),t(h,{color:"error",onClick:u.confirmLogoutAllDevices,loading:n.logoutAllLoading,disabled:!n.isLogin},{default:s(()=>e[36]||(e[36]=[i(" 登出所有设备 ")])),_:1,__:[36]},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n.lastResponse?(d(),_(k,{key:0,outlined:"",class:"mt-4"},{default:s(()=>[t(w,{class:"subtitle-1"},{default:s(()=>[e[38]||(e[38]=i(" 最近API响应 ")),t(L),t(h,{icon:"",small:"",onClick:e[1]||(e[1]=a=>n.lastResponse=null)},{default:s(()=>[t(x,null,{default:s(()=>e[37]||(e[37]=[i("mdi-close")])),_:1,__:[37]})]),_:1})]),_:1,__:[38]}),t(g,null,{default:s(()=>[o("div",G,[e[39]||(e[39]=o("div",{class:"font-weight-bold mr-2"},"状态:",-1)),t(A,{color:u.getStatusColor(n.lastResponseStatus),"text-color":"white",small:""},{default:s(()=>[i(r(n.lastResponseStatus),1)]),_:1},8,["color"]),e[40]||(e[40]=o("div",{class:"ml-4 font-weight-bold mr-2"},"响应时间:",-1)),o("span",null,r(n.lastResponseTime)+"ms",1)]),t(E,{class:"my-2"}),o("div",Q,[o("pre",null,r(u.formattedResponse),1)])]),_:1})]),_:1})):p("",!0),t(B,{modelValue:n.confirmDialog,"onUpdate:modelValue":e[3]||(e[3]=a=>n.confirmDialog=a),"max-width":"400"},{default:s(()=>[t(k,null,{default:s(()=>[t(w,null,{default:s(()=>e[41]||(e[41]=[i("确认操作")])),_:1,__:[41]}),t(g,null,{default:s(()=>[i(r(n.confirmMessage),1)]),_:1}),t(M,null,{default:s(()=>[t(L),t(h,{color:"grey darken-1",text:"",onClick:e[2]||(e[2]=a=>n.confirmDialog=!1)},{default:s(()=>e[42]||(e[42]=[i(" 取消 ")])),_:1,__:[42]}),t(h,{color:"error",text:"",onClick:u.confirmAction},{default:s(()=>e[43]||(e[43]=[i(" 确认 ")])),_:1,__:[43]},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})])}const ie=P(O,[["render",Z],["__scopeId","data-v-609ef17a"]]);export{ie as default};
