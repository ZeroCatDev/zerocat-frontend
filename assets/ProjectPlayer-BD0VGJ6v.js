import{_ as E}from"./UserRelationControls-BuUkj7p4.js";import{_ as V,aa as A,ab as $,Y as f,o as l,N as a,e as t,aU as O,aV as ee,a9 as T,L as n,X as u,aW as z,Z as M,n as F,W as y,a1 as te,i as c,O as v,a0 as w,az as re,$ as _,j as ae,ad as se,c as h,F as b,U as K,ae as x,aD as I,af as B,ag as ie,aE as S,aA as oe,a3 as U,aB as D,m as ne,aX as W,aY as le,f as p,S as g,Q as N,R as k,aZ as de,a_ as ue,aC as ce,a$ as me,an as pe}from"./index-_2MgdHBD.js";import{c as fe,a as R,r as ge,u as he,s as ye,b as _e,d as je}from"./projectListService-Duh3bfdH.js";import{V as P}from"./VSpacer-DqqW3ccg.js";import{V as X}from"./VSelect-DsIYCbsR.js";import{_ as Y}from"./TimeAgo-DjFmhgh6.js";import{o as ve}from"./openEdit-AJJkPSPH.js";import{_ as Z}from"./CodeRunTerminal-CZVe4YYC.js";import{p as q}from"./programming_languages-DsXmqGcu.js";import{V as G}from"./VTextarea-7fE7Fp49.js";const be={name:"ProjectAuthorCard",components:{UserRelationControls:E},props:{author:{type:Object,required:!0}},data(){return{localuser:$,loading:!1,error:null,s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await A("s3.staticurl")}};function Ve(e,r,s,C,i,d){const o=E;return l(),f(y,{to:"/"+s.author.username,border:"",hover:""},{default:a(()=>[t(O,null,ee({prepend:a(()=>[t(M,null,{default:a(()=>[t(F,{alt:s.author.display_name,src:i.s3BucketUrl+"/user/"+s.author.avatar},null,8,["alt","src"])]),_:1})]),default:a(()=>[t(T,{class:"text-white"},{default:a(()=>[n(u(s.author.display_name),1)]),_:1}),t(z,{class:"text-white"},{default:a(()=>[n(u(s.author.bio),1)]),_:1})]),_:2},[i.localuser.id&&i.localuser.id!==s.author.id?{name:"append",fn:a(()=>[t(o,{"display-name":s.author.display_name,"user-id":s.author.id,username:s.author.username},null,8,["display-name","user-id","username"])]),key:"0"}:void 0]),1024)]),_:1},8,["to"])}const Q=V(be,[["render",Ve]]),Ce={props:{projectId:{type:[String,Number],required:!0,validator:e=>e==null?!1:typeof e=="string"?e.trim()!=="":typeof e=="number"?!isNaN(e)&&e>0:!1}},data(){return{isStarred:!1,starCount:0,starLoading:!1,listLoading:!1,creatingList:!1,isVisibleDialog:!1,menu:!1,myLists:[],newListInfo:{title:"",description:"",state:"private"},listStates:[{state:"私密",abbr:"private"},{state:"公开",abbr:"public"}],error:null}},computed:{isValidProjectId(){return this.projectId!==void 0&&this.projectId!==null&&(typeof this.projectId=="string"?this.projectId.trim()!=="":!isNaN(this.projectId)&&this.projectId>0)}},async created(){this.isValidProjectId?(await this.checkStarStatus(),await this.getStarCount()):(console.error("Invalid projectId provided:",this.projectId),this.error="无效的项目ID")},watch:{menu(e){e&&this.isValidProjectId&&this.fetchMyLists()},projectId:{immediate:!0,handler(e){this.isValidProjectId&&(this.checkStarStatus(),this.getStarCount())}}},methods:{async checkStarStatus(){if(this.isValidProjectId)try{const e=await je(this.projectId);if((e==null?void 0:e.status)==="success")this.isStarred=e.star;else throw new Error((e==null?void 0:e.message)||"检查收藏状态失败")}catch(e){console.error("检查收藏状态失败:",e),this.error=e.message||"检查收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}},async getStarCount(){if(this.isValidProjectId){try{const e=await _e(this.projectId);if((e==null?void 0:e.status)==="success")this.starCount=e.data;else throw new Error((e==null?void 0:e.message)||"获取收藏数失败")}catch(e){console.error("获取收藏数失败:",e),this.error=e.message||"获取收藏数失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}this.$emit("star-updated")}},async toggleStar(){if(!this.isValidProjectId){this.$toast.add({severity:"error",summary:"错误",detail:"无效的项目ID",life:3e3});return}this.starLoading=!0;try{const e=this.isStarred?await he(this.projectId):await ye(this.projectId);if((e==null?void 0:e.status)==="success")this.isStarred=!this.isStarred,await this.getStarCount(),this.$toast.add({severity:"success",summary:"成功",detail:e.message,life:2e3});else throw new Error((e==null?void 0:e.message)||"操作失败")}catch(e){console.error("切换收藏状态失败:",e),this.error=e.message||"切换收藏状态失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.starLoading=!1}},async fetchMyLists(){var e,r;if(this.isValidProjectId){this.listLoading=!0;try{const s=await te.get(`/projectlist/lists/check?projectid=${this.projectId}`);if(((e=s==null?void 0:s.data)==null?void 0:e.status)==="success")this.myLists=s.data.data||[];else throw new Error(((r=s==null?void 0:s.data)==null?void 0:r.message)||"获取列表状态失败")}catch(s){console.error("获取我的列表失败:",s),this.error=s.message||"获取我的列表失败",this.$toast.add({severity:"error",summary:"错误",detail:this.error,life:3e3})}finally{this.listLoading=!1}}},async toggleListItem(e){const r=this.myLists.find(s=>s.id===e);if(r){r.loading=!0;try{let s;r.hasProject?(s=await ge(e,this.projectId),s.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已从列表中移除",life:3e3}),r.hasProject=!1)):(s=await R(e,this.projectId),s.status==="success"&&(this.$toast.add({severity:"success",summary:"成功",detail:"已添加到列表",life:3e3}),r.hasProject=!0))}catch(s){console.error("操作列表失败:",s),this.$toast.add({severity:"error",summary:"错误",detail:"操作失败",life:3e3})}finally{r.loading=!1}}},async createNewList(){if(this.newListInfo.title){this.creatingList=!0;try{const e=await fe(this.newListInfo);e.status==="success"?(this.$toast.add({severity:"success",summary:"成功",detail:"列表创建成功",life:3e3}),this.newListInfo={title:"",description:"",state:"private"},this.isVisibleDialog=!1,e.data&&e.data.id&&await R(e.data.id,this.projectId),await this.fetchMyLists()):this.$toast.add({severity:"error",summary:"错误",detail:e.message||"创建列表失败",life:3e3})}catch(e){console.error("创建列表失败:",e),this.$toast.add({severity:"error",summary:"错误",detail:"创建列表失败",life:3e3})}finally{this.creatingList=!1}}}}};function we(e,r,s,C,i,d){return l(),f(W,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:a(()=>[t(c,{loading:i.starLoading,class:"text-none",text:"Star",variant:"tonal",onClick:d.toggleStar},{prepend:a(()=>[t(v,{color:i.isStarred?"yellow":"",icon:i.isStarred?"mdi-star":"mdi-star-outline"},null,8,["color","icon"])]),default:a(()=>[n(" "+u(i.isStarred?"Starred":"Star")+" "+u(i.starCount),1)]),_:1},8,["loading","onClick"]),t(w,{color:"surface-light",vertical:""}),t(re,{modelValue:i.menu,"onUpdate:modelValue":r[8]||(r[8]=o=>i.menu=o),"close-on-content-click":!1},{activator:a(({props:o})=>[t(c,ne({class:"px-5",icon:"mdi-menu-down"},o),null,16)]),default:a(()=>[t(y,{"max-width":"400","min-width":"300"},{default:a(()=>[i.listLoading?(l(),f(ae,{key:0,color:"primary",indeterminate:""})):_("",!0),t(se,null,{default:a(()=>[(l(!0),h(b,null,K(i.myLists,o=>(l(),h("div",{key:o.id},[t(x,{active:o.hasProject,"prepend-icon":o.hasProject?"mdi-check-circle":"mdi-playlist-plus","prepend-icon-color":o.hasProject?"success":void 0,onClick:I(m=>d.toggleListItem(o.id),["stop"])},{default:a(()=>[t(B,null,{default:a(()=>[n(u(o.title),1)]),_:2},1024),t(ie,null,{default:a(()=>[n(u(o.description),1)]),_:2},1024)]),_:2},1032,["active","prepend-icon","prepend-icon-color","onClick"])]))),128)),t(w,{class:"my-2"}),t(x,{onClick:r[0]||(r[0]=I(o=>i.isVisibleDialog=!0,["stop"]))},{prepend:a(()=>[t(v,null,{default:a(()=>r[9]||(r[9]=[n("mdi-plus",-1)])),_:1,__:[9]})]),default:a(()=>[t(B,null,{default:a(()=>r[10]||(r[10]=[n("新建列表",-1)])),_:1,__:[10]})]),_:1})]),_:1}),t(S,null,{default:a(()=>[t(P),t(c,{text:"关闭",variant:"text",onClick:r[1]||(r[1]=o=>i.menu=!1)})]),_:1})]),_:1}),t(oe,{modelValue:i.isVisibleDialog,"onUpdate:modelValue":r[6]||(r[6]=o=>i.isVisibleDialog=o),"min-width":"400",width:"auto","onClick:outside":r[7]||(r[7]=o=>i.isVisibleDialog=!1)},{default:a(()=>[t(y,{border:"","prepend-icon":"mdi-format-list-bulleted",title:"新建列表"},{default:a(()=>[t(U,null,{default:a(()=>[t(D,{modelValue:i.newListInfo.title,"onUpdate:modelValue":r[2]||(r[2]=o=>i.newListInfo.title=o),rules:[o=>!!o||"标题不能为空"],hint:"将便于查找",label:"标题",required:""},null,8,["modelValue","rules"]),t(D,{modelValue:i.newListInfo.description,"onUpdate:modelValue":r[3]||(r[3]=o=>i.newListInfo.description=o),hint:"简要描述列表内容",label:"简介"},null,8,["modelValue"]),t(X,{modelValue:i.newListInfo.state,"onUpdate:modelValue":r[4]||(r[4]=o=>i.newListInfo.state=o),items:i.listStates,"item-title":"state","item-value":"abbr",label:"列表状态"},null,8,["modelValue","items"])]),_:1}),t(w),t(S,null,{default:a(()=>[t(P),t(c,{text:"关闭",variant:"plain",onClick:r[5]||(r[5]=o=>i.isVisibleDialog=!1)}),t(c,{disabled:!i.newListInfo.title,loading:i.creatingList,color:"primary",text:"创建",variant:"tonal",onClick:I(d.createNewList,["stop"])},null,8,["disabled","loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})}const H=V(Ce,[["render",we]]),Le={name:"ProjectInfoCard",components:{TimeAgo:Y,ProjectStar:H,ProjectAuthorCard:Q},props:{project:{type:Object,required:!0},author:{type:Object,required:!0},username:{type:String,required:!0},projectname:{type:String,required:!0}},data(){return{openEditor:ve,loading:!1,error:null,stats:{pageviews:0,visitors:0},s3BucketUrl:""}},async mounted(){this.s3BucketUrl=await A("s3.staticurl")},watch:{"project.id":{immediate:!0,handler(e){e&&this.loadProjectStats()}}},methods:{async loadProjectStats(){try{this.stats=await le(this.project.id)}catch(e){console.error("Error fetching project stats:",e),this.stats={pageviews:0,visitors:0}}}}},Ie={class:"px-4 d-flex ga-2 mb-2"},ke={class:"px-4 d-flex ga-2 mb-2"},xe={class:"px-4 d-flex ga-2 mb-2"},Se={class:"px-4 d-flex ga-2 mb-2"},Pe={class:"px-4 d-flex ga-2 mb-2"},Te={class:"px-4 d-flex ga-2 mb-2"},Ue={class:"px-4 d-flex ga-2 mb-2"},Be={class:"px-4"};function De(e,r,s,C,i,d){const o=Y,m=H,L=Q;return l(),f(y,{border:"",hover:""},{default:a(()=>[t(O,null,{default:a(()=>[t(T,null,{default:a(()=>[n(u(s.project.title),1)]),_:1}),t(z,null,{default:a(()=>[n(u(s.project.description),1)]),_:1})]),_:1}),p("div",Ie,[t(g,{pill:""},{default:a(()=>[t(M,{start:""},{default:a(()=>[t(F,{src:i.s3BucketUrl+"/user/"+s.author.avatar},null,8,["src"])]),_:1}),n(" "+u(s.author.display_name),1)]),_:1})]),p("div",ke,[t(g,{pill:"","prepend-icon":"mdi-chart-line"},{default:a(()=>[n(u(i.stats.pageviews)+"浏览",1)]),_:1}),t(g,{pill:"","prepend-icon":"mdi-account-multiple"},{default:a(()=>[n(u(i.stats.visitors)+"访客",1)]),_:1}),t(g,{pill:"","prepend-icon":"mdi-clock"},{default:a(()=>[t(o,{date:s.project.time},null,8,["date"])]),_:1})]),p("div",xe,[s.project.state=="public"?(l(),f(g,{key:0,pill:"","prepend-icon":"mdi-xml"},{default:a(()=>r[1]||(r[1]=[n("开源作品 ",-1)])),_:1,__:[1]})):_("",!0),s.project.state=="private"?(l(),f(g,{key:1,color:"red",pill:"","prepend-icon":"mdi-xml",variant:"outlined"},{default:a(()=>r[2]||(r[2]=[n("私密作品 ",-1)])),_:1,__:[2]})):_("",!0),t(g,{pill:"","prepend-icon":"mdi-application"},{default:a(()=>[n(u(s.project.type),1)]),_:1})]),p("div",Se,[(l(!0),h(b,null,K(s.project.tags,j=>(l(),h("div",null,[t(g,{to:`/app/projects/tag/${j.name}`},{default:a(()=>[n(u(j.name),1)]),_:2},1032,["to"])]))),256))]),p("div",Pe,[t(m,{projectId:s.project.id,starcount:s.project.star_count},null,8,["projectId","starcount"])]),p("div",Te,[t(W,{border:"",density:"compact",rounded:"lg",size:"x-small"},{default:a(()=>[t(c,{to:`/${s.username}/${s.projectname}/fork`,class:"text-none",variant:"tonal"},{default:a(()=>r[3]||(r[3]=[n(" 分叉 ",-1)])),_:1,__:[3]},8,["to"]),t(c,{to:`/app/projects/fork/${s.project.id}`,text:""},{default:a(()=>[n(u(i.stats.forks),1)]),_:1},8,["to"])]),_:1})]),p("div",Ue,[t(c,{variant:"text",onClick:r[0]||(r[0]=j=>i.openEditor(s.project.id,s.project.type))},{default:a(()=>r[4]||(r[4]=[n("打开创造页 ",-1)])),_:1,__:[4]}),t(c,{to:`/${s.username}/${s.projectname}/edit`,variant:"text"},{default:a(()=>r[5]||(r[5]=[n("编辑源文件 ",-1)])),_:1,__:[5]},8,["to"])]),p("div",Be,[t(L,{author:s.author},null,8,["author"])]),r[6]||(r[6]=p("br",null,null,-1))]),_:1,__:[6]})}const He=V(Le,[["render",De]]),Ne={name:"CodeRunner",components:{CodeRunTerminal:Z},props:{projectType:{type:String,default:"python"},initialCode:{type:String,default:""}},data(){return{code:this.initialCode||"",selectedLanguage:this.getValidLanguage(),programmingLanguages:q,originalCode:this.initialCode||""}},computed:{languageOptions(){return Object.entries(this.programmingLanguages).map(([e,r])=>({key:e,name:r.name}))},currentLanguage(){return this.programmingLanguages[this.selectedLanguage]||{}}},methods:{runCode(){this.$refs.terminal&&this.$refs.terminal.runCode()},clearCode(){this.code=this.originalCode},getValidLanguage(){return Object.keys(q).includes(this.projectType)?this.projectType:"python"},getLanguageColor(e){return{python:"blue","python-2.7":"blue-darken-1","python-3.11":"blue","python-3.12":"blue-darken-2","python-3.13":"blue-darken-3",javascript:"yellow-darken-3","javascript-nodejs18":"green","javascript-nodejs20":"green-darken-1","javascript-nodejs22":"green-darken-2","javascript-nodejs24":"green-darken-3",rust:"orange-darken-3",golang:"cyan",ruby:"red",java:"orange","java-openjdk17":"orange-darken-1","java-openjdk21":"orange-darken-2","java-openjdk24":"orange-darken-3"}[e]||"grey"}},watch:{initialCode(e){this.code=e||""},projectType:{handler(e){this.selectedLanguage=e},immediate:!0}}},Re={class:"code-runner"};function qe(e,r,s,C,i,d){const o=Z;return l(),h("div",Re,[t(y,{class:"editor-card",elevation:"2"},{default:a(()=>[t(T,{class:"d-flex align-center pa-4"},{default:a(()=>[t(v,{icon:d.currentLanguage.icon||"mdi-code-tags",class:"me-3",size:"24"},null,8,["icon"]),r[2]||(r[2]=p("span",{class:"text-h6"},"代码编辑器",-1)),t(P),t(g,{color:d.getLanguageColor(i.selectedLanguage),variant:"flat",size:"small",class:"text-caption"},{default:a(()=>[n(u(d.currentLanguage.name||i.selectedLanguage),1)]),_:1},8,["color"])]),_:1,__:[2]}),t(w),t(U,{class:"pa-4"},{default:a(()=>[t(N,null,{default:a(()=>[t(k,{cols:"12"},{default:a(()=>[t(X,{modelValue:i.selectedLanguage,"onUpdate:modelValue":r[0]||(r[0]=m=>i.selectedLanguage=m),items:d.languageOptions,class:"mb-4","item-title":"name","item-value":"key",label:"选择编程语言",variant:"outlined","prepend-inner-icon":"mdi-code-braces","hide-details":""},{item:a(({props:m,item:L})=>[t(x,de(ue(m)),{prepend:a(()=>{var j;return[t(v,{icon:((j=i.programmingLanguages[L.value])==null?void 0:j.icon)||"mdi-code-tags",class:"me-3"},null,8,["icon"])]}),_:2},1040)]),_:1},8,["modelValue","items"])]),_:1}),t(k,{cols:"12"},{default:a(()=>[t(G,{modelValue:i.code,"onUpdate:modelValue":r[1]||(r[1]=m=>i.code=m),label:d.currentLanguage.placeholder||"在此输入代码",placeholder:d.currentLanguage.sample,class:"mb-4",rows:"12",variant:"outlined",onKeydown:ce(d.runCode,["enter"])},{"prepend-inner":a(()=>[t(v,{icon:"mdi-code-tags",class:"mt-1",size:"20",color:"grey"})]),_:1},8,["modelValue","label","placeholder","onKeydown"])]),_:1})]),_:1}),t(N,{class:"mt-2"},{default:a(()=>[t(k,{cols:"12",class:"d-flex justify-end"},{default:a(()=>[t(c,{onClick:d.clearCode,color:"grey",variant:"outlined","prepend-icon":"mdi-eraser",class:"me-2"},{default:a(()=>r[3]||(r[3]=[n(" 撤销所有编辑 ",-1)])),_:1,__:[3]},8,["onClick"]),r[5]||(r[5]=n()),t(c,{onClick:d.runCode,color:"primary",variant:"elevated","prepend-icon":"mdi-play"},{default:a(()=>r[4]||(r[4]=[n(" 运行代码 ",-1)])),_:1,__:[4]},8,["onClick"])]),_:1,__:[5]})]),_:1})]),_:1})]),_:1}),t(o,{ref:"terminal","auto-run":!1,code:i.code,language:i.selectedLanguage},null,8,["code","language"])])}const J=V(Ne,[["render",qe],["__scopeId","data-v-a87ae1a8"]]),Ee={name:"ProjectPlayer",components:{CodeRunner:J},props:{projectId:{type:[Number,String],required:!0},branch:{type:String,default:"main"},commitId:{type:String,default:"latest"},showplayer:{type:Boolean,required:!0},type:{type:String,default:"scratch"}},data(){return{initProject:pe,projectType:this.type,projectCode:"",projectContent:"",projectLanguage:"python"}},computed:{embedurl(){let e=`/scratch/embed.html?id=${this.projectId}&embed=true`;return localStorage.getItem("embedurl")&&(e=`${localStorage.getItem("embedurl")}/embed.html?id=${this.projectId}&embed=true`),this.commitId!=="latest"?`${e}&ref=${this.commitId}`:`${e}&branch=${this.branch}&ref=${this.commitId}`}},methods:{async loadProjectContent(){if(!(!this.showplayer||this.projectType==="scratch"))try{const e=await me(this.projectId,this.branch,this.commitId);this.projectType==="text"?this.projectContent=e.code||"":(this.projectCode=e.code||"",this.projectLanguage=e.language||"python")}catch(e){console.error("Failed to load project content:",e)}}},async mounted(){await this.loadProjectContent()},watch:{projectId:{handler:"loadProjectContent",immediate:!0},branch:"loadProjectContent",commitId:"loadProjectContent",type:{handler(e){this.projectType=e,this.loadProjectContent()},immediate:!0}}},Ae=["src"];function Oe(e,r,s,C,i,d){const o=J;return l(),h("div",null,[i.projectType==="scratch"?(l(),h(b,{key:0},[s.showplayer?(l(),f(y,{key:0,border:"",hover:"",style:{"aspect-ratio":"4 / 3"}},{default:a(()=>[p("iframe",{src:d.embedurl,frameborder:"0",scrolling:"no",style:{width:"100%",height:"100%"}},null,8,Ae)]),_:1})):_("",!0)],64)):i.projectType==="text"?(l(),h(b,{key:1},[s.showplayer?(l(),f(y,{key:0,border:"",hover:""},{default:a(()=>[t(U,null,{default:a(()=>[t(G,{modelValue:i.projectContent,"onUpdate:modelValue":r[0]||(r[0]=m=>i.projectContent=m),"auto-grow":"","hide-details":"",readonly:"",rows:"10"},null,8,["modelValue"])]),_:1})]),_:1})):_("",!0)],64)):(l(),h(b,{key:2},[s.showplayer?(l(),f(o,{key:0,ref:"codeRunner","initial-code":i.projectCode,"initial-language":i.projectLanguage,"project-type":i.projectType},null,8,["initial-code","initial-language","project-type"])):_("",!0)],64)),s.showplayer?_("",!0):(l(),f(y,{key:3,border:"",hover:"",title:"项目尚未初始化"},{default:a(()=>[t(S,null,{default:a(()=>[t(c,{onClick:r[1]||(r[1]=m=>i.initProject(s.projectId,"scratch"))},{default:a(()=>r[3]||(r[3]=[n("以Scratch模板初始化项目",-1)])),_:1,__:[3]}),t(c,{onClick:r[2]||(r[2]=m=>i.initProject(s.projectId,"text"))},{default:a(()=>r[4]||(r[4]=[n("以文本模板初始化项目",-1)])),_:1,__:[4]})]),_:1})]),_:1}))])}const Je=V(Ee,[["render",Oe],["__scopeId","data-v-e47013c7"]]);export{He as _,Je as a};
