<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google" value="notranslate" />
    <meta name="description"
        content="ZeroCat is a Scratch mod with a compiler to run projects faster, dark mode for your eyes, a bunch of addons to improve the editor, and more." />
    <title>
        ZeroCat - Run Scratch projects faster
    </title>
    <link rel="apple-touch-icon" href="./images/apple-touch-icon.png" />
    
            <script src="./main.js"></script>
            <script src="./jquery.3.7.1.js"></script>
            <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css" />
            <script src="https://unpkg.com/mdui@2/mdui.global.js"></script>

            <style>
                .splash-screen {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                }

                .splash-screen[hidden] {
                    display: none;
                }

                .splash-screen[data-theme="dark"] {
                    background-color: #333;
                    color: white;
                }

                .splash-screen>* {
                    max-width: 80%;
                }

                .splash-spinner:after {
                    content: " ";
                    display: block;
                    width: 64px;
                    height: 64px;
                    border-radius: 50%;
                    border: 6px solid;
                    border-color: currentColor transparent currentColor transparent;
                    animation: splash-spinner 1.2s linear infinite;
                }

                @keyframes splash-spinner {
                    0% {
                        transform: rotate(0deg);
                    }

                    100% {
                        transform: rotate(360deg);
                    }
                }

                .splash-error-title {
                    font-weight: bold;
                }

                .splash-error-title a {
                    color: inherit;
                }

                .splash-errors {
                    font-family: monospace;
                }

                .splash-error-list {
                    white-space: pre-wrap;
                }

                .splash-reset {
                    color: inherit;
                    background: none;
                    padding: 0;
                    margin: 0;
                    border: none;
                    text-decoration: underline;
                    cursor: pointer;
                }

                .splash-reset:disabled {
                    opacity: 0.8;
                }

                .splash-pride-month {
                    max-width: 350px;
                }
            </style>
</head>

<body>
    <noscript>
        <div class="splash-screen">
            <div>
                <h1>
                    ZeroCat
                        需要使用杨博士自主研发遥遥领先的JvavScript
                </h1>
                <p>兄弟你咋想的？</p>
            </div>
        </div>
    </noscript>

    <div class="splash-screen spash-waiting-for-js" hidden>
        <div class="splash-spinner"></div>

        <div class="splash-pride-month" lang="en">
            <b>正在加载作品</b>
            数据文件从ZeroCat服务器加载，卡住请刷新
        </div>

        <div class="splash-error-title" hidden>
            出问题了~
            <a href="https://qm.qq.com/q/wn3TkPoZ5C" target="_blank" rel="noreferrer">Please report</a>
            with the information below.
        </div>
        <div class="splash-errors" hidden></div>
        <button class="splash-reset" hidden>
            Click here to reset caches (can fix some errors)
        </button>
    </div>

    <script>
        (function () {
            'use strict';

            var theme = '';
            var accent = '#ff4c4c';

            try {
                var themeSetting = localStorage.getItem('zc:theme');
            } catch (e) {
                // ignore
            }
            if (themeSetting === 'light') {
                theme = 'light';
            } else if (themeSetting === 'dark') {
                theme = 'dark';
            } else if (themeSetting) {
                try {
                    var parsed = JSON.parse(themeSetting);
                    if (parsed.accent === 'purple') {
                        accent = '#855cd6';
                    } else if (parsed.accent === 'blue') {
                        accent = '#4c97ff';
                    }
                    if (parsed.gui === 'dark' || parsed.gui === 'light') {
                        theme = parsed.gui;
                    }
                } catch (e) {
                    // ignore
                }
            }

            if (!theme) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            var htmlElement = document.getElementsByTagName("html")[0];

            htmlElement.classList.add('mdui-theme-' + theme);
            mdui.setColorScheme("#2087fd")

            var splash = document.querySelector('.spash-waiting-for-js');
            splash.setAttribute('data-theme', theme);
            if (theme !== 'dark') {
                      
                    splash.style.color = accent;
                      
                    }
            splash.hidden = false;

            var splashErrorTitle = document.querySelector('.splash-error-title');
            var splashError = document.querySelector('.splash-errors');
            var splashReset = document.querySelector('.splash-reset');
            var splashPrideMonth = document.querySelector('.splash-pride-month');

            var totalErrors = 0;
            window.onerror = function (event, source, line, col, err) {
                if (++totalErrors > 5) return; // dont bother logging more
                splashErrorTitle.hidden = splashError.hidden = splashReset.hidden = false;
                splashPrideMonth.hidden = true;
                var el = document.createElement('div');
                el.textContent = 'Error (splash) in ' + source + ' (' + line + ':' + col + '): ' + err;
                splashError.appendChild(el);
            };

            splashReset.onclick = function () {
                splashReset.disabled = true;
                function hardRefresh() {
                    var search = location.search.replace(/[?&]nocache=\d+/, '');
                    location.replace(location.pathname + search + (search ? '&' : '?') + 'nocache=' + Math.floor(Math.random() * 100000));
                }
                if ('serviceWorker' in navigator) {
                    setTimeout(hardRefresh, 5000);
                    navigator.serviceWorker.getRegistration("./")
                        .then(function (registration) {
                            if (registration) {
                                return registration.unregister();
                            }
                        })
                        .then(hardRefresh)
                        .catch(hardRefresh);
                } else {
                    hardRefresh();
                }
            };

            window.SplashEnd = () => {
                splash.hidden = true;
                window.onerror = null;
            };
        })();
    </script>

    <mdui-dialog headline="作品" description="加载中" close-on-overlay-click id="zerocat-tab">
        <mdui-button id="savestatic" onclick="uploadAssets()">保存媒体库</mdui-button>
        <mdui-button onclick="projectjson='null';saveproject()">强制保存作品</mdui-button>
        <mdui-button onclick="logText.innerText = ''">清空log</mdui-button>

        <div id="log-text"></div>
    </mdui-dialog>


    <script src="./jwt-decode.js"></script>
    <script>
        if (localStorage.getItem("ZeroCat_Apihost")) {
            window.apiHost = localStorage.getItem("ZeroCat_Apihost");
            window.apihost = localStorage.getItem("ZeroCat_Apihost");

        } else {
            window.apiHost = "https://zerocat-api.houlangs.com";
            window.apihost = "https://zerocat-api.houlangs.com";

        }
        window.assetHost = "https://s4-1.wuyuan.1r.ink/material/asset";

        // 论天才群星闪耀时
        window.assethost = "https://s4-1.wuyuan.1r.ink/material/asset";

        var _pid = {};
        var logText = {};
        var zctab = {};
        var openzctabButton = {};
        var setinfotab = {};
        var forkdialog = {};
        var openforkdialog = {};

        var userinfo = {};

        var opensetinfotabButton = {};


        var projectjson = "null";
        var projectinfo = {};
        window.projectinfo = projectinfo;
        // 常用函数
        function getQueryString(name) {
            const url_string = window.location.href;
            const url = new URL(url_string);
            return url.searchParams.get(name);
        }
        function getTime() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            return hours + ":" + minutes + ":" + seconds;
        }

        function removeQuery(url, query) {
            const urlObj = new URL(url);
            urlObj.searchParams.delete(query);
            return urlObj.toString();
        }
        function snackbar(text) {
            mdui.snackbar({
                message: text,
                closeable: true
            });
        }
        // 处理作品的函数
        // 上传作品资源
        function uploadAssets() {
            $.each(vm.assets, function (index, asset) {
                var data = asset.data;
                if (asset.clean == false) {
                    console.log(asset.clean);
                    const formData = new FormData();
                    formData.append('file', new Blob([data], { type: asset.assetType.contentType }), `${asset.assetId}.${asset.dataFormat}`);

                    $.ajax({
                        url: window.apiHost +
                            "/scratch/assets/" +
                            asset.assetId +
                            "." +
                            asset.dataFormat +
                            "?token=" +
                            localStorage.getItem("token"),
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem("token")
                        },
                        success: function (response) {
                            logText.innerText += `[${getTime()}]文件上传成功${asset.assetId}.${asset.dataFormat}\n`;
                            console.log("文件上传成功:", asset.assetId + "." + asset.dataFormat);
                            asset.clean = true;
                        },
                        error: function (xhr, status, error) {
                            logText.innerText += `[${getTime()}]文件上传失败${asset.assetId}.${asset.dataFormat}\nerror:${error}\n`;
                            console.error("文件上传失败:", asset.assetId + "." + asset.dataFormat, error);
                        },
                    });
                } else {
                    logText.innerText += `[${getTime()}]文件未修改${asset.assetId
                        }.${asset.dataFormat}\n`;

                    console.log(
                        "文件未修改:",
                        asset.assetId + "." + asset.dataFormat
                    );
                }
            });
            snackbar('媒体库保存完成')
        }
        // 上传作品
        function uploadProject() {
            if (_pid == 0) {
                console.log('创建作品')
                $.ajax({
                    url: `${window.apiHost}/project?token=${localStorage.getItem("token")}`,
                    type: "post",
                    data: JSON.stringify({ title: 'Scratch新作品', type: 'scratch', devsource: vm.toJSON() }),
                    contentType: "application/json",
                    success: function (result) {
                        console.log("作品创建成功");
                        location.href = "/editor.html#" + result.id;

                    },
                    error: function (err) {
                        console.log(err);
                        mdui.alert({
                            headline: "创建作品出错",
                            description: JSON.stringify(err),
                            confirmText: "关闭",
                        });
                    },
                });
            } else {
                $.ajax({
                    url: `${window.apiHost}/project/${projectinfo.id}/source?token=${localStorage.getItem("token")}`,
                    type: "put",
                    data: vm.toJSON(),
                    contentType: "application/json",
                    success: function (result) {
                        console.log("作品保存成功");
                        console.log(result);
                        snackbar("作品保存成功")
                    },
                    error: function (err) {
                        console.log(err);
                        mdui.alert({
                            headline: "保存作品出错",
                            description: JSON.stringify(err),
                            confirmText: "关闭",
                        });
                    },
                });
            }
        }

        // 读取数据函数
        // 读取用户信息并写入
        function loaduserinfo() {
            if (localStorage.getItem("token")) {
                document.getElementById("open-setinfo-tab").style.display = "none";

                const decoded = jwtDecode(localStorage.getItem("token"));
                console.log(decoded);
                userinfo = decoded;
                localStorage.setItem("zc:id", decoded.userid);
                localStorage.setItem("zc:username", decoded.display_name);
                //document.querySelector(    "#userinfotext").innerText = `已登录,id:${decoded.userid},用户名:${decoded.display_name}`;
                document.querySelector("#open-setinfo-tab").innerText = userinfo.display_name;
                document.querySelector("#open-setinfo-tab").removeAttribute('href');
                console.log("加载了用户信息");

            } else {
                console.log("无令牌");
                snackbar('未登录')
            }
        }

        // 读取作品信息并写入
        function getprojectinfo() {
            if (_pid !== 0 && Number.isInteger(_pid)) {
                $.ajax({
                    url: window.apiHost + "/scratch/projectinfo?id=" + _pid,
                    type: "GET",
                    data: { token: localStorage.getItem("token") },
                    success: function (result) {
                        if (result.status == "404") {
                            location.href = "/editor.html?msg=404";
                            return;
                        }
                        window.projectinfo = result;
                        zctab.headline = result.title;
                        zctab.description = `用户ID：${result.authorid
                            }，作品ID：${result.id} ，${result.authorid == localStorage.getItem("zc:id")
                                ? "是你的作品"
                                : "不是你的作品"
                            }`;

                        console.log("成功获取作品信息");
                        console.log(result);

                        if (
                            result.authorid ===
                            localStorage.getItem("zc:id")
                        ) {
                            console.log("作品作者为当前用户");
                            setSaveButton();
                        }
                        if (
                            result.authorid != localStorage.getItem("zc:id")
                        ) {
                            console.log("作品作者不是当前用户");
                            setForkButton();
                        }
                    },
                    error: function (err) {
                        alert(err);
                    },
                });
            }
        }


        window.onload = function () {
            if (getQueryString("msg")) {
                if (getQueryString("msg") == "404") {
                    debugger;
                    alert("作品不存在");
                }
                if (getQueryString("msg") == "401") {
                    alert("请先登录");
                }
            }

            _pid = 0;
            load();

            zctab = document.querySelector("#zerocat-tab");
            openzctabButton = document.querySelector("#open-zerocat-tab");
            openzctabButton.addEventListener(
                "click",
                () => (zctab.open = true)
            );

            logText = document.querySelector("#log-text");

        };
        function zctabopen() {
            zctab.open = true;
        }
        window.zctabopen = zctabopen;
        function forkdialogopen() {
            forkdialog.open = true;
        }
        window.zctabopen = zctabopen;
        function setinfotabopen() {
            setinfotab.open = true;
        }
        window.setinfotabopen = setinfotabopen;
        function pushdialogopen() {
            pushdialog.open = true;
        }
        window.pushdialogopen = pushdialogopen;
        function load() {

            loaduserinfo();
            console.log("加载");
            if (window.location.hash) {
                _pid = Number(location.hash.match(/\d+/i)[0]);
            }
            console.log("作品ID为" + _pid);
            if (_pid !== 0) {
                console.log("加载作品信息");
                getprojectinfo();
                setSaveButton();
            } else {
                console.log("作品ID为0");
                setSaveButton();
            }
        }
        window.scratchConfig = {
            handleProjectLoaded: () => {
                load()
            },
            handleDefaultProjectLoaded: () => {
                if (window.location.hash) {
                    _pid = Number(location.hash.match(/\d+/i)[0]);
                }
                setSaveButton();
                console.log("默认作品");
            },
        };




        // 处理顶部按钮的函数
        function setSaveButton() {
            if (_pid == 0) {
                // document.getElementById("push-button").style.removeProperty("display");
                document.getElementById("push-button").innerText =
                    "新建并保存";
                document.getElementById("push-button").onclick =
                    function () {
                        saveproject();
                    };
                console.log("设置保存按钮");
            } else {
                // document.getElementById("push-button").style.display ="none";
                document.getElementById("push-button").innerText = "推送";
                document.getElementById("push-button").onclick =
                    function () {
                        window.open('/projects/' + _pid + '/push')
                    };
                console.log("设置推送按钮");
            }
        }
        function setForkButton() {
            // document.getElementById("push-button").style.display = "none";
            // document.getElementById("push-button").style.removeProperty("display");
            document.getElementById("push-button").innerText = "改编";
            document.getElementById("push-button").onclick =
                function () {
                    window.open('/projects/' + _pid + '/fork')
                };
            console.log("设置改编按钮");
        }

        // 由按钮触发的函数
        // 保存作品
        function saveproject() {
            uploadAssets();
            if (projectjson == "null" || projectjson != vm.toJSON() || _pid == 0
            ) {
                projectjson = vm.toJSON();
                if (
                    window.projectinfo.authorid ==
                    localStorage.getItem("zc:id") ||
                    _pid == 0
                ) {
                    uploadProject();
                    console.log("保存完成");
                    snackbar('保存完成')
                    logText.innerText += `[${getTime()}]保存完成\n`;

                    return "保存完成";
                }
            }
            if ((projectjson = vm.toJSON())) {
                console.log("作品未修改");
                snackbar('作品未修改')

                logText.innerText += `[${getTime()}]作品未修改\n`;
                return "作品未修改";
            }
        }

    </script>
    <div id="app"></div>
<script src="./js/vendors~addon-settings~credits~editor~embed~fullscreen~player.js"></script><script src="./js/vendors~editor~embed~fullscreen~player.js"></script><script src="./js/addon-settings~addons~editor~fullscreen~player.js"></script><script src="./js/addon-settings~editor~embed~fullscreen~player.js"></script><script src="./js/player.js"></script></body>

</html>

<mdui-dialog close-on-overlay-click id="fork-dialog" style="display: none">
    <span slot="headline">改编此作品</span>
    <span slot="description">你确定要改编这个作品吗？<br />
        改编设立的目的是为了让社区中的作品得到更好的发展，请不要滥用改编，更不能直接抄袭。<br />
        如果您已了解以上内容，请在下方的输入框中输入<br />
        <strong draggable="false" style="user-select: none">我保证会好好对待改编的作品</strong>
    </span>
    <mdui-text-field id="suretoforktext"></mdui-text-field>

    <mdui-button
        onclick="if(document.querySelector('#suretoforktext').value=='我保证会好好对待改编的作品'){forkproject();forkdialog.open=false}else{alert('请输入正确的内容')}">改编</mdui-button>
</mdui-dialog>